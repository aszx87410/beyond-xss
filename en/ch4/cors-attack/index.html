<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch4/cors-attack" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Cross-Origin Security Issues | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/en/ch4/cors-attack/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="google-site-verification" content="O7SjDEO9AQXbxqBWhtUW0FVahHxSrnweMXJxLICpSz4"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Cross-Origin Security Issues | Beyond XSS"><meta data-rh="true" name="description" content="While some websites use reverse proxies or other mechanisms to place the frontend and backend under the same origin, this seems to be the exception rather than the norm. In most cases, allowing frontend access to cross-origin backend APIs is almost inevitable."><meta data-rh="true" property="og:description" content="While some websites use reverse proxies or other mechanisms to place the frontend and backend under the same origin, this seems to be the exception rather than the norm. In most cases, allowing frontend access to cross-origin backend APIs is almost inevitable."><link data-rh="true" rel="icon" href="/beyond-xss/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/en/ch4/cors-attack/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch4/cors-attack/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/cors-attack/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/cors-attack/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/en/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/en/assets/js/runtime~main.9a9bfab3.js" as="script">
<link rel="preload" href="/beyond-xss/en/assets/js/main.3d2d1fa0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/en/"><div class="navbar__logo"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS: Explore the Web Front-end Security Universe</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch4/cors-attack/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/beyond-xss/ch4/cors-attack/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-TW">中文（台灣）</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/">About This Series</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch1/browser-security-model/">Chapter 1: Starting with XSS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch2/xss-defense-sanitization/">Chapter 2: Defense and bypass for XSS </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch3/attack-without-js/">Chapter 3: Attacks without JavaScript  </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/beyond-xss/en/ch4/sop-and-site/">Chapter 4: Cross-site attacks </a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/sop-and-site/">The Essence: Same-origin Policy and Site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cors-intro/">Introduction to Cross-Origin Resource Sharing (CORS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/en/ch4/cors-attack/">Cross-Origin Security Issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/csrf/">Cross-Site Request Forgery (CSRF) Made Easy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/same-site-cookie/">Same-site cookie, the savior of CSRF?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/subdomain/">From same-site to main site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cookie-bomb/">Interesting and Practical Cookie Bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch5/clickjacking/">Chapter 5: Other interesting topics  </a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/summary/">Conclusion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/contact/">Contact the Author</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/beyond-xss/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Chapter 4: Cross-site attacks </span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Cross-Origin Security Issues</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Cross-Origin Security Issues</h1><p>While some websites use reverse proxies or other mechanisms to place the frontend and backend under the same origin, this seems to be the exception rather than the norm. In most cases, allowing frontend access to cross-origin backend APIs is almost inevitable.</p><p>However, configuring CORS headers may not be as simple as it seems. If misconfigured, it can allow attackers to access resources they shouldn&#x27;t have access to.</p><p>In addition to misconfigurations in CORS settings, there are also security concerns with cross-origin access for elements like <code>&lt;img&gt;</code> or <code>&lt;script&gt;</code>, which we will discuss in this post.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cors-misconfiguration">CORS Misconfiguration<a href="#cors-misconfiguration" class="hash-link" aria-label="Direct link to CORS Misconfiguration" title="Direct link to CORS Misconfiguration">​</a></h2><p>As mentioned earlier, if a cross-origin non-simple request wants to include cookies, the <code>Access-Control-Allow-Origin</code> cannot be <code>*</code>. It must specify a single origin; otherwise, the browser will not allow it.</p><p>But in reality, we cannot have just one origin. We may have multiple origins, such as <code>buy.example.com</code>, <code>social.example.org</code>, <code>note.example.com.tw</code>, all needing to access <code>api.example.com</code>. In this case, we cannot hardcode the origin in the response header; it needs to be dynamically adjusted.</p><p>Let&#x27;s start with the worst approach, which is:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> res</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;Access-Control-Allow-Credentials&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;true&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;Access-Control-Allow-Origin&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;Origin&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The origin is directly taken from the request header for convenience. By doing this, any origin can pass the CORS check.</p><p>What problems does this approach have?</p><p>It has significant issues.</p><p>Let&#x27;s say I create a website with the URL <code>https://fake-example.com</code> and try to get users to click on it. Inside the website, there is a script:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// send a request with cookie</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;https://api.example.com/me&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">credentials</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;include&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">res</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">res</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// got user data, and I can send it to my server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// redirect back to the real service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">location</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;https://example.com&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Because the server returns the correct header, recognizing <code>https://fake-example.com</code> as a valid origin, the CORS check passes. Therefore, this website can also retrieve data from <code>http://api.example.com/me</code>.</p><p>As a result, this attack will only affect users who visit the website and are logged into <code>example.com</code>. The impact depends on the website&#x27;s API. At a minimum, it can access user data, and in more severe cases, it may obtain the user&#x27;s token (if such an API exists).</p><p>There are a few things to note about this attack:</p><ol><li>This is not XSS because I am not executing code on <code>example.com</code>. I am executing it on my own website, <code>http://fake-example.com</code>.</li><li>It is somewhat similar to CSRF, but websites usually do not add CSRF token protection to GET APIs, so it can pass.</li><li>If SameSite cookies are set, the attack will fail because the cookie will not be sent.</li></ol><p>(CSRF and SameSite will be discussed later)</p><p>Therefore, for this attack to succeed, several prerequisites must be met:</p><ol><li>CORS headers are given to an unauthorized origin.</li><li>The website uses cookies for authentication and does not set SameSite.</li><li>The user actively clicks on the website and is logged in.</li></ol><p>Regarding the first point, it is unlikely that anyone would write code like the example above, directly using the origin from the request header. A more likely approach is:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> res</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;Access-Control-Allow-Credentials&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;true&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> origin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;Origin&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">example\.com$</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;Access-Control-Allow-Origin&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> origin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This way, the following origins can pass:</p><ol><li>example.com</li><li>buy.example.com</li><li>social.example.com</li></ol><p>However, this approach has a problem because this can also pass:</p><ol><li>fakeexample.com</li></ol><p>Vulnerabilities like this are caused by incorrect CORS settings and are therefore called CORS misconfigurations.</p><p>The solution is not to use RegExp for checking but to prepare an allow-list in advance. Only origins that appear in the list can pass; otherwise, they will fail. This way, we can ensure that there are no vulnerabilities in the checking process and remember to add the SameSite attribute to cookies.</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> allowOrigins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;https://example.com&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;https://buy.example.com&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;https://social.example.com&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> res</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;Access-Control-Allow-Credentials&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;true&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> origin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;Origin&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allowOrigins</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">includes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;Access-Control-Allow-Origin&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> origin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="real-world-example">Real-World Example<a href="#real-world-example" class="hash-link" aria-label="Direct link to Real-World Example" title="Direct link to Real-World Example">​</a></h3><p>The first example is a vulnerability found by Jordan Milne in JetBrains IDE in 2016.</p><p>When using JetBrains IDE, it runs a local server. When you open a file and click &quot;view in browser,&quot; it opens the URL: <code>http://localhost:63342/&lt;projectname&gt;/&lt;your_file.html&gt;</code>, which is handled by the local server behind the scenes.</p><p>And this server is not well implemented. Its <code>Access-Control-Allow-Origin</code> header is just like the wrong example I mentioned earlier, directly using the origin header from the request. Therefore, any website can read the response.</p><p>Furthermore, the author discovered a path traversal vulnerability, which allows accessing any file through this API. Therefore, when combined, it means that an attacker can read files on the system through the JetBrains local server API on their website.</p><p>The simple PoC provided by the author is as follows:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token script language-javascript keyword" style="color:#00009f">var</span><span class="token script language-javascript"> xhr </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword" style="color:#00009f">new</span><span class="token script language-javascript"> </span><span class="token script language-javascript class-name">XMLHttpRequest</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">xhr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">open</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&quot;GET&quot;</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&quot;http://localhost:63342/testing/something.txt&quot;</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean" style="color:#36acaa">true</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">xhr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method-variable function-variable method function property-access" style="color:#d73a49">onload</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript function" style="color:#d73a49">alert</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">xhr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">responseText</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">xhr</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">send</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Later, the author found other issues and successfully achieved RCE (Remote Code Execution). However, those parts are unrelated to the CORS configuration issue discussed in this article, so I won&#x27;t go into detail. If you are interested, you can refer to the original article: <a href="http://blog.saynotolinux.com/blog/2016/08/15/jetbrains-ide-remote-code-execution-and-local-file-disclosure-vulnerability-analysis/" target="_blank" rel="noopener noreferrer">JetBrains IDE Remote Code Execution and Local File Disclosure</a>.</p><p>The second case is about a vulnerability in a Bitcoin exchange shared by James Kettle at the 2017 AppSec EU conference.</p><p>He found that one of the exchange&#x27;s APIs had the same vulnerability, allowing any origin to read the response. One of the APIs was <code>/api/requestApiKey</code>, which could retrieve the user&#x27;s apiKey. This apiKey could be used to transfer the user&#x27;s bitcoins to another account.</p><p>For more information, you can refer to: <a href="https://www.youtube.com/watch?v=wgkj4ZgxI4c&amp;ab_channel=OWASP" target="_blank" rel="noopener noreferrer">AppSec EU 2017 Exploiting CORS Misconfigurations For Bitcoins And Bounties by James Kettle</a>.</p><p>Lastly, let&#x27;s look at the vulnerability I reported for Asiayo in 2020. The root cause is exactly the same, allowing other websites to access user data, including names, phone numbers, and email addresses:</p><p><img loading="lazy" src="/beyond-xss/en/assets/images/22-01-7996e373152b0341b07c18d6498f2259.png" width="1201" height="153" class="img_ev3q"></p><p>Original report(in Mardarin): <a href="https://zeroday.hitcon.org/vulnerability/ZD-2020-00829" target="_blank" rel="noopener noreferrer">Asiayo Website CORS Misconfiguration Vulnerability</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-coxx-series-headers">Other COXX Series Headers<a href="#other-coxx-series-headers" class="hash-link" aria-label="Direct link to Other COXX Series Headers" title="Direct link to Other COXX Series Headers">​</a></h2><p>In addition to the familiar CORS, there are several headers starting with CO:</p><ol><li>CORB (Cross-Origin Read Blocking)</li><li>CORP (Cross-Origin Resource Policy)</li><li>COEP (Cross-Origin-Embedder-Policy)</li><li>COOP (Cross-Origin-Opener-Policy)</li></ol><p>These headers with CO are also related to cross-origin data access. Now let&#x27;s take a look at what these headers are doing.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="serious-security-vulnerabilities-meltdown-and-spectre">Serious Security Vulnerabilities: Meltdown and Spectre<a href="#serious-security-vulnerabilities-meltdown-and-spectre" class="hash-link" aria-label="Direct link to Serious Security Vulnerabilities: Meltdown and Spectre" title="Direct link to Serious Security Vulnerabilities: Meltdown and Spectre">​</a></h2><p>On January 3, 2018, Google&#x27;s Project Zero released an article titled <a href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html" target="_blank" rel="noopener noreferrer">Reading privileged memory with a side-channel</a>, which described three attacks targeting CPU data cache:</p><ul><li>Variant 1: bounds check bypass (CVE-2017-5753)</li><li>Variant 2: branch target injection (CVE-2017-5715)</li><li>Variant 3: rogue data cache load (CVE-2017-5754)</li></ul><p>The first two are known as Spectre, and the third one is known as Meltdown. If you remember, this was a big issue at the time because the problem was with the CPU and not an easy one to fix.</p><p>I think the disclosure of this vulnerability had a significant impact on the operation mechanism of browsers (or at least accelerated the evolution of browsers). Especially, Spectre can be used to attack browsers, which also affects the topic of this series: Cross-Origin Resource Sharing.</p><p>Therefore, it is necessary to have a basic understanding of what Spectre is doing. To fully understand this attack, a lot of background knowledge is required, but that is not the main focus of this article. So, below I will explain Spectre using a highly simplified model. If you want to fully understand it, you can refer to the link above.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="super-simplified-explanation-of-spectre-attack">Super Simplified Explanation of Spectre Attack<a href="#super-simplified-explanation-of-spectre-attack" class="hash-link" aria-label="Direct link to Super Simplified Explanation of Spectre Attack" title="Direct link to Super Simplified Explanation of Spectre Attack">​</a></h2><p>Again, it is important to note that this is a simplified version for easier understanding. It may differ from the original attack, but the core concept should be similar.</p><p>Let&#x27;s assume we have a piece of code (in C language) that looks like this:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">uint8_t</span><span class="token plain"> arr1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">uint8_t</span><span class="token plain"> arr2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">256</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> array1_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">size_t</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> array1_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint8_t</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> array2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">array1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">size_t</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I have declared two arrays of type <code>uint8_t</code>, so each element in the arrays will be 1 byte (8 bits) in size. The length of <code>arr1</code> is 16, and the length of <code>arr2</code> is 256.</p><p>Next, I have a function called <code>run</code> which takes a number <code>x</code> as input. It checks if <code>x</code> is smaller than <code>array1_size</code>. If it is, it retrieves the value of <code>array1[x]</code>, uses it as an index to access <code>array2</code>, and assigns the retrieved value to <code>y</code>.</p><p>In the example above, if we call <code>run(1)</code>, it will execute:</p><div class="language-C codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">uint8_t y = array2[array1[1]];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since the value of <code>array1[1]</code> is 2, it becomes <code>y = array2[2]</code>.</p><p>This code seems fine and I have also added a check for array length, so there won&#x27;t be any out-of-bounds (OOB) access unless <code>x</code> is smaller than <code>array1_size</code>.</p><p>However, this is just how it appears to you.</p><p>When the CPU executes the code, there is a mechanism called branch prediction. To improve code execution efficiency, the CPU predicts whether the if condition will be true or false. If the prediction is true, it executes the code inside the if statement and calculates the result in advance.</p><p>All of this is just &quot;prediction&quot;. After the actual execution of the if condition, if the result matches the prediction, everything is fine. But if it doesn&#x27;t match, the previously calculated result is discarded. This mechanism is called speculative execution.</p><p>Because the CPU discards the result, we cannot directly access the speculative execution result unless there are some clues left by the CPU.</p><p>And this is the main reason why Spectre attack works, because there are indeed some clues left.</p><p>To further improve execution efficiency, during speculative execution, some results are stored in the CPU cache to enhance data retrieval efficiency.</p><p>Let&#x27;s say we have three things: A, B, and C. One of them is in the CPU cache, and the other two are not. How can we determine which one is in the cache?</p><p>The answer is by observing the access time of these three things! Since accessing something in the CPU cache is faster, if accessing A takes 10ms, B takes 10ms, and C only takes 1ms, we can conclude that C is in the CPU cache. This type of attack that obtains information through other channels is called a side-channel attack.</p><p>In the above method, we determine based on time, so it is also known as a timing attack.</p><p>Now, let&#x27;s go back to the previous code:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">uint8_t</span><span class="token plain"> arr1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">uint8_t</span><span class="token plain"> arr2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">256</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> array1_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">size_t</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> array1_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint8_t</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> array2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">array1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">size_t</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Assume that we run <code>run(10)</code> multiple times. Based on branch prediction, the CPU reasonably predicts that the next execution will also satisfy the if condition and executes the code inside. At this moment, I suddenly set <code>x</code> to 100 and run <code>run(100)</code>.</p><p>The code inside the if statement will be speculatively executed:</p><div class="language-C codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">uint8_t y = array2[array1[100]];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s say the value of <code>array1[100]</code> is 38. So it becomes <code>y = array2[38]</code>, and <code>array2[38]</code> is stored in the CPU cache, enhancing the efficiency of subsequent data retrieval.</p><p>Then, during the actual execution, the if condition is found to be false, so the previously obtained result is discarded, and nothing happens. The function execution is completed.</p><p>Now, based on the timing attack we discussed earlier, we read each element of <code>array2</code> and measure the time. We will find that the access time for <code>array2[38]</code> is the shortest.</p><p>At this point, we know one thing:</p><blockquote><p>The content of <code>array1[100]</code> is 38.</p></blockquote><p>You might ask, &quot;So what can you do with this information?&quot; There are many things you can do. Since the length of <code>array1</code> is only 16, the value we read is not from <code>array1</code> itself but from other parts of memory that we should not have accessed. By continuously replicating this pattern, we can read data from other places.</p><p>If this attack is performed in a browser, I can read data from other websites within the same process. In other words, if there is content from other websites within the same process, I can access that content!</p><p>This is the Spectre attack, which exploits certain mechanisms of the CPU to perform a side-channel attack and read data that should not be accessible, causing security issues.</p><p>In simple terms, &quot;Spectre allows you to potentially read data from other websites while using a browser.&quot;</p><p>The explanation of Spectre ends here. The details have been simplified above, and I don&#x27;t fully understand those details either. If you want to know more, you can refer to:</p><ol><li><a href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html" target="_blank" rel="noopener noreferrer">Reading privileged memory with a side-channel</a></li><li><a href="https://zhuanlan.zhihu.com/p/32757727" target="_blank" rel="noopener noreferrer">Interpreting Meltdown &amp; Spectre CPU vulnerabilities</a></li><li><a href="https://yangrz.github.io/blog/2018/01/09/cpu/" target="_blank" rel="noopener noreferrer">A discussion on processor-level Spectre Attack and Poc analysis</a></li><li><a href="https://www.ptt.cc/bbs/NetSecurity/M.1515146856.A.750.html" target="_blank" rel="noopener noreferrer">[Chat] Introduction to Spectre &amp; Meltdown vulnerabilities (translation)</a></li><li><a href="https://github.com/hdzitao/spectre-attack-zh" target="_blank" rel="noopener noreferrer">Spectre vulnerability example code comments</a></li><li><a href="https://developers.google.com/web/updates/2018/02/meltdown-spectre" target="_blank" rel="noopener noreferrer">Google update: Meltdown/Spectre</a></li><li><a href="https://security.googleblog.com/2018/07/mitigating-spectre-with-site-isolation.html" target="_blank" rel="noopener noreferrer">Mitigating Spectre with Site Isolation in Chrome</a></li></ol><p>As for the COXX stuff, their purpose is similar, which is to prevent one website from being able to read data from other websites. As long as malicious websites and target websites are not in the same process, this type of attack is ineffective.</p><p>From this perspective, let&#x27;s take a look at various related mechanisms.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="corb-cross-origin-read-blocking">CORB (Cross-Origin Read Blocking)<a href="#corb-cross-origin-read-blocking" class="hash-link" aria-label="Direct link to CORB (Cross-Origin Read Blocking)" title="Direct link to CORB (Cross-Origin Read Blocking)">​</a></h2><p>About a month after the public disclosure of the Spectre attack by Google, in February 2018, they published a blog post explaining what Chrome did to prevent this type of attack: <a href="https://developers.google.com/web/updates/2018/02/meltdown-spectre" target="_blank" rel="noopener noreferrer">Meltdown/Spectre</a>.</p><p>The Cross-Site Document Blocking mentioned in the article is the predecessor of CORB. According to <a href="https://www.chromestatus.com/feature/5629709824032768" target="_blank" rel="noopener noreferrer">Chrome Platform Status</a>, it was officially enabled by default in Chrome for desktop release 67, which was around May 2018. Around the same time, it was merged into the fetch spec and became part of the specification (<a href="https://github.com/whatwg/fetch/pull/686" target="_blank" rel="noopener noreferrer">CORB: blocking of nosniff and 206 responses</a>).</p><p>As mentioned earlier, Spectre can read data under the same process. So one way to defend against it is to prevent data from other websites from appearing under the same process.</p><p>A website has many ways to bring in cross-origin resources, such as <code>fetch</code> or <code>xhr</code>, but these two methods are already controlled by CORS, and the response obtained should be stored in a network-related process rather than the website&#x27;s own process. Therefore, even with Spectre, it cannot be read.</p><p>However, using <code>&lt;img&gt;</code> or <code>&lt;script&gt;</code> tags can easily load resources from other websites. For example: <code>&lt;img src=&quot;https://bank.com/secret.json&quot;&gt;</code>. Suppose <code>secret.json</code> is confidential data, we can &quot;load&quot; this confidential data.</p><p>You may wonder, &quot;What&#x27;s the point of doing this? It&#x27;s not an image, and I can&#x27;t access it with JavaScript either.&quot; That&#x27;s right, it&#x27;s not an image, but in terms of Chrome&#x27;s operation mechanism, Chrome doesn&#x27;t know it&#x27;s not an image before downloading it (it could have a file extension of .json but actually be an image), so it downloads it first. After downloading, it sends the result to the render process, and only then does it realize that it&#x27;s not an image, triggering a loading error.</p><p>It may seem like there&#x27;s no problem, but don&#x27;t forget that Spectre opened a new window where &quot;any data in the same process can be potentially read.&quot; Therefore, just &quot;sending the result to the render process&quot; is not enough because through Spectre attacks, attackers can still access data stored in memory.</p><p>Therefore, the purpose of the CORB mechanism is:</p><blockquote><p>If the data type you want to read is completely unreasonable, there is no need to read it into the render process, just discard the result!</p></blockquote><p>Continuing with the example above, if the MIME type of that JSON file is <code>application/json</code>, it means that it cannot be an image, so it cannot be placed inside an img tag. This is what I mean by &quot;unreasonable data type to read&quot;.</p><p>CORB mainly protects three types of data: HTML, XML, and JSON. How does the browser know if it is one of these three types? Let&#x27;s determine it from the content type in the response header, right?</p><p>Unfortunately, it&#x27;s not possible. The reason is that many websites have incorrectly set content types. It is possible that a JavaScript file is set as <code>text/html</code>, and then CORB blocks it, causing the website to break.</p><p>Therefore, Chrome will detect (sniffing) the file type based on its content to decide whether to apply CORB or not.</p><p>However, there is also a possibility of misjudgment. So, if the content type provided by your server is always correct, you can send a response header <code>X-Content-Type-Options: nosniff</code>, and Chrome will directly use the content type you provided instead of sniffing it.</p><p><img loading="lazy" alt="CORB error message" src="/beyond-xss/en/assets/images/22-02-83e532426aa5c1b67b4a64bb25d1795e.png" width="896" height="98" class="img_ev3q"></p><p>In summary, CORB is a mechanism that is already built into Chrome. It automatically blocks the loading of unreasonable cross-origin resources, such as using <code>&lt;img&gt;</code> to load JSON or using <code>&lt;script&gt;</code> to load HTML, and so on.</p><p>For more detailed explanations, you can refer to:</p><ol><li><a href="https://www.chromium.org/Home/chromium-security/corb-for-developers" target="_blank" rel="noopener noreferrer">Cross-Origin Read Blocking for Web Developers</a></li><li><a href="https://chromium.googlesource.com/chromium/src/+/master/services/network/cross_origin_read_blocking_explainer.md" target="_blank" rel="noopener noreferrer">Cross-Origin Read Blocking (CORB)</a></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="corp-cross-origin-resource-policy">CORP (Cross-Origin Resource Policy)<a href="#corp-cross-origin-resource-policy" class="hash-link" aria-label="Direct link to CORP (Cross-Origin Resource Policy)" title="Direct link to CORP (Cross-Origin Resource Policy)">​</a></h2><p>CORB is a built-in mechanism in browsers that automatically protects HTML, XML, and JSON from being loaded into cross-origin render processes, thus preventing Spectre attacks. But what about other resources? If there are other types of resources, such as certain photos and videos that are also sensitive data, can I protect them?</p><p>This is where the CORP HTTP response header comes into play. CORP, formerly known as From-Origin, is described in the following quote from <a href="https://github.com/whatwg/fetch/issues/687" target="_blank" rel="noopener noreferrer">Cross-Origin-Resource-Policy (was: From-Origin) #687</a>:</p><blockquote><p>Cross-Origin Read Blocking (CORB) automatically protects against Spectre attacks that load cross-origin, cross-type HTML, XML, and JSON resources, and is based on the browser’s ability to distinguish resource types. We think CORB is a good idea. From-Origin would offer servers an opt-in protection beyond CORB.</p></blockquote><p>If you know which resources need to be protected, you can use the CORP header to specify which sources can load these resources. CORP has three options:</p><ol><li>same-site</li><li>same-origin</li><li>cross-origin</li></ol><p>The third option is similar to not setting it (but there is still a difference, which will be explained later), meaning that all cross-origin sources can load the resource. Let&#x27;s see what happens after setting this!</p><p>First, let&#x27;s run a simple server using express, add the CORP header, and place an image with the URL <code>http://b.example.com/logo.jpg</code>:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> res</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Cross-Origin-Resource-Policy&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;same-origin&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">express</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">static</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;public&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, in <code>http://a.example.com</code>, let&#x27;s include this image:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">img</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://b.example.com/logo.jpg</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When you refresh and open the console, you will see an error message indicating that the image failed to load. Opening the network tab will provide a detailed explanation of the reason:</p><p><img loading="lazy" src="/beyond-xss/en/assets/images/22-03-926b42b4f629cf27973e9877ba120244.png" width="1110" height="574" class="img_ev3q"></p><p>If you change the header to <code>same-site</code> or <code>cross-origin</code>, you will be able to see the image loaded correctly.</p><p>So, this header is actually a &quot;resource-level CORS&quot;. The original CORS is more like a protocol for accessing APIs or &quot;data&quot; between different origins, allowing cross-origin access to data with permission. However, when it comes to loading resources such as using <code>&lt;img&gt;</code> or <code>&lt;script&gt;</code>, if you want to prevent cross-origin loading, you could only rely on server-side logic to determine the <code>Origin</code> or <code>Referer</code> values and dynamically decide whether to return the data.</p><p>With the introduction of the CORP header, it provides a method to block &quot;any cross-origin loading&quot; by simply setting a header. So, it&#x27;s not just about security considerations; security is just one aspect. The key is that you can prevent others from loading your resources.</p><p>As mentioned in the <a href="https://www.w3.org/TR/from-origin" target="_blank" rel="noopener noreferrer">spec</a> of the predecessor of CORP, From-Origin:</p><blockquote><p>The Web platform has no limitations on embedding resources from different origins currently. E.g. an HTML document on <a href="http://example.org" target="_blank" rel="noopener noreferrer">http://example.org</a> can embed an image from <a href="http://corp.invalid" target="_blank" rel="noopener noreferrer">http://corp.invalid</a> without issue. This has led to a number of problems:</p></blockquote><p>For this type of embedded resource, the Web platform currently has no limitations on what can be loaded. Although it is convenient, it can also cause some problems, such as:</p><blockquote><p>Inline linking — the practice of embedding resources (e.g. images or fonts) from another server, causing the owner of that server to get a higher hosting bill.</p><p>Clickjacking — embedding a resource from another origin and attempting to let the visitor click on a concealed link thereof, causing harm to the visitor.</p></blockquote><p>For example, directly linking to images from someone else&#x27;s server on my blog would result in the traffic and hosting bill being attributed to that server. Additionally, there can be clickjacking issues.</p><blockquote><p>Privacy leakage — sometimes resource availability depends on whether a visitor is signed in to a particular website. E.g. only with a I&#x27;m-signed-in-cookie will an image be returned, and if there is no such cookie an HTML document. An HTML document embedding such a resource (requested with the user&#x27;s credentials) can figure out the existence of that resource and thus whether the visitor is signed in and therefore has an account with a particular service.</p></blockquote><p>There are also privacy concerns. For example, a website can determine whether you are logged in on other websites (which will be discussed later).</p><p>How does it know? Because some resources may only be accessible when logged in. Let&#x27;s say a certain image URL only returns the image correctly when logged in, and returns a server error otherwise. I can simply write this:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">img</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onerror</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">alert</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript string" style="color:#e3116c">&#x27;not login&#x27;</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onload</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">alert</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript string" style="color:#e3116c">&#x27;login&#x27;</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>By checking whether the image is loaded successfully, I can determine if you are logged in.</p><blockquote><p>License checking — certain font licenses require that the font be prevented from being embedded on other origins.</p></blockquote><p>Font websites may prevent users without a license from loading fonts, and this header is also suitable for such situations.</p><p>In summary, the earlier introduction of CORB only &quot;prevents unreasonable reading,&quot; such as loading HTML using img, which is purely for security considerations.</p><p>However, CORP can prevent any reading (except for iframes, which are not affected by it) and can protect the resources of your website from being loaded by others. It is a more powerful and widely applicable header.</p><p>Nowadays, mainstream browsers already support this header.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="site-isolation">Site Isolation<a href="#site-isolation" class="hash-link" aria-label="Direct link to Site Isolation" title="Direct link to Site Isolation">​</a></h2><p>To prevent Spectre attacks, there are two approaches:</p><ol><li>Prevent attackers from having the opportunity to execute Spectre attacks.</li><li>Even if the attack is executed, prevent obtaining the desired information.</li></ol><p>The principle of Spectre attacks was mentioned earlier, which involves determining which data is stored in the cache by measuring the time it takes to read the data. By doing so, attackers can &quot;steal&quot; data from memory. If the timing provided by the browser&#x27;s timer function is intentionally imprecise, wouldn&#x27;t that defend against the attack? Because the calculated time by the attacker would be similar, they wouldn&#x27;t know which read is faster.</p><p>After the appearance of Spectre attacks, browsers took two actions:</p><ol><li>Reduced the precision of <code>performance.now</code>.</li><li>Disabled <code>SharedArrayBuffer</code>.</li></ol><p>The first point is easy to understand; by reducing the precision of the timing function, attackers cannot determine the correct reading speed. But why the second point?</p><p>Let&#x27;s talk about <code>SharedArrayBuffer</code>. This allows JavaScript in your document to share the same block of memory with web workers, enabling data sharing. So, in a web worker, you can create a counter that keeps incrementing, and then read this counter in JavaScript, achieving the functionality of a timer.</p><p>Therefore, after Spectre appeared, browsers made these two adjustments, starting from the perspective of &quot;preventing the source of the attack,&quot; which is the first approach.</p><p>The other approach is to prevent malicious websites from accessing information from cross-origin websites, which was mentioned earlier as CORB and now introducing: Site Isolation.</p><p>This term was briefly mentioned in the &quot;Browser Security Model&quot; section. Let&#x27;s start with an introduction from <a href="https://developers.google.com/web/updates/2018/07/site-isolation" target="_blank" rel="noopener noreferrer">Site Isolation for web developers</a>:</p><blockquote><p>Site Isolation is a security feature in Chrome that offers an additional line of defense to make such attacks less likely to succeed. It ensures that pages from different websites are always put into different processes, each running in a sandbox that limits what the process is allowed to do. It also blocks the process from receiving certain types of sensitive data from other sites.</p></blockquote><p>In simple terms, Site Isolation ensures that resources from different websites are placed in different processes. Therefore, even if a Spectre attack is executed on your own website, it doesn&#x27;t matter because it cannot read data from other websites.</p><p>Site Isolation is currently enabled by default in Chrome. The corresponding drawback is that it consumes more memory because more processes are created. For other impacts, you can refer to the aforementioned article.</p><p>In addition to Site Isolation, there is another concept that is easily confused, called &quot;cross-origin isolated state.&quot;</p><p>What is the difference between these two? According to my understanding, the article <a href="https://security.googleblog.com/2018/07/mitigating-spectre-with-site-isolation.html" target="_blank" rel="noopener noreferrer">Mitigating Spectre with Site Isolation in Chrome</a> mentions:</p><blockquote><p>Note that Chrome uses a specific definition of &quot;site&quot; that includes just the scheme and registered domain. Thus, <a href="https://google.co.uk" target="_blank" rel="noopener noreferrer">https://google.co.uk</a> would be a site, and subdomains like <a href="https://maps.google.co.uk" target="_blank" rel="noopener noreferrer">https://maps.google.co.uk</a> would stay in the same process.</p></blockquote><p>The definition of &quot;Site&quot; in Site Isolation is the same as the same-site concept. For example, <code>http://a.example.com</code> and <code>http://b.example.com</code> are considered the same site. Therefore, even under Site Isolation, these two web pages would still be placed in the same process.</p><p>And the cross-origin isolated state should be a stronger isolation, isolating everything that is not the same origin, even if it is the same site. Therefore, <code>http://a.example.com</code> and <code>http://b.example.com</code> will be isolated. Moreover, Site Isolation isolates processes, while cross-origin isolated appears to isolate browsing context groups, preventing cross-origin resources from being in the same browsing context group.</p><p>This cross-origin isolated state is not enabled by default and requires setting up these two headers on the webpage:</p><ol><li>Cross-Origin-Embedder-Policy: require-corp</li><li>Cross-Origin-Opener-Policy: same-origin</li></ol><p>As for why these two headers, I will explain later.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="coep-cross-origin-embedder-policy">COEP (Cross-Origin-Embedder-Policy)<a href="#coep-cross-origin-embedder-policy" class="hash-link" aria-label="Direct link to COEP (Cross-Origin-Embedder-Policy)" title="Direct link to COEP (Cross-Origin-Embedder-Policy)">​</a></h2><p>To achieve the cross-origin isolated state, it is necessary to ensure that all cross-origin accesses on your website are legitimate and authorized.</p><p>The COEP (Cross-Origin-Embedder-Policy) header has two values:</p><ol><li>unsafe-none</li><li>require-corp</li></ol><p>The first one is the default value, which means there are no restrictions. The second one is related to CORP (Cross-Origin-Resource-Policy) mentioned earlier. If you use require-corp, it means telling the browser, &quot;All resources I load on the page must have the CORP header (or CORS) and be legitimate.&quot;</p><p>Now, let&#x27;s assume we have a website <code>a.example.com</code> and we want to make it a cross-origin isolated state. Therefore, we add a header to it: <code>Cross-Origin-Embedder-Policy: require-corp</code>. Then, we import a resource in the webpage:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">img</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://b.example.com/logo.jpg</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, we send the correct header on the <code>b</code> side:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> res</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Cross-Origin-Resource-Policy&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;cross-origin&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This way, the first step is achieved.</p><p>Also, I mentioned earlier that there is a slight difference between not setting CORP and setting it as <code>cross-origin</code>, and it lies here. In the example above, if the <code>b</code> side does not send this header, the Embedder Policy will not pass.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="coop-cross-origin-opener-policy">COOP (Cross-Origin-Opener-Policy)<a href="#coop-cross-origin-opener-policy" class="hash-link" aria-label="Direct link to COOP (Cross-Origin-Opener-Policy)" title="Direct link to COOP (Cross-Origin-Opener-Policy)">​</a></h2><p>The second step is the COOP (Cross-Origin-Opener-Policy) header. When you use <code>window.open</code> to open a webpage, you can manipulate the location of that webpage, and the opened webpage can also manipulate your webpage using <code>window.opener</code>.</p><p>Having such a connection between windows does not comply with cross-origin isolation. Therefore, the COOP header is used to regulate the relationship between windows and openers. It has three values:</p><ol><li>Cross-Origin-Opener-Policy: <code>unsafe-none</code></li><li>Cross-Origin-Opener-Policy: <code>same-origin</code></li><li>Cross-Origin-Opener-Policy: <code>same-origin-allow-popups</code></li></ol><p>The first one is the default value, and it doesn&#x27;t have any effect, so I won&#x27;t explain it. The other two are a bit more complicated. Let&#x27;s summarize them with a simple example.</p><p>Suppose there is a webpage A that opens a webpage B using <code>window.open</code>:</p><ol><li>If AB is cross-origin, the browser already has restrictions and can only access methods like <code>window.location</code> or <code>window.close</code>. It cannot access the DOM or anything else.</li><li>If AB is same-origin, they can access each other&#x27;s windows almost entirely, including the DOM.</li><li>If A adds the COOP header with a value of <code>same-origin</code>, it means imposing additional restrictions on the second case. Both A and B must have this header with a value of <code>same-origin</code> to access each other&#x27;s windows.</li><li>If A adds the COOP header with a value of <code>same-origin-allow-popups</code>, it also restricts the second case but is more lenient. As long as B&#x27;s COOP header is not <code>same-origin</code>, they can access each other&#x27;s windows.</li></ol><p>In summary, to have the &quot;opportunity to access each other&#x27;s windows,&quot; they must first be the same origin, and this is unchangeable. Whether they can access each other depends on whether the COOP header is set and the value of the header.</p><p>If the COOP header is set but does not comply with the rules, <code>window.opener</code> will become <code>null</code> directly, and even the location cannot be obtained (if no rules are set, it can be obtained even if it is cross-origin).</p><p>In fact, according to the <a href="https://html.spec.whatwg.org/multipage/origin.html#cross-origin-opener-policies" target="_blank" rel="noopener noreferrer">spec</a>, there is also a fourth type: same-origin-plus-COEP, but it seems more complicated, so let&#x27;s not study it for now.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="returning-to-the-cross-origin-isolated-state">Returning to the cross-origin isolated state<a href="#returning-to-the-cross-origin-isolated-state" class="hash-link" aria-label="Direct link to Returning to the cross-origin isolated state" title="Direct link to Returning to the cross-origin isolated state">​</a></h2><p>As mentioned earlier, the cross-origin isolated state requires setting these two headers:</p><ol><li>Cross-Origin-Embedder-Policy: require-corp</li><li>Cross-Origin-Opener-Policy: same-origin</li></ol><p>Why? Because once set, it means that you have permission to access all cross-origin resources on the page. If you don&#x27;t have permission, an error will occur. So if it is set and passes, it means that you are allowed to access all cross-origin resources, and there will be no security issues.</p><p>On the website, you can use:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">crossOriginIsolated</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>to determine if you have entered the cross-origin isolated state. If so, you can use some restricted features because the browser knows you are secure.</p><p>In addition, if you enter this state, the trick of bypassing the same-origin policy by modifying <code>document.domain</code> mentioned earlier will no longer work. The browser will not allow you to modify this anymore.</p><p>To learn more about COOP, COEP, and the cross-origin isolated state, you can refer to:</p><ol><li><a href="https://web.dev/coop-coep/" target="_blank" rel="noopener noreferrer">Making your website &quot;cross-origin isolated&quot; using COOP and COEP</a></li><li><a href="https://web.dev/why-coop-coep/" target="_blank" rel="noopener noreferrer">Why you need &quot;cross-origin isolated&quot; for powerful features</a></li><li><a href="https://scotthelme.co.uk/coop-and-coep/" target="_blank" rel="noopener noreferrer">COEP COOP CORP CORS CORB - CRAP that&#x27;s a lot of new stuff!</a></li><li><a href="https://github.com/whatwg/html/issues/4175" target="_blank" rel="noopener noreferrer">Making postMessage() work for SharedArrayBuffer (Cross-Origin-Embedder-Policy) #4175</a></li><li><a href="https://github.com/whatwg/html/issues/3740" target="_blank" rel="noopener noreferrer">Restricting cross-origin WindowProxy access (Cross-Origin-Opener-Policy) #3740</a></li><li><a href="https://www.chromestatus.com/feature/4647328103268352" target="_blank" rel="noopener noreferrer">Feature: Cross-Origin Resource Policy</a></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>This article actually covers a lot of things, all revolving around security. We first discussed the consequences of incorrect CORS settings and defense methods, and provided several practical examples.</p><p>Then, we talked about various headers starting with CO:</p><ol><li>CORB (Cross-Origin Read Blocking)</li><li>CORP (Cross-Origin Resource Policy)</li><li>COEP (Cross-Origin-Embedder-Policy)</li><li>COOP (Cross-Origin-Opener-Policy)</li></ol><p>If we were to summarize these four things in a sentence each, it might be:</p><ol><li>CORB: The default mechanism of the browser, mainly to prevent loading unreasonable resources, such as loading HTML with <code>&lt;img&gt;</code></li><li>CORP: An HTTP response header that determines who can load this resource, preventing cross-origin loading of images, videos, or any resources</li><li>COEP: An HTTP response header that ensures all resources on the page are loaded legitimately</li><li>COOP: An HTTP response header that adds stricter window sharing settings to same-origin</li></ol><p>The reason for the extensive length of this article is that, on one hand, there are many details to explain, and on the other hand, it shows the importance of the origin concept to the browser, so important that it requires so many measures to protect and ensure the same-origin policy.</p><p>After reading through all these same-origin and cross-origin things, let&#x27;s switch gears in the next article and take a look at the classic CSRF.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/en/ch4/cors-intro/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Introduction to Cross-Origin Resource Sharing (CORS)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/en/ch4/csrf/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Cross-Site Request Forgery (CSRF) Made Easy</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#cors-misconfiguration" class="table-of-contents__link toc-highlight">CORS Misconfiguration</a><ul><li><a href="#real-world-example" class="table-of-contents__link toc-highlight">Real-World Example</a></li></ul></li><li><a href="#other-coxx-series-headers" class="table-of-contents__link toc-highlight">Other COXX Series Headers</a></li><li><a href="#serious-security-vulnerabilities-meltdown-and-spectre" class="table-of-contents__link toc-highlight">Serious Security Vulnerabilities: Meltdown and Spectre</a></li><li><a href="#super-simplified-explanation-of-spectre-attack" class="table-of-contents__link toc-highlight">Super Simplified Explanation of Spectre Attack</a></li><li><a href="#corb-cross-origin-read-blocking" class="table-of-contents__link toc-highlight">CORB (Cross-Origin Read Blocking)</a></li><li><a href="#corp-cross-origin-resource-policy" class="table-of-contents__link toc-highlight">CORP (Cross-Origin Resource Policy)</a></li><li><a href="#site-isolation" class="table-of-contents__link toc-highlight">Site Isolation</a></li><li><a href="#coep-cross-origin-embedder-policy" class="table-of-contents__link toc-highlight">COEP (Cross-Origin-Embedder-Policy)</a></li><li><a href="#coop-cross-origin-opener-policy" class="table-of-contents__link toc-highlight">COOP (Cross-Origin-Opener-Policy)</a></li><li><a href="#returning-to-the-cross-origin-isolated-state" class="table-of-contents__link toc-highlight">Returning to the cross-origin isolated state</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/en/assets/js/runtime~main.9a9bfab3.js"></script>
<script src="/beyond-xss/en/assets/js/main.3d2d1fa0.js"></script>
</body>
</html>