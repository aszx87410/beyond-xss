<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch4/cors-intro" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Introduction to Cross-Origin Resource Sharing (CORS) | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/en/ch4/cors-intro/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Introduction to Cross-Origin Resource Sharing (CORS) | Beyond XSS"><meta data-rh="true" name="description" content="When discussing the same-origin policy, I mentioned that browsers generally prevent a website from accessing data from a different origin. However, during development, the frontend and backend may not be on the same origin. For example, one may be on huli.tw and the other on api.huli.tw. In such cases, how can the frontend access data from the backend?"><meta data-rh="true" property="og:description" content="When discussing the same-origin policy, I mentioned that browsers generally prevent a website from accessing data from a different origin. However, during development, the frontend and backend may not be on the same origin. For example, one may be on huli.tw and the other on api.huli.tw. In such cases, how can the frontend access data from the backend?"><link data-rh="true" rel="icon" href="/beyond-xss/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/en/ch4/cors-intro/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch4/cors-intro/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/cors-intro/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/cors-intro/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/en/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/en/assets/js/runtime~main.c3ff4a96.js" as="script">
<link rel="preload" href="/beyond-xss/en/assets/js/main.a303d294.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/en/"><div class="navbar__logo"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS: Explore the Web Front-end Security Universe</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch4/cors-intro/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/beyond-xss/ch4/cors-intro/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-TW">中文（台灣）</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/">About This Series</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch1/browser-security-model/">Chapter 1: Starting with XSS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch2/xss-defense-sanitization/">Chapter 2: Defense and bypass for XSS </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch3/attack-without-js/">Chapter 3: Attacks without JavaScript  </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/beyond-xss/en/ch4/sop-and-site/">Chapter 4: Cross-site attacks </a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/sop-and-site/">The Essence: Same-origin Policy and Site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/en/ch4/cors-intro/">Introduction to Cross-Origin Resource Sharing (CORS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cors-attack/">Cross-Origin Security Issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/csrf/">Cross-Site Request Forgery (CSRF) Made Easy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/same-site-cookie/">Same-site cookie, the savior of CSRF?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/subdomain/">From same-site to main site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cookie-bomb/">Interesting and Practical Cookie Bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch5/clickjacking/">Chapter 5: Other interesting topics  </a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/summary/">Conclusion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/contact/">Contact the Author</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/beyond-xss/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Chapter 4: Cross-site attacks </span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Introduction to Cross-Origin Resource Sharing (CORS)</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Introduction to Cross-Origin Resource Sharing (CORS)</h1><p>When discussing the same-origin policy, I mentioned that browsers generally prevent a website from accessing data from a different origin. However, during development, the frontend and backend may not be on the same origin. For example, one may be on <code>huli.tw</code> and the other on <code>api.huli.tw</code>. In such cases, how can the frontend access data from the backend?</p><p>This is where CORS comes into play. CORS stands for Cross-Origin Resource Sharing and is a mechanism that allows websites to exchange data across different origins. This mechanism is commonly used in development, but if not configured correctly, it can become a security vulnerability.</p><p>To understand why CORS exists, we need to start with why browsers block cross-origin API calls.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-cant-we-make-cross-origin-api-calls">Why can&#x27;t we make cross-origin API calls?<a href="#why-cant-we-make-cross-origin-api-calls" class="hash-link" aria-label="Direct link to Why can&#x27;t we make cross-origin API calls?" title="Direct link to Why can&#x27;t we make cross-origin API calls?">​</a></h2><p>To be more precise, the question should be: &quot;Why can&#x27;t we use <code>XMLHttpRequest</code> or <code>fetch</code> (also known as AJAX) to retrieve resources from a different origin?&quot;</p><p>This more accurate definition is necessary because retrieving a &quot;cross-origin resource&quot; is actually quite common. For example, <code>&lt;img src=&quot;https://another-domain.com/bg.png&quot; /&gt;</code> is a cross-origin request to fetch an image. Similarly, <code>&lt;script src=&quot;https://another-domain.com/script.js&quot; /&gt;</code> is a cross-origin request to fetch and execute a JavaScript file.</p><p>But have you encountered any issues with these two scenarios? Most likely not, as we are already accustomed to using them without problems.</p><p>So why is it different when it comes to AJAX using <code>XMLHttpRequest</code> or <code>fetch</code>? Why are cross-origin requests blocked in this case? (This explanation is not entirely accurate and will be further explained later.)</p><p>To understand this issue, we need to think in reverse. Since we already know that cross-origin requests are blocked, there must be a reason for it. But what is the reason? It&#x27;s similar to using the method of proof by contradiction. To prove something, let&#x27;s assume that blocking cross-origin requests is wrong or meaningless. Then, if we find a contradiction, we will know why cross-origin requests are blocked.</p><p>Therefore, let&#x27;s consider the following question:</p><blockquote><p>What would happen if cross-origin requests were not blocked?</p></blockquote><p>In that case, we could freely make API calls without having to search for CORS solutions! It sounds like there wouldn&#x27;t be any issues. After all, <code>&lt;img&gt;</code> and <code>&lt;script&gt;</code> tags can access cross-origin resources, so why can&#x27;t AJAX?</p><p>If cross-origin AJAX requests were not blocked, I could use AJAX in my webpage (let&#x27;s say <code>https://huli.tw/index.html</code>) to fetch data from <code>https://google.com</code>, right?</p><p>At first glance, it seems harmless, just fetching the HTML of the Google homepage. No big deal.</p><p>But what if I happen to know that your company has an &quot;internal&quot; public website with the URL <code>http://internal.good-company.com</code>? This website is not accessible from outside; only company employees&#x27; computers can access it. Now, what if I write a piece of AJAX code in my webpage to fetch data from that internal website? Would I be able to retrieve the website&#x27;s content and send it back to my server?</p><p>This raises security concerns because an attacker could gain access to confidential information.</p><p><img loading="lazy" src="/beyond-xss/en/assets/images/21-01-e7971ace06e603d6daf99b014b9c890f.png" width="1249" height="781" class="img_ev3q"></p><ol><li>The target opens a malicious website.</li><li>The malicious website uses AJAX to fetch data from the internal confidential website.</li><li>The data is obtained.</li><li>It is sent back to the attacker&#x27;s server.</li></ol><p>You might ask, &quot;But to use this technique, the attacker would need to know the URL of the internal website. Isn&#x27;t that difficult?&quot;</p><p>If you think that&#x27;s too difficult, let me give you another example.</p><p>During development, many people run a server on their own computer with URLs like <code>http://localhost:3000</code> or <code>http://localhost:5566</code>. This is very common in modern frontend development.</p><p>If the browser didn&#x27;t block cross-origin APIs, I could write code like this:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// send request and get response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sendRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">url</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">XMLHttpRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onload</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">response</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// try every port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> port </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> port</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">sendRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;http://localhost:&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> port</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token parameter">data</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// send data back to my server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this case, as long as you have a server running on localhost, I could access its content and learn about what you are developing. In a work setting, this could potentially expose company secrets, or attackers could analyze these websites to find vulnerabilities and exploit them using similar methods.</p><p>Furthermore, if you think the above two examples are not feasible, let&#x27;s make another assumption here. In addition to assuming that cross-origin requests are not blocked, let&#x27;s also assume that &quot;cross-origin requests automatically include cookies.&quot;</p><p>So, if I send a request to <code>https://www.facebook.com/messages/t</code>, I could see your chat messages. If I send a request to <code>https://mail.google.com/mail/u/0/</code>, I could see your private emails.</p><p>When it comes to this point, we can understand why cross-origin AJAX requests are blocked, in one word: &quot;security&quot;.</p><p>In the browser, if you want to retrieve the complete content of a website (able to fully read it), you can basically only do it through <code>XMLHttpRequest</code> or <code>fetch</code>. If these cross-origin AJAX requests are not restricted, it would be possible to use the user&#x27;s browser to retrieve the content of &quot;any website&quot;, including various websites that may contain sensitive information.</p><p>Therefore, it is reasonable for browsers to block cross-origin AJAX requests for the sake of security.</p><p>At this point, some people may have a question: &quot;Why are images, CSS, or scripts not blocked?&quot;</p><p>This is because these are more like &quot;part of the web resources&quot;. For example, if I want to use someone else&#x27;s image, I use <code>&lt;img&gt;</code> to import it, and if I want to use CSS, I use <code>&lt;link href=&quot;...&quot;&gt;</code>. The resources that can be obtained through these tags are limited. Furthermore, once I load an image, it is just an image. Only the browser knows the content of the image, I don&#x27;t know it, and I cannot read it with a program. This is important.</p><p>After I load an image, it is really just an image. I cannot read its content with a program, so I cannot send the obtained result to another place. Therefore, there is less risk of data leakage.</p><p>To correctly understand cross-origin requests, the first step is to understand &quot;why browsers block them&quot;, and the second step is to have a correct understanding of &quot;how they are blocked&quot;. Below, I have prepared a quiz for you to try to answer.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="in-class-quiz">In-class Quiz<a href="#in-class-quiz" class="hash-link" aria-label="Direct link to In-class Quiz" title="Direct link to In-class Quiz">​</a></h2><p>John is working on a project that needs to integrate an API. In the company, there is an API for deleting posts. You can delete a post by sending a POST request to <code>https://lidemy.com/deletePost</code> with the post ID as <code>application/x-www-form-urlencoded</code> content type.</p><p>For example, sending a POST request to <code>https://lidemy.com/deletePost</code> with <code>id=13</code> will delete the post with ID 13 (the backend does not perform any permission checks).</p><p>The frontend and backend domains are different, and the backend does not add the CORS header. Therefore, John believes that the frontend cannot make the AJAX call to delete the post because it will be restricted by the same-origin policy, and the request cannot be sent.</p><p>After making the call, the console indeed shows the error message: &quot;request has been blocked by CORS policy: No &#x27;Access-Control-Allow-Origin&#x27; header is present on the requested resource&quot;.</p><p>So John believes that the frontend cannot use AJAX to call this API and delete the post. He thinks the post cannot be deleted.</p><p>Is John&#x27;s statement correct? If not, please point out the error.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-are-cross-origin-ajax-requests-blocked">How are cross-origin AJAX requests blocked?<a href="#how-are-cross-origin-ajax-requests-blocked" class="hash-link" aria-label="Direct link to How are cross-origin AJAX requests blocked?" title="Direct link to How are cross-origin AJAX requests blocked?">​</a></h2><p>This question is testing the concept:</p><blockquote><p>When a cross-origin request is blocked by the browser, what does it actually mean? How is it blocked?</p></blockquote><p>This question is included because many people think that &quot;the blocked part is the request&quot; and therefore, in John&#x27;s example, the request is blocked by the browser and cannot reach the server, so the data cannot be deleted.</p><p>But if you think about it, you will realize that this statement is problematic. Just look at the error message:</p><blockquote><p>request has been blocked by CORS policy: No &#x27;Access-Control-Allow-Origin&#x27; header is present on the requested resource</p></blockquote><p>When the browser says that the header does not exist, what does it mean? It means that it has already sent out the request for you, and it has received the response, only to find that the <code>Access-Control-Allow-Origin</code> header is not present.</p><p>So what the browser blocks is not the request, but the response. This is a crucial point.</p><p>Your request has already reached the server, and the server has returned a response. It&#x27;s just that the browser doesn&#x27;t give you the result.</p><p>Therefore, the answer to this question is that although John sees the CORS error, because the request has actually been sent to the server, the post has been deleted. It&#x27;s just that John cannot receive the response. Yes, believe me, the post has been deleted, really.</p><p>This is completely in line with the specifications, but many people are confused about it. Some even mistakenly think that this is a security issue and report it to Chromium:</p><ol><li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1122756&amp;q=sop%20bypass&amp;can=1" target="_blank" rel="noopener noreferrer">Issue 1122756: Possible to send XHR POST request from different origins - SOP bypass</a></li><li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1151540" target="_blank" rel="noopener noreferrer">Issue 1151540: Same-Origin-Policy is bypassed by an XMLHttpRequest Executed within an eval()</a></li></ol><p>But the results are always the same, marked as &quot;won&#x27;t fix&quot; because it is a compliant implementation.</p><p>Let me clarify a concept that many people are confused about.</p><p>Earlier, I mentioned that blocking CORS is for security purposes. If it is not blocked, attackers can use AJAX to retrieve internal non-public data, resulting in the leakage of company secrets. And here I also mentioned that &quot;there is no CORS issue outside the browser,&quot; which means that even if CORS is blocked, can I still send requests to the same website and retrieve data? Isn&#x27;t that a security issue?</p><p>For example, if I use curl or Postman or any other tool, shouldn&#x27;t I be able to bypass CORS restrictions?</p><p>People who think this way overlook one key difference between these two approaches.</p><p>Let&#x27;s assume our target is an internal network of a company, with the URL: <a href="http://internal.good-company.com" target="_blank" rel="noopener noreferrer">http://internal.good-company.com</a></p><p>If I directly send a request using curl from my computer, I will only see an error page because, firstly, I am not on the internal network of that company, so I don&#x27;t have the authorization, and secondly, I may not even be able to reach that domain because only the internal network can resolve it.</p><p>On the other hand, CORS is like this: &quot;I have created a website for internal network users to access and send requests to retrieve data.&quot; The biggest difference between these two approaches is &quot;who is visiting the website.&quot; In the former case, it&#x27;s me, but in the latter case, it&#x27;s someone else (and someone who can access the internal network).</p><p><img loading="lazy" src="/beyond-xss/en/assets/images/21-02-07cc56f39c2de63df2381da58190458a.png" width="1020" height="620" class="img_ev3q"></p><p>As shown in the figure, the top part is the attacker trying to access that URL, but it will fail because the target is within the internal network. So, even without the same-origin policy, the attacker still cannot obtain the desired information.</p><p>The bottom part, however, is when the attacker creates a malicious website and finds a way to make users visit that website. For example, at point 1, when the user visits the website, the flow goes to point 2, where an AJAX request is made to the target (internal server). After retrieving the data at point 3, it returns to the attacker at point 4.</p><p>With the protection of the same-origin policy, point 4 will not be executed because JavaScript cannot access the fetch result, so it won&#x27;t know what the response is.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-set-up-cors">How to set up CORS?<a href="#how-to-set-up-cors" class="hash-link" aria-label="Direct link to How to set up CORS?" title="Direct link to How to set up CORS?">​</a></h2><p>Now that we have discussed the principles and understood why browsers block cross-origin requests, let&#x27;s talk about how to set up CORS. The setup is straightforward. Since browsers protect for security purposes, you just need to tell the browser: &quot;I allow xxx to access the response of this request.&quot; Here&#x27;s how you do it:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Allow-Origin: *</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This response header means &quot;allow any origin to access this response.&quot; If you want to restrict it to a single origin, you can write it like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Allow-Origin: https://blog.huli.tw</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But what if you want to allow multiple origins? Currently, it is not possible. The value of this header does not support multiple origins. You can only handle it on the server side by dynamically outputting different headers based on the request.</p><p>Furthermore, cross-origin requests are divided into two types: &quot;simple requests&quot; and &quot;non-simple requests.&quot; Regardless of which type, the backend needs to include the <code>Access-Control-Allow-Origin</code> header. The main difference is that non-simple requests send a preflight request before sending the actual request. If the preflight request fails, the actual request will not be sent.</p><p>For the preflight request, we also need to include the <code>Access-Control-Allow-Origin</code> header to pass it.</p><p>In addition, some products may want to send custom headers, such as <code>X-App-Version</code>, to indicate the current version of the website. In this case, the backend needs to add the <code>Access-Control-Allow-Headers</code> header to pass the preflight:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;http://localhost:3000/form&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">headers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-property property" style="color:#36acaa">&#x27;X-App-Version&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-property property" style="color:#36acaa">&#x27;Content-Type&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">body</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">res</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">res</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In summary, the preflight is a validation mechanism to ensure that the backend knows the expected request from the frontend, and only then will the browser allow it. What I mentioned earlier, &quot;CORS blocks the response, not the request,&quot; only applies to simple requests. For non-simple requests with a preflight, the actual request you want to send will indeed be blocked.</p><p>So why do we need a preflight request? We can consider it from two perspectives:</p><ol><li>Compatibility</li><li>Security</li></ol><p>Regarding the first point, you may have noticed that if a request is a non-simple request, you cannot replicate it using the HTML <code>&lt;form&gt;</code> element, and vice versa. For example, the <code>&lt;form&gt;</code> element&#x27;s enctype does not support <code>application/json</code>, so this content type is a non-simple request. On the other hand, enctype supports <code>multipart/form</code>, so this content type belongs to a simple request.</p><p>For those ancient websites, even before XMLHttpRequest existed, their backends did not expect browsers to send requests with the <code>DELETE</code> or <code>PATCH</code> method, nor did they expect requests with the <code>application/json</code> content-type. This is because in that era, <code>&lt;form&gt;</code> and <code>&lt;img&gt;</code> were the only elements capable of sending requests.</p><p>At that time, there was no <code>fetch</code>, not even <code>XMLHttpRequest</code>. So, in order to prevent these backends from receiving unexpected requests, a preflight request is sent first. Since the ancient backends do not handle this preflight, it will not pass, and the browser will not send the actual request.</p><p>This is what I mean by compatibility. By passing the preflight request, early websites are protected from receiving unexpected requests.</p><p>As for the second point, security, let&#x27;s take an example. Typically, the <code>DELETE</code> HTTP method is used for delete APIs. If there is no preflight request to block it, the browser will actually send this request, which may cause unexpected behavior on the backend (as the browser was not expected to send it).</p><p>That&#x27;s why a preflight request is needed, to ensure that the backend knows that the upcoming request is legitimate before sending the actual request.</p><p>Lastly, let&#x27;s talk about cookies. Cross-origin requests do not include cookies by default. If cookies need to be included, three conditions must be met:</p><ol><li>The backend&#x27;s response header must have <code>Access-Control-Allow-Credentials: true</code>.</li><li>The <code>Access-Control-Allow-Origin</code> in the backend&#x27;s response header cannot be <code>*</code>; it must be explicitly specified.</li><li>The frontend&#x27;s fetch must include <code>credentials: &#x27;include&#x27;</code>.</li></ol><p>For &quot;simple requests,&quot; only the third condition needs to be met. For &quot;non-simple requests,&quot; all three conditions must be met.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>In this article, we have learned the basic principles of CORS and &quot;why browsers block cross-origin requests.&quot; Ultimately, it is all about security, which is why this restriction exists. In addition, we have learned how to set CORS headers. One section mentions that <code>Access-Control-Allow-Origin</code> does not support multiple values, so if many origins require this header, it must be dynamically set. What if it is not set correctly? That would be a security vulnerability, which we will discuss in our next article.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/en/ch4/sop-and-site/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">The Essence: Same-origin Policy and Site</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/en/ch4/cors-attack/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Cross-Origin Security Issues</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-cant-we-make-cross-origin-api-calls" class="table-of-contents__link toc-highlight">Why can&#39;t we make cross-origin API calls?</a></li><li><a href="#in-class-quiz" class="table-of-contents__link toc-highlight">In-class Quiz</a></li><li><a href="#how-are-cross-origin-ajax-requests-blocked" class="table-of-contents__link toc-highlight">How are cross-origin AJAX requests blocked?</a></li><li><a href="#how-to-set-up-cors" class="table-of-contents__link toc-highlight">How to set up CORS?</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/en/assets/js/runtime~main.c3ff4a96.js"></script>
<script src="/beyond-xss/en/assets/js/main.a303d294.js"></script>
</body>
</html>