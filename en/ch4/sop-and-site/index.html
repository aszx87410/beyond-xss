<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch4/sop-and-site" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">The Essence: Same-origin Policy and Site | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/en/ch4/sop-and-site/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="google-site-verification" content="O7SjDEO9AQXbxqBWhtUW0FVahHxSrnweMXJxLICpSz4"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="The Essence: Same-origin Policy and Site | Beyond XSS"><meta data-rh="true" name="description" content="In previous articles, we have mentioned &quot;same-origin&quot; several times. It is an extremely important term in both the frontend and cybersecurity worlds. The same-origin policy of browsers is crucial in development and also when dealing with attacks."><meta data-rh="true" property="og:description" content="In previous articles, we have mentioned &quot;same-origin&quot; several times. It is an extremely important term in both the frontend and cybersecurity worlds. The same-origin policy of browsers is crucial in development and also when dealing with attacks."><link data-rh="true" rel="icon" href="/beyond-xss/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/en/ch4/sop-and-site/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch4/sop-and-site/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/sop-and-site/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/sop-and-site/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/en/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/en/assets/js/runtime~main.9a9bfab3.js" as="script">
<link rel="preload" href="/beyond-xss/en/assets/js/main.3d2d1fa0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/en/"><div class="navbar__logo"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS: Explore the Web Front-end Security Universe</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch4/sop-and-site/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/beyond-xss/ch4/sop-and-site/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-TW">中文（台灣）</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/">About This Series</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch1/browser-security-model/">Chapter 1: Starting with XSS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch2/xss-defense-sanitization/">Chapter 2: Defense and bypass for XSS </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch3/attack-without-js/">Chapter 3: Attacks without JavaScript  </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/beyond-xss/en/ch4/sop-and-site/">Chapter 4: Cross-site attacks </a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/en/ch4/sop-and-site/">The Essence: Same-origin Policy and Site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cors-intro/">Introduction to Cross-Origin Resource Sharing (CORS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cors-attack/">Cross-Origin Security Issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/csrf/">Cross-Site Request Forgery (CSRF) Made Easy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/same-site-cookie/">Same-site cookie, the savior of CSRF?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/subdomain/">From same-site to main site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cookie-bomb/">Interesting and Practical Cookie Bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch5/clickjacking/">Chapter 5: Other interesting topics  </a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/summary/">Conclusion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/contact/">Contact the Author</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/beyond-xss/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Chapter 4: Cross-site attacks </span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">The Essence: Same-origin Policy and Site</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>The Essence: Same-origin Policy and Site</h1><p>In previous articles, we have mentioned &quot;same-origin&quot; several times. It is an extremely important term in both the frontend and cybersecurity worlds. The same-origin policy of browsers is crucial in development and also when dealing with attacks.</p><p>Additionally, there are a few terms that are often confused, such as host and site. For example, XS in XSS stands for cross-site, and CS in CSRF also means cross-site. So, what is the difference between origin and site? How are they different from host?</p><p>This article will help you fully understand these concepts so that you won&#x27;t get confused anymore.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-exactly-are-origin-and-site-how-to-differentiate-them">What exactly are Origin and Site? How to differentiate them?<a href="#what-exactly-are-origin-and-site-how-to-differentiate-them" class="hash-link" aria-label="Direct link to What exactly are Origin and Site? How to differentiate them?" title="Direct link to What exactly are Origin and Site? How to differentiate them?">​</a></h2><p>Let&#x27;s start with a simple and somewhat incorrect explanation, and then we will correct it step by step.</p><p>Origin is composed of the scheme, port, and host. When combined, they form the origin.</p><p>For example, if we have a URL like <code>https://huli.tw/abc</code>, the components are:</p><ul><li>Scheme: https</li><li>Port: 443 (the default port for https)</li><li>Host: huli.tw</li></ul><p>Therefore, its origin is <code>https://huli.tw</code>. As you can see, the path part <code>/abc</code> does not affect the origin, and for the port part, https already implies the default port 443.</p><p>The same origin means that the origins of two URLs must be the same. For example:</p><ol><li><code>https://huli.tw/abc</code> and <code>https://huli.tw/hello/yo</code> are the same origin because the scheme, port, and host are the same, and the path does not affect the result.</li><li><code>https://huli.tw</code> and <code>http://huli.tw</code> are not the same origin because the schemes are different.</li><li><code>http://huli.tw</code> and <code>http://huli.tw:8080</code> are not the same origin because the ports are different.</li><li><code>https://huli.tw</code> and <code>https://blog.huli.tw</code> are not the same origin because the hosts are different.</li></ol><p>From the above examples, we can see that the conditions for the same origin are quite strict. Basically, except for the path, all other parts must be the same to be considered the same origin.</p><p>Now let&#x27;s take a look at site. Site considers fewer elements compared to origin; it only looks at the scheme and host, ignoring the port. The definition of two URLs being the same site is more relaxed, as the host does not have to be exactly the same; as long as it is a subdomain, it is still considered the same site.</p><p>For example:</p><ol><li><code>https://huli.tw/abc</code> and <code>https://huli.tw/hello/yo</code> are the same site because the scheme and host are the same.</li><li><code>https://huli.tw</code> and <code>http://huli.tw</code> are not the same site because the schemes are different.</li><li><code>http://huli.tw</code> and <code>http://huli.tw:8080</code> are the same site because the port does not affect the result.</li><li><code>https://huli.tw</code> and <code>https://blog.huli.tw</code> are the same site because both huli.tw and blog.huli.tw are under the same parent domain, huli.tw.</li><li><code>https://abc.huli.tw</code> and <code>https://blog.huli.tw</code> are also the same site because both abc.huli.tw and blog.huli.tw are under the same parent domain, huli.tw.</li></ol><p>Compared to the same origin, it is evident that the same site is more relaxed. Different ports are considered the same site, and as long as the host belongs to the same parent domain, it is generally considered the same site.</p><p>However, as I mentioned at the beginning, although the above definitions are correct in most cases, they are not precise. Let&#x27;s directly refer to the specification to see the exceptions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="examining-same-origin-in-detail">Examining Same-origin in Detail<a href="#examining-same-origin-in-detail" class="hash-link" aria-label="Direct link to Examining Same-origin in Detail" title="Direct link to Examining Same-origin in Detail">​</a></h2><p>In the HTML specification&#x27;s <a href="https://html.spec.whatwg.org/multipage/origin.html#origin" target="_blank" rel="noopener noreferrer">7.5 Origin</a> section, you can find the complete definition. Let&#x27;s take a look at the specification&#x27;s explanation of origin:</p><blockquote><p>Origins are the fundamental currency of the web&#x27;s security model. Two actors in the web platform that share an origin are assumed to trust each other and to have the same authority. Actors with differing origins are considered potentially hostile versus each other, and are isolated from each other to varying degrees.</p></blockquote><p>The content here is very clear. It starts by explaining that if two websites have the same origin, it means that these two websites trust each other. However, if they have different origins, they will be isolated and restricted.</p><p>Next, the specification divides origins into two types: &quot;An opaque origin&quot; and &quot;A tuple origin&quot;.</p><p>Opaque origin can be considered as an origin that only appears in special cases. For example, when I open a webpage on my local machine, the URL will be &quot;file:///...&quot;. In this case, when sending a request within the webpage, the origin will be an opaque origin, which is &quot;null&quot;.</p><p>Tuple origin is more common and is the type of origin we are more concerned about. The document states that a tuple origin includes:</p><ol><li>scheme (an ASCII string).</li><li>host (a host).</li><li>port (null or a 16-bit unsigned integer).</li><li>domain (null or a domain). Null unless stated otherwise.</li></ol><p>You might wonder why there is both a host and a domain. We will discuss this later.</p><p>Furthermore, the specification also describes the algorithm to determine whether two origins, A and B, are the same origin:</p><ol><li>If A and B are the same opaque origin, then return true.</li><li>If A and B are both tuple origins and their schemes, hosts, and port are identical, then return true.</li><li>Return false.</li></ol><p>Either the two origins are the same opaque origin, or their schemes, hosts, and ports are all identical to be considered the same origin. In addition to the same origin, you will also come across another term called &quot;same origin-domain&quot; in the specification, which will be explained later.</p><p>As I mentioned earlier, same origin is a strict restriction. For example, for the URL &quot;<a href="https://huli.tw/api%22" target="_blank" rel="noopener noreferrer">https://huli.tw/api&quot;</a>, since the origin does not consider the path, its origin will be &quot;<a href="https://huli.tw%22" target="_blank" rel="noopener noreferrer">https://huli.tw&quot;</a>. This means that any website with the same origin must have a URL starting with &quot;<a href="https://huli.tw/*%22" target="_blank" rel="noopener noreferrer">https://huli.tw/*&quot;</a> to be considered the same origin.</p><p>Although &quot;<a href="https://huli.tw%22" target="_blank" rel="noopener noreferrer">https://huli.tw&quot;</a> and &quot;<a href="https://blog.huli.tw%22" target="_blank" rel="noopener noreferrer">https://blog.huli.tw&quot;</a> are related to domain and subdomain, they are not the same origin because the hosts are different.</p><p>Remember this, as it is important.</p><p>The detailed exploration of origin and same origin in the specification, compared to the &quot;inaccurate statement&quot; mentioned at the beginning, adds an opaque origin, same origin-domain, and an unused &quot;domain&quot; in the origin tuple.</p><p>Finally, let me mention one more thing. When I say that the origin of &quot;<a href="https://huli.tw/api%22" target="_blank" rel="noopener noreferrer">https://huli.tw/api&quot;</a> is &quot;<a href="https://huli.tw%22" target="_blank" rel="noopener noreferrer">https://huli.tw&quot;</a>, a more accurate statement would be: &quot;The serialized form of the origin of &#x27;<a href="https://huli.tw/api&#x27;" target="_blank" rel="noopener noreferrer">https://huli.tw/api&#x27;</a> is &#x27;<a href="https://huli.tw&#x27;%22" target="_blank" rel="noopener noreferrer">https://huli.tw&#x27;&quot;</a>.</p><p>This is because it was mentioned earlier that the origin is actually a tuple, represented as <code>(https, huli.tw, null, null)</code>, and it becomes <code>https://huli.tw</code> when serialized into a string. I find the serialized form of the tuple easier to read compared to its representation as a tuple. Therefore, when both can convey similar information, I prefer the latter approach.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploring-same-site-in-detail">Exploring same site in detail<a href="#exploring-same-site-in-detail" class="hash-link" aria-label="Direct link to Exploring same site in detail" title="Direct link to Exploring same site in detail">​</a></h2><p>The definition of site is also in the same specification, stating:</p><blockquote><p>A site is an opaque origin or a scheme-and-host.</p></blockquote><p>So, a site can be an opaque origin or a scheme-and-host.</p><p>In the specification, you can find another term called &quot;schemelessly same site&quot; in addition to same site. The difference between these two is also clear: same site considers the scheme, while schemelessly same site does not consider the scheme.</p><p>Therefore, when determining whether two origins, A and B, are the same site, the algorithm is as follows:</p><blockquote><p>Two origins, A and B, are said to be same site if both of the following statements are true:</p><ul><li>A and B are schemelessly same site</li><li>A and B are either both opaque origins, or both tuple origins with the same scheme</li></ul></blockquote><p>If A and B are the same site, either they are both opaque origins or they have the same scheme and are schemelessly same site.</p><p>Therefore, the concept of same site depends on the scheme. URLs with different schemes, such as http and https, are never considered the same site, but they can be schemelessly same site.</p><p>There is a bit of history here. When same site was first introduced, it did not consider the scheme. It was later that the scheme was taken into consideration.</p><p>In the 2016 RFC: Same-site Cookies, you can see that the determination of same site did not include the scheme. So at that time, <code>https://huli.tw</code> and <code>http://huli.tw</code> were considered the same site.</p><p>It wasn&#x27;t until June 2019 that the discussion started on whether to include the scheme in the consideration. For more details, refer to: <a href="https://github.com/w3c/webappsec-fetch-metadata/issues/34" target="_blank" rel="noopener noreferrer">https://github.com/w3c/webappsec-fetch-metadata/issues/34</a></p><p>At that time, the same site specification was not defined in the HTML specification we see today, but in another URL specification. So the discussion was moved there: <a href="https://github.com/whatwg/url/issues/448" target="_blank" rel="noopener noreferrer">Consider introducing a &quot;same-site&quot; concept that includes scheme. #448</a>. Then in September 2019, there was this PR: <a href="https://github.com/whatwg/url/pull/449" target="_blank" rel="noopener noreferrer">Tighten &#x27;same site&#x27; checks to include &#x27;scheme&#x27;. #449</a>, which officially included the scheme in the specification. Same site was defined as &quot;considering the scheme&quot;, and a new term was introduced for not considering the scheme: schemelessly same site.</p><p>Then, after two months, the relevant specification was moved from URL to HTML. You can refer to these two PRs: <a href="https://github.com/whatwg/url/pull/457" target="_blank" rel="noopener noreferrer">Let HTML handle the &quot;same site&quot; definition #457</a>, <a href="https://github.com/whatwg/html/pull/5076" target="_blank" rel="noopener noreferrer">Define (schemelessly) same site for origins #5076</a>.</p><p>Specifications are one thing, but sometimes browsers don&#x27;t immediately catch up with the changes. So what is the current implementation in browsers?</p><p>In November 2020, Chrome wrote an article: <a href="https://web.dev/schemeful-samesite/" target="_blank" rel="noopener noreferrer">Schemeful Same-Site</a>, indicating that at that time, different schemes were still considered the same site. But from <a href="https://chromestatus.com/feature/5096179480133632" target="_blank" rel="noopener noreferrer">Chrome platform status: Feature: Schemeful same-site</a>, we can see that Chrome started considering the scheme from version 89.</p><p>As for Firefox, from the status of this issue: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1651119" target="_blank" rel="noopener noreferrer">[meta] Enable cookie sameSite schemeful</a>, it seems that this behavior is not yet the default. If not specifically configured, different schemes are still considered the same site.</p><p>After going through the history, let&#x27;s take a look at how schemelessly same site is determined:</p><p><img loading="lazy" alt="schemelessly same site" src="/beyond-xss/en/assets/images/20-01-edadea6cfb957872adccc3a543883d9b.png" width="980" height="349" class="img_ev3q"></p><p>Let&#x27;s not talk about the opaque part for now. The key point above is a new term: &quot;registrable domain&quot;, which is used to compare two hosts to determine if they are the same site.</p><p>The definition of registrable domain is in another URL spec: <a href="https://url.spec.whatwg.org/#host-registrable-domain" target="_blank" rel="noopener noreferrer">URL&#x27;s spec</a>.</p><blockquote><p>A host&#x27;s registrable domain is a domain formed by the most specific public suffix, along with the domain label immediately preceding it, if any.</p></blockquote><p>Here, a new term is mentioned: &quot;public suffix.&quot;</p><p>Let&#x27;s start with an example to better understand it. The registrable domain of <code>blog.huli.tw</code> would be <code>huli.tw</code>, and the registrable domain of <code>huli.tw</code> would also be <code>huli.tw</code>.</p><p>However, the registrable domain of <code>bob.github.io</code> is not <code>github.io</code>, but rather <code>bob.github.io</code>.</p><p>Why is that? Let me explain briefly below.</p><p>If we didn&#x27;t have the concepts of &quot;registrable domain&quot; and &quot;public suffix,&quot; then the definition of a same site would be as mentioned earlier: <code>huli.tw</code> and <code>blog.huli.tw</code> would be considered the same site, and there would be no problem with that.</p><p>But if that were the case, <code>bob.github.io</code> and <code>alice.github.io</code> would also be considered the same site.</p><p>Wait, is that a problem?</p><p>Yes, it is. <code>github.io</code> is a service provided by GitHub, and each GitHub user has their own subdomain. However, GitHub does not want <code>bob.github.io</code> to interfere with <code>alice.github.io</code> because they are actually two completely independent websites, unlike <code>huli.tw</code> and <code>blog.huli.tw</code>, which are both owned by me.</p><p>Therefore, the concept of a public suffix emerged. It is a manually maintained list that contains the &quot;list of domains that should not be considered as the same website.&quot; Let me give you a few examples:</p><ol><li>github.io</li><li>com.tw</li><li>s3.amazonaws.com</li><li>azurestaticapps.net</li><li>herokuapp.com</li></ol><p>So, after referring to this list, the browser will recognize that <code>bob.github.io</code> and <code>alice.github.io</code> are not related and are not the same site. There is also a specific term for this called eTLD (effective Top-Level-Domain). For more details, you can refer to: <a href="https://blog.kalan.dev/2021-11-09-url-and-samesite/" target="_blank" rel="noopener noreferrer">How to determine if two domains have the same owner?</a></p><p>As mentioned above, because <code>github.io</code> is included in the public suffix list, the registrable domain of <code>bob.github.io</code> is <code>bob.github.io</code>, and the registrable domain of <code>alice.github.io</code> is <code>alice.github.io</code>.</p><p>So, the definition of the same site that we initially mentioned is incorrect. Two hosts may appear to belong to the same parent domain, but that does not necessarily mean they are the same site. It also depends on whether they are listed in the public suffix list.</p><p><code>bob.github.io</code> and <code>alice.github.io</code> are not the same site because their registrable domains are different.</p><p><code>blog.huli.tw</code>, <code>huli.tw</code>, and <code>test.huli.tw</code> are all the same site because their registrable domain is <code>huli.tw</code>.</p><p>The specification includes a clearer table for reference. Please take a closer look:</p><p><img loading="lazy" alt="registrable domain table" src="/beyond-xss/en/assets/images/20-02-b666bbfbac8fe1684ad927082dc5a452.png" width="872" height="485" class="img_ev3q"></p><p>Finally, let&#x27;s summarize the same site:</p><ol><li>There are same site and schemelessly same site, with the former being more commonly used.</li><li>To determine if two hosts are the same site, we need to look at the registrable domain.</li><li>To determine the registrable domain, we need to refer to the public suffix list.</li><li>Even if two hosts appear to belong to the same parent domain, they may not be the same site due to the presence of a public suffix.</li><li>Same site does not consider the port, so <code>http://blog.huli.tw:8888</code> and <code>http://huli.tw</code> are the same site.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="same-origin-and-same-site">Same origin and same site<a href="#same-origin-and-same-site" class="hash-link" aria-label="Direct link to Same origin and same site" title="Direct link to Same origin and same site">​</a></h2><p>Same origin is determined by:</p><ol><li>Scheme</li><li>Port</li><li>Host</li></ol><p>And the same site is:</p><ol><li>scheme</li><li>host (registrable domain)</li></ol><p>If two websites have the same origin, then they must be the same site because the criteria for determining the same origin are stricter.</p><p>The main differences between the two are:</p><ol><li>Same origin considers the port, while same site does not.</li><li>Same origin considers the host, while same site considers the registrable domain.</li></ol><p>Here are some examples:</p><table><thead><tr><th>A</th><th>B</th><th>Same Origin</th><th>Same Site</th><th>Explanation</th></tr></thead><tbody><tr><td><a href="http://huli.tw:8080" target="_blank" rel="noopener noreferrer">http://huli.tw:8080</a></td><td><a href="http://huli.tw" target="_blank" rel="noopener noreferrer">http://huli.tw</a></td><td>X</td><td>O</td><td>Same site does not consider the port</td></tr><tr><td><a href="https://blog.huli.tw" target="_blank" rel="noopener noreferrer">https://blog.huli.tw</a></td><td><a href="https://huli.tw" target="_blank" rel="noopener noreferrer">https://huli.tw</a></td><td>X</td><td>O</td><td>Same registrable domain</td></tr><tr><td><a href="https://alice.github.io" target="_blank" rel="noopener noreferrer">https://alice.github.io</a></td><td><a href="https://github.io" target="_blank" rel="noopener noreferrer">https://github.io</a></td><td>X</td><td>X</td><td>github.io is in the public suffix list</td></tr><tr><td><a href="https://a.alice.github.io" target="_blank" rel="noopener noreferrer">https://a.alice.github.io</a></td><td><a href="https://b.alice.github.io" target="_blank" rel="noopener noreferrer">https://b.alice.github.io</a></td><td>X</td><td>O</td><td>Same registrable domain</td></tr><tr><td><a href="https://bob.github.io/page1" target="_blank" rel="noopener noreferrer">https://bob.github.io/page1</a></td><td><a href="https://bob.github.io/about" target="_blank" rel="noopener noreferrer">https://bob.github.io/about</a></td><td>O</td><td>O</td><td>Path is not considered</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-magical-documentdomain">The magical document.domain<a href="#the-magical-documentdomain" class="hash-link" aria-label="Direct link to The magical document.domain" title="Direct link to The magical document.domain">​</a></h2><p>When looking at the origin specification, there is a mention of a magical &quot;domain&quot; attribute that is not clear what it is used for. There is even something called &quot;same origin-domain&quot; mentioned in the origin specification, and there is a green note directly addressing this:</p><p><img loading="lazy" alt="same origin note" src="/beyond-xss/en/assets/images/20-03-251552df2e976227c38ada9c7ec321f5.png" width="1387" height="407" class="img_ev3q"></p><p>It states that the origin is immutable except for the domain attribute, which can be changed using <code>document.domain</code>. In the specification, there is a section <a href="https://html.spec.whatwg.org/multipage/origin.html#relaxing-the-same-origin-restriction" target="_blank" rel="noopener noreferrer">7.5.2 Relaxing the same-origin restriction</a> that explains this. Here is a small excerpt:</p><blockquote><p>(document.domain) can be set to a value that removes subdomains, to change the origin&#x27;s domain to allow pages on other subdomains of the same domain (if they do the same thing) to access each other. This enables pages on different hosts of a domain to synchronously access each other&#x27;s DOMs.</p></blockquote><p>To help everyone understand, let&#x27;s have a demo.</p><p>I modified the <code>/etc/hosts</code> file on my local machine with the following content:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1   alice.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1   bob.example.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, both of these URLs will connect to the local machine. Then, I started a simple HTTP server and created a basic HTML page running on localhost:5555.</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&lt;!</span><span class="token doctype doctype-tag" style="color:#999988;font-style:italic">DOCTYPE</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">html</span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">charset</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">utf-8</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">viewport</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">width=device-width, initial-scale=1</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">h1</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">h1</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">h2</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">h2</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">load</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript string" style="color:#e3116c">&#x27;alice&#x27;</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">load alice iframe</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">load</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript string" style="color:#e3116c">&#x27;bob&#x27;</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">load bob iframe</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">access</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">access iframe content</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">update</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">update domain</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> name </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">domain</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">replace</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;.example.com&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;h1&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">innerText</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> name</span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;h2&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">innerText</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript known-class-name class-name">Math</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">random</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">load</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">name</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> iframe </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">createElement</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;iframe&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      iframe</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">src</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;http://&#x27;</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">+</span><span class="token script language-javascript"> name </span><span class="token script language-javascript operator" style="color:#393A34">+</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;.example.com:5555&#x27;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">body</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">appendChild</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">iframe</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">access</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> win </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;iframe&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">contentWindow</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript function" style="color:#d73a49">alert</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;secret:&#x27;</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">+</span><span class="token script language-javascript"> win</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;h2&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">innerText</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">update</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">domain</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;example.com&#x27;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The page has three functionalities:</p><ol><li>Loading an iframe</li><li>Reading data from the iframe&#x27;s DOM</li><li>Changing the document.domain</li></ol><p>Let&#x27;s start by opening <code>http://alice.example.com:5555</code> and then loading the iframe from <code>http://bob.example.com:5555</code>. Then, click on &quot;access iframe content&quot; on the Alice page.</p><p><img loading="lazy" alt="exception" src="/beyond-xss/en/assets/images/20-04-290308aa6bce3f68805c523b6df75761.png" width="722" height="461" class="img_ev3q"></p><p>You will see an error message in the console that says:</p><blockquote><p>Uncaught DOMException: Blocked a frame with origin &quot;<a href="http://alice.example.com:5555%22" target="_blank" rel="noopener noreferrer">http://alice.example.com:5555&quot;</a> from accessing a cross-origin frame.</p></blockquote><p>This is because although Alice and Bob are on the same site, they are not on the same origin. In order for an iframe to access the content of the DOM, it must be on the same origin.</p><p>Next, both Alice and Bob click on &quot;update domain&quot; on their respective pages, and then click &quot;access iframe content&quot; again:</p><p><img loading="lazy" alt="success" src="/beyond-xss/en/assets/images/20-05-3b2e6e0865aa2cd1c254c8b23649dc9b.png" width="721" height="427" class="img_ev3q"></p><p>This time, you will see that we have successfully obtained the data from Bob&#x27;s page, and changed <code>http://alice.example.com:5555</code> and <code>http://bob.example.com:5555</code> from cross-origin to same origin.</p><p>This technique cannot be used by any two web pages. Basically, only websites on the same site can use it, and there are also many checks during the setup:</p><p><img loading="lazy" alt="check" src="/beyond-xss/en/assets/images/20-06-0c004681ed15c8ee94ee0d2e87e5e3f1.png" width="1302" height="604" class="img_ev3q"></p><p>Taking github.io as an example, if <code>alice.github.io</code> executes <code>document.domain = &#x27;github.io&#x27;</code>, an error will be thrown in the console:</p><blockquote><p>Uncaught DOMException: Failed to set the &#x27;domain&#x27; property on &#x27;Document&#x27;: &#x27;github.io&#x27; is a top-level domain.</p></blockquote><p>Why does changing <code>document.domain</code> make the two pages become the same origin? Strictly speaking, it is not the same origin, but the same origin-domain. In the <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-bcc-content-document" target="_blank" rel="noopener noreferrer">document</a> related spec, it is mentioned that some checks are based on the same origin-domain, not the same origin.</p><p>So how do we determine if two origins are the same origin-domain? Let&#x27;s take a look at what the spec says:</p><blockquote><ol><li>If A and B are the same opaque origin, then return true.</li><li>If A and B are both tuple origins, run these substeps:</li></ol><ul><li>If A and B&#x27;s schemes are identical, and their domains are identical and non-null, then return true.</li><li>Otherwise, if A and B are same origin and their domains are identical and null, then return true.</li></ul><ol start="3"><li>Return false.</li></ol></blockquote><p>If A and B have the same scheme, and their domain properties are identical and non-null, then return true. Otherwise, if A and B are the same origin and their domains are identical and null, then return true. Otherwise, return false.</p><p>Here are a few interesting points:</p><ol><li>Both web pages must either have no domain set or have the same domain set in order for it to potentially return true (this is important).</li><li>If the domain is set, the same origin-domain check does not consider the port.</li></ol><p><code>document.domain</code> is used to change the domain property in the origin tuple.</p><p>In the example above, both of our web pages, <code>http://alice.example.com:5555</code> and <code>http://bob.example.com:5555</code>, change their domain to <code>example.com</code>, so they are the same origin-domain.</p><p>Now let&#x27;s look at three interesting scenarios.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scenario-1-one-sided-change">Scenario 1: One-sided change<a href="#scenario-1-one-sided-change" class="hash-link" aria-label="Direct link to Scenario 1: One-sided change" title="Direct link to Scenario 1: One-sided change">​</a></h3><p>If <code>https://alice.example.com</code> executes <code>document.domain = &#x27;example.com&#x27;</code>, and then embeds <code>https://example.com</code> in an iframe, they are still not the same origin-domain because Alice&#x27;s page has the domain property, but the <code>example.com</code> page does not.</p><p><code>example.com</code> also needs to execute <code>document.domain = &#x27;example.com&#x27;</code> in order for them to be in the same origin-domain.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-2-disappearing-port">Case 2: Disappearing port<a href="#case-2-disappearing-port" class="hash-link" aria-label="Direct link to Case 2: Disappearing port" title="Direct link to Case 2: Disappearing port">​</a></h3><p><code>http://alice.example.com:1234</code> and <code>http://alice.example.com:4567</code> are considered cross-origin because they have different ports. However, if both pages execute <code>document.domain = &#x27;alice.example.com&#x27;</code>, they will become the same origin-domain and can access each other&#x27;s DOM because the port is not taken into account.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-3-i-am-not-who-i-used-to-be">Case 3: I am not who I used to be<a href="#case-3-i-am-not-who-i-used-to-be" class="hash-link" aria-label="Direct link to Case 3: I am not who I used to be" title="Direct link to Case 3: I am not who I used to be">​</a></h3><p>Assuming <code>http://alice.example.com</code> embeds itself in an iframe, the iframe and the original page are obviously the same origin and can access each other&#x27;s DOM.</p><p>However, if I execute <code>document.domain = &#x27;alice.example.com&#x27;</code> on the page, the page will set the domain attribute, but the page inside the iframe does not have the domain attribute set. Therefore, they become different origin-domains.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-fading-and-exit-of-documentdomain">The fading and exit of document.domain<a href="#the-fading-and-exit-of-documentdomain" class="hash-link" aria-label="Direct link to The fading and exit of document.domain" title="Direct link to The fading and exit of document.domain">​</a></h2><p>Using this technique to relax the same-origin restriction has been around for a while, and it hasn&#x27;t been removed for compatibility with early behaviors. I guess many web pages used this technique to access same-site but cross-origin pages in the early days.</p><p>However, this approach is obviously risky. For example, if a subdomain has an XSS vulnerability, it can be exploited to expand the impact. In a 2016 article by <a href="https://twitter.com/fin1te" target="_blank" rel="noopener noreferrer">@fin1te</a> titled <a href="https://whitton.io/articles/xss-on-facebook-via-png-content-types/" target="_blank" rel="noopener noreferrer">An XSS on Facebook via PNGs &amp; Wonky Content Types</a>, this technique was used to successfully perform XSS from a subdomain to <code>www.facebook.com</code>, increasing the vulnerability&#x27;s impact.</p><p>Due to security concerns, Chrome published an article on January 11, 2022, on their blog: <a href="https://developer.chrome.com/blog/immutable-document-domain/" target="_blank" rel="noopener noreferrer">Chrome will disable modifying document.domain to relax the same-origin policy</a>. The article explains that starting from Chrome version 101, support for modifying <code>document.domain</code> will be discontinued.</p><p>The original behavior can be replaced with <code>postMessage</code> or the <code>Channel Messaging API</code>, but it requires writing more code. After all, it is not as convenient as directly manipulating the DOM.</p><p>If a webpage wants to continue using the functionality of modifying <code>document.domain</code>, it needs to include <code>Origin-Agent-Cluster: ?0</code> in the response header.</p><p>The article also includes a related discussion thread about this change: <a href="https://github.com/w3ctag/design-reviews/issues/564" target="_blank" rel="noopener noreferrer">Deprecating document.domain setter. #564</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>The same-origin policy is a browser protection mechanism that ensures only web pages from the same origin can access each other&#x27;s data to avoid security issues. Therefore, it is important to understand the definition of origin in order to determine whether two web pages are from the same origin.</p><p>After introducing the important concepts of origin and site, we will gradually encounter two related terms: CSRF (Cross-site request forgery) and CORS (Cross-origin resource sharing).</p><p>References:</p><ol><li><a href="https://html.spec.whatwg.org/multipage/origin.html#origin" target="_blank" rel="noopener noreferrer">HTML spec</a></li><li><a href="https://url.spec.whatwg.org/#host-registrable-domain" target="_blank" rel="noopener noreferrer">URL spec</a></li><li><a href="https://blog.kalan.dev/2021-11-09-url-and-samesite/" target="_blank" rel="noopener noreferrer">如何判斷兩個網域的擁有者是否相同？</a></li><li><a href="https://developer.chrome.com/blog/immutable-document-domain/" target="_blank" rel="noopener noreferrer">Chrome will disable modifying document.domain to relax the same-origin policy</a></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/en/ch3/html-attack/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Can You Attack with Just HTML?</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/en/ch4/cors-intro/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Introduction to Cross-Origin Resource Sharing (CORS)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-exactly-are-origin-and-site-how-to-differentiate-them" class="table-of-contents__link toc-highlight">What exactly are Origin and Site? How to differentiate them?</a></li><li><a href="#examining-same-origin-in-detail" class="table-of-contents__link toc-highlight">Examining Same-origin in Detail</a></li><li><a href="#exploring-same-site-in-detail" class="table-of-contents__link toc-highlight">Exploring same site in detail</a></li><li><a href="#same-origin-and-same-site" class="table-of-contents__link toc-highlight">Same origin and same site</a></li><li><a href="#the-magical-documentdomain" class="table-of-contents__link toc-highlight">The magical document.domain</a><ul><li><a href="#scenario-1-one-sided-change" class="table-of-contents__link toc-highlight">Scenario 1: One-sided change</a></li><li><a href="#case-2-disappearing-port" class="table-of-contents__link toc-highlight">Case 2: Disappearing port</a></li><li><a href="#case-3-i-am-not-who-i-used-to-be" class="table-of-contents__link toc-highlight">Case 3: I am not who I used to be</a></li></ul></li><li><a href="#the-fading-and-exit-of-documentdomain" class="table-of-contents__link toc-highlight">The fading and exit of document.domain</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/en/assets/js/runtime~main.9a9bfab3.js"></script>
<script src="/beyond-xss/en/assets/js/main.3d2d1fa0.js"></script>
</body>
</html>