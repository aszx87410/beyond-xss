<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch4/subdomain" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">From same-site to main site | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/en/ch4/subdomain/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="From same-site to main site | Beyond XSS"><meta data-rh="true" name="description" content="In the previous post about Grafana attack scenarios, it was mentioned that attackers must first gain control of a same-site website in order to execute subsequent attacks. In this post, let&#x27;s consider a different perspective: &quot;If you have control over a same-site website, what kind of attacks can you perform?&quot; For example, CSRF is a possible attack method."><meta data-rh="true" property="og:description" content="In the previous post about Grafana attack scenarios, it was mentioned that attackers must first gain control of a same-site website in order to execute subsequent attacks. In this post, let&#x27;s consider a different perspective: &quot;If you have control over a same-site website, what kind of attacks can you perform?&quot; For example, CSRF is a possible attack method."><link data-rh="true" rel="icon" href="/beyond-xss/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/en/ch4/subdomain/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch4/subdomain/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/subdomain/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/subdomain/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/en/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/en/assets/js/runtime~main.c3ff4a96.js" as="script">
<link rel="preload" href="/beyond-xss/en/assets/js/main.a303d294.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/en/"><div class="navbar__logo"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS: Explore the Web Front-end Security Universe</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch4/subdomain/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/beyond-xss/ch4/subdomain/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-TW">中文（台灣）</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/">About This Series</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch1/browser-security-model/">Chapter 1: Starting with XSS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch2/xss-defense-sanitization/">Chapter 2: Defense and bypass for XSS </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch3/attack-without-js/">Chapter 3: Attacks without JavaScript  </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/beyond-xss/en/ch4/sop-and-site/">Chapter 4: Cross-site attacks </a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/sop-and-site/">The Essence: Same-origin Policy and Site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cors-intro/">Introduction to Cross-Origin Resource Sharing (CORS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cors-attack/">Cross-Origin Security Issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/csrf/">Cross-Site Request Forgery (CSRF) Made Easy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/same-site-cookie/">Same-site cookie, the savior of CSRF?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/en/ch4/subdomain/">From same-site to main site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cookie-bomb/">Interesting and Practical Cookie Bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch5/clickjacking/">Chapter 5: Other interesting topics  </a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/summary/">Conclusion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/contact/">Contact the Author</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/beyond-xss/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Chapter 4: Cross-site attacks </span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">From same-site to main site</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>From same-site to main site</h1><p>In the previous post about Grafana attack scenarios, it was mentioned that attackers must first gain control of a same-site website in order to execute subsequent attacks. In this post, let&#x27;s consider a different perspective: &quot;If you have control over a same-site website, what kind of attacks can you perform?&quot; For example, CSRF is a possible attack method.</p><p>This often happens in the world of bug bounty, where websites offer rewards to bounty hunters for actively discovering and reporting vulnerabilities. This allows the website to patch the vulnerabilities before they can be maliciously exploited, benefiting both parties. These bug bounty programs usually have an explanation page that specifies the monetary value for different severity levels of vulnerabilities.</p><p>In addition, there are also core and non-core websites. For example, vulnerabilities found on the <code>api.huli.tw</code> API server are worth more than vulnerabilities found on the <code>2023.campaign.huli.tw</code> one-time event page because the former can cause greater impact.</p><p>Therefore, when a bounty hunter discovers a vulnerability on <code>2023.campaign.huli.tw</code>, they may try to further investigate if there is a way to expand the scope of this vulnerability, such as affecting <code>api.huli.tw</code>, in order to earn more rewards.</p><p>Apart from finding XSS on same-site websites, there is another way to control subdomains.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="subdomain-takeover">Subdomain takeover<a href="#subdomain-takeover" class="hash-link" aria-label="Direct link to Subdomain takeover" title="Direct link to Subdomain takeover">​</a></h2><p>As the name suggests, this vulnerability allows attackers to take over an entire subdomain and gain control over it.</p><p>Sounds difficult, right? Do you need to gain control of their DNS or infiltrate the company&#x27;s internal systems to take over a subdomain? Actually, it&#x27;s not always necessary. In the era of various cloud services, there is a simpler method to try.</p><p>Amazon S3 is a cloud storage service where you can upload files and set permissions to share them with others. Many people use Amazon S3 to store images or even host entire websites because it provides website hosting functionality. Each storage space in S3 is called a bucket and has a name, which also corresponds to a subdomain provided by S3.</p><p>For example, if my bucket is named <code>hulitest</code>, the subdomain would be: <code>https://hulitest.s3.us-east-1.amazonaws.com</code>. Since S3 is convenient and easy to use, it is a good choice for hosting static websites. For example, if a company&#x27;s architecture separates the frontend and backend completely and does not require server-side rendering, a purely static website can be hosted on S3, eliminating the need to manage the frontend infrastructure.</p><p>The only problem is that the domain <code>https://hulitest.s3.us-east-1.amazonaws.com</code> doesn&#x27;t look good. Companies usually have their own domain names, and S3 provides the functionality to customize the domain, which is also quite simple.</p><p>First, change the bucket name to the desired domain, for example, <code>campaign.huli.tw</code>.</p><p>Second, add a CNAME record in DNS, pointing <code>campaign.huli.tw</code> to <code>hulitest.s3.us-east-1.amazonaws.com</code>. This way, you can use <code>https://campaign.huli.tw</code> as your own domain.</p><p>The entire process seems fine and convenient, but what about when you no longer need this webpage? For example, there may be a Christmas event page hosted on S3 using a custom domain <code>xmas.huli.tw</code>. After Christmas and the event are over, the S3 bucket is deleted since storage space and traffic still incur costs.</p><p>However, the DNS part may be handled by another department, and if they are not specifically informed to delete it, it may remain there.</p><p>As a result, a situation arises where the DNS record still exists, but the destination it points to has been deleted.</p><p>In the case of S3, as long as the bucket name is not taken by someone else, you can claim that name. Now that the <code>xmas.huli.tw</code> bucket has been deleted, I can create a new one with the same name, <code>xmas.huli.tw</code>. This way, the domain <code>xmas.huli.tw</code> will point to the S3 bucket, and since the S3 bucket contains my content, I effectively control the content of <code>xmas.huli.tw</code>, achieving subdomain takeover.</p><p>Apart from S3, there are many other services that provide similar functionality and have this issue. You can refer to the detailed list here: <a href="https://github.com/EdOverflow/can-i-take-over-xyz" target="_blank" rel="noopener noreferrer">Can I take over XYZ</a>. Azure has also created a page specifically explaining how to defend against this: <a href="https://learn.microsoft.com/en-us/azure/security/fundamentals/subdomain-takeover" target="_blank" rel="noopener noreferrer">Prevent dangling DNS entries and avoid subdomain takeover</a>. In simple terms, just delete the DNS record, and there will be no problem.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="things-you-can-do-after-gaining-subdomain-control">Things You Can Do After Gaining Subdomain Control<a href="#things-you-can-do-after-gaining-subdomain-control" class="hash-link" aria-label="Direct link to Things You Can Do After Gaining Subdomain Control" title="Direct link to Things You Can Do After Gaining Subdomain Control">​</a></h2><p>Let&#x27;s take a look at a few examples!</p><p>The first example is an article published by Hacktus in 2023: <a href="https://hacktus.tech/subdomain-takeover-leading-to-full-account-takeover" target="_blank" rel="noopener noreferrer">Subdomain Takeover leading to Full Account Takeover</a>. It mentions that the website <code>example.com</code> has its cookies directly written on the root domain <code>example.com</code>, making them shareable with other subdomains.</p><p>Hacktus discovered that one of the subdomains, <code>test.example.com</code>, was pointing to <code>azurewebsites.net</code> and was not registered by anyone. So, Hacktus registered the service and successfully took over the domain. After taking over, whenever a user visits <code>test.example.com</code>, the browser sends the cookies stored in <code>example.com</code> to the server, allowing Hacktus to obtain the user&#x27;s cookies.</p><p>The second case is an article published by a cybersecurity company called Shockwave: <a href="https://www.shockwave.cloud/blog/subdomain-takeover-how-a-misconfigured-dns-record-could-lead-to-a-huge-supply-chain-attack" target="_blank" rel="noopener noreferrer">Subdomain Takeover: How a Misconfigured DNS Record Could Lead to a Huge Supply Chain Attack</a>. The case mentioned in the article is similar to the S3 bucket issue we discussed earlier, but this time the domain taken over is <code>assets.npmjs.com</code>.</p><p>NPM stands for Node Package Manager, a service used to manage JavaScript packages. If an attacker gains control of <code>assets.npmjs.com</code>, they can upload malicious packages and deceive developers into thinking they are safe. Since developers are familiar with this domain and it appears highly credible, the probability of successful phishing is also high.</p><p>The third case involves a vulnerability discovered by Smaran Chand towards the end of 2022: <a href="https://smaranchand.com.np/2022/10/taking-over-the-medium-subdomain-using-medium/" target="_blank" rel="noopener noreferrer">Taking over the Medium subdomain using Medium</a>. One of the subdomains of the blogging platform Medium, <code>platform.medium.engineering</code>, points to Medium but does not exist as a blog.</p><p>An attacker can create their own Medium blog and request a link to <code>platform.medium.engineering</code>. Although they cannot fully control the content of the webpage in this case, they can still engage in social engineering attacks, such as posting fake job advertisements, which appear highly credible.</p><p>Apart from the application methods mentioned in these practical examples, there are actually more possibilities.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting-incorrect-security-assumptions">Exploiting Incorrect Security Assumptions<a href="#exploiting-incorrect-security-assumptions" class="hash-link" aria-label="Direct link to Exploiting Incorrect Security Assumptions" title="Direct link to Exploiting Incorrect Security Assumptions">​</a></h2><p>Many backend programs make incorrect security assumptions and grant excessive permissions to entities that should not have them.</p><p>For example, let&#x27;s consider the case of dynamic origin in CORS. Some servers implement the following check:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> domain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;huli.tw&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> domain </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> origin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">endsWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> domain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setHeader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Access-Control-Allow-Origin&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the origin is <code>huli.tw</code> or ends with <code>.huli.tw</code>, it passes. Although it may not seem like a big issue, the security of this check is based on the assumption that &quot;attackers cannot control subdomains of <code>huli.tw</code>&quot;.</p><p>However, by now, I believe everyone knows that gaining control of a subdomain may not be as difficult as imagined, and the risk still exists. If an attacker can control a subdomain, they can exploit this incorrect assumption to launch attacks from the subdomain.</p><p>Therefore, this seemingly secure check is actually not secure enough. The most secure check should be:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> allowOrigins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;huli.tw&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;blog.huli.tw&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allowOrigins</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">includes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setHeader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Access-Control-Allow-Origin&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Prepare a list, and only origins in the list can pass the check. Although this may be more cumbersome because every new domain needs to be manually added, it also increases security by not blindly trusting any subdomain.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cookie-tossing">Cookie Tossing<a href="#cookie-tossing" class="hash-link" aria-label="Direct link to Cookie Tossing" title="Direct link to Cookie Tossing">​</a></h2><p>Another thing you can do after gaining control of a subdomain is called cookie tossing.</p><p>Let&#x27;s assume there is a website with an API server at <code>api.huli.tw</code>, and the authentication cookie is stored under this domain. Additionally, the backend has implemented CSRF protection, adding <code>SameSite=Lax</code> and checking the CSRF token to ensure that the <code>csrf_token</code> in the request body matches the one in the cookie.</p><p>Now, suppose we have control over a subdomain called <code>s3.huli.tw</code> and can execute XSS attacks on it. What should we do next?</p><p>When writing cookies, we can write them to higher-level domains. For example, <code>a.b.huli.tw</code> can write cookies to:</p><ol><li>a.b.huli.tw</li><li>b.huli.tw</li><li>huli.tw</li></ol><p>Therefore, when we are on <code>s3.huli.tw</code>, we can write a cookie to <code>huli.tw</code>, allowing us to write a cookie called <code>csrf_token</code>.</p><p>In a scenario where both <code>api.huli.tw</code> and <code>huli.tw</code> have cookies with the same name, what will the browser do? It will send both cookies together, and based on the <code>path</code> attribute of the cookie, the more specific one will be sent first.</p><p>For example, if the cookie on <code>api.huli.tw</code> does not have a <code>path</code> set, and the cookie on <code>huli.tw</code> has a <code>path=/users</code> set, when the browser sends a request to <code>https://api.huli.tw/users</code>, the sent cookies will be: <code>csrf_token={value_of_huli_tw}&amp;csrf_token={value_of_api_huli_tw}</code>.</p><p>Usually, when retrieving cookie values on the backend, only the first one is taken by default. Therefore, we will retrieve the cookie we wrote on <code>s3.huli.tw</code>.</p><p>Through this behavior, an attacker can overwrite cookies from other same-site domains, as if they are &quot;tossing&quot; cookies from a subdomain to another domain. This is known as cookie tossing.</p><p>By overwriting the <code>csrf_token</code> cookie, we essentially know its value and can execute a CSRF attack. Therefore, in this situation, even with same-site cookie settings and CSRF token checks, we cannot escape the fate of being attacked.</p><p>The solution is to change the cookie name of the CSRF token from <code>csrf_token</code> to <code>__Host-csrf_token</code>. With this prefix, the cookie cannot have the <code>path</code> and <code>domain</code> attributes when setting it. Therefore, other subdomains cannot write and overwrite it. For more examples, you can refer to the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#cookie_prefixes" target="_blank" rel="noopener noreferrer">MDN page</a>.</p><p>For specific examples and other applications, you can refer to @filedescriptor&#x27;s talk at HITCON CMT in 2019: <a href="https://www.youtube.com/watch?v=njQcVWPB1is&amp;ab_channel=HITCON" target="_blank" rel="noopener noreferrer">The cookie monster in your browsers</a>, or check out the <a href="https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers" target="_blank" rel="noopener noreferrer">slides</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>This article continues the same-site issue mentioned in the previous one. When designing systems, we should adhere to the principle of least privilege and avoid unnecessary security assumptions. Instead of trusting all same-site domains, a more secure approach would be to trust a fixed list of domains and ensure that every trusted domain is listed.</p><p>Furthermore, from this article, we can see that a same-site website inherently has more privileges (e.g., ignoring same-site cookies). Therefore, many companies actually place less trusted files (e.g., user-uploaded files) or less important websites on a completely new domain.</p><p>For example, the main site may be at <code>www.huli.tw</code>, while the campaign webpage is called <code>campaign.huli.app</code>. This way, even if the campaign webpage is compromised, the damage can be minimized and it won&#x27;t affect the main site.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/en/ch4/same-site-cookie/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Same-site cookie, the savior of CSRF?</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/en/ch4/cookie-bomb/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Interesting and Practical Cookie Bomb</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#subdomain-takeover" class="table-of-contents__link toc-highlight">Subdomain takeover</a></li><li><a href="#things-you-can-do-after-gaining-subdomain-control" class="table-of-contents__link toc-highlight">Things You Can Do After Gaining Subdomain Control</a></li><li><a href="#exploiting-incorrect-security-assumptions" class="table-of-contents__link toc-highlight">Exploiting Incorrect Security Assumptions</a></li><li><a href="#cookie-tossing" class="table-of-contents__link toc-highlight">Cookie Tossing</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/en/assets/js/runtime~main.c3ff4a96.js"></script>
<script src="/beyond-xss/en/assets/js/main.a303d294.js"></script>
</body>
</html>