<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch4/same-site-cookie" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Same-site cookie, the savior of CSRF? | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/en/ch4/same-site-cookie/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Same-site cookie, the savior of CSRF? | Beyond XSS"><meta data-rh="true" name="description" content="When it comes to defending against CSRF, regardless of the method used, both the frontend and backend need to implement a comprehensive mechanism to protect against it. Previously, when discussing XSS, we mentioned CSP, which can block resources that do not comply with the rules. But does the browser provide a similar way to prevent CSRF? Is there something we can add to prevent CSRF?"><meta data-rh="true" property="og:description" content="When it comes to defending against CSRF, regardless of the method used, both the frontend and backend need to implement a comprehensive mechanism to protect against it. Previously, when discussing XSS, we mentioned CSP, which can block resources that do not comply with the rules. But does the browser provide a similar way to prevent CSRF? Is there something we can add to prevent CSRF?"><link data-rh="true" rel="icon" href="/beyond-xss/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/en/ch4/same-site-cookie/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch4/same-site-cookie/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/same-site-cookie/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/same-site-cookie/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/en/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/en/assets/js/runtime~main.80dafa6d.js" as="script">
<link rel="preload" href="/beyond-xss/en/assets/js/main.a303d294.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/en/"><div class="navbar__logo"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS: Explore the Web Front-end Security Universe</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch4/same-site-cookie/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/beyond-xss/ch4/same-site-cookie/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-TW">中文（台灣）</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/">About This Series</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch1/browser-security-model/">Chapter 1: Starting with XSS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch2/xss-defense-sanitization/">Chapter 2: Defense and bypass for XSS </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch3/attack-without-js/">Chapter 3: Attacks without JavaScript  </a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/beyond-xss/en/ch4/sop-and-site/">Chapter 4: Cross-site attacks </a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/sop-and-site/">The Essence: Same-origin Policy and Site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cors-intro/">Introduction to Cross-Origin Resource Sharing (CORS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cors-attack/">Cross-Origin Security Issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/csrf/">Cross-Site Request Forgery (CSRF) Made Easy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/en/ch4/same-site-cookie/">Same-site cookie, the savior of CSRF?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/subdomain/">From same-site to main site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cookie-bomb/">Interesting and Practical Cookie Bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/en/ch5/clickjacking/">Chapter 5: Other interesting topics  </a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/summary/">Conclusion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/contact/">Contact the Author</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/beyond-xss/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Chapter 4: Cross-site attacks </span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Same-site cookie, the savior of CSRF?</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Same-site cookie, the savior of CSRF?</h1><p>When it comes to defending against CSRF, regardless of the method used, both the frontend and backend need to implement a comprehensive mechanism to protect against it. Previously, when discussing XSS, we mentioned CSP, which can block resources that do not comply with the rules. But does the browser provide a similar way to prevent CSRF? Is there something we can add to prevent CSRF?</p><p>Yes, there is something called a same-site cookie. In this post, let&#x27;s explore what it is and whether using it can give us peace of mind.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploring-the-same-site-cookie">Exploring the same-site cookie<a href="#exploring-the-same-site-cookie" class="hash-link" aria-label="Direct link to Exploring the same-site cookie" title="Direct link to Exploring the same-site cookie">​</a></h2><p>As the name suggests, a same-site cookie is a cookie that is only sent under same-site conditions. It is used by setting an attribute called <code>SameSite</code>, which can have three values:</p><ol><li>None</li><li>Lax</li><li>Strict</li></ol><p><code>None</code> is the most lenient, meaning &quot;I don&#x27;t want the SameSite attribute.&quot;</p><p>On the other hand, <code>Strict</code> is the strictest. When you add it, it explicitly states that &quot;this cookie can only be sent when the target is same-site.&quot;</p><p>For example, suppose a cookie is set with <code>SameSite=Strict</code> on <code>https://api.huli.tw</code>. In that case, requests sent from <code>https://example.com</code> to <code>https://api.huli.tw</code> will not include this cookie because these two websites are not same-site.</p><p>However, if it is <code>https://test.huli.tw</code>, the cookie will be included because it is same-site.</p><p>How strict is it? It&#x27;s so strict that even &quot;clicking on a link counts.&quot; If I click on a hyperlink <code>&lt;a href=&quot;https://api.huli.tw&quot;&gt;&lt;/a&gt;</code> on <code>https://example.com</code>, it is equivalent to sending a cross-site request from <code>https://example.com</code> to <code>https://api.huli.tw</code>.</p><p>Therefore, in this case, the cookie will not be included.</p><p>But isn&#x27;t this inconvenient? Let&#x27;s take Google as an example. Suppose Google uses a same-site cookie to verify user identity, and there is a hyperlink in my article that leads to a Google search page. When a user clicks on the link, the opened Google page will be in a logged-out state because it doesn&#x27;t have the token. This results in a poor user experience.</p><p>There are two solutions to this issue. The first is similar to Amazon&#x27;s approach, which involves preparing two sets of cookies. The first set maintains the login status, while the second set is used for sensitive operations (such as purchasing items or account settings). The first set does not have the <code>SameSite</code> attribute, so it will maintain the login status regardless of where the request comes from. However, even if an attacker has the first set of cookies, they cannot do anything because they cannot perform any operations. The second set, on the other hand, completely avoids CSRF by setting the <code>SameSite</code> attribute.</p><p>However, this approach can be a bit cumbersome. So you can consider the second solution, which is to adjust to another mode of <code>SameSite</code>: <code>Lax</code>.</p><p>Lax mode relaxes some restrictions. Basically, as long as it is a &quot;top-level navigation,&quot; such as <code>&lt;a href&gt;</code> or <code>&lt;form method=&quot;GET&quot;&gt;</code>, cookies will still be included. However, if it is a POST method form, the cookie will not be included.</p><p>This way, you can maintain flexibility, allowing users to maintain their login status when coming from other websites, while also preventing CSRF attacks.</p><p>If cross-site requests do not include cookies, attackers cannot execute CSRF attacks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="history-of-same-site-cookie">History of Same-site cookie<a href="#history-of-same-site-cookie" class="hash-link" aria-label="Direct link to History of Same-site cookie" title="Direct link to History of Same-site cookie">​</a></h2><p>The <a href="https://datatracker.ietf.org/doc/html/draft-west-first-party-cookies-00" target="_blank" rel="noopener noreferrer">first draft specification</a> of the Same-site cookie was published in October 2014. At that time, it was called &quot;First-Party Cookie&quot; instead of the current &quot;Same-site cookie.&quot; It was not until January 2016 that the name was changed to Same-site cookie.</p><p>Google officially introduced this feature with Chrome 51 in May 2016: <a href="https://www.chromestatus.com/feature/4672634709082112" target="_blank" rel="noopener noreferrer">SameSite cookie</a>. Firefox also added support in Firefox 60, released in May 2018. Safari, with the slowest progress, only fully supported this feature with the release of Safari 15 in September 2021.</p><p>Due to the increased security and privacy protection provided by the SameSite attribute, in October 2019, Chrome directly released an article titled <a href="https://blog.chromium.org/2019/10/developers-get-ready-for-new.html" target="_blank" rel="noopener noreferrer">Developers: Get Ready for New SameSite=None; Secure Cookie Settings</a>, announcing that starting from February 2020, cookies without the SameSite attribute will default to Lax.</p><p>And after the outbreak of the pandemic, although we had tested this feature for a while before going live, Chrome still wanted to ensure that all websites were stable and not broken. Therefore, in April 2020, they decided to temporarily rollback this change: <a href="https://blog.chromium.org/2020/04/temporarily-rolling-back-samesite.html" target="_blank" rel="noopener noreferrer">Temporarily rolling back SameSite Cookie Changes</a>.</p><p>However, after the pandemic eased slightly in July, this change was gradually redeployed and was fully deployed by August.</p><p>In addition to Chrome, Firefox also announced in August 2020 that they would follow suit. Cookies without the SameSite attribute would default to Lax. The article at that time was: <a href="https://hacks.mozilla.org/2020/08/changes-to-samesite-cookie-behavior/" target="_blank" rel="noopener noreferrer">Changes to SameSite Cookie Behavior – A Call to Action for Web Developers</a>.</p><p>As for Safari, they announced in March 2020 that they would <a href="https://webkit.org/blog/10218/full-third-party-cookie-blocking-and-more/" target="_blank" rel="noopener noreferrer">completely block third-party cookies</a>, but the actual behavior seems to be a black box.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mid-break-for-reflection">Mid-Break for Reflection<a href="#mid-break-for-reflection" class="hash-link" aria-label="Direct link to Mid-Break for Reflection" title="Direct link to Mid-Break for Reflection">​</a></h2><p>By now, everyone should be somewhat familiar with the principles and defense methods of CSRF. The same-site cookie introduced in this article seems quite reliable, and browsers even automatically make it the default, allowing you to enjoy the benefits without making any adjustments.</p><p>With the default <code>SameSite=Lax</code>, CSRF seems to have exited the stage, officially declared dead, becoming a tear of the times. It&#x27;s okay not to add a CSRF token because the same-site cookie will automatically handle everything.</p><p>However, is it really like that?</p><p>Is the default <code>SameSite=Lax</code> really that powerful? Do we still need to add a CSRF token with it? Will there be any issues if we don&#x27;t add it? What situations can cause problems?</p><p>Think about these questions first, and then continue reading.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="csrf-with-get-requests">CSRF with GET Requests<a href="#csrf-with-get-requests" class="hash-link" aria-label="Direct link to CSRF with GET Requests" title="Direct link to CSRF with GET Requests">​</a></h2><p>In the previous examples, when I introduced CSRF, I always used POST requests. The reason is simple: CSRF focuses on executing actions, and generally, GET requests are not used for executing actions because it does not align with the semantics of the GET method (or, in more professional terms, GET is only suitable for idempotent operations).</p><p>However, &quot;not suitable&quot; does not mean &quot;cannot be done&quot;.</p><p>As I mentioned in the first example when talking about CSRF, some people may take shortcuts and use GET to implement deletion or other functions, like this: <code>/delete?id=3</code>.</p><p>In this case, SameSite lax cannot provide protection because lax allows the following behavior:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token dom variable" style="color:#36acaa">location</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;https://api.example.com/delete?id=3&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Redirecting to pages like this is one of the allowed behaviors. Therefore, even with the default same-site cookie, it still cannot provide protection.</p><p>In the future, when you see someone writing this kind of &quot;executing actions with GET,&quot; besides telling them that it is a bad practice, now you have another reason: &quot;Doing this will have security issues.&quot;</p><p>However, there should be only a few people who write it this way, right? So, the problem should not be significant?</p><p>For this kind of writing, it is indeed rare, but there is another common mechanism we can utilize: method override.</p><p>The <code>method</code> attribute in HTML forms represents the HTTP method used when the request is sent. It only supports two values: GET and POST.</p><p>What if we want to use PUT, PATCH, or DELETE? It cannot be done. Either we have to use <code>fetch()</code> to send the request or implement a workaround on the backend, which many frameworks support.</p><p>For some web frameworks, if a request has the <code>X-HTTP-Method-Override</code> header or the query string has the <code>_method</code> parameter, the value inside will be used as the request method instead of the original HTTP method.</p><p>This was originally used in the scenario I just mentioned, where you want to update data but can only use POST. You can add a <code>_method</code> parameter to let the server know that it is actually a PATCH request:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">/api/update/1</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">POST</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">_method</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">PATCH</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">title</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">new_title</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But it can also be used in our CSRF attack. For example, <code>GET /api/deleteMyAccount?_method=POST</code> will be treated as a POST request by the server, not GET.</p><p>Through this method, the protection of lax can be bypassed, attacking servers that support this method override. As for which web frameworks have this mechanism enabled by default, you can refer to: <a href="https://hazanasec.github.io/2023-07-30-Samesite-bypass-method-override.md/" target="_blank" rel="noopener noreferrer">Bypassing Samesite Cookie Restrictions with Method Override</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hidden-rules-of-same-site-cookies">Hidden Rules of Same-site Cookies<a href="#hidden-rules-of-same-site-cookies" class="hash-link" aria-label="Direct link to Hidden Rules of Same-site Cookies" title="Direct link to Hidden Rules of Same-site Cookies">​</a></h2><p>So, if there is no support for method override and no inappropriate operations using GET, does that mean everything is fine? Of course, it&#x27;s not that simple.</p><p>The default same-site cookie actually has a hidden rule, or rather, a lesser-known rule that was mentioned in the previous announcement by Firefox:</p><blockquote><p>For any flows involving POST requests, you should test with and without a long delay. This is because both Firefox and Chrome implement a two-minute threshold that permits newly created cookies without the SameSite attribute to be sent on top-level, cross-site POST requests (a common login flow).</p></blockquote><p>This means that for a cookie without the SameSite attribute, it can bypass some of the lax restrictions within the first two minutes of being written, allowing &quot;top-level cross-site POST requests,&quot; in plain terms, <code>&lt;form method=POST&gt;</code>.</p><p>Therefore, let&#x27;s assume a user has just logged into a website, and the cookie used for authentication has just been written. At this time, the user opens a webpage created by an attacker, and the content of the webpage is a CSRF exploit:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">f</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://api.huli.tw/transfer</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">POST</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">target</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">attacker_account</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">amount</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">1000</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  f</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">submit</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Due to the exception mentioned earlier, the CSRF attack will be successful.</p><p>This exception was originally added to prevent certain websites from breaking, but at the same time, it also opened a backdoor for attackers. As long as certain conditions are met, the &quot;default lax&quot; restrictions can be ignored.</p><p>If a website explicitly specifies <code>SameSite=Lax</code>, then this issue would not exist. So, does that mean it is truly secure?</p><p>I think you know what I&#x27;m about to say.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="is-same-site-cookie-enough-to-prevent-csrf">Is Same-site Cookie Enough to Prevent CSRF?<a href="#is-same-site-cookie-enough-to-prevent-csrf" class="hash-link" aria-label="Direct link to Is Same-site Cookie Enough to Prevent CSRF?" title="Direct link to Is Same-site Cookie Enough to Prevent CSRF?">​</a></h2><p>Although CSRF stands for cross-site, most of the time it is more like cross-origin. In other words, if an attacker can launch an attack from <code>assets.huli.tw</code> to <code>huli.tw</code>, we would generally consider it as CSRF, even though these two websites are not cross-site.</p><p>Same-site cookies only ensure that cookies are not sent in cross-site scenarios. But if two websites are same-site, it doesn&#x27;t care.</p><p>Continuing from the previous example, let&#x27;s say the main website of Facebook is <code>www.facebook.com</code>, and it has a testing environment called <code>sandbox.facebook.com</code>, where an XSS vulnerability was found.</p><p>If the website only relies on same-site cookies to prevent CSRF, then it is completely useless in this scenario because <code>www.facebook.com</code> and <code>sandbox.facebook.com</code> are obviously same-site. Therefore, we can easily launch a CSRF attack on the main website using the XSS vulnerability found on the sandbox.</p><p>But this is clearly a vulnerability that should be defended against because we don&#x27;t want subdomains to be able to attack other domains.</p><p>Therefore, relying solely on same-site cookies to defend against CSRF is an insecure choice. The <a href="https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis-12#name-samesite-cookies" target="_blank" rel="noopener noreferrer">RFC for Cookies</a> also states:</p><blockquote><p>Developers are strongly encouraged to deploy the usual server-side defenses (CSRF tokens, ensuring that &quot;safe&quot; HTTP methods are idempotent, etc) to mitigate the risk more fully.</p></blockquote><p>It is strongly recommended that developers implement the usual defense measures, such as CSRF tokens, in addition to same-site cookies.</p><p>So, even with same-site cookies, it doesn&#x27;t mean that the previous defense measures can be removed. We still need CSRF tokens, combined with same-site cookies, to build a more robust defense wall and prevent various attack scenarios.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="real-world-example">Real-world Example<a href="#real-world-example" class="hash-link" aria-label="Direct link to Real-world Example" title="Direct link to Real-world Example">​</a></h2><p>In 2022, jub0bs and abrahack discovered a CSRF vulnerability in the open-source monitoring system Grafana, with the identifier <a href="https://github.com/grafana/grafana/security/advisories/GHSA-cmf4-h3xc-jw8w" target="_blank" rel="noopener noreferrer">CVE-2022-21703</a>.</p><p>The root cause is that Grafana only uses <code>SameSite=Lax</code> as CSRF protection, so any same-site request can execute a CSRF attack. Interestingly, in 2019, Grafana originally intended to add a CSRF token, but after some changes, they thought &quot;having a same-site cookie seems sufficient&quot; and stopped development. You can find more details in this PR: <a href="https://github.com/grafana/grafana/pull/20070" target="_blank" rel="noopener noreferrer">WIP: security: csrf protection #20070</a>.</p><p>However, there is a reason why Grafana thinks this way. The Grafana API only accepts requests with the <code>application/json</code> content type, and this content type cannot be sent via a form. You can only use <code>fetch</code>, and this content type falls under non-simple requests, so it requires a preflight.</p><p>Since there is a preflight, other origin requests should be blocked, so theoretically, there should be no issue.</p><p>But by carefully reading the CORS specification and a small bug in the server, this limitation was successfully bypassed.</p><p>A MIME type consists of three parts: type, subtype, and parameters. We often see <code>application/json</code>, where the type is application, the subtype is json, and there are no parameters.</p><p>However, <code>text/plain; charset=utf-8</code> has a type of text, a subtype of plain, and the parameter <code>charset=utf-8</code>.</p><p>The CORS specification only requires the type and subtype to be one of the following:</p><ol><li>application/x-www-form-urlencoded</li><li>multipart/form-data</li><li>text/plain</li></ol><p>But it does not restrict the content of the parameters.</p><p>Therefore, this content type can be a simple request: <code>text/plain; application/json</code>. <code>application/json</code> is the parameter, and <code>text/plain</code> is the type + subtype, which fully complies with the specification.</p><p>The handling logic on the API side is as follows:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">macaron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ifacePtr </span><span class="token operator" style="color:#393A34">...</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  contentType </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Content-Type&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Method </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;POST&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Method </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PUT&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contentType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> strings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contentType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;form-urlencoded&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">Form</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ifacePtr</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> strings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contentType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;multipart/form-data&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">MultipartForm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ifacePtr</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> strings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contentType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;json&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">Json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ifacePtr</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">Form</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ifacePtr</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here, <code>strings.contains</code> is used directly on the entire content type, so even though the content type we pass in is essentially <code>text/plain</code>, it is treated as a valid JSON by the server due to the parameters.</p><p>After bypassing this limitation, we can use <code>fetch</code> to initiate a CSRF attack from a same-site website.</p><p>Assuming Grafana is hosted at <code>https://grafana.huli.tw</code>, we would need to find at least one XSS vulnerability or gain control over the entire <code>*.huli.tw</code> domain to launch an attack. Although it may be challenging, it is not impossible.</p><p>As I mentioned earlier, this is an attack initiated from the same site, so same-site cookies cannot prevent it. Strictly speaking, if we consider the literal meaning, it cannot be called CSRF because it is not cross-site. However, giving it a new name seems odd.</p><p>You can find the original writeup here: <a href="https://jub0bs.com/posts/2022-02-08-cve-2022-21703-writeup/" target="_blank" rel="noopener noreferrer">CVE-2022-21703: cross-origin request forgery against Grafana</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>In this article, we introduced the new measures that major browsers have recently implemented, which is setting cookies to <code>SameSite=Lax</code> by default. Although this does increase some security, do not think that using this alone can completely prevent CSRF.</p><p>Just like defending against XSS, defending against CSRF also requires multiple layers of protection to ensure that if one line of defense is breached, there are other defenses to hold up. For example, if only same-site cookies are used, it means surrendering when another same-site website is compromised. Instead, it is better to implement additional protection measures such as CSRF tokens, which can at least mitigate the impact when the same-site is compromised.</p><p>Speaking of which, is it easy to gain control over other same-site websites? And what can be done once control is obtained? Everyone can think about these questions, and we will discuss them in the next article.</p><p>References:</p><ol><li><a href="https://www.sjoerdlangkemper.nl/2016/04/14/preventing-csrf-with-samesite-cookie-attribute/" target="_blank" rel="noopener noreferrer">Preventing CSRF with the same-site cookie attribute</a></li><li><a href="http://bobao.360.cn/learning/detail/2844.html" target="_blank" rel="noopener noreferrer">再见，CSRF：讲解set-cookie中的SameSite属性</a></li><li><a href="http://www.cnblogs.com/ziyunfei/p/5637945.html" target="_blank" rel="noopener noreferrer">SameSite Cookie，防止 CSRF 攻击</a></li><li><a href="https://rlilyyy.github.io/2016/07/10/SameSite-Cookie%E2%80%94%E2%80%94%E9%98%B2%E5%BE%A1-CSRF-XSSI/" target="_blank" rel="noopener noreferrer">SameSite——防御 CSRF &amp; XSSI 新机制</a></li><li><a href="https://scotthelme.co.uk/csrf-is-dead/" target="_blank" rel="noopener noreferrer">Cross-Site Request Forgery is dead!</a></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/en/ch4/csrf/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Cross-Site Request Forgery (CSRF) Made Easy</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/en/ch4/subdomain/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">From same-site to main site</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#exploring-the-same-site-cookie" class="table-of-contents__link toc-highlight">Exploring the same-site cookie</a></li><li><a href="#history-of-same-site-cookie" class="table-of-contents__link toc-highlight">History of Same-site cookie</a></li><li><a href="#mid-break-for-reflection" class="table-of-contents__link toc-highlight">Mid-Break for Reflection</a></li><li><a href="#csrf-with-get-requests" class="table-of-contents__link toc-highlight">CSRF with GET Requests</a></li><li><a href="#hidden-rules-of-same-site-cookies" class="table-of-contents__link toc-highlight">Hidden Rules of Same-site Cookies</a></li><li><a href="#is-same-site-cookie-enough-to-prevent-csrf" class="table-of-contents__link toc-highlight">Is Same-site Cookie Enough to Prevent CSRF?</a></li><li><a href="#real-world-example" class="table-of-contents__link toc-highlight">Real-world Example</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/en/assets/js/runtime~main.80dafa6d.js"></script>
<script src="/beyond-xss/en/assets/js/main.a303d294.js"></script>
</body>
</html>