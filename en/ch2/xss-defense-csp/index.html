<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch2/xss-defense-csp" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">The Second Line of Defense Against XSS: CSP | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/en/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/en/ch2/xss-defense-csp/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="google-site-verification" content="O7SjDEO9AQXbxqBWhtUW0FVahHxSrnweMXJxLICpSz4"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="The Second Line of Defense Against XSS: CSP | Beyond XSS"><meta data-rh="true" name="description" content="The first line of defense against XSS is to sanitize user input and ensure that the content is safe. However, it is easier said than done, especially for legacy projects with messy and complex code. It becomes difficult to determine where to make the necessary fixes."><meta data-rh="true" property="og:description" content="The first line of defense against XSS is to sanitize user input and ensure that the content is safe. However, it is easier said than done, especially for legacy projects with messy and complex code. It becomes difficult to determine where to make the necessary fixes."><link data-rh="true" rel="icon" href="/beyond-xss/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/en/ch2/xss-defense-csp/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch2/xss-defense-csp/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch2/xss-defense-csp/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ja/ch2/xss-defense-csp/" hreflang="ja"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch2/xss-defense-csp/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/en/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/en/assets/js/runtime~main.222f121e.js" as="script">
<link rel="preload" href="/beyond-xss/en/assets/js/main.56058cb3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/en/"><div class="navbar__logo"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/en/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS: Explore the Web Front-end Security Universe</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch2/xss-defense-csp/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/beyond-xss/ch2/xss-defense-csp/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-TW">中文（台灣）</a></li><li><a href="/beyond-xss/ja/ch2/xss-defense-csp/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ja">日本語</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/">About This Series</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Chapter 1: Starting with XSS</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch1/browser-security-model/">Browser Security Model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch1/xss-introduction/">Starting with XSS for Frontend Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch1/know-xss-a-bit-more/">Understanding XSS a Bit More</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch1/javascript-protocol/">Dangerous javascript: pseudo protocol</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">Chapter 2: Defense and bypass for XSS </a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch2/xss-defense-sanitization/">The First Line of Defense Against XSS: Sanitization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/en/ch2/xss-defense-csp/">The Second Line of Defense Against XSS: CSP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch2/token-storage/">The Third Line of Defense against XSS: Reducing the Impact Scope</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch2/trust-types/">Latest XSS Defense: Trusted Types and Built-in Sanitizer API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch2/csp-bypass/">Bypassing Your Defenses: Common CSP Bypasses</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch2/mutation-xss/">Bypassing Your Defense: Mutation XSS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch2/universal-xss/">The Most Powerful XSS: Universal XSS</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Chapter 3: Attacks without JavaScript  </a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch3/attack-without-js/">Who says you have to execute JavaScript directly to attack?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch3/prototype-pollution/">Prototype Pollution: Exploiting the Prototype Chain</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch3/dom-clobbering/">Can HTML affect JavaScript? Introduction to DOM clobbering</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch3/csti/">Template Injection in Frontend: CSTI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch3/css-injection/">CSS Injection: Attacking with Just CSS (Part 1)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch3/css-injection-2/">CSS Injection: Attacking with Just CSS (Part 2)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch3/html-attack/">Can You Attack with Just HTML?</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Chapter 4: Cross-site attacks </a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/sop-and-site/">The Essence: Same-origin Policy and Site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cors-intro/">Introduction to Cross-Origin Resource Sharing (CORS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cors-attack/">Cross-Origin Security Issues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/csrf/">Cross-Site Request Forgery (CSRF) Made Easy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/same-site-cookie/">Same-site cookie, the savior of CSRF?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/subdomain/">From same-site to main site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch4/cookie-bomb/">Interesting and Practical Cookie Bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Chapter 5: Other interesting topics  </a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch5/clickjacking/">What You See Is Not What You Get: Clickjacking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch5/mime-sniffing/">Exploiting MIME Sniffing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch5/supply-chain-attack/">Frontend Supply Chain Attacks: Attacking Downstream from Upstream</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch5/web3-attacks/">Web Frontend Attacks in Web3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch5/xsleaks-1/">The Most Interesting Frontend Side-Channel Attack: XSLeaks (Part 1)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/en/ch5/xsleaks-2/">The Most Interesting Frontend Side Channel Attack: XSLeaks (Part 2)</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/summary/">Conclusion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/en/contact/">Contact the Author</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/beyond-xss/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Chapter 2: Defense and bypass for XSS </span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">The Second Line of Defense Against XSS: CSP</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>The Second Line of Defense Against XSS: CSP</h1><p>The first line of defense against XSS is to sanitize user input and ensure that the content is safe. However, it is easier said than done, especially for legacy projects with messy and complex code. It becomes difficult to determine where to make the necessary fixes.</p><p>Furthermore, mistakes can happen while writing code, and there are three main reasons for security issues:</p><ol><li>You are unaware that certain actions can lead to problems.</li><li>You forget that certain actions can lead to problems.</li><li>You are aware that certain actions can lead to problems, but due to project deadlines or instructions from superiors, you choose to ignore them.</li></ol><p>The first reason is similar to the example mentioned earlier with the <code>&lt;a href&gt;</code> tag, where you may not be aware that it can execute code using <code>javascript:</code>.</p><p>The second reason is when you are aware of XSS vulnerabilities and know that output should be encoded, but you forget to do so.</p><p>The third reason is when you knowingly leave a vulnerability unencoded, even though it should be encoded, due to project time constraints or instructions from superiors.</p><p>In the case of the first reason, where you have no idea where to handle the issue or that there is a vulnerability, how can you defend against it? This is why we need the second line of defense.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="automatic-defense-mechanism-content-security-policy">Automatic Defense Mechanism: Content Security Policy<a href="#automatic-defense-mechanism-content-security-policy" class="hash-link" aria-label="Direct link to Automatic Defense Mechanism: Content Security Policy" title="Direct link to Automatic Defense Mechanism: Content Security Policy">​</a></h2><p>CSP, short for Content Security Policy, allows you to establish rules for your web page and inform the browser that only content that adheres to these rules should be allowed. Any content that does not comply should be blocked.</p><p>There are two ways to add CSP to a web page. One is through the HTTP response header <code>Content-Security-Policy</code>, and the other is through the <code>&lt;meta&gt;</code> tag. Since the latter is easier to demonstrate, we will focus on that (although the former is more commonly used, as some rules can only be set through it).</p><p>(There is also a mysterious third method involving the <code>csp</code> attribute of <code>&lt;iframe&gt;</code>, but that is a different topic that we won&#x27;t discuss here.)</p><p>Let&#x27;s look at an example:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&lt;!</span><span class="token doctype doctype-tag" style="color:#999988;font-style:italic">DOCTYPE</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">html</span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">http-equiv</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">Content-Security-Policy</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">script-src </span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">none</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript function" style="color:#d73a49">alert</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript number" style="color:#36acaa">1</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CSP test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above web page, CSP is declared as <code>script-src &#x27;none&#x27;</code>, which means &quot;no script execution is allowed&quot; on this web page. Therefore, the script in the body will not be executed. If you open the DevTools, you will see the following error message:</p><blockquote><p>Refused to execute inline script because it violates the following Content Security Policy directive: &quot;script-src &#x27;none&#x27;&quot;. Either the &#x27;unsafe-inline&#x27; keyword, a hash (&#x27;sha256-bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF+pI=&#x27;), or a nonce (&#x27;nonce-...&#x27;) is required to enable inline execution.</p></blockquote><p>This is why I refer to CSP as the second line of defense. When your first line of defense (handling user input) fails, you can still rely on CSP to prevent the loading of scripts or other resources, effectively preventing XSS vulnerabilities.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rules-of-csp">Rules of CSP<a href="#rules-of-csp" class="hash-link" aria-label="Direct link to Rules of CSP" title="Direct link to Rules of CSP">​</a></h2><p>CSP allows you to define directives along with rules. In the example above, the directive <code>script-src</code> is set to <code>&#x27;none&#x27;</code>, which ultimately blocks the execution of any JavaScript.</p><p>First, it&#x27;s important to note that the directive <code>script-src</code> should not be easily interpreted as &quot;the src attribute of script tags.&quot; Here, the term &quot;script&quot; refers to general &quot;scripts&quot; and not specifically to script tags or src attributes.</p><p>For example, if there is an HTML snippet <code>&lt;a href=&quot;javascript:alert(1)&quot;&gt;click&lt;/a&gt;</code> on the page, which does not have a script tag or src attribute, it will still be blocked by CSP, and an error message will be displayed. This is because <code>script-src &#x27;none&#x27;</code> means &quot;block the execution of any JavaScript,&quot; whether it is through script tags, event handlers, or the javascript: pseudo-protocol.</p><p>So, what are the available directives?</p><p>The most important one is <code>default-src</code>, which represents the default rules. For example, if <code>script-src</code> is not set, the rules from <code>default-src</code> will be used. However, it&#x27;s important to note that some directives do not fallback to <code>default-src</code>, such as <code>base-uri</code> or <code>form-action</code>. You can find the complete list here: <a href="https://content-security-policy.com/default-src/" target="_blank" rel="noopener noreferrer">The default-src Directive</a></p><p>Other commonly used directives include:</p><ol><li><code>script-src</code>: Manages JavaScript</li><li><code>style-src</code>: Manages CSS</li><li><code>font-src</code>: Manages fonts</li><li><code>img-src</code>: Manages images</li><li><code>connect-src</code>: Manages connections (fetch, XMLHttpRequest, WebSocket, etc.)</li><li><code>media-src</code>: Manages videos and audios</li><li><code>frame-src</code>: Manages frames and iframes</li><li><code>base-uri</code>: Manages the use of <code>&lt;base&gt;</code></li><li><code>form-action</code>: Manages form actions</li><li><code>frame-ancestors</code>: Manages which pages can embed the current page</li><li><code>report-uri</code>: To be discussed later</li><li><code>navigate-to</code>: Manages where the page can navigate to</li></ol><p>There are many types, right? And this list is subject to change. For example, the <code>navigate-to</code> at the end is a newer feature that is not yet supported by current browsers.</p><p>In addition to these, there are actually many more, but I didn&#x27;t specifically mention the less commonly used ones. If you&#x27;re interested, you can refer to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy" target="_blank" rel="noopener noreferrer">MDN: Content-Security-Policy</a> or <a href="https://content-security-policy.com/" target="_blank" rel="noopener noreferrer">Content Security Policy Reference</a> for more information.</p><p>So, what are the possible rules for each of these? Depending on the directives, different rules can be used.</p><p>The commonly used rules are as follows:</p><ol><li><code>*</code> - Allows all URLs except <code>data:</code>, <code>blob:</code>, and <code>filesystem:</code>.</li><li><code>&#x27;none&#x27;</code> - Doesn&#x27;t allow anything.</li><li><code>&#x27;self&#x27;</code> - Only allows same-origin resources.</li><li><code>https:</code> - Allows all HTTPS resources.</li><li><code>example.com</code> - Allows specific domains (both HTTP and HTTPS).</li><li><code>https://example.com</code> - Allows specific origins (HTTPS only).</li></ol><p>For example, <code>script-src *</code> is basically equivalent to not setting any rule(allows all URLs, but it&#x27;s worth noting that inline script is still blocked), while <code>script-src &#x27;none&#x27;</code> completely blocks the execution of any JavaScript.</p><p>Furthermore, some rules can be combined. In practice, you often see rules like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">script-src &#x27;self&#x27; cdn.example.com www.google-analytics.com *.facebook.net</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Sometimes scripts are hosted on the same origin, so <code>self</code> is needed. Some scripts are hosted on a CDN, so <code>cdn.example.com</code> is required. And because Google Analytics and Facebook SDK are used, <code>www.google-analytics.com *.facebook.net</code> is needed to load their JavaScript.</p><p>The complete CSP is a combination of these rules, with directives separated by <code>;</code>, like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">default-src &#x27;none&#x27;; script-src &#x27;self&#x27; cdn.example.com www.google-analytics.com *.facebook.net; img-src *;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Through CSP, we can inform the browser which resources are allowed to be loaded and which are not. Even if an attacker finds an injection point, they may not be able to execute JavaScript, thus mitigating the impact of an XSS vulnerability (although it still needs to be fixed, but the risk is smaller).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rules-for-script-src">Rules for script-src<a href="#rules-for-script-src" class="hash-link" aria-label="Direct link to Rules for script-src" title="Direct link to Rules for script-src">​</a></h2><p>In addition to specifying the URLs of the resources to be loaded, there are other rules that can be used.</p><p>For example, after setting CSP, inline scripts and <code>eval</code> are blocked by default. The following inline scripts are blocked:</p><ol><li>Code directly placed inside <code>&lt;script&gt;</code> tags (should be loaded from an external source using <code>&lt;script src&gt;</code>)</li><li>Event handlers written in HTML, such as <code>onclick</code></li><li>The <code>javascript:</code> pseudo-protocol</li></ol><p>To allow the use of inline scripts, the <code>&#x27;unsafe-inline&#x27;</code> rule needs to be added.</p><p>And if you want to execute code as if it were <code>eval</code>, you need to add the <code>&#x27;unsafe-eval&#x27;</code> rule. Some people may know that <code>setTimeout</code> can also execute code as a string, like this:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;alert(1)&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similarly, <code>setInterval</code>, <code>Function</code>, and others can achieve the same thing, but they all require the <code>&#x27;unsafe-eval&#x27;</code> rule to be used.</p><p>In addition to these, there is also <code>&#x27;nonce-xxx&#x27;</code>, which means generating a random string on the backend, for example, <code>a2b5zsa19c</code>. Then, a script tag with <code>nonce=a2b5zsa19c</code> can be loaded:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- Allowed --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">nonce</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">a2b5zsa19c</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript function" style="color:#d73a49">alert</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript number" style="color:#36acaa">1</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- Not allowed --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript function" style="color:#d73a49">alert</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript number" style="color:#36acaa">1</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There is also a similar <code>&#x27;sha256-abc...&#x27;</code> rule, which allows specific inline scripts based on their hash. For example, if we take <code>alert(1)</code> and calculate its sha256 hash, we get a binary value that, when base64 encoded, becomes <code>bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF+pI=</code>. Therefore, in the example below, only the script with the exact content of <code>alert(1)</code> will be loaded, while others will not be loaded:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&lt;!</span><span class="token doctype doctype-tag" style="color:#999988;font-style:italic">DOCTYPE</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">html</span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">http-equiv</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">Content-Security-Policy</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">script-src </span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">sha256-bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF+pI=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- Allowed --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript function" style="color:#d73a49">alert</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript number" style="color:#36acaa">1</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- Not Allowed --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript function" style="color:#d73a49">alert</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript number" style="color:#36acaa">2</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- An extra space is also not allowed because it results in a different hash value--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript function" style="color:#d73a49">alert</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript number" style="color:#36acaa">1</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, there is one more that may be used, <code>&#x27;strict-dynamic&#x27;</code>, which means: &quot;Scripts that comply with the rules can load other scripts without being restricted by CSP.&quot; Like this:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&lt;!</span><span class="token doctype doctype-tag" style="color:#999988;font-style:italic">DOCTYPE</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">html</span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">http-equiv</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">Content-Security-Policy</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">script-src </span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">nonce-rjg103rj1298e</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c"> </span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">strict-dynamic</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">nonce</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">rjg103rj1298e</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> element </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">createElement</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;script&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    element</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">src</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;https://example.com&#x27;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">body</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">appendChild</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">element</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the CSP we set, only <code>nonce-rjg103rj1298e</code> is allowed for scripts, and no other sources are allowed. However, scripts added from within <code>&lt;script nonce=rjg103rj1298e&gt;</code> are not restricted and can dynamically add scripts from other sources. This is the function of <code>&#x27;strict-dynamic&#x27;</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-determine-the-csp-rules">How to determine the CSP rules?<a href="#how-to-determine-the-csp-rules" class="hash-link" aria-label="Direct link to How to determine the CSP rules?" title="Direct link to How to determine the CSP rules?">​</a></h2><p>When setting up CSP, it usually starts with <code>default-src &#x27;self&#x27;</code>, allowing same-origin resources by default.</p><p>Next, let&#x27;s handle the most important scripts. Usually, the top priority is to avoid using <code>&#x27;unsafe-inline&#x27;</code> and <code>&#x27;unsafe-eval&#x27;</code>, as having these two doesn&#x27;t make much difference compared to not having CSP at all.</p><p>What is the purpose of adding CSP? It is to serve as the second line of defense against XSS attacks. However, if <code>&#x27;unsafe-inline&#x27;</code> is added, it undermines this defense line, as simply inserting <code>&lt;svg onload=alert(1)&gt;</code> can execute code.</p><p>But in reality, there are usually some existing inline scripts that force us to add <code>unsafe-inline</code>. Here, I will introduce a common approach. For example, with Google Analytics, they will ask you to add the following code to your webpage:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">async</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript dom variable" style="color:#36acaa">window</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">dataLayer</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">window</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">dataLayer</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">||</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">[</span><span class="token script language-javascript punctuation" style="color:#393A34">]</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">gtag</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript">dataLayer</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">push</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">arguments</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript function" style="color:#d73a49">gtag</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;js&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword" style="color:#00009f">new</span><span class="token script language-javascript"> </span><span class="token script language-javascript class-name">Date</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript function" style="color:#d73a49">gtag</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;config&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;UA-XXXXXXXX-X&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is the inline script we want to avoid. So, what can we do? The official documentation provided by Google, <a href="https://developers.google.com/tag-platform/tag-manager/csp?hl=en" target="_blank" rel="noopener noreferrer">Using a code management tool with Content Security Policy</a>, mentions two solutions:</p><ol><li>Add a nonce to that specific script.</li><li>Calculate the hash of that script and add a rule like <code>sha256-xxx</code>.</li></ol><p>Both of these solutions allow specific inline scripts to execute without relying on the wide-open permission of <code>&#x27;unsafe-inline&#x27;</code>. In addition, the official documentation also reminds us that if we want to use the &quot;Custom JavaScript Variable&quot; feature, we must enable <code>&#x27;unsafe-eval&#x27;</code> for it to work.</p><p>If you are unsure whether your CSP is secure, you can use a website provided by Google called <a href="https://csp-evaluator.withgoogle.com/" target="_blank" rel="noopener noreferrer">CSP Evaluator</a>. It will detect any errors in your CSP and evaluate its security, as shown in the following image:</p><p><img loading="lazy" src="/beyond-xss/en/assets/images/07-01-6035cb6d2134c891bf72b92ea09093b7.png" width="1620" height="1296" class="img_ev3q"></p><p>Although it was mentioned earlier that a poorly configured CSP is similar to not having one at all, it is still better to have a configuration. After all, taking the first step is important. Many companies may not have known about CSP in the past, so adding it is commendable, and improvements can be made gradually.</p><p>In the first half of the article, there was a mention of a directive called &quot;report-uri,&quot; which is a very considerate feature. If CSP is not properly configured, it can potentially block normal resources, causing the website to malfunction or certain features to break. This would be a loss.</p><p>Therefore, there is another header called <code>Content-Security-Policy-Report-Only</code>, which means you can set CSP but it won&#x27;t actually block anything. Instead, it will send a report to a specified URL when a resource that violates the rules is loaded.</p><p>With this feature, we can observe any violations of CSP and check if there are any misconfigurations by examining the logs. Once everything is confirmed to be fine, we can switch to using <code>Content-Security-Policy</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-others-configure-their-csp">How do others configure their CSP?<a href="#how-do-others-configure-their-csp" class="hash-link" aria-label="Direct link to How do others configure their CSP?" title="Direct link to How do others configure their CSP?">​</a></h2><p>Have you ever seen a long string of CSP?</p><p>Let&#x27;s take a look at the CSP on the GitHub homepage to get a sense of what a long string looks like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">default-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;none&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">base-uri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;self&#x27;; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">child-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.com/assets-cdn/worker/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gist.github.com/assets-cdn/worker/;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connect-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;self&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uploads.github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  objects-origin.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  www.githubstatus.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  collector.github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  raw.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  api.github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github-cloud.s3.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github-production-repository-file-5c1aeb.s3.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github-production-upload-manifest-file-7fdce7.s3.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github-production-user-asset-6210df.s3.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cdn.optimizely.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  logx.optimizely.com/v1/events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.actions.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  productionresultssa0.blob.core.windows.net/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  productionresultssa1.blob.core.windows.net/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  productionresultssa2.blob.core.windows.net/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  productionresultssa3.blob.core.windows.net/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  productionresultssa4.blob.core.windows.net/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wss://*.actions.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github-production-repository-image-32fea6.s3.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github-production-release-asset-2e65be.s3.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  insights.github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wss://alive.github.com github.githubassets.com; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">font-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.githubassets.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">form-action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;self&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gist.github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  objects-origin.githubusercontent.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frame-ancestors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;none&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">frame-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  viewscreen.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  notebooks.githubusercontent.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;self&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.githubassets.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  media.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  camo.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  identicons.github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  avatars.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github-cloud.s3.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  objects.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  objects-origin.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secured-user-images.githubusercontent.com/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user-images.githubusercontent.com/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private-user-images.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opengraph.githubassets.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github-production-user-asset-6210df.s3.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  customer-stories-feed.github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spotlights-feed.github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.githubusercontent.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">manifest-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;self&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">media-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user-images.githubusercontent.com/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secured-user-images.githubusercontent.com/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private-user-images.githubusercontent.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.githubassets.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">script-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.githubassets.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">style-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;unsafe-inline&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.githubassets.com;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upgrade-insecure-requests;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  github.com/assets-cdn/worker/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gist.github.com/assets-cdn/worker/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Basically, it includes various possible configurations. As for the scripts we are most concerned about, only <code>github.githubassets.com;</code> is allowed, which is a secure way of configuring it.</p><p>GitHub&#x27;s bug bounty program also has a special category called <a href="https://bounty.github.com/targets/csp.html" target="_blank" rel="noopener noreferrer">GitHub CSP</a>. If you can bypass CSP and execute code, even if you haven&#x27;t found a place to inject HTML, it still counts.</p><p>Now let&#x27;s look at Facebook:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">default-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  blob:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;self&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;wasm-unsafe-eval&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">script-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.fbcdn.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.facebook.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.google-analytics.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.google.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  127.0.0.1:*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;unsafe-inline&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  blob:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;self&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;wasm-unsafe-eval&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">style-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  blob:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;unsafe-inline&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connect-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secure.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dashi.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dashi-pc.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  graph-video.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  streaming-graph.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  z-m-graph.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  z-p3-graph.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  z-p4-graph.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rupload.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  upload.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vupload-edge.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vupload2.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  z-p3-upload.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  z-upload.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  graph.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;self&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.fbcdn.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wss://*.fbcdn.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  attachment.fbsbx.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  blob:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.cdninstagram.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.up.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wss://edge-chat-latest.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wss://edge-chat.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  edge-chat.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  edge-chat-latest.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wss://gateway.facebook.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *.facebook.com/rsrc.php/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  https://api.mapbox.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  https://*.tiles.mapbox.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">block-all-mixed-content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upgrade-insecure-requests;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Although it is also a long string, you can notice that <code>&#x27;unsafe-inline&#x27;</code> is enabled for scripts, which is a less secure approach. If you paste this CSP into the CSP Evaluator mentioned earlier, it will show a lot of red flags:</p><p><img loading="lazy" src="/beyond-xss/en/assets/images/07-02-1857ab161ed3a5dbe854f4574ab9f763.png" width="1618" height="1482" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>I personally recommend setting up CSP. Once it is configured, it adds an extra layer of defense, giving us a chance to mitigate any issues. By blocking XSS payloads from attackers through CSP, we can minimize the damage.</p><p>Moreover, the barrier to entry is not high. You can start with the &quot;report only&quot; mode, observe and adjust the CSP rules for your website, and make sure it doesn&#x27;t affect regular users before going live with it.</p><p>Finally, let&#x27;s have a little quiz, which will be answered in future articles.</p><p>After reading this article, Bob looked back at his own project and found that all JavaScript files come from <code>https://unpkg.com</code> packages. Therefore, he added the following CSP. What is the problem with the <code>script-src</code> part?</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Content-Security-Policy: script-src https://unpkg.com;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/en/ch2/xss-defense-sanitization/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">The First Line of Defense Against XSS: Sanitization</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/en/ch2/token-storage/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">The Third Line of Defense against XSS: Reducing the Impact Scope</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#automatic-defense-mechanism-content-security-policy" class="table-of-contents__link toc-highlight">Automatic Defense Mechanism: Content Security Policy</a></li><li><a href="#rules-of-csp" class="table-of-contents__link toc-highlight">Rules of CSP</a></li><li><a href="#rules-for-script-src" class="table-of-contents__link toc-highlight">Rules for script-src</a></li><li><a href="#how-to-determine-the-csp-rules" class="table-of-contents__link toc-highlight">How to determine the CSP rules?</a></li><li><a href="#how-do-others-configure-their-csp" class="table-of-contents__link toc-highlight">How do others configure their CSP?</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/en/assets/js/runtime~main.222f121e.js"></script>
<script src="/beyond-xss/en/assets/js/main.56058cb3.js"></script>
</body>
</html>