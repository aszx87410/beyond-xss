"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[857],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),u=c(n),h=o,m=u["".concat(l,".").concat(h)]||u[h]||d[h]||i;return n?a.createElement(m,s(s({ref:t},p),{},{components:n})):a.createElement(m,s({ref:t},p))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,s=new Array(i);s[0]=h;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r[u]="string"==typeof e?e:o,s[1]=r;for(var c=2;c<i;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},3729:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>c});var a=n(7462),o=(n(7294),n(3905));const i={sidebar_position:7},s="The Second Line of Defense Against XSS: CSP",r={unversionedId:"ch2/xss-defense-csp",id:"ch2/xss-defense-csp",title:"The Second Line of Defense Against XSS: CSP",description:"The first line of defense against XSS is to sanitize user input and ensure that the content is safe. However, it is easier said than done, especially for legacy projects with messy and complex code. It becomes difficult to determine where to make the necessary fixes.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/ch2/07-xss-defense-csp.md",sourceDirName:"ch2",slug:"/ch2/xss-defense-csp",permalink:"/beyond-xss/en/ch2/xss-defense-csp",draft:!1,tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"The First Line of Defense Against XSS: Sanitization",permalink:"/beyond-xss/en/ch2/xss-defense-sanitization"},next:{title:"The Third Line of Defense against XSS: Reducing the Impact Scope",permalink:"/beyond-xss/en/ch2/token-storage"}},l={},c=[{value:"Automatic Defense Mechanism: Content Security Policy",id:"automatic-defense-mechanism-content-security-policy",level:2},{value:"Rules of CSP",id:"rules-of-csp",level:2},{value:"Rules for script-src",id:"rules-for-script-src",level:2},{value:"How to determine the CSP rules?",id:"how-to-determine-the-csp-rules",level:2},{value:"How do others configure their CSP?",id:"how-do-others-configure-their-csp",level:2},{value:"Conclusion",id:"conclusion",level:2}],p={toc:c},u="wrapper";function d(e){let{components:t,...i}=e;return(0,o.kt)(u,(0,a.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"the-second-line-of-defense-against-xss-csp"},"The Second Line of Defense Against XSS: CSP"),(0,o.kt)("p",null,"The first line of defense against XSS is to sanitize user input and ensure that the content is safe. However, it is easier said than done, especially for legacy projects with messy and complex code. It becomes difficult to determine where to make the necessary fixes."),(0,o.kt)("p",null,"Furthermore, mistakes can happen while writing code, and there are three main reasons for security issues:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"You are unaware that certain actions can lead to problems."),(0,o.kt)("li",{parentName:"ol"},"You forget that certain actions can lead to problems."),(0,o.kt)("li",{parentName:"ol"},"You are aware that certain actions can lead to problems, but due to project deadlines or instructions from superiors, you choose to ignore them.")),(0,o.kt)("p",null,"The first reason is similar to the example mentioned earlier with the ",(0,o.kt)("inlineCode",{parentName:"p"},"<a href>")," tag, where you may not be aware that it can execute code using ",(0,o.kt)("inlineCode",{parentName:"p"},"javascript:"),"."),(0,o.kt)("p",null,"The second reason is when you are aware of XSS vulnerabilities and know that output should be encoded, but you forget to do so."),(0,o.kt)("p",null,"The third reason is when you knowingly leave a vulnerability unencoded, even though it should be encoded, due to project time constraints or instructions from superiors."),(0,o.kt)("p",null,"In the case of the first reason, where you have no idea where to handle the issue or that there is a vulnerability, how can you defend against it? This is why we need the second line of defense."),(0,o.kt)("h2",{id:"automatic-defense-mechanism-content-security-policy"},"Automatic Defense Mechanism: Content Security Policy"),(0,o.kt)("p",null,"CSP, short for Content Security Policy, allows you to establish rules for your web page and inform the browser that only content that adheres to these rules should be allowed. Any content that does not comply should be blocked."),(0,o.kt)("p",null,"There are two ways to add CSP to a web page. One is through the HTTP response header ",(0,o.kt)("inlineCode",{parentName:"p"},"Content-Security-Policy"),", and the other is through the ",(0,o.kt)("inlineCode",{parentName:"p"},"<meta>")," tag. Since the latter is easier to demonstrate, we will focus on that (although the former is more commonly used, as some rules can only be set through it)."),(0,o.kt)("p",null,"(There is also a mysterious third method involving the ",(0,o.kt)("inlineCode",{parentName:"p"},"csp")," attribute of ",(0,o.kt)("inlineCode",{parentName:"p"},"<iframe>"),", but that is a different topic that we won't discuss here.)"),(0,o.kt)("p",null,"Let's look at an example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<head>\n  <meta http-equiv="Content-Security-Policy" content="script-src \'none\'">\n</head>\n<body>\n  <script>alert(1)<\/script>\n  CSP test\n</body>\n</html>\n')),(0,o.kt)("p",null,"In the above web page, CSP is declared as ",(0,o.kt)("inlineCode",{parentName:"p"},"script-src 'none'"),', which means "no script execution is allowed" on this web page. Therefore, the script in the body will not be executed. If you open the DevTools, you will see the following error message:'),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Refused to execute inline script because it violates the following Content Security Policy directive: \"script-src 'none'\". Either the 'unsafe-inline' keyword, a hash ('sha256-bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF+pI='), or a nonce ('nonce-...') is required to enable inline execution.")),(0,o.kt)("p",null,"This is why I refer to CSP as the second line of defense. When your first line of defense (handling user input) fails, you can still rely on CSP to prevent the loading of scripts or other resources, effectively preventing XSS vulnerabilities."),(0,o.kt)("h2",{id:"rules-of-csp"},"Rules of CSP"),(0,o.kt)("p",null,"CSP allows you to define directives along with rules. In the example above, the directive ",(0,o.kt)("inlineCode",{parentName:"p"},"script-src")," is set to ",(0,o.kt)("inlineCode",{parentName:"p"},"'none'"),", which ultimately blocks the execution of any JavaScript."),(0,o.kt)("p",null,"First, it's important to note that the directive ",(0,o.kt)("inlineCode",{parentName:"p"},"script-src"),' should not be easily interpreted as "the src attribute of script tags." Here, the term "script" refers to general "scripts" and not specifically to script tags or src attributes.'),(0,o.kt)("p",null,"For example, if there is an HTML snippet ",(0,o.kt)("inlineCode",{parentName:"p"},'<a href="javascript:alert(1)">click</a>')," on the page, which does not have a script tag or src attribute, it will still be blocked by CSP, and an error message will be displayed. This is because ",(0,o.kt)("inlineCode",{parentName:"p"},"script-src 'none'"),' means "block the execution of any JavaScript," whether it is through script tags, event handlers, or the javascript: pseudo-protocol.'),(0,o.kt)("p",null,"So, what are the available directives?"),(0,o.kt)("p",null,"The most important one is ",(0,o.kt)("inlineCode",{parentName:"p"},"default-src"),", which represents the default rules. For example, if ",(0,o.kt)("inlineCode",{parentName:"p"},"script-src")," is not set, the rules from ",(0,o.kt)("inlineCode",{parentName:"p"},"default-src")," will be used. However, it's important to note that some directives do not fallback to ",(0,o.kt)("inlineCode",{parentName:"p"},"default-src"),", such as ",(0,o.kt)("inlineCode",{parentName:"p"},"base-uri")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"form-action"),". You can find the complete list here: ",(0,o.kt)("a",{parentName:"p",href:"https://content-security-policy.com/default-src/"},"The default-src Directive")),(0,o.kt)("p",null,"Other commonly used directives include:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"script-src"),": Manages JavaScript"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"style-src"),": Manages CSS"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"font-src"),": Manages fonts"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"img-src"),": Manages images"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"connect-src"),": Manages connections (fetch, XMLHttpRequest, WebSocket, etc.)"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"media-src"),": Manages videos and audios"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"frame-src"),": Manages frames and iframes"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"base-uri"),": Manages the use of ",(0,o.kt)("inlineCode",{parentName:"li"},"<base>")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"form-action"),": Manages form actions"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"frame-ancestors"),": Manages which pages can embed the current page"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"report-uri"),": To be discussed later"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"navigate-to"),": Manages where the page can navigate to")),(0,o.kt)("p",null,"There are many types, right? And this list is subject to change. For example, the ",(0,o.kt)("inlineCode",{parentName:"p"},"navigate-to")," at the end is a newer feature that is not yet supported by current browsers."),(0,o.kt)("p",null,"In addition to these, there are actually many more, but I didn't specifically mention the less commonly used ones. If you're interested, you can refer to ",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy"},"MDN: Content-Security-Policy")," or ",(0,o.kt)("a",{parentName:"p",href:"https://content-security-policy.com/"},"Content Security Policy Reference")," for more information."),(0,o.kt)("p",null,"So, what are the possible rules for each of these? Depending on the directives, different rules can be used."),(0,o.kt)("p",null,"The commonly used rules are as follows:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"*")," - Allows all URLs except ",(0,o.kt)("inlineCode",{parentName:"li"},"data:"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"blob:"),", and ",(0,o.kt)("inlineCode",{parentName:"li"},"filesystem:"),"."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"'none'")," - Doesn't allow anything."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"'self'")," - Only allows same-origin resources."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"https:")," - Allows all HTTPS resources."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"example.com")," - Allows specific domains (both HTTP and HTTPS)."),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"https://example.com")," - Allows specific origins (HTTPS only).")),(0,o.kt)("p",null,"For example, ",(0,o.kt)("inlineCode",{parentName:"p"},"script-src *")," is basically equivalent to not setting any rule(allows all URLs, but it's worth noting that inline script is still blocked), while ",(0,o.kt)("inlineCode",{parentName:"p"},"script-src 'none'")," completely blocks the execution of any JavaScript."),(0,o.kt)("p",null,"Furthermore, some rules can be combined. In practice, you often see rules like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"script-src 'self' cdn.example.com www.google-analytics.com *.facebook.net\n")),(0,o.kt)("p",null,"Sometimes scripts are hosted on the same origin, so ",(0,o.kt)("inlineCode",{parentName:"p"},"self")," is needed. Some scripts are hosted on a CDN, so ",(0,o.kt)("inlineCode",{parentName:"p"},"cdn.example.com")," is required. And because Google Analytics and Facebook SDK are used, ",(0,o.kt)("inlineCode",{parentName:"p"},"www.google-analytics.com *.facebook.net")," is needed to load their JavaScript."),(0,o.kt)("p",null,"The complete CSP is a combination of these rules, with directives separated by ",(0,o.kt)("inlineCode",{parentName:"p"},";"),", like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"default-src 'none'; script-src 'self' cdn.example.com www.google-analytics.com *.facebook.net; img-src *;\n")),(0,o.kt)("p",null,"Through CSP, we can inform the browser which resources are allowed to be loaded and which are not. Even if an attacker finds an injection point, they may not be able to execute JavaScript, thus mitigating the impact of an XSS vulnerability (although it still needs to be fixed, but the risk is smaller)."),(0,o.kt)("h2",{id:"rules-for-script-src"},"Rules for script-src"),(0,o.kt)("p",null,"In addition to specifying the URLs of the resources to be loaded, there are other rules that can be used."),(0,o.kt)("p",null,"For example, after setting CSP, inline scripts and ",(0,o.kt)("inlineCode",{parentName:"p"},"eval")," are blocked by default. The following inline scripts are blocked:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Code directly placed inside ",(0,o.kt)("inlineCode",{parentName:"li"},"<script>")," tags (should be loaded from an external source using ",(0,o.kt)("inlineCode",{parentName:"li"},"<script src>"),")"),(0,o.kt)("li",{parentName:"ol"},"Event handlers written in HTML, such as ",(0,o.kt)("inlineCode",{parentName:"li"},"onclick")),(0,o.kt)("li",{parentName:"ol"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"javascript:")," pseudo-protocol")),(0,o.kt)("p",null,"To allow the use of inline scripts, the ",(0,o.kt)("inlineCode",{parentName:"p"},"'unsafe-inline'")," rule needs to be added."),(0,o.kt)("p",null,"And if you want to execute code as if it were ",(0,o.kt)("inlineCode",{parentName:"p"},"eval"),", you need to add the ",(0,o.kt)("inlineCode",{parentName:"p"},"'unsafe-eval'")," rule. Some people may know that ",(0,o.kt)("inlineCode",{parentName:"p"},"setTimeout")," can also execute code as a string, like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"setTimeout('alert(1)')\n")),(0,o.kt)("p",null,"Similarly, ",(0,o.kt)("inlineCode",{parentName:"p"},"setInterval"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"Function"),", and others can achieve the same thing, but they all require the ",(0,o.kt)("inlineCode",{parentName:"p"},"'unsafe-eval'")," rule to be used."),(0,o.kt)("p",null,"In addition to these, there is also ",(0,o.kt)("inlineCode",{parentName:"p"},"'nonce-xxx'"),", which means generating a random string on the backend, for example, ",(0,o.kt)("inlineCode",{parentName:"p"},"a2b5zsa19c"),". Then, a script tag with ",(0,o.kt)("inlineCode",{parentName:"p"},"nonce=a2b5zsa19c")," can be loaded:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},"\x3c!-- Allowed --\x3e\n<script nonce=a2b5zsa19c>\n  alert(1)\n<\/script>\n\n\x3c!-- Not allowed --\x3e\n<script>\n  alert(1)\n<\/script>\n")),(0,o.kt)("p",null,"There is also a similar ",(0,o.kt)("inlineCode",{parentName:"p"},"'sha256-abc...'")," rule, which allows specific inline scripts based on their hash. For example, if we take ",(0,o.kt)("inlineCode",{parentName:"p"},"alert(1)")," and calculate its sha256 hash, we get a binary value that, when base64 encoded, becomes ",(0,o.kt)("inlineCode",{parentName:"p"},"bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF+pI="),". Therefore, in the example below, only the script with the exact content of ",(0,o.kt)("inlineCode",{parentName:"p"},"alert(1)")," will be loaded, while others will not be loaded:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<head>\n  <meta http-equiv="Content-Security-Policy" content="script-src \'sha256-bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF+pI=\'">\n</head>\n<body>\n  \x3c!-- Allowed --\x3e\n  <script>alert(1)<\/script>\n\n  \x3c!-- Not Allowed --\x3e\n  <script>alert(2)<\/script>\n\n  \x3c!-- An extra space is also not allowed because it results in a different hash value--\x3e\n  <script>alert(1) <\/script>\n</body>\n</html>\n')),(0,o.kt)("p",null,"Finally, there is one more that may be used, ",(0,o.kt)("inlineCode",{parentName:"p"},"'strict-dynamic'"),', which means: "Scripts that comply with the rules can load other scripts without being restricted by CSP." Like this:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},"<!DOCTYPE html>\n<html>\n<head>\n  <meta http-equiv=\"Content-Security-Policy\" content=\"script-src 'nonce-rjg103rj1298e' 'strict-dynamic'\">\n</head>\n<body>\n  <script nonce=rjg103rj1298e>\n    const element = document.createElement('script')\n    element.src = 'https://example.com'\n    document.body.appendChild(element)\n  <\/script>\n</body>\n</html>\n")),(0,o.kt)("p",null,"In the CSP we set, only ",(0,o.kt)("inlineCode",{parentName:"p"},"nonce-rjg103rj1298e")," is allowed for scripts, and no other sources are allowed. However, scripts added from within ",(0,o.kt)("inlineCode",{parentName:"p"},"<script nonce=rjg103rj1298e>")," are not restricted and can dynamically add scripts from other sources. This is the function of ",(0,o.kt)("inlineCode",{parentName:"p"},"'strict-dynamic'"),"."),(0,o.kt)("h2",{id:"how-to-determine-the-csp-rules"},"How to determine the CSP rules?"),(0,o.kt)("p",null,"When setting up CSP, it usually starts with ",(0,o.kt)("inlineCode",{parentName:"p"},"default-src 'self'"),", allowing same-origin resources by default."),(0,o.kt)("p",null,"Next, let's handle the most important scripts. Usually, the top priority is to avoid using ",(0,o.kt)("inlineCode",{parentName:"p"},"'unsafe-inline'")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"'unsafe-eval'"),", as having these two doesn't make much difference compared to not having CSP at all."),(0,o.kt)("p",null,"What is the purpose of adding CSP? It is to serve as the second line of defense against XSS attacks. However, if ",(0,o.kt)("inlineCode",{parentName:"p"},"'unsafe-inline'")," is added, it undermines this defense line, as simply inserting ",(0,o.kt)("inlineCode",{parentName:"p"},"<svg onload=alert(1)>")," can execute code."),(0,o.kt)("p",null,"But in reality, there are usually some existing inline scripts that force us to add ",(0,o.kt)("inlineCode",{parentName:"p"},"unsafe-inline"),". Here, I will introduce a common approach. For example, with Google Analytics, they will ask you to add the following code to your webpage:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},"<script async src=\"https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X\"><\/script>\n<script>\n  window.dataLayer = window.dataLayer || [];\n  function gtag(){dataLayer.push(arguments);}\n  gtag('js', new Date());\n\n  gtag('config', 'UA-XXXXXXXX-X');\n<\/script>\n")),(0,o.kt)("p",null,"This is the inline script we want to avoid. So, what can we do? The official documentation provided by Google, ",(0,o.kt)("a",{parentName:"p",href:"https://developers.google.com/tag-platform/tag-manager/csp?hl=en"},"Using a code management tool with Content Security Policy"),", mentions two solutions:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Add a nonce to that specific script."),(0,o.kt)("li",{parentName:"ol"},"Calculate the hash of that script and add a rule like ",(0,o.kt)("inlineCode",{parentName:"li"},"sha256-xxx"),".")),(0,o.kt)("p",null,"Both of these solutions allow specific inline scripts to execute without relying on the wide-open permission of ",(0,o.kt)("inlineCode",{parentName:"p"},"'unsafe-inline'"),'. In addition, the official documentation also reminds us that if we want to use the "Custom JavaScript Variable" feature, we must enable ',(0,o.kt)("inlineCode",{parentName:"p"},"'unsafe-eval'")," for it to work."),(0,o.kt)("p",null,"If you are unsure whether your CSP is secure, you can use a website provided by Google called ",(0,o.kt)("a",{parentName:"p",href:"https://csp-evaluator.withgoogle.com/"},"CSP Evaluator"),". It will detect any errors in your CSP and evaluate its security, as shown in the following image:"),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(8527).Z,width:"1620",height:"1296"})),(0,o.kt)("p",null,"Although it was mentioned earlier that a poorly configured CSP is similar to not having one at all, it is still better to have a configuration. After all, taking the first step is important. Many companies may not have known about CSP in the past, so adding it is commendable, and improvements can be made gradually."),(0,o.kt)("p",null,'In the first half of the article, there was a mention of a directive called "report-uri," which is a very considerate feature. If CSP is not properly configured, it can potentially block normal resources, causing the website to malfunction or certain features to break. This would be a loss.'),(0,o.kt)("p",null,"Therefore, there is another header called ",(0,o.kt)("inlineCode",{parentName:"p"},"Content-Security-Policy-Report-Only"),", which means you can set CSP but it won't actually block anything. Instead, it will send a report to a specified URL when a resource that violates the rules is loaded."),(0,o.kt)("p",null,"With this feature, we can observe any violations of CSP and check if there are any misconfigurations by examining the logs. Once everything is confirmed to be fine, we can switch to using ",(0,o.kt)("inlineCode",{parentName:"p"},"Content-Security-Policy"),"."),(0,o.kt)("h2",{id:"how-do-others-configure-their-csp"},"How do others configure their CSP?"),(0,o.kt)("p",null,"Have you ever seen a long string of CSP?"),(0,o.kt)("p",null,"Let's take a look at the CSP on the GitHub homepage to get a sense of what a long string looks like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"default-src\n  'none';\nbase-uri\n  'self'; \nchild-src\n  github.com/assets-cdn/worker/\n  gist.github.com/assets-cdn/worker/;\nconnect-src\n  'self'\n  uploads.github.com\n  objects-origin.githubusercontent.com\n  www.githubstatus.com\n  collector.github.com\n  raw.githubusercontent.com\n  api.github.com\n  github-cloud.s3.amazonaws.com\n  github-production-repository-file-5c1aeb.s3.amazonaws.com\n  github-production-upload-manifest-file-7fdce7.s3.amazonaws.com\n  github-production-user-asset-6210df.s3.amazonaws.com\n  cdn.optimizely.com\n  logx.optimizely.com/v1/events\n  *.actions.githubusercontent.com\n  productionresultssa0.blob.core.windows.net/\n  productionresultssa1.blob.core.windows.net/\n  productionresultssa2.blob.core.windows.net/\n  productionresultssa3.blob.core.windows.net/\n  productionresultssa4.blob.core.windows.net/\n  wss://*.actions.githubusercontent.com\n  github-production-repository-image-32fea6.s3.amazonaws.com\n  github-production-release-asset-2e65be.s3.amazonaws.com\n  insights.github.com\n  wss://alive.github.com github.githubassets.com; \nfont-src\n  github.githubassets.com;\nform-action\n  'self'\n  github.com\n  gist.github.com\n  objects-origin.githubusercontent.com;\nframe-ancestors\n  'none';\nframe-src\n  viewscreen.githubusercontent.com\n  notebooks.githubusercontent.com;\nimg-src\n  'self'\n  data:\n  github.githubassets.com\n  media.githubusercontent.com\n  camo.githubusercontent.com\n  identicons.github.com\n  avatars.githubusercontent.com\n  github-cloud.s3.amazonaws.com\n  objects.githubusercontent.com\n  objects-origin.githubusercontent.com\n  secured-user-images.githubusercontent.com/\n  user-images.githubusercontent.com/\n  private-user-images.githubusercontent.com\n  opengraph.githubassets.com\n  github-production-user-asset-6210df.s3.amazonaws.com\n  customer-stories-feed.github.com\n  spotlights-feed.github.com\n  *.githubusercontent.com;\nmanifest-src\n  'self';\nmedia-src\n  github.com\n  user-images.githubusercontent.com/\n  secured-user-images.githubusercontent.com/\n  private-user-images.githubusercontent.com\n  github.githubassets.com;\nscript-src\n  github.githubassets.com;\nstyle-src\n  'unsafe-inline'\n  github.githubassets.com;\nupgrade-insecure-requests;\nworker-src\n  github.com/assets-cdn/worker/\n  gist.github.com/assets-cdn/worker/\n")),(0,o.kt)("p",null,"Basically, it includes various possible configurations. As for the scripts we are most concerned about, only ",(0,o.kt)("inlineCode",{parentName:"p"},"github.githubassets.com;")," is allowed, which is a secure way of configuring it."),(0,o.kt)("p",null,"GitHub's bug bounty program also has a special category called ",(0,o.kt)("a",{parentName:"p",href:"https://bounty.github.com/targets/csp.html"},"GitHub CSP"),". If you can bypass CSP and execute code, even if you haven't found a place to inject HTML, it still counts."),(0,o.kt)("p",null,"Now let's look at Facebook:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"default-src\n  *\n  data:\n  blob:\n  'self'\n  'wasm-unsafe-eval'\nscript-src\n  *.facebook.com\n  *.fbcdn.net\n  *.facebook.net\n  *.google-analytics.com\n  *.google.com\n  127.0.0.1:*\n  'unsafe-inline'\n  blob:\n  data:\n  'self'\n  'wasm-unsafe-eval'\nstyle-src\n  data:\n  blob:\n  'unsafe-inline'\n  *\nconnect-src\n  secure.facebook.com\n  dashi.facebook.com\n  dashi-pc.facebook.com\n  graph-video.facebook.com\n  streaming-graph.facebook.com\n  z-m-graph.facebook.com\n  z-p3-graph.facebook.com\n  z-p4-graph.facebook.com\n  rupload.facebook.com\n  upload.facebook.com\n  vupload-edge.facebook.com\n  vupload2.facebook.com\n  z-p3-upload.facebook.com\n  z-upload.facebook.com\n  graph.facebook.com\n  'self'\n  *.fbcdn.net\n  wss://*.fbcdn.net\n  attachment.fbsbx.com\n  blob:\n  data:\n  *.cdninstagram.com\n  *.up.facebook.com\n  wss://edge-chat-latest.facebook.com\n  wss://edge-chat.facebook.com\n  edge-chat.facebook.com\n  edge-chat-latest.facebook.com\n  wss://gateway.facebook.com\n  *.facebook.com/rsrc.php/\n  https://api.mapbox.com\n  https://*.tiles.mapbox.com\nblock-all-mixed-content\nupgrade-insecure-requests;\n")),(0,o.kt)("p",null,"Although it is also a long string, you can notice that ",(0,o.kt)("inlineCode",{parentName:"p"},"'unsafe-inline'")," is enabled for scripts, which is a less secure approach. If you paste this CSP into the CSP Evaluator mentioned earlier, it will show a lot of red flags:"),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(6413).Z,width:"1618",height:"1482"})),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"I personally recommend setting up CSP. Once it is configured, it adds an extra layer of defense, giving us a chance to mitigate any issues. By blocking XSS payloads from attackers through CSP, we can minimize the damage."),(0,o.kt)("p",null,'Moreover, the barrier to entry is not high. You can start with the "report only" mode, observe and adjust the CSP rules for your website, and make sure it doesn\'t affect regular users before going live with it.'),(0,o.kt)("p",null,"Finally, let's have a little quiz, which will be answered in future articles."),(0,o.kt)("p",null,"After reading this article, Bob looked back at his own project and found that all JavaScript files come from ",(0,o.kt)("inlineCode",{parentName:"p"},"https://unpkg.com")," packages. Therefore, he added the following CSP. What is the problem with the ",(0,o.kt)("inlineCode",{parentName:"p"},"script-src")," part?"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Content-Security-Policy: script-src https://unpkg.com;\n")))}d.isMDXComponent=!0},8527:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/07-01-6035cb6d2134c891bf72b92ea09093b7.png"},6413:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/07-02-1857ab161ed3a5dbe854f4574ab9f763.png"}}]);