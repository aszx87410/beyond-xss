"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[889],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},h="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),h=c(n),d=i,m=h["".concat(l,".").concat(d)]||h[d]||u[d]||o;return n?a.createElement(m,s(s({ref:t},p),{},{components:n})):a.createElement(m,s({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,s=new Array(o);s[0]=d;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r[h]="string"==typeof e?e:i,s[1]=r;for(var c=2;c<o;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8218:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>c});var a=n(7462),i=(n(7294),n(3905));const o={sidebar_position:25},s="From same-site to main site",r={unversionedId:"ch4/subdomain",id:"ch4/subdomain",title:"From same-site to main site",description:'In the previous post about Grafana attack scenarios, it was mentioned that attackers must first gain control of a same-site website in order to execute subsequent attacks. In this post, let\'s consider a different perspective: "If you have control over a same-site website, what kind of attacks can you perform?" For example, CSRF is a possible attack method.',source:"@site/i18n/en/docusaurus-plugin-content-docs/current/ch4/25-subdomain.md",sourceDirName:"ch4",slug:"/ch4/subdomain",permalink:"/beyond-xss/en/ch4/subdomain",draft:!1,tags:[],version:"current",sidebarPosition:25,frontMatter:{sidebar_position:25},sidebar:"tutorialSidebar",previous:{title:"Same-site cookie, the savior of CSRF?",permalink:"/beyond-xss/en/ch4/same-site-cookie"},next:{title:"Interesting and Practical Cookie Bomb",permalink:"/beyond-xss/en/ch4/cookie-bomb"}},l={},c=[{value:"Subdomain takeover",id:"subdomain-takeover",level:2},{value:"Things You Can Do After Gaining Subdomain Control",id:"things-you-can-do-after-gaining-subdomain-control",level:2},{value:"Exploiting Incorrect Security Assumptions",id:"exploiting-incorrect-security-assumptions",level:2},{value:"Cookie Tossing",id:"cookie-tossing",level:2},{value:"Conclusion",id:"conclusion",level:2}],p={toc:c},h="wrapper";function u(e){let{components:t,...n}=e;return(0,i.kt)(h,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"from-same-site-to-main-site"},"From same-site to main site"),(0,i.kt)("p",null,'In the previous post about Grafana attack scenarios, it was mentioned that attackers must first gain control of a same-site website in order to execute subsequent attacks. In this post, let\'s consider a different perspective: "If you have control over a same-site website, what kind of attacks can you perform?" For example, CSRF is a possible attack method.'),(0,i.kt)("p",null,"This often happens in the world of bug bounty, where websites offer rewards to bounty hunters for actively discovering and reporting vulnerabilities. This allows the website to patch the vulnerabilities before they can be maliciously exploited, benefiting both parties. These bug bounty programs usually have an explanation page that specifies the monetary value for different severity levels of vulnerabilities."),(0,i.kt)("p",null,"In addition, there are also core and non-core websites. For example, vulnerabilities found on the ",(0,i.kt)("inlineCode",{parentName:"p"},"api.huli.tw")," API server are worth more than vulnerabilities found on the ",(0,i.kt)("inlineCode",{parentName:"p"},"2023.campaign.huli.tw")," one-time event page because the former can cause greater impact."),(0,i.kt)("p",null,"Therefore, when a bounty hunter discovers a vulnerability on ",(0,i.kt)("inlineCode",{parentName:"p"},"2023.campaign.huli.tw"),", they may try to further investigate if there is a way to expand the scope of this vulnerability, such as affecting ",(0,i.kt)("inlineCode",{parentName:"p"},"api.huli.tw"),", in order to earn more rewards."),(0,i.kt)("p",null,"Apart from finding XSS on same-site websites, there is another way to control subdomains."),(0,i.kt)("h2",{id:"subdomain-takeover"},"Subdomain takeover"),(0,i.kt)("p",null,"As the name suggests, this vulnerability allows attackers to take over an entire subdomain and gain control over it."),(0,i.kt)("p",null,"Sounds difficult, right? Do you need to gain control of their DNS or infiltrate the company's internal systems to take over a subdomain? Actually, it's not always necessary. In the era of various cloud services, there is a simpler method to try."),(0,i.kt)("p",null,"Amazon S3 is a cloud storage service where you can upload files and set permissions to share them with others. Many people use Amazon S3 to store images or even host entire websites because it provides website hosting functionality. Each storage space in S3 is called a bucket and has a name, which also corresponds to a subdomain provided by S3."),(0,i.kt)("p",null,"For example, if my bucket is named ",(0,i.kt)("inlineCode",{parentName:"p"},"hulitest"),", the subdomain would be: ",(0,i.kt)("inlineCode",{parentName:"p"},"https://hulitest.s3.us-east-1.amazonaws.com"),". Since S3 is convenient and easy to use, it is a good choice for hosting static websites. For example, if a company's architecture separates the frontend and backend completely and does not require server-side rendering, a purely static website can be hosted on S3, eliminating the need to manage the frontend infrastructure."),(0,i.kt)("p",null,"The only problem is that the domain ",(0,i.kt)("inlineCode",{parentName:"p"},"https://hulitest.s3.us-east-1.amazonaws.com")," doesn't look good. Companies usually have their own domain names, and S3 provides the functionality to customize the domain, which is also quite simple."),(0,i.kt)("p",null,"First, change the bucket name to the desired domain, for example, ",(0,i.kt)("inlineCode",{parentName:"p"},"campaign.huli.tw"),"."),(0,i.kt)("p",null,"Second, add a CNAME record in DNS, pointing ",(0,i.kt)("inlineCode",{parentName:"p"},"campaign.huli.tw")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"hulitest.s3.us-east-1.amazonaws.com"),". This way, you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"https://campaign.huli.tw")," as your own domain."),(0,i.kt)("p",null,"The entire process seems fine and convenient, but what about when you no longer need this webpage? For example, there may be a Christmas event page hosted on S3 using a custom domain ",(0,i.kt)("inlineCode",{parentName:"p"},"xmas.huli.tw"),". After Christmas and the event are over, the S3 bucket is deleted since storage space and traffic still incur costs."),(0,i.kt)("p",null,"However, the DNS part may be handled by another department, and if they are not specifically informed to delete it, it may remain there."),(0,i.kt)("p",null,"As a result, a situation arises where the DNS record still exists, but the destination it points to has been deleted."),(0,i.kt)("p",null,"In the case of S3, as long as the bucket name is not taken by someone else, you can claim that name. Now that the ",(0,i.kt)("inlineCode",{parentName:"p"},"xmas.huli.tw")," bucket has been deleted, I can create a new one with the same name, ",(0,i.kt)("inlineCode",{parentName:"p"},"xmas.huli.tw"),". This way, the domain ",(0,i.kt)("inlineCode",{parentName:"p"},"xmas.huli.tw")," will point to the S3 bucket, and since the S3 bucket contains my content, I effectively control the content of ",(0,i.kt)("inlineCode",{parentName:"p"},"xmas.huli.tw"),", achieving subdomain takeover."),(0,i.kt)("p",null,"Apart from S3, there are many other services that provide similar functionality and have this issue. You can refer to the detailed list here: ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/EdOverflow/can-i-take-over-xyz"},"Can I take over XYZ"),". Azure has also created a page specifically explaining how to defend against this: ",(0,i.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/security/fundamentals/subdomain-takeover"},"Prevent dangling DNS entries and avoid subdomain takeover"),". In simple terms, just delete the DNS record, and there will be no problem."),(0,i.kt)("h2",{id:"things-you-can-do-after-gaining-subdomain-control"},"Things You Can Do After Gaining Subdomain Control"),(0,i.kt)("p",null,"Let's take a look at a few examples!"),(0,i.kt)("p",null,"The first example is an article published by Hacktus in 2023: ",(0,i.kt)("a",{parentName:"p",href:"https://hacktus.tech/subdomain-takeover-leading-to-full-account-takeover"},"Subdomain Takeover leading to Full Account Takeover"),". It mentions that the website ",(0,i.kt)("inlineCode",{parentName:"p"},"example.com")," has its cookies directly written on the root domain ",(0,i.kt)("inlineCode",{parentName:"p"},"example.com"),", making them shareable with other subdomains."),(0,i.kt)("p",null,"Hacktus discovered that one of the subdomains, ",(0,i.kt)("inlineCode",{parentName:"p"},"test.example.com"),", was pointing to ",(0,i.kt)("inlineCode",{parentName:"p"},"azurewebsites.net")," and was not registered by anyone. So, Hacktus registered the service and successfully took over the domain. After taking over, whenever a user visits ",(0,i.kt)("inlineCode",{parentName:"p"},"test.example.com"),", the browser sends the cookies stored in ",(0,i.kt)("inlineCode",{parentName:"p"},"example.com")," to the server, allowing Hacktus to obtain the user's cookies."),(0,i.kt)("p",null,"The second case is an article published by a cybersecurity company called Shockwave: ",(0,i.kt)("a",{parentName:"p",href:"https://www.shockwave.cloud/blog/subdomain-takeover-how-a-misconfigured-dns-record-could-lead-to-a-huge-supply-chain-attack"},"Subdomain Takeover: How a Misconfigured DNS Record Could Lead to a Huge Supply Chain Attack"),". The case mentioned in the article is similar to the S3 bucket issue we discussed earlier, but this time the domain taken over is ",(0,i.kt)("inlineCode",{parentName:"p"},"assets.npmjs.com"),"."),(0,i.kt)("p",null,"NPM stands for Node Package Manager, a service used to manage JavaScript packages. If an attacker gains control of ",(0,i.kt)("inlineCode",{parentName:"p"},"assets.npmjs.com"),", they can upload malicious packages and deceive developers into thinking they are safe. Since developers are familiar with this domain and it appears highly credible, the probability of successful phishing is also high."),(0,i.kt)("p",null,"The third case involves a vulnerability discovered by Smaran Chand towards the end of 2022: ",(0,i.kt)("a",{parentName:"p",href:"https://smaranchand.com.np/2022/10/taking-over-the-medium-subdomain-using-medium/"},"Taking over the Medium subdomain using Medium"),". One of the subdomains of the blogging platform Medium, ",(0,i.kt)("inlineCode",{parentName:"p"},"platform.medium.engineering"),", points to Medium but does not exist as a blog."),(0,i.kt)("p",null,"An attacker can create their own Medium blog and request a link to ",(0,i.kt)("inlineCode",{parentName:"p"},"platform.medium.engineering"),". Although they cannot fully control the content of the webpage in this case, they can still engage in social engineering attacks, such as posting fake job advertisements, which appear highly credible."),(0,i.kt)("p",null,"Apart from the application methods mentioned in these practical examples, there are actually more possibilities."),(0,i.kt)("h2",{id:"exploiting-incorrect-security-assumptions"},"Exploiting Incorrect Security Assumptions"),(0,i.kt)("p",null,"Many backend programs make incorrect security assumptions and grant excessive permissions to entities that should not have them."),(0,i.kt)("p",null,"For example, let's consider the case of dynamic origin in CORS. Some servers implement the following check:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const domain = 'huli.tw'\nif (origin === domain || origin.endsWith('.' + domain)) {\n  res.setHeader('Access-Control-Allow-Origin', origin)\n}\n")),(0,i.kt)("p",null,"If the origin is ",(0,i.kt)("inlineCode",{parentName:"p"},"huli.tw")," or ends with ",(0,i.kt)("inlineCode",{parentName:"p"},".huli.tw"),', it passes. Although it may not seem like a big issue, the security of this check is based on the assumption that "attackers cannot control subdomains of ',(0,i.kt)("inlineCode",{parentName:"p"},"huli.tw"),'".'),(0,i.kt)("p",null,"However, by now, I believe everyone knows that gaining control of a subdomain may not be as difficult as imagined, and the risk still exists. If an attacker can control a subdomain, they can exploit this incorrect assumption to launch attacks from the subdomain."),(0,i.kt)("p",null,"Therefore, this seemingly secure check is actually not secure enough. The most secure check should be:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const allowOrigins = [\n  'huli.tw',\n  'blog.huli.tw'\n]\nif (allowOrigins.includes(origin)) {\n  res.setHeader('Access-Control-Allow-Origin', origin)\n}\n")),(0,i.kt)("p",null,"Prepare a list, and only origins in the list can pass the check. Although this may be more cumbersome because every new domain needs to be manually added, it also increases security by not blindly trusting any subdomain."),(0,i.kt)("h2",{id:"cookie-tossing"},"Cookie Tossing"),(0,i.kt)("p",null,"Another thing you can do after gaining control of a subdomain is called cookie tossing."),(0,i.kt)("p",null,"Let's assume there is a website with an API server at ",(0,i.kt)("inlineCode",{parentName:"p"},"api.huli.tw"),", and the authentication cookie is stored under this domain. Additionally, the backend has implemented CSRF protection, adding ",(0,i.kt)("inlineCode",{parentName:"p"},"SameSite=Lax")," and checking the CSRF token to ensure that the ",(0,i.kt)("inlineCode",{parentName:"p"},"csrf_token")," in the request body matches the one in the cookie."),(0,i.kt)("p",null,"Now, suppose we have control over a subdomain called ",(0,i.kt)("inlineCode",{parentName:"p"},"s3.huli.tw")," and can execute XSS attacks on it. What should we do next?"),(0,i.kt)("p",null,"When writing cookies, we can write them to higher-level domains. For example, ",(0,i.kt)("inlineCode",{parentName:"p"},"a.b.huli.tw")," can write cookies to:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"a.b.huli.tw"),(0,i.kt)("li",{parentName:"ol"},"b.huli.tw"),(0,i.kt)("li",{parentName:"ol"},"huli.tw")),(0,i.kt)("p",null,"Therefore, when we are on ",(0,i.kt)("inlineCode",{parentName:"p"},"s3.huli.tw"),", we can write a cookie to ",(0,i.kt)("inlineCode",{parentName:"p"},"huli.tw"),", allowing us to write a cookie called ",(0,i.kt)("inlineCode",{parentName:"p"},"csrf_token"),"."),(0,i.kt)("p",null,"In a scenario where both ",(0,i.kt)("inlineCode",{parentName:"p"},"api.huli.tw")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"huli.tw")," have cookies with the same name, what will the browser do? It will send both cookies together, and based on the ",(0,i.kt)("inlineCode",{parentName:"p"},"path")," attribute of the cookie, the more specific one will be sent first."),(0,i.kt)("p",null,"For example, if the cookie on ",(0,i.kt)("inlineCode",{parentName:"p"},"api.huli.tw")," does not have a ",(0,i.kt)("inlineCode",{parentName:"p"},"path")," set, and the cookie on ",(0,i.kt)("inlineCode",{parentName:"p"},"huli.tw")," has a ",(0,i.kt)("inlineCode",{parentName:"p"},"path=/users")," set, when the browser sends a request to ",(0,i.kt)("inlineCode",{parentName:"p"},"https://api.huli.tw/users"),", the sent cookies will be: ",(0,i.kt)("inlineCode",{parentName:"p"},"csrf_token={value_of_huli_tw}&csrf_token={value_of_api_huli_tw}"),"."),(0,i.kt)("p",null,"Usually, when retrieving cookie values on the backend, only the first one is taken by default. Therefore, we will retrieve the cookie we wrote on ",(0,i.kt)("inlineCode",{parentName:"p"},"s3.huli.tw"),"."),(0,i.kt)("p",null,'Through this behavior, an attacker can overwrite cookies from other same-site domains, as if they are "tossing" cookies from a subdomain to another domain. This is known as cookie tossing.'),(0,i.kt)("p",null,"By overwriting the ",(0,i.kt)("inlineCode",{parentName:"p"},"csrf_token")," cookie, we essentially know its value and can execute a CSRF attack. Therefore, in this situation, even with same-site cookie settings and CSRF token checks, we cannot escape the fate of being attacked."),(0,i.kt)("p",null,"The solution is to change the cookie name of the CSRF token from ",(0,i.kt)("inlineCode",{parentName:"p"},"csrf_token")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"__Host-csrf_token"),". With this prefix, the cookie cannot have the ",(0,i.kt)("inlineCode",{parentName:"p"},"path")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"domain")," attributes when setting it. Therefore, other subdomains cannot write and overwrite it. For more examples, you can refer to the ",(0,i.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#cookie_prefixes"},"MDN page"),"."),(0,i.kt)("p",null,"For specific examples and other applications, you can refer to @filedescriptor's talk at HITCON CMT in 2019: ",(0,i.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=njQcVWPB1is&ab_channel=HITCON"},"The cookie monster in your browsers"),", or check out the ",(0,i.kt)("a",{parentName:"p",href:"https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers"},"slides"),"."),(0,i.kt)("h2",{id:"conclusion"},"Conclusion"),(0,i.kt)("p",null,"This article continues the same-site issue mentioned in the previous one. When designing systems, we should adhere to the principle of least privilege and avoid unnecessary security assumptions. Instead of trusting all same-site domains, a more secure approach would be to trust a fixed list of domains and ensure that every trusted domain is listed."),(0,i.kt)("p",null,"Furthermore, from this article, we can see that a same-site website inherently has more privileges (e.g., ignoring same-site cookies). Therefore, many companies actually place less trusted files (e.g., user-uploaded files) or less important websites on a completely new domain."),(0,i.kt)("p",null,"For example, the main site may be at ",(0,i.kt)("inlineCode",{parentName:"p"},"www.huli.tw"),", while the campaign webpage is called ",(0,i.kt)("inlineCode",{parentName:"p"},"campaign.huli.app"),". This way, even if the campaign webpage is compromised, the damage can be minimized and it won't affect the main site."))}u.isMDXComponent=!0}}]);