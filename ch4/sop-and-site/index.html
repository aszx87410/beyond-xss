<!doctype html>
<html lang="zh-TW" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch4/sop-and-site" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">重中之重：Same-origin policy 與 site | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/ch4/sop-and-site/"><meta data-rh="true" name="docusaurus_locale" content="zh-TW"><meta data-rh="true" name="docsearch:language" content="zh-TW"><meta data-rh="true" name="google-site-verification" content="O7SjDEO9AQXbxqBWhtUW0FVahHxSrnweMXJxLICpSz4"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="重中之重：Same-origin policy 與 site | Beyond XSS"><meta data-rh="true" name="description" content="在前面的文章裡有提過不少次「same-origin」或是「同源」，無論在前端或是資安的世界裡都是個非常重要的名詞，因為瀏覽器的同源政策（Same-origin policy）在開發上會碰到，在攻擊的時候也會碰到，至關重要。"><meta data-rh="true" property="og:description" content="在前面的文章裡有提過不少次「same-origin」或是「同源」，無論在前端或是資安的世界裡都是個非常重要的名詞，因為瀏覽器的同源政策（Same-origin policy）在開發上會碰到，在攻擊的時候也會碰到，至關重要。"><link data-rh="true" rel="icon" href="/beyond-xss/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/ch4/sop-and-site/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch4/sop-and-site/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/sop-and-site/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/sop-and-site/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/assets/js/runtime~main.d379f94d.js" as="script">
<link rel="preload" href="/beyond-xss/assets/js/main.f124e165.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav aria-label="主導航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/"><div class="navbar__logo"><img src="/beyond-xss/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS：探索網頁前端資安宇宙</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文（台灣）</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch4/sop-and-site/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/beyond-xss/ch4/sop-and-site/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-TW">中文（台灣）</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切換淺色/暗黑模式（當前為淺色模式）" aria-label="切換淺色/暗黑模式（當前為淺色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文件側邊欄" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/">關於本系列</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch1/browser-security-model/">第一章：從 XSS 開始談前端資安</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch2/xss-defense-sanitization/">第二章：XSS 的防禦方式以及繞過手法</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch3/attack-without-js/">第三章：不直接執行 JavaScript 的攻擊手法</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/beyond-xss/ch4/sop-and-site/">第四章：跨越限制攻擊其他網站</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/ch4/sop-and-site/">重中之重：Same-origin policy 與 site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/cors-intro/">跨來源資源共用 CORS 基本介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/cors-attack/">跨來源的安全性問題</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/csrf/">跨站請求偽造 CSRF 一點就通</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/same-site-cookie/">Same-site cookie，CSRF 的救星？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/subdomain/">從 same-site 網站打進你家</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/cookie-bomb/">有趣又實用的 Cookie bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch5/clickjacking/">第五章：其他有趣的前端資安主題</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/summary/">結語</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/contact/">聯絡作者</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/beyond-xss/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">第四章：跨越限制攻擊其他網站</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">重中之重：Same-origin policy 與 site</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><h1>重中之重：Same-origin policy 與 site</h1><p>在前面的文章裡有提過不少次「same-origin」或是「同源」，無論在前端或是資安的世界裡都是個非常重要的名詞，因為瀏覽器的同源政策（Same-origin policy）在開發上會碰到，在攻擊的時候也會碰到，至關重要。</p><p>另外，還有幾個常被混用的名詞，例如說 host 或是 site，像是 XSS 的 XS 就是 cross-site，CSRF 的 CS 也是 cross-site 的意思，那 origin 跟 site 又有什麼不同？跟 host 又有什麼不同？</p><p>這篇就帶你完全搞懂這些觀念，以後再也不搞混。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="origin-跟-site-到底是什麼該怎麼區分">Origin 跟 site 到底是什麼？該怎麼區分？<a href="#origin-跟-site-到底是什麼該怎麼區分" class="hash-link" aria-label="Origin 跟 site 到底是什麼？該怎麼區分？的直接連結" title="Origin 跟 site 到底是什麼？該怎麼區分？的直接連結">​</a></h2><p>先提供一下簡單好懂但有些許錯誤的解釋，待會我們再來一個個修正。</p><p>Origin 的話就是：scheme + port + host，三者加起來就是 origin。</p><p>假設有個 URL 是 <code>https://huli.tw/abc</code>，各個組成分別是：</p><ul><li>scheme：https</li><li>port：443（https 的預設 port）</li><li>host：huli.tw</li></ul><p>因此它的 origin 就是 <code>https://huli.tw</code>，可以看到 path 的部分 <code>/abc</code> 並不影響 origin，而 port 的部份 https 已經蘊含預設就是 443 port 了。</p><p>而 same origin 就是兩個 URL 的 origin 要是一樣的，舉例來說：</p><ol><li><code>https://huli.tw/abc</code> 跟 <code>https://huli.tw/hello/yo</code> 是 same origin，因為 scheme、port 跟 host 都一樣，path 不影響結果</li><li><code>https://huli.tw</code> 跟 <code>http://huli.tw</code> 不是 same origin，因為 scheme 不一樣</li><li><code>http://huli.tw</code> 跟 <code>http://huli.tw:8080</code> 不是 same origin，因為 port 不一樣</li><li><code>https://huli.tw</code> 跟 <code>https://blog.huli.tw</code> 不是 same origin，因為 host 不一樣</li></ol><p>從上面幾個範例可以看出 same origin 的條件相當嚴苛，基本上除了 path 以外的部分都要一樣，才能叫做 same origin。</p><p>接著我們看一下 site，site 的話看的東西比 origin 少，只看 scheme 跟 host，所以不看 port。而兩個 URL 是 same site 的定義也更寬鬆了，host 的部分不用完全相同，只要是 subdomain 也算是 same site。</p><p>舉例來說，</p><ol><li><code>https://huli.tw/abc</code> 跟 <code>https://huli.tw/hello/yo</code> 是 same site，因為 scheme 跟 host 都一樣</li><li><code>https://huli.tw</code> 跟 <code>http://huli.tw</code> 不是 same site，因為 scheme 不一樣</li><li><code>http://huli.tw</code> 跟 <code>http://huli.tw:8080</code> 是 same site，因為 port 不影響結果</li><li><code>https://huli.tw</code> 跟 <code>https://blog.huli.tw</code> 是 same site，因為 huli.tw 跟 blog.huli.tw 都在同一個 domain huli.tw 底下</li><li><code>https://abc.huli.tw</code> 跟 <code>https://blog.huli.tw</code> 也是 same site，因為 abc.huli.tw 跟 blog.huli.tw 都在同一個 domain huli.tw 底下</li></ol><p>跟 same origin 比起來，same site 顯然更為寬鬆，port 不同也是 same site，host 的部分只要隸屬於同個 parent domain 基本上也是 same site。</p><p>但就如同我開頭說的，上面的定義雖然在大多數情況下都正確，但其實並不精確，底下我們直接來看 spec，看看有哪些狀況例外。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="細究-same-origin">細究 same origin<a href="#細究-same-origin" class="hash-link" aria-label="細究 same origin的直接連結" title="細究 same origin的直接連結">​</a></h2><p>在 HTML 規範中的 <a href="https://html.spec.whatwg.org/multipage/origin.html#origin" target="_blank" rel="noopener noreferrer">7.5 Origin</a> 章節裡面可以看到完整的定義，先來看一下規範裡面對 origin 的說明：</p><blockquote><p>Origins are the fundamental currency of the web&#x27;s security model. Two actors in the web platform that share an origin are assumed to trust each other and to have the same authority. Actors with differing origins are considered potentially hostile versus each other, and are isolated from each other to varying degrees.</p></blockquote><p>這邊寫得很清楚，開宗明義就講了如果兩個網站有著相同的 origin，就意味著這兩個網站信任彼此，但如果是不同的 origin，就會被隔離開來而且受到限制。</p><p>接著規範裡把 origin 分成兩種，一種是 <code>An opaque origin</code>，另一種是 <code>A tuple origin</code>。</p><p>Opaque origin 可以想成是在特殊狀況下才會出現的 origin，例如說我在本機開啟一個網頁，網址會是 <code>file:///...</code>，這時候在網頁內發送 request，origin 就會是 opaque origin，也就是 <code>null</code>。</p><p>Tuple origin 則是比較常見而且我們也比較關心的 origin，文件寫說 tuple 內包含了：</p><ol><li>scheme (an ASCII string).</li><li>host (a host).</li><li>port (null or a 16-bit unsigned integer).</li><li>domain (null or a domain). Null unless stated otherwise.</li></ol><p>你可能會好奇為什麼又有 host 又有 domain，這個我們晚點會提到。</p><p>接著，在規範裡面也有講到判斷 A 跟 B 兩個 origin 是否是 same origin 的演算法：</p><ol><li>If A and B are the same opaque origin, then return true.</li><li>If A and B are both tuple origins and their schemes, hosts, and port are identical, then return true.</li><li>Return false.</li></ol><p>要嘛兩個是一樣的 opaque origin，否則的話要 scheme、host 跟 port 三者都相等，才是 same origin。除了 same origin 以外，你還會在 spec 裡面看到另外一個詞叫做「same origin-domain」，這個等等也會提到。</p><p>如同我前面說的，same origin 是很嚴格的限制，以 <code>https://huli.tw/api</code> 這個網址來說，因為 origin 不看 path，所以它的 origin 會是 <code>https://huli.tw</code>，也就是說，跟它同源的網站的網址一定都是 <code>https://huli.tw/*</code>，才會是同源的。</p><p><code>https://huli.tw</code> 跟 <code>https://blog.huli.tw</code> 雖然只是網域跟子網域的關係，但也不是同源的，因為 host 不一樣。</p><p>記住這點，這很重要。</p><p>這邊仔細探究的 origin 跟 same origin 的定義跟開頭所說的「不精確的說法」比起來，差別在於多了一個 opaque origin 以及 same origin-domain，還有 origin tuple 中多了一個我們剛剛都沒用到的「domain」。</p><p>最後再提一個東西，當我說「<code>https://huli.tw/api</code> 的 origin 是 <code>https://huli.tw</code>」的時候，更精確的說法是：「<code>https://huli.tw/api</code> 的 origin 序列化（serialization）過的結果是 <code>https://huli.tw</code>」</p><p>這是因為前面有提到 origin 其實是個 tuple，表示起來會像這樣：<code>(https, huli.tw, null, null)</code>，而 tuple 變成字串後才會是 <code>https://huli.tw</code>。tuple 的表示法跟序列化過後的字串比起來，我認為後者比較好讀，因此當兩者能表現出的資訊類似時，我會採用後者那種做法</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="細究-same-site">細究 same site<a href="#細究-same-site" class="hash-link" aria-label="細究 same site的直接連結" title="細究 same site的直接連結">​</a></h2><p>site 的定義也在同一份 spec 裡面，寫說：</p><blockquote><p>A site is an opaque origin or a scheme-and-host.</p></blockquote><p>所以 site 可以是 opaque origin，或者是 scheme-and-host。</p><p>在 spec 中可以發現除了 same site 以外，還有另外一個名詞叫做「schemelessly same site」，這兩個的差別也很明顯，same site 會看 scheme，而 schemelessly same site 則不看 scheme。</p><p>因此，在判斷兩個 origin A 跟 B 是否是 same site 時，演算法是這樣的：</p><blockquote><p>Two origins, A and B, are said to be same site if both of the following statements are true:</p><ul><li>A and B are schemelessly same site  </li><li>A and B are either both opaque origins, or both tuple origins with the same scheme</li></ul></blockquote><p>如果 A 跟 B 是 same site，要嘛他們都是 opaque origin，要嘛兩個有著同樣的 scheme 而且兩個是 schemelessly same site。</p><p>所以 same site 是會看 scheme 的，http 跟 https 的兩個網址絕對不會是 same site，但有可能是 schemelessly same site。</p><p>這邊其實有一小段歷史，那就是 same site 剛出來的時候，其實是不看 scheme 的，是到後來才把 scheme 納入考量。</p><p>在這份 2016 的 <a href="https://datatracker.ietf.org/doc/html/draft-west-first-party-cookies-07#section-2.1" target="_blank" rel="noopener noreferrer">RFC: Same-site Cookies</a> 中，可以看到對於 same site 的判斷並沒有 scheme，所以那時候 <code>https://huli.tw</code> 跟 <code>http://huli.tw</code> 是 same site。</p><p>一直到 2019 年 6 月的時候，才開始在討論是否要把 scheme 列入考量，詳情可參考：<a href="https://github.com/w3c/webappsec-fetch-metadata/issues/34" target="_blank" rel="noopener noreferrer">Treat http://foo.com -&gt; https://foo.com requests as Sec-Fetch-Site: cross-site. #34</a>。</p><p>那時 same site 的 spec 並不是定義在我們今天看的 HTML spec 裡面，而是另外一份 URL spec，所以後來討論被移到那邊去：<a href="https://github.com/whatwg/url/issues/448" target="_blank" rel="noopener noreferrer">Consider introducing a &quot;same-site&quot; concept that includes scheme. #448</a>，接著在 2019 年 9 月，就有了這個 PR：<a href="https://github.com/whatwg/url/pull/449" target="_blank" rel="noopener noreferrer">Tighten &#x27;same site&#x27; checks to include &#x27;scheme&#x27;. #449</a>，才正式在規格中把 scheme 列入考量，將 same site 定義成「會看 scheme」，而不看 scheme 的則引入了一個新的名詞：schemelessly same site。</p><p>接著過了兩個月，相關的 spec 從 URL 移到 HTML，可參考這兩個 PR：<a href="https://github.com/whatwg/url/pull/457" target="_blank" rel="noopener noreferrer">Let HTML handle the &quot;same site&quot; definition #457</a>、<a href="https://github.com/whatwg/html/pull/5076" target="_blank" rel="noopener noreferrer">Define (schemelessly) same site for origins #5076</a></p><p>Spec 歸 spec，有時候規格修正不代表瀏覽器就會馬上跟上，那瀏覽器目前的實作為何呢？</p><p>Chrome 在 2020 年 11 月時有寫了一篇文章：<a href="https://web.dev/schemeful-samesite/" target="_blank" rel="noopener noreferrer">Schemeful Same-Site</a>，看來在那時瀏覽器還是把不同 scheme 也當作是 same site，但從 <a href="https://chromestatus.com/feature/5096179480133632" target="_blank" rel="noopener noreferrer">Chrome platform status:  Feature: Schemeful same-site</a> 中我們可以得知，Chrome 從 89 以後就把 scheme 也列入考慮了。</p><p>至於 Firefox 的話，從這個 issue：<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1651119" target="_blank" rel="noopener noreferrer">[meta] Enable cookie sameSite schemeful</a> 的狀態看來，似乎還沒有把這個行為當作是預設值，如果沒有特別調整設定，scheme 不同也會被看作是 same site。</p><p>看完了歷史，接著就來看一下最重要的 schemelessly same site 是如何判斷的：</p><p><img loading="lazy" alt="schemelessly same site" src="/beyond-xss/assets/images/20-01-edadea6cfb957872adccc3a543883d9b.png" width="980" height="349" class="img_ev3q"></p><p>Opaque 的部份我們就先不說了，上面的重點很顯然是一個新的名詞：「registrable domain」，在判斷兩個 host 是否是 same site 時，會用這個來做比較。</p><p>這個 registrable domain 的定義在另外一份 <a href="https://url.spec.whatwg.org/#host-registrable-domain" target="_blank" rel="noopener noreferrer">URL 的 spec</a> 中：</p><blockquote><p>A host’s registrable domain is a domain formed by the most specific public suffix, along with the domain label immediately preceding it, if any</p></blockquote><p>這邊又提到一個新的詞：「public suffix」。</p><p>先舉個例子會比較好懂，<code>blog.huli.tw</code> 的 registrable domain 會是 <code>huli.tw</code>，而 <code>huli.tw</code> 的 registrable domain 也是 <code>huli.tw</code>。</p><p>但是 <code>bob.github.io</code> 的 registrable domain 不是 <code>github.io</code>，而是 <code>bob.github.io</code>。</p><p>這是為什麼呢？底下我簡單解釋一下。</p><p>如果沒有「registrable domain」以及「public suffix」這兩個概念的話，那 same site 的定義就是開頭所講的，<code>huli.tw</code> 跟 <code>blog.huli.tw</code> 是 same site，這沒什麼問題。</p><p>但如果是這樣的話，<code>bob.github.io</code> 跟 <code>alice.github.io</code> 也是 same site 了。</p><p>咦，這樣不好嗎？</p><p>不好，因為 <code>github.io</code> 是 GitHub pages 的服務，每一個 GitHub 的使用者都會有自己專屬的 subdomain 可以用，但 GitHub 不希望 <code>bob.github.io</code> 能干擾到 <code>alice.github.io</code>，因為它們其實就是完全獨立的兩個網站，並不像 <code>huli.tw</code> 跟 <code>blog.huli.tw</code> 一樣，擁有者都是我。</p><p>因此，public suffix 的概念就出現了，這是一個人工維護的清單，裡面有著這些「不想被當作是同個網站的列表」，我舉幾個例子：</p><ol><li>github.io</li><li>com.tw</li><li>s3.amazonaws.com</li><li>azurestaticapps.net</li><li>herokuapp.com</li></ol><p>所以瀏覽器參照這張表之後，就會認定 <code>bob.github.io</code> 跟 <code>alice.github.io</code> 其實並沒有關係，不是 same site。這也有個專有名詞叫做 eTLD（effective Top-Level-Domain），細節可參考：<a href="https://blog.kalan.dev/2021-11-09-url-and-samesite/" target="_blank" rel="noopener noreferrer">如何判斷兩個網域的擁有者是否相同？</a></p><p>如上所述，因為 <code>github.io</code> 存在於 public suffix list 裡面，所以 <code>bob.github.io</code> 的 registrable domain 是 <code>bob.github.io</code>，而 <code>alice.github.io</code> 的 registrable domain 則是 <code>alice.github.io</code>。</p><p>所以呢，我們一開始講的 same site 的定義並不正確，兩個 host 看起來很像是隸屬於同一個 parent domain，並不代表就一定是 same site，還要看有沒有在 public suffix list 裡面。</p><p>而 <code>bob.github.io</code> 跟 <code>alice.github.io</code> 不是 same site，因為他們的 registrable domain 不一樣。</p><p><code>blog.huli.tw</code> 跟 <code>huli.tw</code> 還有 <code>test.huli.tw</code> 這三個 host 都是 same site，因為 registrable domain 都是 <code>huli.tw</code>。</p><p>spec 中有附上一張更清楚的表格，大家可以仔細看一下：</p><p><img loading="lazy" alt="registrable domain table" src="/beyond-xss/assets/images/20-02-b666bbfbac8fe1684ad927082dc5a452.png" width="872" height="485" class="img_ev3q"></p><p>最後，為 same site 做個總結：</p><ol><li>有 same site 跟 schemelessly same site，較常用的是前者</li><li>要比較兩個 host 是否為 same site 時，要看 registrable domain</li><li>要決定 registrable domain 是什麼，要看 public suffix list</li><li>兩個 host 僅管看起來隸屬於同個 parent domain，但因為有 public suffix 的存在，不一定是 same site</li><li>same site 不看 port，所以 <code>http://blog.huli.tw:8888</code> 跟 <code>http://huli.tw</code> 是 same site</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="same-origin-與-same-site">Same origin 與 same site<a href="#same-origin-與-same-site" class="hash-link" aria-label="Same origin 與 same site的直接連結" title="Same origin 與 same site的直接連結">​</a></h2><p>Same origin 看的是：</p><ol><li>scheme</li><li>port</li><li>host</li></ol><p>而 same site 看的是：</p><ol><li>scheme</li><li>host(registrable domain)</li></ol><p>如果兩個網站是 same origin，那就一定是 same site，因為 same origin 的判斷標準更為嚴苛。</p><p>兩者最大的差別就在於：</p><ol><li>same origin 看 port，same site 不看</li><li>same origin 看 host，same site 看 registrable domain</li></ol><p>底下舉幾個例子：</p><table><thead><tr><th>A</th><th>B</th><th>same origin</th><th>same site</th><th>說明</th></tr></thead><tbody><tr><td><a href="http://huli.tw:8080" target="_blank" rel="noopener noreferrer">http://huli.tw:8080</a></td><td><a href="http://huli.tw" target="_blank" rel="noopener noreferrer">http://huli.tw</a></td><td>X</td><td>O</td><td>same site 不看 port</td></tr><tr><td><a href="https://blog.huli.tw" target="_blank" rel="noopener noreferrer">https://blog.huli.tw</a></td><td><a href="https://huli.tw" target="_blank" rel="noopener noreferrer">https://huli.tw</a></td><td>X</td><td>O</td><td>registrable domain 相同</td></tr><tr><td><a href="https://alice.github.io" target="_blank" rel="noopener noreferrer">https://alice.github.io</a></td><td><a href="https://github.io" target="_blank" rel="noopener noreferrer">https://github.io</a></td><td>X</td><td>X</td><td>github.io 在 public suffix 裡面</td></tr><tr><td><a href="https://a.alice.github.io" target="_blank" rel="noopener noreferrer">https://a.alice.github.io</a></td><td><a href="https://b.alice.github.io" target="_blank" rel="noopener noreferrer">https://b.alice.github.io</a></td><td>X</td><td>O</td><td>registrable domain 相同</td></tr><tr><td><a href="https://bob.github.io/page1" target="_blank" rel="noopener noreferrer">https://bob.github.io/page1</a></td><td><a href="https://bob.github.io/about" target="_blank" rel="noopener noreferrer">https://bob.github.io/about</a></td><td>O</td><td>O</td><td>不管 path</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="神奇的-documentdomain">神奇的 document.domain<a href="#神奇的-documentdomain" class="hash-link" aria-label="神奇的 document.domain的直接連結" title="神奇的 document.domain的直接連結">​</a></h2><p>在看 origin 的 spec 時，就有提到一個神奇的「domain」屬性，不知道要幹嘛，甚至還有「same origin-domain」這個東西，在 origin 的 spec 中其實有一段綠底的 note，直接破題：</p><p><img loading="lazy" alt="same origin note" src="/beyond-xss/assets/images/20-03-251552df2e976227c38ada9c7ec321f5.png" width="1387" height="407" class="img_ev3q"></p><p>寫說 origin 除了 domain 這個屬性以外都是不可變的，而這屬性可以透過 <code>document.domain</code> 來改變。在 spec 中有一個章節 <a href="https://html.spec.whatwg.org/multipage/origin.html#relaxing-the-same-origin-restriction" target="_blank" rel="noopener noreferrer">7.5.2 Relaxing the same-origin restriction</a>，就是在講這件事情，我節錄一小段：</p><blockquote><p>(document.domain) can be set to a value that removes subdomains, to change the origin&#x27;s domain to allow pages on other subdomains of the same domain (if they do the same thing) to access each other. This enables pages on different hosts of a domain to synchronously access each other&#x27;s DOMs.</p></blockquote><p>為了方便大家理解，直接來個 demo。</p><p>我改了本機的 <code>/etc/hosts</code>，內容如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1   alice.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1   bob.example.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如此一來，這兩個網址都會連到 local，接著我開了一個簡單的 HTTP server，寫了一個簡單的 HTML，讓它跑在 localhost:5555</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&lt;!</span><span class="token doctype doctype-tag" style="color:#999988;font-style:italic">DOCTYPE</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">html</span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">charset</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">utf-8</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">viewport</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">width=device-width, initial-scale=1</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">h1</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">h1</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">h2</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">h2</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">load</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript string" style="color:#e3116c">&#x27;alice&#x27;</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">load alice iframe</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">load</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript string" style="color:#e3116c">&#x27;bob&#x27;</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">load bob iframe</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">access</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">access iframe content</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">update</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">update domain</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> name </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">domain</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">replace</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;.example.com&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;h1&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">innerText</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> name</span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;h2&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">innerText</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript known-class-name class-name">Math</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">random</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">load</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">name</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> iframe </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">createElement</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;iframe&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      iframe</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">src</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;http://&#x27;</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">+</span><span class="token script language-javascript"> name </span><span class="token script language-javascript operator" style="color:#393A34">+</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;.example.com:5555&#x27;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">body</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">appendChild</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">iframe</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">access</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> win </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;iframe&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">contentWindow</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript function" style="color:#d73a49">alert</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;secret:&#x27;</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">+</span><span class="token script language-javascript"> win</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;h2&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">innerText</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">update</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">domain</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;example.com&#x27;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>頁面上有三個功能：</p><ol><li>載入 iframe</li><li>讀取 iframe 內 DOM 的資料</li><li>改變 document.domain</li></ol><p>我們先開啟 <code>http://alice.example.com:5555</code>，然後載入 <code>http://bob.example.com:5555</code> 的 iframe，接著按下 alice 頁面中的「access iframe content」：</p><p><img loading="lazy" alt="exception" src="/beyond-xss/assets/images/20-04-290308aa6bce3f68805c523b6df75761.png" width="722" height="461" class="img_ev3q"></p><p>你會在 console 看到錯誤訊息，寫說：</p><blockquote><p>Uncaught DOMException: Blocked a frame with origin &quot;<a href="http://alice.example.com:5555%22" target="_blank" rel="noopener noreferrer">http://alice.example.com:5555&quot;</a> from accessing a cross-origin frame.</p></blockquote><p>因為 alice 跟 bob 雖然是 same site，但是並不是 same origin，而 iframe 如果要存取到 DOM 的內容，必須是 same origin 才行。</p><p>接著我們雙雙按下 alice 跟 bob 頁面中的「update domain」，按完以後再按一次「access iframe content」：</p><p><img loading="lazy" alt="success" src="/beyond-xss/assets/images/20-05-3b2e6e0865aa2cd1c254c8b23649dc9b.png" width="721" height="427" class="img_ev3q"></p><p>你會看到這一次，我們順便取得了 bob 頁面中的資料，成功把  <code>http://alice.example.com:5555</code> 跟 <code>http://bob.example.com:5555</code> 從 cross origin 變成了 same origin，這就是忍術，same site 變成 same origin 之術！</p><p>這一招並不是任意兩個網頁都可以使用的，基本上只有 same site 的網站可以，而且在設置時還會做很多檢查：</p><p><img loading="lazy" alt="check" src="/beyond-xss/assets/images/20-06-0c004681ed15c8ee94ee0d2e87e5e3f1.png" width="1302" height="604" class="img_ev3q"></p><p>以 github.io 為例，如果 <code>alice.github.io</code> 執行了 <code>document.domain = &#x27;github.io&#x27;</code>，console 就會跳出錯誤：</p><blockquote><p>Uncaught DOMException: Failed to set the &#x27;domain&#x27; property on &#x27;Document&#x27;: &#x27;github.io&#x27; is a top-level domain.</p></blockquote><p>為什麼改變 <code>document.domain</code> 後，兩個頁面就會變成是 same origin 呢？其實嚴格來說不是 same origin，而是 same origin-domain，在 <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-bcc-content-document" target="_blank" rel="noopener noreferrer">docuemnt</a> 相關的 spec 中有寫到，有些檢查是看 same origin-domain，而不是 same origin。</p><p>那怎麼看兩個 origin 是不是 same origin-domain 呢？一起來看看 spec 怎麼說：</p><blockquote><ol><li>If A and B are the same opaque origin, then return true.  </li><li>If A and B are both tuple origins, run these substeps:</li></ol><ul><li>If A and B&#x27;s schemes are identical, and their domains are identical and non-null, then return true.  </li><li>Otherwise, if A and B are same origin and their domains are identical and null, then return true.</li></ul><ol start="3"><li>Return false.</li></ol></blockquote><p>如果 A 跟 B 的 scheme 一樣，而且 domain 屬性也一樣而且不是 null 的話，就回傳 true，否則的話檢查 A 跟 B 是不是 same origin 而且 domain 都是 null，成立才回傳 true。</p><p>這邊可以看到幾個有趣的地方：</p><ol><li>一定要兩個網頁都沒有設置 domain 或是都有設置，才有可能回傳 true（這很重要）</li><li>如果有設置 domain 的話，same origin-domain 就不檢查 port 了</li></ol><p><code>document.domain</code> 就是改變 origin tuple 中 domain 這個屬性用的。</p><p>在上面的範例中，我們兩個網頁 <code>http://alice.example.com:5555</code> 跟 <code>http://bob.example.com:5555</code> 都將自己的 domain 改成 <code>example.com</code>，所以是 same origin-domain。</p><p>底下我們來看看三個有趣的案例。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="案例一單方面改變">案例一：單方面改變<a href="#案例一單方面改變" class="hash-link" aria-label="案例一：單方面改變的直接連結" title="案例一：單方面改變的直接連結">​</a></h3><p>如果 <code>https://alice.example.com</code> 執行了 <code>document.domain = &#x27;example.com&#x27;</code>，接著把 <code>https://example.com</code> 嵌入在 iframe 裡面，它們兩個「依舊不是 same origin-domain」，因為 alice 頁面有 domain 屬性，但是 <code>example.com</code> 頁面沒有 domain 屬性。</p><p><code>example.com</code> 也要執行 <code>document.domain = &#x27;example.com&#x27;</code>，兩者才會是 same origin-domain。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="案例二消失的-port">案例二：消失的 port<a href="#案例二消失的-port" class="hash-link" aria-label="案例二：消失的 port的直接連結" title="案例二：消失的 port的直接連結">​</a></h3><p><code>http://alice.example.com:1234</code> 跟 <code>http://alice.example.com:4567</code>，因為 port 不一樣，所以是 cross origin，但如果兩個頁面都執行了 <code>document.domain = &#x27;alice.example.com&#x27;</code> 的話，就會變成 same origin-domain，可以存取彼此的 DOM，因為它不看 port。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="案例三我不是原來的我">案例三：我不是原來的我<a href="#案例三我不是原來的我" class="hash-link" aria-label="案例三：我不是原來的我的直接連結" title="案例三：我不是原來的我的直接連結">​</a></h3><p>假設 <code>http://alice.example.com</code> 把自己嵌入在 iframe 裡面，那 iframe 跟原本的頁面顯然是 same origin，可以存取彼此的 DOM。</p><p>但是呢，如果我在頁面上執行了 <code>document.domain = &#x27;alice.example.com&#x27;</code>，這頁面就會被設置 domain 屬性，而 iframe 裡的頁面並沒有設置 domain 屬性，所以它們就變得不是 same origin-domain 了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="documentdomain-的淡出及退場">document.domain 的淡出及退場<a href="#documentdomain-的淡出及退場" class="hash-link" aria-label="document.domain 的淡出及退場的直接連結" title="document.domain 的淡出及退場的直接連結">​</a></h2><p>用這一招來放寬 same origin 的限制應該滿早就有了，而遲遲沒有拔掉就是為了相容早期的行為，我猜在早期的時候很多網頁都會用這招去存取 same site 但是 cross origin 的頁面。</p><p>但這樣做顯然是有風險的，例如說假設某個 subdomain 有 XSS 漏洞，就有機會利用這個方式擴大影響範圍，在 2016 年由 <a href="https://twitter.com/fin1te" target="_blank" rel="noopener noreferrer">@fin1te</a> 所寫的一篇文章 <a href="https://whitton.io/articles/xss-on-facebook-via-png-content-types/" target="_blank" rel="noopener noreferrer">An XSS on Facebook via PNGs &amp; Wonky Content Types</a> 中，就利用了這個手法，成功從 subdomain 繞到 <code>www.facebook.com</code> 進行 XSS，提升漏洞的影響力。 </p><p>也因為安全性的問題，Chrome 在 2022 年 1 月 11 日於部落格發布了一篇文章：<a href="https://developer.chrome.com/blog/immutable-document-domain/" target="_blank" rel="noopener noreferrer">Chrome will disable modifying document.domain to relax the same-origin policy</a>，文中說明了最快從 Chrome 101 版開始，就會停止支援更改 <code>document.domain</code>。</p><p>原本的行為可以用 <code>postMessage</code> 或是 <code>Channel Messaging API</code> 來取代，只是要多寫一些程式碼就是了，畢竟沒辦法像原本直接操作 DOM 這麼方便。</p><p>而如果有網頁想繼續使用這個修改 document.domain 的功能，需要在 response header 裡面帶上 <code>Origin-Agent-Cluster: ?0</code>，才能繼續使用。</p><p>文中也有附上關於這個改動的相關討論串：<a href="https://github.com/w3ctag/design-reviews/issues/564" target="_blank" rel="noopener noreferrer">Deprecating document.domain setter. #564</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="小結">小結<a href="#小結" class="hash-link" aria-label="小結的直接連結" title="小結的直接連結">​</a></h2><p>所謂的同源政策，就是瀏覽器的保護機制，確保只有同源的網頁可以讀取彼此的資料，來避免資安問題。因此我們有需要知道 origin 的定義是什麼，才能判斷兩個網頁是否同源。</p><p>介紹完 origin 與 site 這兩個重要的基本觀念以後，我們會陸續看到兩個延伸的名詞，分別是 CSRF（Cross-site request forgery） 與 CORS（Cross-origin resource sharing）。</p><p>本文改寫自：<a href="https://blog.huli.tw/2022/01/16/same-site-to-same-origin-document-domain/" target="_blank" rel="noopener noreferrer">忍術！把 same site 變 same origin 之術！</a></p><p>參考資料：</p><ol><li><a href="https://html.spec.whatwg.org/multipage/origin.html#origin" target="_blank" rel="noopener noreferrer">HTML spec</a></li><li><a href="https://url.spec.whatwg.org/#host-registrable-domain" target="_blank" rel="noopener noreferrer">URL spec</a></li><li><a href="https://blog.kalan.dev/2021-11-09-url-and-samesite/" target="_blank" rel="noopener noreferrer">如何判斷兩個網域的擁有者是否相同？</a></li><li><a href="https://developer.chrome.com/blog/immutable-document-domain/" target="_blank" rel="noopener noreferrer">Chrome will disable modifying document.domain to relax the same-origin policy</a></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件選項卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/ch3/html-attack/"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">就算只有 HTML 也能攻擊？</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/ch4/cors-intro/"><div class="pagination-nav__sublabel">下一頁</div><div class="pagination-nav__label">跨來源資源共用 CORS 基本介紹</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#origin-跟-site-到底是什麼該怎麼區分" class="table-of-contents__link toc-highlight">Origin 跟 site 到底是什麼？該怎麼區分？</a></li><li><a href="#細究-same-origin" class="table-of-contents__link toc-highlight">細究 same origin</a></li><li><a href="#細究-same-site" class="table-of-contents__link toc-highlight">細究 same site</a></li><li><a href="#same-origin-與-same-site" class="table-of-contents__link toc-highlight">Same origin 與 same site</a></li><li><a href="#神奇的-documentdomain" class="table-of-contents__link toc-highlight">神奇的 document.domain</a><ul><li><a href="#案例一單方面改變" class="table-of-contents__link toc-highlight">案例一：單方面改變</a></li><li><a href="#案例二消失的-port" class="table-of-contents__link toc-highlight">案例二：消失的 port</a></li><li><a href="#案例三我不是原來的我" class="table-of-contents__link toc-highlight">案例三：我不是原來的我</a></li></ul></li><li><a href="#documentdomain-的淡出及退場" class="table-of-contents__link toc-highlight">document.domain 的淡出及退場</a></li><li><a href="#小結" class="table-of-contents__link toc-highlight">小結</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/assets/js/runtime~main.d379f94d.js"></script>
<script src="/beyond-xss/assets/js/main.f124e165.js"></script>
</body>
</html>