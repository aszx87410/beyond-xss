<!doctype html>
<html lang="zh-TW" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch4/csrf" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">跨站請求偽造 CSRF 一點就通 | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/ch4/csrf/"><meta data-rh="true" name="docusaurus_locale" content="zh-TW"><meta data-rh="true" name="docsearch:language" content="zh-TW"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="跨站請求偽造 CSRF 一點就通 | Beyond XSS"><meta data-rh="true" name="description" content="前面我們提到了 CORS，跨來源的資料共享，也提到了 CORS 如果設置錯誤，可以讓攻擊者讀取到使用者的個人資料或其他機密資料等等，重點在於「讀取」。"><meta data-rh="true" property="og:description" content="前面我們提到了 CORS，跨來源的資料共享，也提到了 CORS 如果設置錯誤，可以讓攻擊者讀取到使用者的個人資料或其他機密資料等等，重點在於「讀取」。"><link data-rh="true" rel="icon" href="/beyond-xss/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/ch4/csrf/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch4/csrf/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/csrf/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/csrf/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/assets/js/runtime~main.f2e5ea11.js" as="script">
<link rel="preload" href="/beyond-xss/assets/js/main.ae4d3a33.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav aria-label="主導航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/"><div class="navbar__logo"><img src="/beyond-xss/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS：探索網頁前端資安宇宙</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文（台灣）</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch4/csrf/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/beyond-xss/ch4/csrf/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-TW">中文（台灣）</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切換淺色/暗黑模式（當前為淺色模式）" aria-label="切換淺色/暗黑模式（當前為淺色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文件側邊欄" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/">關於本系列</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch1/browser-security-model/">第一章：從 XSS 開始談前端資安</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch2/xss-defense-sanitization/">第二章：XSS 的防禦方式以及繞過手法</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch3/attack-without-js/">第三章：不直接執行 JavaScript 的攻擊手法</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/beyond-xss/ch4/sop-and-site/">第四章：跨越限制攻擊其他網站</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/sop-and-site/">重中之重：Same-origin policy 與 site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/cors-intro/">跨來源資源共用 CORS 基本介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/cors-attack/">跨來源的安全性問題</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/ch4/csrf/">跨站請求偽造 CSRF 一點就通</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/same-site-cookie/">Same-site cookie，CSRF 的救星？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/subdomain/">從 same-site 網站打進你家</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/cookie-bomb/">有趣又實用的 Cookie bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch5/clickjacking/">第五章：其他有趣的前端資安主題</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/summary/">結語</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/contact/">聯絡作者</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/beyond-xss/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">第四章：跨越限制攻擊其他網站</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">跨站請求偽造 CSRF 一點就通</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><h1>跨站請求偽造 CSRF 一點就通</h1><p>前面我們提到了 CORS，跨來源的資料共享，也提到了 CORS 如果設置錯誤，可以讓攻擊者讀取到使用者的個人資料或其他機密資料等等，重點在於「讀取」。</p><p>而有另外一個原理類似的攻擊，叫做 CSRF，全名為 Cross-Site Request Forgery，又稱為跨站請求偽造，它的重點在於「執行操作」。</p><p>我們先來從一個簡單的範例中學習什麼是 CSRF 吧！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="從偷懶的刪除功能開始介紹-csrf">從偷懶的刪除功能開始介紹 CSRF<a href="#從偷懶的刪除功能開始介紹-csrf" class="hash-link" aria-label="從偷懶的刪除功能開始介紹 CSRF的直接連結" title="從偷懶的刪除功能開始介紹 CSRF的直接連結">​</a></h2><p>以前我有做過一個簡單的後台頁面，就想成是一個部落格吧！可以發表、刪除以及編輯文章，介面大概長得像這樣：</p><p><img loading="lazy" src="/beyond-xss/assets/images/23-01-865ba4cad966b43f8d2d2fcba4aea9ae.png" width="1364" height="494" class="img_ev3q"></p><p>可以看到刪除的那個按鈕，點下去之後就可以把一篇文章刪掉。</p><p>要實作這個功能有很多種方式，例如說點了之後打 API 啦，或是點了之後直接送出一個表單等等，而我選擇了一個更簡單的方式。</p><p>因為想偷懶的緣故，想說如果我把這個功能做成 GET，就可以直接用一個連結完成刪除這件事，在前端幾乎不用寫到任何程式碼：</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">/delete?id=3</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">刪除</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>很方便對吧？然後我在網頁後端那邊做一下驗證，驗證 request 有沒有帶 session id 上來，也驗證這篇文章是不是這個 id 的作者寫的，都符合的話才刪除文章。</p><p>聽起來該做的都做了啊，我都已經做到：「只有作者本人可以刪除自己的文章」了，應該很安全了，難道還有哪裡漏掉了嗎？</p><p>沒錯，在權限檢查的部分確實是「只有作者本人可以刪除自己的文章」，但如果他不是自己「主動刪除」，而是在不知情的情況下刪除呢？你可能會覺得我在講什麼東西，怎麼會有這種事情發生，不是作者主動刪的還能怎麼刪？</p><p>好，我就來讓你看看還能怎麼刪！</p><p>今天假設小黑是一個邪惡的壞蛋，想要讓小明在不知情的情況下就把自己的文章刪掉，該怎麼做呢？</p><p>他知道小明很喜歡心理測驗，於是就做了一個心理測驗網站，並且發給小明。但這個心理測驗網站跟其他網站不同的點在於，「開始測驗」的按鈕長得像這樣：</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete?id=3</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">開始測驗</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>小明收到網頁之後很開心，就點擊「開始測驗」。點擊之後瀏覽器就會發送一個 GET 請求給<code>https://small-min.blog.com/delete?id=3</code>，並且因為瀏覽器的運行機制，一併把 <code>small-min.blog.com</code> 的 cookie 都一起帶上去。</p><p>伺服器收到之後檢查了一下 session，發現是小明，而且這篇文章也真的是小明發的，於是就把這篇文章給刪除了。</p><p>這就是 CSRF，跨站請求偽造。</p><p>你現在明明在心理測驗網站，假設是 <code>https://test.com</code> 好了，但是卻在不知情的狀況下刪除了 <code>https://small-min.blog.com</code> 的文章，你說這可不可怕？超可怕！</p><p>這也是為什麼 CSRF 又稱作 one-click attack 的緣故，只要點一下就中招了。</p><p>有些看得比較仔細的人可能會說：「可是這樣小明不就知道了嗎，不就連過去部落格了？不符合『不知情的狀況』啊！」</p><p>這些都是小問題，如果改成這樣呢：</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">img</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete?id=3</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">width</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">0</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">height</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">0</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">/test</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">開始測驗</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在開啟頁面的同時，用看不到的圖片偷偷發送一個刪除的 request 出去，這次小明是真的完全不知道這件事情，這樣就符合了吧！</p><p>從這個簡單的案例中我們可以清楚地看到 CSRF 的原理跟攻擊方式。</p><p>CSRF 攻擊想達成的目的就是「在其他網站底下對目標網站送出一個請求，讓目標網站誤以為這請求是使用者自己發出的，但其實不是」</p><p>要達成這件事的前提跟瀏覽器的機制有關，你只要發送 request 給某個網站，就會把關聯的 cookie 一起帶上去。如果使用者是登入狀態，那這個 request 就理所當然包含了他的資訊（例如說 session id），這 request 看起來就像是使用者本人發出的。</p><p>畢竟伺服器通常也沒有在管你是誰的，它只認 cookie，或更精確一點只認 cookie 裡面帶的資訊，從 A 網站對 B 網站發 request，會帶上 B 的 cookie，從 C 網站對 B 網站發 request，也會帶上 B 的 cookie，這就是 CSRF 之所以可以成立的關鍵。</p><p>但其實上面的案例有個問題，那就是：「我把刪除改成 POST 不就好了嗎？」</p><p>沒錯，聰明！我們不要那麼懶，好好把刪除的功能做成 POST，這樣不就無法透過 <code>&lt;a&gt;</code> 或是 <code>&lt;img&gt;</code> 來攻擊了嗎？除非，有哪個 HTML 元素可以發送 POST request。</p><p>有，正好有一個，就叫做 <code>&lt;form&gt;</code>。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">POST</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">開始測驗</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>小明點下去以後，照樣中招，一樣刪除了文章。上次是透過看不到的圖片，這次是透過表單。</p><p>你可能又會疑惑說，但是這樣小明不就知道了嗎？我跟你一樣很疑惑，於是我 Google 到了這篇：<a href="http://stackoverflow.com/questions/17940811/example-of-silently-submitting-a-post-form-csrf" target="_blank" rel="noopener noreferrer">Example of silently submitting a POST FORM (CSRF)</a></p><p>這篇提供的範例如下，網頁的世界真是博大精深：</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">iframe</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">style</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value css language-css property" style="color:#36acaa">display</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#e3116c">none</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">csrf-frame</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">iframe</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">POST</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">target</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">csrf-frame</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">csrf-form</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">id</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">3</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">getElementById</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&quot;csrf-form&quot;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">submit</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>開一個看不見的 iframe，讓 form submit 之後的結果出現在 iframe 裡面，而且這個 form 還可以自動 submit，完全不需要經過小明的任何操作。</p><p>到了這步，你就知道改成 POST 是沒用的，一樣會有 CSRF 問題。</p><p>於是聰明的你靈機一動：「既然在前端只有 form 可以送出 POST 的話，那我的 API 改成用 JSON 格式收資料不就可以了嗎？這樣總不能用 form 了吧！」</p><p>以 HTML 的 form 來說，<code>enctype</code> 只支援三種：</p><ol><li><code>application/x-www-form-urlencoded</code></li><li><code>multipart/form-data</code></li><li><code>text/plain</code></li></ol><p>大多數狀況下都會使用第一種，而上傳檔案的情形是第二種，第三種則比較少用到。如果要在伺服器端解析 JSON 的話，通常 content type 都會是 <code>application/json</code>。</p><p>所以這句話對了一半，對有些伺服器來說，如果 request 的 content type 不是 <code>application/json</code>，它是會拋出錯誤的，不會認為這是一個合法的 request。</p><p>而錯的那一半則是因為對另外一些伺服器來講，只要 body 內容是 JSON 格式，就算 content type 帶 <code>text/plain</code> 也是可以接受的，而 JSON 格式的 body 可以利用底下的表單拼出來：</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">post</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">enctype</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">text/plain</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">{</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">:3, </span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">ignore_me</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">:</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">test</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">}</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">delete!</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>&lt;form&gt;</code> 產生 request body 的規則是 <code>name=value</code>，所以上面的表單會產生的 request body 是：</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token string-property property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-property property" style="color:#36acaa">&quot;ignore_me&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;=test&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我們舉的例子是刪除文章，這你可能覺得沒什麼，那如果是銀行轉帳呢？攻擊者只要在自己的網頁上寫下轉帳給自己帳號的 code，再把這個網頁散佈出去就好，就可以收到一大堆錢。</p><p>講了這麼多，來講該怎麼防禦吧！先從最簡單的「使用者」開始講。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用者的防禦">使用者的防禦<a href="#使用者的防禦" class="hash-link" aria-label="使用者的防禦的直接連結" title="使用者的防禦的直接連結">​</a></h2><p>CSRF 攻擊之所以能成立，是因為使用者在被攻擊的網頁是處於已經登入的狀態，所以才能做出一些行為。雖然說這些攻擊應該由網頁那邊負責處理，但如果你真的很怕，怕網頁會處理不好的話，你可以在每次使用完網站就登出，就可以避免掉 CSRF。</p><p>不過使用者能做的其實很有限，真的該做事的是伺服器那邊才對。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="伺服器的防禦">伺服器的防禦<a href="#伺服器的防禦" class="hash-link" aria-label="伺服器的防禦的直接連結" title="伺服器的防禦的直接連結">​</a></h2><p>CSRF 之所以可怕是因為 CS 兩個字：Cross-site，你可以在任何一個網站底下發動攻擊。CSRF 的防禦就可以從這個方向思考，簡單來說就是：「我要怎麼擋掉從別的來源發的 request」</p><p>你仔細想想，CSRF 攻擊的 request 跟使用者本人發出的 request 有什麼區別？</p><p>區別在於 origin 的不同，前者是從任意一個 origin 發出的，後者是從同一個 origin 發出的（這邊假設你的 API 跟你的前端網站在同一個 origin），只要能在後端分辨出這一點，就能判別哪一個才是該相信的 request。</p><p>先來講一些沒這麼常見的防禦方式好了。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="檢查-referer-或是-origin-header">檢查 Referer 或是 Origin header<a href="#檢查-referer-或是-origin-header" class="hash-link" aria-label="檢查 Referer 或是 Origin header的直接連結" title="檢查 Referer 或是 Origin header的直接連結">​</a></h3><p>Request 的 header 裡面會帶一個欄位叫做 <code>referer</code>，代表這個 request 是從哪個地方過來的，可以檢查這個欄位看是不是合法的 origin，不是的話直接拒絕即可。</p><p>有些 request 也會帶上 <code>origin</code> 的 header，意思差不多，都是代表這個 request 是從哪邊發過來的。</p><p>但這個檢查方法要注意的地方有三個，第一個是在有些狀況下可能不會帶 referer 或是 origin，你就沒東西可以檢查了。</p><p>第二個是有些使用者可能會關閉帶 referer 的功能，這時候你的伺服器就會拒絕掉由真的使用者發出的 request。</p><p>第三個是判定是不是合法 origin 的程式碼必須要保證沒有 bug，例如：</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> referer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">referer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">referer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">indexOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;small-min.blog.com&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>你看出上面這段的問題了嗎？如果攻擊者的網頁是<code>small-min.blog.com.attack.com</code>的話，你的檢查就被繞過了。</p><p>所以，檢查 <code>referer</code> 或是 <code>origin</code> 並不是一個很完善的解法。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="加上圖形驗證碼或是簡訊驗證碼等等">加上圖形驗證碼或是簡訊驗證碼等等<a href="#加上圖形驗證碼或是簡訊驗證碼等等" class="hash-link" aria-label="加上圖形驗證碼或是簡訊驗證碼等等的直接連結" title="加上圖形驗證碼或是簡訊驗證碼等等的直接連結">​</a></h3><p>就跟網路銀行轉帳的時候一樣，都會要你收簡訊驗證碼，多了這一道檢查就可以確保不會被 CSRF 攻擊。還有圖形驗證碼也是，攻擊者並不知道圖形驗證碼的答案是什麼，所以就不可能攻擊了。</p><p>雖然說這是一個很完善的解決方法，但會影響到使用者體驗。如果使用者每次留言都需要打一次圖形驗證碼，應該會煩死吧！</p><p>因此這個保護方式適合利用在重要操作的時候，例如說銀行的轉帳、會員的修改密碼或是查看自己的薪資單等等，都要再做一層驗證。而「收取簡訊驗證碼（或是收 email 之類的）」這種方法除了可以防止 CSRF 以外，也可以防止 XSS，就算駭客可以在頁面上執行程式碼，他還是沒辦法用你的手機或是 email 收取驗證碼，因此不知道驗證碼是什麼，就沒辦法進行後續操作。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="常見的防禦方式">常見的防禦方式<a href="#常見的防禦方式" class="hash-link" aria-label="常見的防禦方式的直接連結" title="常見的防禦方式的直接連結">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="加上-csrf-token">加上 CSRF token<a href="#加上-csrf-token" class="hash-link" aria-label="加上 CSRF token的直接連結" title="加上 CSRF token的直接連結">​</a></h3><p>要防止 CSRF 攻擊，我們其實只要確保有些資訊「只有網站自己知道」即可，那該怎麼做呢？</p><p>我們在 form 裡面加上一個隱藏的欄位，叫做 <code>csrf_token</code>，這裡面填的值由伺服器隨機產生，每一次表單操作都應該產生一個新的，並且存在伺服器的 session 資料中。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">POST</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">csrf_token</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">fj1iro2jro12ijoi1</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">刪除文章</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>按下送出之後，伺服器比對表單中的 <code>csrf_token</code> 與自己 session 裡面存的是不是一樣的，是的話就代表這的確是由自己的網站發出的 request。</p><p>那為什麼可以防禦呢？因為攻擊者並不知道 <code>csrf_token</code> 的值是什麼，也猜不出來，所以不知道該帶什麼值，伺服器的檢查就會失敗，操作就不會被執行。</p><p>接著讓我們來看看另外一種解法。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="double-submit-cookie">Double Submit Cookie<a href="#double-submit-cookie" class="hash-link" aria-label="Double Submit Cookie的直接連結" title="Double Submit Cookie的直接連結">​</a></h3><p>上一種解法需要伺服器的 state，亦即 CSRF token 必須被保存在伺服器當中，才能驗證正確性，而現在這個解法的好處就是完全不需要伺服器儲存東西。</p><p>這個解法的前半段與剛剛的相似，由伺服器產生一組隨機的 token 並且加在 form 上面。但不同的點在於，除了不用把這個值寫在 session 以外，同時也設定一個名叫 <code>csrf_token</code> 的 cookie，值也是同一組 token。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Set-Cookie: csrf_token=fj1iro2jro12ijoi1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">POST</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">csrf_token</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">fj1iro2jro12ijoi1</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">刪除文章</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>正如同前面所提過的，CSRF 防禦的核心是「辨識出攻擊的 request 與正常的 request」，而 Double Submit Cookie 這個解法也是從這個想法出發。</p><p>當使用者按下送出的時候，伺服器比對 cookie 內的 <code>csrf_token</code> 與 form 裡面的 <code>csrf_token</code>，檢查是否有值並且相等，就知道是不是網站發的了。</p><p>為什麼這樣可以防禦呢？</p><p>假設現在攻擊者想要發起攻擊，根據前面講的 CSRF 原理，cookie 中的 <code>csrf_token</code> 會一起送到 server，但是表單裡面的 <code>csrf_token</code> 呢？攻擊者在別的 origin 底下看不到目標網站的 cookie，更看不到表單內容，因此他不會知道正確的值是什麼。</p><p>當表單跟 cookie 中的 <code>csrf_token</code> 不一致時，攻擊就會被擋下。</p><p>不過這個方法看似好用，也是有缺點的，這個之後會再提到。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="純前端的-double-submit-cookie">純前端的 Double Submit Cookie<a href="#純前端的-double-submit-cookie" class="hash-link" aria-label="純前端的 Double Submit Cookie的直接連結" title="純前端的 Double Submit Cookie的直接連結">​</a></h3><p>會特別提到前端，是因為我之前所碰到的專案是 Single Page Application，上網搜尋一下就會發現有人在問：「SPA 該如何拿到 CSRF token？」，難道要伺服器再提供一個 API 嗎？這樣好像有點怪怪的。</p><p>但是呢，我們可以利用 Double Submit Cookie 的精神來解決這個問題。而解決這問題的關鍵就在於：由前端來產生 CSRF token，就不用跟伺服器 API 有任何的互動。</p><p>其他的流程都跟之前一樣，產生之後放到 form 裡面以及寫進 cookie。</p><p>那為什麼由前端來產生這個 token 也可以呢？因為這個 token 本身的目的其實不包含任何資訊，只是為了「不讓攻擊者」猜出而已，所以由前端 還是後來來產生都是一樣的，只要確保不被猜出來即可。</p><p>Double Submit Cookie 的核心概念是：「攻擊者的沒辦法讀寫目標網站的 cookie，所以 request 中的 token 會跟 cookie 內的不一樣」，只要能滿足這個條件，就能阻擋攻擊。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="其他解法">其他解法<a href="#其他解法" class="hash-link" aria-label="其他解法的直接連結" title="其他解法的直接連結">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="不要用-cookie-做身份驗證">不要用 cookie 做身份驗證<a href="#不要用-cookie-做身份驗證" class="hash-link" aria-label="不要用 cookie 做身份驗證的直接連結" title="不要用 cookie 做身份驗證的直接連結">​</a></h3><p>CSRF 之所以成立，前提是瀏覽器在發送請求時會自動帶上 cookie，而且這個 cookie 是拿來做身份驗證的。</p><p>所以如果我們不用 cookie 來做身份驗證，就沒有 CSRF 的問題了。</p><p>現在有許多網站都採取前後端分離的架構，把前端跟後端完全切開，前端就只是一個靜態網站，後端則只有提供純資料的 API，網頁跟畫面的顯示百分之百交給前端負責。而前後端的網域通常也會分開，例如說前端在 <code>https://huli.tw</code>，後端在 <code>https://api.huli.tw</code> 等等。</p><p>在這種架構下，比起傳統的 cookie-based 的身份驗證，有更多網站會選擇使用 JWT 搭配 HTTP header，把驗證身份的 token 存在瀏覽器的 localStorage 裡面，向後端發送 request 時放在 <code>Authorization</code> header 中，像這樣：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GET /me HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: api.huli.tw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: Bearer {JWT_TOKEN}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>像這種的驗證方式就完全沒有使用到 cookie，因此這機制天生就對 CSRF 免疫，不會有 CSRF 的問題。比起防禦方式，這更像是一種技術選擇。我相信很多人在選擇要用這種驗證方式時，並不知道這樣可以順便防止 CSRF。</p><p>不過，當然也有其他缺點就是了，例如說 cookie 可以用 <code>HttpOnly</code> 這個屬性讓瀏覽器讀取不到，讓攻擊者沒辦法直接偷到 token，但是 <code>localStorage</code> 並沒有類似的機制，一旦被 XSS 攻擊，攻擊者就可以輕鬆把 token 拿走。</p><p>有關 token 的儲存我們之前在 XSS 的第三道防線那裡也聊過了，這邊就不再提了。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="加上-custom-header">加上 custom header<a href="#加上-custom-header" class="hash-link" aria-label="加上 custom header的直接連結" title="加上 custom header的直接連結">​</a></h3><p>當我們在講 CSRF 攻擊的時候，拿來使用的範例是表單跟圖片，而這些送出請求的方式不能帶上 HTTP header，因此前端在打 API 的時候，可以帶上一個 <code>X-Version: web</code> 之類的 heaedr，如此一來後端就可以根據有沒有這個 header，辨識出這個請求是不是合法的。</p><p>雖然乍聽之下沒問題，但要小心的是我們剛剛才提過的 CORS 設定。</p><p>除了表單或是圖片，攻擊者也可以利用 fetch 直接發出一個跨站的請求，並且含有 header：</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">headers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&#x27;X-Version&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;web&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但是帶有自訂 header 的請求是非簡單請求，因此需要通過 preflight request 的檢查，才會真正發送出去。所以，如果你伺服器端的 CORS 實作是沒有問題的，那這個防禦也是沒問題的。</p><p>那若是 CORS 設置有問題的話呢？那就沒辦法防禦 CSRF 攻擊了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="實際案例">實際案例<a href="#實際案例" class="hash-link" aria-label="實際案例的直接連結" title="實際案例的直接連結">​</a></h2><p>第一個要介紹的案例是 2022 年 Google Cloud Shell 的 CSRF 漏洞，有一個可以上傳檔案的 API 並沒有任何 CSRF 的防護，因此攻擊者可以利用這個漏洞上傳 <code>~/.bash_profile</code> 之類的，在使用者每次執行 bash 時就會執行到攻擊的上傳的指令。</p><p>全文可以參考：<a href="https://obmiblog.blogspot.com/2022/12/gcp-2022-few-bugs-in-google-cloud-shell.html" target="_blank" rel="noopener noreferrer">[ GCP 2022 ] Few bugs in the google cloud shell</a></p><p>第二個是 2023 年一間名叫 Ermetic 的資安公司發現的在 Azure web service 上的漏洞，這個過程滿有趣的。</p><p>Azure web service 跟 Heroku 有點類似，你把 code 準備好以後就可以直接把一個 web 應用程式部署上去，而這些 server 上除了你的應用程式，預設還會安裝一個 Kudu SCM，讓你看一些環境變數跟設定等等，還可以下載 log 之類的，需要登入才能使用。</p><p>而這次要講的漏洞就是在 Kudu SCM 發現的。Kudu SCM 的 API 並沒有使用 CSRF token，而是用了我們提過的「檢查 Origin header」的方式去驗證請求是否合法。</p><p>假設 server 的 URL 是：<code>https://huli.scm.azurewebsites.net</code>，那底下幾個 origin 都會回傳錯誤：</p><ol><li><code>https://huli.scm.azurewebsites.net.attacker.com</code> （加在後面）</li><li><code>https://attacker.huli.scm.azurewebsites.net</code> （加在前面）</li><li><code>http://huli.scm.azurewebsites.net</code> （改成 HTTP）</li></ol><p>雖然看似沒有希望，但他們卻發現只要加上除了 <code>_</code> 跟 <code>-</code> 以外的字元在特定位置，就可以繞過這個限制。</p><p>例如說 <code>https://huli.scm.azurewebsites.net$.attacker.com</code> 就可以通過檢查。</p><p>但問題是對於瀏覽器來說，這些特殊符號不是合法的 domain 名稱，那該怎麼辦呢？</p><p>他們發現了 <code>_</code> 可以作為 subdomain 的名稱，因此可以構造出這樣的網址：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">https://huli.scm.azurewebsites.net._.attacker.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>用這個網址，就可以繞過 server 對於 origin 的檢查（原因是 server 的 RegExp 沒寫好）。繞過檢查以後開始看有哪些 API 可以利用，找到了一個 <code>/api/zipdeploy</code>，可以直接把壓縮檔部署到 server 上！</p><p>所以透過這個 CSRF 的漏洞，攻擊者可以在使用者的 Azure web service 上面部署程式碼，達成 RCE。攻擊方式是準備好一個會呼叫 API 的 HTML，host <code>https://huli.scm.azurewebsites.net._.attacker.com</code> 上，接著傳給目標。</p><p>只要目標處在登入狀態並且點了連結，就會中招。</p><p>他們把這個攻擊稱之為 EmojiDeploy，因為繞過的網址的其中一部分 <code>._.</code> 很像表情符號，聽起來十分可愛。</p><p>這邊我有省略一些細節沒講，全文可以看：<a href="https://ermetic.com/blog/azure/emojideploy-smile-your-azure-web-service-just-got-rced/" target="_blank" rel="noopener noreferrer">EmojiDeploy: Smile! Your Azure web service just got RCE’d ._.</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="漏洞連連看csrf-與-self-xss">漏洞連連看：CSRF 與 self-XSS<a href="#漏洞連連看csrf-與-self-xss" class="hash-link" aria-label="漏洞連連看：CSRF 與 self-XSS的直接連結" title="漏洞連連看：CSRF 與 self-XSS的直接連結">​</a></h2><p>在之前提到 XSS 時，我有介紹了一種 self-XSS，指的是只對自己有作用的 XSS。</p><p>舉例來說，電話號碼有 XSS 的漏洞，但是電話號碼只在我自己的個人資料設定頁面看得到，其他人是看不到的，所以除非我自己把電話號碼改成 XSS payload，否則也無法發起攻擊。</p><p>不覺得這就是個結合 CSRF 的好時機嗎？</p><p>假設修改個人資料頁面有 CSRF 漏洞，就可以利用 CSRF 把受害者的電話號碼改成 XSS payload，然後再開啟個人資料頁面，如此一來就把 self-XSS 轉變成一個真的 XSS 了！</p><p>原本的 self-XSS 漏洞沒什麼影響，很多 bug bounty 平台可能不收，但結合了 CSRF 以後就變成了一個真的有影響力的 XSS，提升了嚴重程度，平台就會收了。</p><p>一個實際的案例是 2016 年時 @fin1te 向 Uber 回報的漏洞：<a href="https://whitton.io/articles/uber-turning-self-xss-into-good-xss/" target="_blank" rel="noopener noreferrer">Uber Bug Bounty: Turning Self-XSS into Good-XSS</a>，雖然有點久了但是裡面的技巧依舊很實用。</p><p>他在 <code>partners.uber.com</code> 找到了一個 self-XSS，接著結合了 logout CSRF，把現在的使用者在 <code>partners.uber.com</code> 網域登出，但是在 <code>login.uber.com</code> 網域依舊保持著登入狀態。</p><p>然後利用 login CSRF 登入自己預先準備好的帳號，登入之後就可以觸發 XSS，此時再利用 iframe 把使用者再度登入回去，就能夠利用這個 XSS 去讀取現在的使用者資料，完美地把這幾個漏洞串起來，發揮了更大的影響力。</p><p>流程比較複雜一點，但是這個漏洞的串連也相當有趣，利用 CSP 來阻擋頁面的跳轉也是一個很新穎的做法！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="小結">小結<a href="#小結" class="hash-link" aria-label="小結的直接連結" title="小結的直接連結">​</a></h2><p>資安世界裡的漏洞環環相扣，在選擇修復方法時，同時也可以注意對於其他漏洞的影響。</p><p>舉例來說，「不要用 cookie 做身份驗證」雖然可以解決 CSRF 的問題，但是卻讓 XSS 能夠偷到 token，增加了 XSS 能夠影響的範圍。而「加上 custom header」雖然乍看之下可以防禦 CSRF，但如果 CORS 設置有問題，這個防禦方式就無效了。</p><p>因此，「加上 CSRF token」是比較好而且也最普遍的方式，或其實資安的防禦也不是只能用一種，可以把上面提到的幾種混在一起用。</p><p>例如說我在 CSS injection 的時候有提過 HackMD 的案例，我雖然拿到了 CSRF token 但還是無法攻擊，就是因為伺服器有做了第二層的保護，驗證 <code>Origin</code> header。</p><p>而剛剛提過的 EmojiDeploy 則是一個反例，他們只驗證了 <code>Origin</code> header 而且還實作錯誤，就被攻擊了，如果他們有額外加上 CSRF token 的保護，就可以防住攻擊。</p><p>參考資料：</p><ol><li><a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)#Prevention_measures_that_do_NOT_work" target="_blank" rel="noopener noreferrer">Cross-Site Request Forgery (CSRF)</a></li><li><a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet" target="_blank" rel="noopener noreferrer">Cross-Site Request Forgery (CSRF) Prevention Cheat Sheet</a></li><li><a href="http://m.2cto.com/article/201505/400902.html" target="_blank" rel="noopener noreferrer">一次较为深刻的CSRF认识</a></li><li><a href="http://cyrilwang.pixnet.net/blog/post/31813672" target="_blank" rel="noopener noreferrer">[技術分享] Cross-site Request Forgery (Part 2)</a></li><li><a href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#csrf" target="_blank" rel="noopener noreferrer">Spring Security Reference</a></li><li><a href="https://www.ibm.com/developerworks/cn/web/1102_niugang_csrf/" target="_blank" rel="noopener noreferrer">CSRF 攻击的应对之道</a></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件選項卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/ch4/cors-attack/"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">跨來源的安全性問題</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/ch4/same-site-cookie/"><div class="pagination-nav__sublabel">下一頁</div><div class="pagination-nav__label">Same-site cookie，CSRF 的救星？</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#從偷懶的刪除功能開始介紹-csrf" class="table-of-contents__link toc-highlight">從偷懶的刪除功能開始介紹 CSRF</a></li><li><a href="#使用者的防禦" class="table-of-contents__link toc-highlight">使用者的防禦</a></li><li><a href="#伺服器的防禦" class="table-of-contents__link toc-highlight">伺服器的防禦</a><ul><li><a href="#檢查-referer-或是-origin-header" class="table-of-contents__link toc-highlight">檢查 Referer 或是 Origin header</a></li><li><a href="#加上圖形驗證碼或是簡訊驗證碼等等" class="table-of-contents__link toc-highlight">加上圖形驗證碼或是簡訊驗證碼等等</a></li></ul></li><li><a href="#常見的防禦方式" class="table-of-contents__link toc-highlight">常見的防禦方式</a><ul><li><a href="#加上-csrf-token" class="table-of-contents__link toc-highlight">加上 CSRF token</a></li><li><a href="#double-submit-cookie" class="table-of-contents__link toc-highlight">Double Submit Cookie</a></li><li><a href="#純前端的-double-submit-cookie" class="table-of-contents__link toc-highlight">純前端的 Double Submit Cookie</a></li></ul></li><li><a href="#其他解法" class="table-of-contents__link toc-highlight">其他解法</a><ul><li><a href="#不要用-cookie-做身份驗證" class="table-of-contents__link toc-highlight">不要用 cookie 做身份驗證</a></li><li><a href="#加上-custom-header" class="table-of-contents__link toc-highlight">加上 custom header</a></li></ul></li><li><a href="#實際案例" class="table-of-contents__link toc-highlight">實際案例</a></li><li><a href="#漏洞連連看csrf-與-self-xss" class="table-of-contents__link toc-highlight">漏洞連連看：CSRF 與 self-XSS</a></li><li><a href="#小結" class="table-of-contents__link toc-highlight">小結</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/assets/js/runtime~main.f2e5ea11.js"></script>
<script src="/beyond-xss/assets/js/main.ae4d3a33.js"></script>
</body>
</html>