<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch4/csrf" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">クロスサイトリクエストフォージェリ（CSRF）を簡単に理解する | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/ja/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/ja/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/ja/ch4/csrf/"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="google-site-verification" content="O7SjDEO9AQXbxqBWhtUW0FVahHxSrnweMXJxLICpSz4"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="クロスサイトリクエストフォージェリ（CSRF）を簡単に理解する | Beyond XSS"><meta data-rh="true" name="description" content="以前、クロスオリジンデータ共有であるCORSと、攻撃者がユーザーの個人情報や機密データにアクセスできる可能性について説明しました。そこでの焦点はデータの「読み取り」でした。"><meta data-rh="true" property="og:description" content="以前、クロスオリジンデータ共有であるCORSと、攻撃者がユーザーの個人情報や機密データにアクセスできる可能性について説明しました。そこでの焦点はデータの「読み取り」でした。"><link data-rh="true" rel="icon" href="/beyond-xss/ja/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/ja/ch4/csrf/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch4/csrf/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/csrf/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ja/ch4/csrf/" hreflang="ja"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/csrf/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/ja/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/ja/assets/js/runtime~main.c9f49c76.js" as="script">
<link rel="preload" href="/beyond-xss/ja/assets/js/main.b4cb8381.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/ja/"><div class="navbar__logo"><img src="/beyond-xss/ja/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/ja/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS：Webフロントエンドセキュリティの世界を探る</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>日本語</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch4/csrf/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/beyond-xss/ch4/csrf/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-TW">中文（台灣）</a></li><li><a href="/beyond-xss/ja/ch4/csrf/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="ja">日本語</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/ja/">このシリーズについて</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">第一章：XSSから見たフロントエンド・セキュリティ</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch1/browser-security-model/">ブラウザのセキュリティモデル</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch1/xss-introduction/">XSSから始めるフロントエンドのセキュリティ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch1/know-xss-a-bit-more/">XSSについてもう少し詳しく</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch1/javascript-protocol/">危険な javascript: 疑似スキーム</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">第二章：XSSの防御と回避</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/xss-defense-sanitization/">XSSの第一の防御線：サニタイズ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/xss-defense-csp/">XSSの第二の防御線：CSP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/token-storage/">XSSの第三の防御線：影響範囲の縮小</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/trust-types/">最新のXSS防御：Trusted Typesと組み込みSanitizer API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/csp-bypass/">防御の回避：一般的なCSPバイパス</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/mutation-xss/">防御の回避：Mutation XSS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/universal-xss/">最強のXSS：Universal XSS</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">第三章：JavaScriptを使わない攻撃</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/attack-without-js/">攻撃にJavaScriptを直接実行する必要があるなんて誰が言った？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/prototype-pollution/">プロトタイプチェーンを悪用した攻撃：Prototype Pollution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/dom-clobbering/">HTMLもJavaScriptに影響を与える？DOM clobbering入門</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/csti/">フロントエンドのテンプレートインジェクション攻撃：CSTI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/css-injection/">CSSだけで攻撃できる？CSSインジェクション（前編）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/css-injection-2/">CSSだけで攻撃できる？CSSインジェクション（後編）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/html-attack/">HTMLだけで攻撃できる？</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">第四章：クロスサイト攻撃</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/sop-and-site/">最重要：同一オリジンポリシーとサイト</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/cors-intro/">クロスオリジンリソース共有 CORS 基本紹介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/cors-attack/">クロスオリジンセキュリティの問題</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/ja/ch4/csrf/">クロスサイトリクエストフォージェリ（CSRF）を簡単に理解する</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/same-site-cookie/">Same-site Cookie、CSRFの救世主？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/subdomain/">Same-Siteからメインサイトへ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/cookie-bomb/">面白くて実用的なCookie Bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">第五章：その他の興味深いフロントエンド・セキュリティのトピック</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/clickjacking/">あなたの画面はあなたの画面ではない：クリックジャッキング</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/mime-sniffing/">MIMEスニッフィングを利用した攻撃</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/supply-chain-attack/">フロントエンドサプライチェーン攻撃：上流から下流への攻撃</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/web3-attacks/">Web3におけるウェブフロントエンド攻撃の応用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/xsleaks-1/">最も興味深いフロントエンドサイドチャネル攻撃：XSLeaks（パート1）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/xsleaks-2/">最も興味深いフロントエンドサイドチャネル攻撃：XSLeaks（パート2）</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/ja/summary/">まとめ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/ja/contact/">著者への連絡</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/beyond-xss/ja/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">第四章：クロスサイト攻撃</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">クロスサイトリクエストフォージェリ（CSRF）を簡単に理解する</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><h1>クロスサイトリクエストフォージェリ（CSRF）を簡単に理解する</h1><p>以前、クロスオリジンデータ共有であるCORSと、攻撃者がユーザーの個人情報や機密データにアクセスできる可能性について説明しました。そこでの焦点はデータの「読み取り」でした。</p><p>さて、CSRF（Cross-Site Request Forgery）と呼ばれる別の同様の攻撃について話しましょう。ここでの重要な違いは、CSRFが「アクションの実行」に焦点を当てていることです。</p><p>簡単な例を通して、CSRFとは何かを理解することから始めましょう！</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="削除機能によるcsrfの紹介">削除機能によるCSRFの紹介<a href="#削除機能によるcsrfの紹介" class="hash-link" aria-label="削除機能によるCSRFの紹介 への直接リンク" title="削除機能によるCSRFの紹介 への直接リンク">​</a></h2><p>以前、ブログのようなシンプルなバックエンドページを作成したことがあります。記事の作成、削除、編集機能がありました。</p><p>削除機能を実装する方法はたくさんありますが、API呼び出しを行ったり、フォームを送信したりするなどです。しかし、私は怠惰だったので、より簡単なアプローチを選びました。</p><p>簡単にするために、この機能をGETリクエストにすれば、フロントエンドでほとんどコードを書かずにリンクだけで削除を達成できると考えました。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">/delete?id=3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">削除</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>便利ですよね？そして、バックエンドでは、リクエストにセッションIDが含まれているか、記事がそのIDの作成者によって書かれたものかを確認する検証を追加しました。両方の条件が満たされた場合にのみ、記事が削除されます。</p><p>やるべきことはすべてやったように見えます。「作成者本人のみが自分の記事を削除できる」のです。安全なはずですよね？何か見落としはありますか？</p><p>確かに、権限チェックは正しく、「作成者本人のみが自分の記事を削除できる」のです。しかし、作成者の知らないうちに他の誰かが記事を削除した場合はどうなるでしょうか？私が何を言っているのかわからないと思うかもしれません。作成者が開始しなかったのに、どうやって記事を削除できるのでしょうか？</p><p>さて、それがどのように行われるかをお見せしましょう！</p><p>ボブが悪意のある悪役で、ピーターに気づかれずに自分の記事を削除させたいとします。どうすればよいでしょうか？</p><p>ピーターが心理テストが大好きであることを知っているボブは、心理テストのウェブサイトを作成し、ピーターに送信します。ただし、このテストウェブサイトには次のようなボタンがあります。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete?id=3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">テストを開始</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>興奮したピーターは「テストを開始」ボタンをクリックします。クリックすると、ブラウザは<code>https://small-min.blog.com/delete?id=3</code>にGETリクエストを送信し、ブラウザのメカニズムにより、<code>small-min.blog.com</code>のCookieも一緒に送信します。</p><p>サーバーがリクエストを受信すると、セッションを確認し、それが確かにピーターであり、記事が彼によって書かれたものであることを確認します。その結果、サーバーは記事を削除します。</p><p>これがCSRF、クロスサイトリクエストフォージェリです。</p><p>あなたは明らかに心理テストのウェブサイト（例えば<code>https://test.com</code>）にいますが、知らず知らずのうちに<code>https://small-min.blog.com</code>の記事を削除してしまいました。恐ろしくないですか？超怖いです！</p><p>これが、CSRFがワンクリック攻撃とも呼ばれる理由です。ワンクリックで侵害されてしまいます。</p><p>観察力の鋭い人は、「でも、ピーターは何が起こったのか気づかないの？ブログにアクセスしたのだから、『知らないうちに』という条件には合わないのでは？」と言うかもしれません。</p><p>これらは些細な問題です。このように変更したらどうでしょうか。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">img</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete?id=3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">width</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">0</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">height</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">0</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">/test</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">テストを開始</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ページを開く際に、見えない画像で密かに削除リクエストを送信します。今回は、ピーターは本当に何も知りません。これで条件に合致します！</p><p>この簡単な例から、CSRFの原理と攻撃方法が明確にわかります。</p><p>CSRF攻撃の目的は、「別のウェブサイトからターゲットのウェブサイトにリクエストを送信し、ターゲットのウェブサイトに、そのリクエストがユーザー自身によって開始されたと誤認させること」です。</p><p>これを達成するには、ブラウザのメカニズムに依存します。ウェブサイトにリクエストを送信すると、関連するCookieが含まれます。ユーザーがログインしている場合、リクエストには当然その情報（セッションIDなど）が含まれ、ユーザーがリクエストを開始したかのように見えます。</p><p>結局のところ、サーバーは通常、あなたが誰であるかを気にしません。Cookie、より正確にはCookieに含まれる情報のみを認識します。サイトAからサイトBにリクエストを送信すると、サイトBのCookieが含まれます。同様に、サイトCからサイトBにリクエストを送信すると、サイトBのCookieも含まれます。これがCSRFが機能する主な理由です。</p><p>しかし、上記の例には欠陥があります。「削除リクエストをPOSTに変更すればよいのでは？」</p><p>その通りです！怠けずに、削除機能をPOSTを使用して適切に実装しましょう。こうすれば、<code>&lt;a&gt;</code>や<code>&lt;img&gt;</code>を介して攻撃することはできなくなりますよね？除非…POSTリクエストを送信できるHTML要素があるのでしょうか？</p><p>あります、それは<code>&lt;form&gt;</code>と呼ばれます。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">POST</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">テストを開始</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ピーターがそれをクリックした後、彼は再び罠にはまり、記事は削除されました。前回は見えない画像を介して、今回はフォームを介してです。</p><p>しかし、ピーターはそれに気づかないのだろうかと疑問に思うかもしれません。私も懐疑的だったので、Googleで検索してこの記事を見つけました：<a href="http://stackoverflow.com/questions/17940811/example-of-silently-submitting-a-post-form-csrf" target="_blank" rel="noopener noreferrer">Example of silently submitting a POST FORM (CSRF)</a></p><p>記事で提供されている例は次のとおりです。ウェブの世界は本当に広大で深遠です。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">iframe</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">style</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value css language-css property" style="color:#36acaa">display</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#e3116c">none</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">csrf-frame</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">iframe</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">POST</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">target</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">csrf-frame</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">csrf-form</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f"></span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">getElementById</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&quot;csrf-form&quot;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">submit</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>見えないiframeを開き、フォーム送信後の結果がiframe内に表示されるようにします。そして、このフォームはピーターの操作なしに自動的に送信することもできます。</p><p>この時点で、POSTに変更しても無駄であり、CSRFの問題は依然として存在することがわかります。</p><p>そこで、あなたは賢いアイデアを思いつきます。「フロントエンドではフォームしかPOSTリクエストを送信できないのだから、APIをJSON形式でデータを受け入れるように変更すればいいのでは？そうすればフォームは使えなくなるでしょう！」</p><p>HTMLフォームの場合、<code>enctype</code>は3種類のみサポートしています。</p><ol><li><code>application/x-www-form-urlencoded</code></li><li><code>multipart/form-data</code></li><li><code>text/plain</code></li></ol><p>ほとんどの場合、最初のタイプが使用され、ファイルアップロードの場合は2番目のタイプが使用され、3番目のタイプはめったに使用されません。サーバー側でJSONを解析したい場合、通常、コンテンツタイプは<code>application/json</code>になります。</p><p>したがって、この記述は半分正しいです。一部のサーバーでは、リクエストのコンテンツタイプが<code>application/json</code>でない場合、エラーをスローし、有効なリクエストとは見なしません。</p><p>誤っている部分は、他のサーバーでは、ボディコンテンツがJSON形式である限り、コンテンツタイプが<code>text/plain</code>であっても受け入れられるということです。JSON形式のボディは、以下のフォームを使用して構築できます。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">post</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">enctype</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">text/plain</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f"></span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">{</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">:3, </span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">ignore_me</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">:</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">test</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">}</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">delete!</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>&lt;form&gt;</code>は<code>name=value</code>というルールに従ってリクエストボディを生成するため、上記のフォームは次のリクエストボディを生成します。</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token string-property property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-property property" style="color:#36acaa">&quot;ignore_me&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;=test&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>記事の削除の例を使用しましたが、これは重要ではないように思えるかもしれません。しかし、銀行振込の場合はどうでしょうか？攻撃者は自分のウェブページに自分の口座に送金するコードを記述し、このウェブページを配布するだけで、多額の金銭を受け取ることができます。</p><p>たくさん話しましたが、それに対する防御方法について話しましょう！最も簡単な防御である「ユーザー」から始めましょう。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ユーザーによる防御">ユーザーによる防御<a href="#ユーザーによる防御" class="hash-link" aria-label="ユーザーによる防御 への直接リンク" title="ユーザーによる防御 への直接リンク">​</a></h2><p>CSRF攻撃が機能するのは、ユーザーが攻撃対象のウェブページに既にログインしているため、特定のアクションを実行できるからです。これらの攻撃はウェブページ側で処理されるべきですが、本当に心配で、ウェブページが適切に処理できないのではないかと懸念している場合は、ウェブサイトの使用後に毎回ログアウトすることでCSRFを回避できます。</p><p>しかし、ユーザーができることは実際には非常に限られています。実際の作業はサーバー側で行われるべきです。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="サーバー防御">サーバー防御<a href="#サーバー防御" class="hash-link" aria-label="サーバー防御 への直接リンク" title="サーバー防御 への直接リンク">​</a></h2><p>CSRFが危険な理由は、その名前にある「CS」、つまりクロスサイトだからです。どのウェブサイトからでも攻撃を開始できます。CSRFに対する防御は、この観点から考えることができます。簡単に言えば、「他のソースからのリクエストをどのようにブロックできるか？」ということです。</p><p>よく考えてみてください。CSRF攻撃のリクエストとユーザーが行ったリクエストの違いは何でしょうか？</p><p>違いはオリジンにあり、前者は任意のオリジンから送信され、後者は同じオリジンから送信されます（APIとフロントエンドウェブサイトが同じオリジンにあると仮定します）。バックエンドでこれを区別できれば、どのリクエストを信頼すべきかを判断できます。</p><p>あまり一般的ではない防御方法について話しましょう。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="refererまたはoriginヘッダーの確認">RefererまたはOriginヘッダーの確認<a href="#refererまたはoriginヘッダーの確認" class="hash-link" aria-label="RefererまたはOriginヘッダーの確認 への直接リンク" title="RefererまたはOriginヘッダーの確認 への直接リンク">​</a></h3><p>リクエストのヘッダーには<code>referer</code>というフィールドが含まれており、リクエストがどこから来たかを示します。このフィールドをチェックして、有効なオリジンであるかどうかを確認できます。そうでない場合は、単に拒否します。</p><p>一部のリクエストには<code>origin</code>ヘッダーも含まれており、これは同じことを意味し、リクエストがどこから来たかを示します。</p><p>ただし、このチェック方法には注意すべき点が3つあります。まず、場合によっては、リファラーやオリジンがリクエストに含まれていない可能性があり、その場合は何もチェックできません。</p><p>第二に、一部のユーザーはリファラー機能を無効にしている可能性があり、その場合、サーバーは正規のユーザーからのリクエストを拒否します。</p><p>第三に、有効なオリジンかどうかを判断するコードにバグがないことを保証する必要があります。例えば、</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> referer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">referer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">referer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">indexOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;small-min.blog.com&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上記のコードの問題点に気づきましたか？攻撃者のウェブページが<code>small-min.blog.com.attack.com</code>の場合、チェックはバイパスされます。</p><p>したがって、<code>referer</code>または<code>origin</code>の確認は、あまり効果的な解決策ではありません。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="captchaまたはsms認証の追加">CAPTCHAまたはSMS認証の追加<a href="#captchaまたはsms認証の追加" class="hash-link" aria-label="CAPTCHAまたはSMS認証の追加 への直接リンク" title="CAPTCHAまたはSMS認証の追加 への直接リンク">​</a></h3><p>オンラインバンキングで送金する際と同様に、SMSで送信された認証コードの入力を求められることがよくあります。この追加のチェックを追加することで、CSRF攻撃からの保護を保証できます。別のオプションはCAPTCHAを使用することです。攻撃者はCAPTCHAの答えを知らないため、攻撃を続行できません。</p><p>これは包括的な解決策ですが、ユーザーエクスペリエンスに影響を与える可能性があります。ユーザーはコメントを残すたびにCAPTCHAを入力するのが面倒だと感じるかもしれません！</p><p>したがって、この保護方法は、銀行振込、パスワード変更、給与明細の表示などの重要な操作に適しています。これらの場合、追加の検証レイヤーを実装する必要があります。「SMS認証コード（または電子メール）の受信」という方法は、CSRF攻撃を防ぐだけでなく、XSSからも保護します。ハッカーがページ上でコードを実行できたとしても、携帯電話や電子メールから認証コードを取得することはできません。認証コードを知らなければ、それ以上の操作はできません。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一般的な防御方法">一般的な防御方法<a href="#一般的な防御方法" class="hash-link" aria-label="一般的な防御方法 への直接リンク" title="一般的な防御方法 への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="csrfトークンの追加">CSRFトークンの追加<a href="#csrfトークンの追加" class="hash-link" aria-label="CSRFトークンの追加 への直接リンク" title="CSRFトークンの追加 への直接リンク">​</a></h3><p>CSRF攻撃を防ぐには、特定の情報が「ウェブサイトのみに知られている」ことを保証するだけで済みます。これをどのように達成できるでしょうか？</p><p>フォーム内に<code>csrf_token</code>という名前の隠しフィールドを追加します。このフィールドの値はサーバーによってランダムに生成され、フォーム送信ごとに一意である必要があります。トークンはサーバーのセッションデータに保存されます。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">POST</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">csrf_token</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">fj1iro2jro12ijoi1</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">削除</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>フォームを送信した後、サーバーはフォーム内の<code>csrf_token</code>をセッションデータに保存されているものと比較します。それらが一致する場合、リクエストはウェブサイト自体によって送信されたことを意味します。</p><p>なぜこれが機能するのでしょうか？攻撃者は<code>csrf_token</code>の値を知らず、推測することもできないからです。したがって、正しい値を提供できず、サーバーのチェックが失敗し、操作がブロックされます。</p><p>次に、別の解決策を見てみましょう。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ダブルサブミットクッキー">ダブルサブミットクッキー<a href="#ダブルサブミットクッキー" class="hash-link" aria-label="ダブルサブミットクッキー への直接リンク" title="ダブルサブミットクッキー への直接リンク">​</a></h3><p>以前の解決策ではサーバー側の状態が必要でした。つまり、CSRFトークンをサーバーに保存してその正当性を検証する必要がありました。この新しい解決策の利点は、サーバーに何も保存する必要がないことです。</p><p>この解決策の前半は以前のものと似ています。サーバーはランダムなトークンを生成し、それをフォームに追加します。ただし、この値をセッションに保存する代わりに、同じトークン値を持つ<code>csrf_token</code>という名前のCookieが設定されます。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Set-Cookie: csrf_token=fj1iro2jro12ijoi1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">form</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">action</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">https://small-min.blog.com/delete</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">method</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">POST</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">id</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">hidden</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">csrf_token</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">fj1iro2jro12ijoi1</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">submit</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">削除</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">form</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>前述の通り、CSRF防御の核心は「悪意のあるリクエストと正当なリクエストを区別すること」です。ダブルサブミットクッキーソリューションはこの考えに基づいています。</p><p>ユーザーがフォームを送信すると、サーバーはクッキー内の<code>csrf_token</code>とフォーム内の<code>csrf_token</code>を比較し、値があるかどうか、等しいかどうかを確認します。これにより、サーバーはリクエストがウェブサイトによって送信されたかどうかを判断できます。</p><p>なぜこれが機能するのでしょうか？</p><p>攻撃者が攻撃を開始したいとします。前述のCSRFの原理によれば、Cookie内の<code>csrf_token</code>がサーバーに送信されます。しかし、フォーム内の<code>csrf_token</code>はどうでしょうか？攻撃者は別のオリジンからターゲットウェブサイトのCookieを見ることも、フォームの内容を見ることもできません。したがって、正しい値を知りません。</p><p>フォームとCookieの<code>csrf_token</code>が一致しない場合、攻撃はブロックされます。</p><p>ただし、この方法には欠点があり、後で説明します。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="純粋なフロントエンドのダブルサブミットクッキー">純粋なフロントエンドのダブルサブミットクッキー<a href="#純粋なフロントエンドのダブルサブミットクッキー" class="hash-link" aria-label="純粋なフロントエンドのダブルサブミットクッキー への直接リンク" title="純粋なフロントエンドのダブルサブミットクッキー への直接リンク">​</a></h3><p>フロントエンドについて特に言及する理由は、以前にシングルページアプリケーション（SPA）であるプロジェクトに遭遇したことがあるからです。オンラインで検索すると、「SPAはどのようにCSRFトークンを取得できるのか？」という質問をしている人が見つかります。サーバーはこのためにAPIを提供する必要があるのでしょうか？少し奇妙に思えます。</p><p>しかし、この問題を解決するためにダブルサブミットクッキーの精神を利用することができます。この問題を解決する鍵は、サーバーAPIとのやり取りなしにフロントエンドにCSRFトークンを生成させることです。</p><p>残りのプロセスは同じです。トークンを生成し、フォームに追加し、Cookieに書き込みます。</p><p>なぜフロントエンドがこのトークンを生成できるのでしょうか？このトークン自体の目的には情報が含まれていないからです。攻撃者がそれを推測するのを防ぐためだけです。したがって、フロントエンドまたはバックエンドのどちらで生成されても、推測されない限り、同じ目的を果たします。</p><p>ダブルサブミットクッキーの核心的な概念は、「攻撃者はターゲットウェブサイトのクッキーを読み書きできないため、リクエスト内のトークンはクッキー内のトークンとは異なる」ということです。この条件が満たされる限り、攻撃はブロックできます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="その他の解決策">その他の解決策<a href="#その他の解決策" class="hash-link" aria-label="その他の解決策 への直接リンク" title="その他の解決策 への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="認証にcookieを使用しない">認証にCookieを使用しない<a href="#認証にcookieを使用しない" class="hash-link" aria-label="認証にCookieを使用しない への直接リンク" title="認証にCookieを使用しない への直接リンク">​</a></h3><p>CSRF攻撃は、ブラウザがリクエストに自動的にCookieを含めること、特に認証に使用されるCookieに依存しています。</p><p>したがって、認証にCookieを使用しなければ、CSRFの問題は発生しません。</p><p>最近の多くのウェブサイトでは、フロントエンドとバックエンドを分離したアーキテクチャを採用しており、フロントエンドは静的なウェブサイトであり、バックエンドはAPIを介してデータのみを提供します。フロントエンドとバックエンドのドメインはしばしば分離されており、例えば、フロントエンドは<code>https://huli.tw</code>、バックエンドは<code>https://api.huli.tw</code>などです。</p><p>このアーキテクチャでは、従来のCookieベースの認証の代わりに、多くのウェブサイトがHTTPヘッダーとともにJWT（JSON Web Token）を使用することを選択しています。認証トークンはブラウザのlocalStorageに保存され、<code>Authorization</code>ヘッダーでバックエンドに送信されます。次のようになります。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GET /me HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: api.huli.tw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: Bearer {JWT_TOKEN}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>この種の認証方法はCookieの使用を完全に回避するため、CSRF攻撃に対して免疫があります。これは防御メカニズムというよりも技術的な選択です。この認証方法を選択する多くの人々は、それがCSRFも防ぐことを認識していないと私は信じています。</p><p>ただし、他の欠点もあります。例えば、Cookieは<code>HttpOnly</code>属性で設定してブラウザが直接アクセスできないようにすることができ、攻撃者がトークンを盗むのを困難にします。しかし、<code>localStorage</code>には同様のメカニズムがありません。XSS攻撃によって侵害されると、攻撃者は簡単にトークンを盗むことができます。</p><p>XSSに対する第3の防御線に関する以前の議論でトークンストレージについて説明したので、ここでは再度触れません。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="カスタムヘッダーの追加">カスタムヘッダーの追加<a href="#カスタムヘッダーの追加" class="hash-link" aria-label="カスタムヘッダーの追加 への直接リンク" title="カスタムヘッダーの追加 への直接リンク">​</a></h3><p>CSRF攻撃について議論する際、使用される例は通常フォームと画像であり、これらはリクエストにHTTPヘッダーを含めることができません。したがって、フロントエンドからAPI呼び出しを行う際に、<code>X-Version: web</code>のようなカスタムヘッダーを含めることで、バックエンドがこのヘッダーの有無に基づいてリクエストが正当であるかどうかを識別できるようにすることができます。</p><p>これは問題ないように聞こえるかもしれませんが、前述のようにCORS設定に注意する必要があります。</p><p>フォームや画像に加えて、攻撃者は<code>fetch</code>を使用して、次のようなカスタムヘッダーを持つクロスサイトリクエストを直接送信することもできます。</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;POST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">headers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&quot;X-Version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;web&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ただし、カスタムヘッダーを持つリクエストは非シンプルリクエストと見なされ、実際に送信される前にプリフライトリクエストチェックを通過する必要があります。したがって、サーバー側のCORS実装が正しければ、この防御メカニズムは正常に機能します。</p><p>しかし、CORS設定に問題がある場合はどうでしょうか？その場合、CSRF攻撃から防御することはできません。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="実際の事例">実際の事例<a href="#実際の事例" class="hash-link" aria-label="実際の事例 への直接リンク" title="実際の事例 への直接リンク">​</a></h2><p>最初に紹介する事例は、Obmi氏が発見した2022年のGoogle Cloud ShellにおけるCSRF脆弱性です。ファイルアップロード用のAPIにCSRF保護が一切施されておらず、攻撃者はこの脆弱性を悪用して<code>~/.bash_profile</code>のようなファイルをアップロードし、ユーザーがbashを実行するたびにアップロードされたコマンドが実行されるようにすることができました。</p><p>全文は以下を参照してください：<a href="https://obmiblog.blogspot.com/2022/12/gcp-2022-few-bugs-in-google-cloud-shell.html" target="_blank" rel="noopener noreferrer">[ GCP 2022 ] Few bugs in the google cloud shell</a></p><p>2番目のケースは、2023年にErmeticというサイバーセキュリティ企業がAzure Webサービスで発見した脆弱性です。これは非常に興味深いものです。</p><p>Azure WebサービスはHerokuに似ており、コードを準備すればWebアプリケーションをデプロイできます。これらのサーバーには、デフォルトでKudu SCMもインストールされており、環境変数や設定の表示、ログのダウンロードなどができますが、アクセスするには認証が必要です。</p><p>ここで話す脆弱性はKudu SCMで見つかりました。Kudu SCM APIはCSRFトークンを使用せず、代わりに前述のようにOriginヘッダーをチェックしてリクエストを検証します。</p><p>サーバーのURLが<code>https://huli.scm.azurewebsites.net</code>であると仮定すると、以下のオリジンはエラーを返します。</p><ol><li><code>https://huli.scm.azurewebsites.net.attacker.com</code>（末尾に追加）</li><li><code>https://attacker.huli.scm.azurewebsites.net</code>（先頭に追加）</li><li><code>http://huli.scm.azurewebsites.net</code>（HTTPに変更）</li></ol><p>絶望的に見えるかもしれませんが、彼らは特定の位置に<code>_</code>と<code>-</code>以外の文字を追加することで、この制限を回避できることを発見しました。</p><p>例えば、<code>https://huli.scm.azurewebsites.net$.attacker.com</code>はチェックを通過できます。</p><p>しかし、問題は、これらの特殊文字がブラウザにとって有効なドメイン名ではないことです。では、どうすればよいでしょうか？</p><p>彼らは<code>_</code>をサブドメイン名として使用できることを発見し、次のようなURLを構築できました。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">https://huli.scm.azurewebsites.net._.attacker.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>このURLを使用すると、サーバーのオリジンチェックを回避できます（サーバーの正規表現が不適切に記述されていたため）。チェックを回避した後、悪用できるAPIを探し始め、サーバーに圧縮ファイルを直接デプロイできる<code>/api/zipdeploy</code>というAPIを見つけました！</p><p>したがって、このCSRF脆弱性を介して、攻撃者はユーザーのAzure Webサービスにコードをデプロイし、RCEを達成できます。攻撃は、APIを呼び出すHTMLを準備し、それを<code>https://huli.scm.azurewebsites.net._.attacker.com</code>でホストし、ターゲットに送信することで構成されます。</p><p>ターゲットがログインしていてリンクをクリックすると、侵害されます。</p><p>彼らはこの攻撃をEmojiDeployと呼んでいます。なぜなら、バイパスされたURLの一部である<code>._.</code>が絵文字のように見え、かわいらしい響きだからです。</p><p>ここではいくつかの詳細を省略しましたが、全文は以下で読むことができます：<a href="https://ermetic.com/blog/azure/emojideploy-smile-your-azure-web-service-just-got-rced/" target="_blank" rel="noopener noreferrer">EmojiDeploy: Smile! Your Azure web service just got RCE’d .<!-- -->_<!-- -->.</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="脆弱性の連鎖csrfとセルフxss">脆弱性の連鎖：CSRFとセルフXSS<a href="#脆弱性の連鎖csrfとセルフxss" class="hash-link" aria-label="脆弱性の連鎖：CSRFとセルフXSS への直接リンク" title="脆弱性の連鎖：CSRFとセルフXSS への直接リンク">​</a></h2><p>以前XSSについて言及した際、セルフXSSと呼ばれるタイプを紹介しました。これは自分自身にのみ影響するXSSを指します。</p><p>例えば、電話番号フィールドにXSS脆弱性があるが、電話番号は自分の個人設定ページでのみ表示され、他の人には表示されない場合、自分で電話番号をXSSペイロードに変更しない限り、攻撃を開始することはできません。</p><p>これをCSRFと組み合わせる絶好の機会だと思いませんか？</p><p>個人設定ページにCSRF脆弱性があると仮定すると、攻撃者はCSRFを使用して被害者の電話番号をXSSペイロードに変更し、その後個人設定ページを開くことができます。これにより、セルフXSSが実際のXSSに変わります！</p><p>元のセルフXSS脆弱性はほとんど影響がなく、多くのバグバウンティプラットフォームでは受け入れられない可能性があります。しかし、CSRFと組み合わせると、本当に影響力のあるXSSになり、深刻度が増し、プラットフォームはそれを受け入れます。</p><p>実際の事例として、2016年に@fin1te氏がUberに報告した脆弱性があります：<a href="https://whitton.io/articles/uber-turning-self-xss-into-good-xss/" target="_blank" rel="noopener noreferrer">Uber Bug Bounty: Turning Self-XSS into Good-XSS</a>。少し古いですが、そこで議論されているテクニックは依然として非常に実用的です。</p><p>彼は<code>partners.uber.com</code>でセルフXSSを発見し、それをログアウトCSRFと組み合わせ、現在のユーザーを<code>partners.uber.com</code>ドメインでログアウトさせ、<code>login.uber.com</code>ドメインではログイン状態を維持しました。</p><p>その後、ログインCSRFを使用して事前に準備したアカウントにログインし、ログイン後にXSSをトリガーしました。この時点で、iframeを使用してユーザーを再度ログインさせ、このXSSを利用して現在のユーザーのデータにアクセスできるようにしました。これにより、これらの脆弱性が巧みに連鎖され、より大きな影響が生み出されました。</p><p>プロセスはやや複雑ですが、これらの脆弱性の連携は非常に興味深く、CSPを使用してページのリダイレクトを防ぐというのも斬新なアプローチです。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>サイバーセキュリティの世界における脆弱性は相互に関連しています。ある脆弱性を修正する方法を選択する際には、他の脆弱性への影響にも注意することが重要です。</p><p>例えば、「認証にCookieを使用しない」はCSRFの問題を解決できますが、XSSがトークンを盗むことを可能にし、XSSの影響範囲を拡大します。一方、「カスタムヘッダーを追加する」はCSRFを防御するように見えるかもしれませんが、CORSが誤って設定されている場合、この防御メカニズムは効果がありません。</p><p>したがって、「CSRFトークンを追加する」はより優れた、より一般的なアプローチです。実際、サイバーセキュリティの防御は単一の方法に限定されません。上記で述べたいくつかの方法を組み合わせることができます。</p><p>例えば、CSSインジェクションの際にHackMDの事例を挙げました。CSRFトークンを取得したにもかかわらず、サーバーが<code>Origin</code>ヘッダーを検証することで第2層の保護を実装していたため、攻撃を開始できませんでした。</p><p>一方、前述のEmojiDeployは反例です。彼らは<code>Origin</code>ヘッダーのみを検証し、それを誤って実装したため、攻撃を受けました。CSRFトークン保護を追加していれば、攻撃を防ぐことができたでしょう。</p><p>参考文献：</p><ol><li><a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)#Prevention_measures_that_do_NOT_work" target="_blank" rel="noopener noreferrer">Cross-Site Request Forgery (CSRF)</a></li><li><a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet" target="_blank" rel="noopener noreferrer">Cross-Site Request Forgery (CSRF) Prevention Cheat Sheet</a></li><li><a href="http://m.2cto.com/article/201505/400902.html" target="_blank" rel="noopener noreferrer">一次较为深刻的 CSRF 认识</a></li><li><a href="http://cyrilwang.pixnet.net/blog/post/31813672" target="_blank" rel="noopener noreferrer">[技術分享] Cross-site Request Forgery (Part 2)</a></li><li><a href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#csrf" target="_blank" rel="noopener noreferrer">Spring Security Reference</a></li><li><a href="https://www.ibm.com/developerworks/cn/web/1102_niugang_csrf/" target="_blank" rel="noopener noreferrer">CSRF 攻击的应对之道</a></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/ja/ch4/cors-attack/"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">クロスオリジンセキュリティの問題</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/ja/ch4/same-site-cookie/"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">Same-site Cookie、CSRFの救世主？</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#削除機能によるcsrfの紹介" class="table-of-contents__link toc-highlight">削除機能によるCSRFの紹介</a></li><li><a href="#ユーザーによる防御" class="table-of-contents__link toc-highlight">ユーザーによる防御</a></li><li><a href="#サーバー防御" class="table-of-contents__link toc-highlight">サーバー防御</a><ul><li><a href="#refererまたはoriginヘッダーの確認" class="table-of-contents__link toc-highlight">RefererまたはOriginヘッダーの確認</a></li><li><a href="#captchaまたはsms認証の追加" class="table-of-contents__link toc-highlight">CAPTCHAまたはSMS認証の追加</a></li></ul></li><li><a href="#一般的な防御方法" class="table-of-contents__link toc-highlight">一般的な防御方法</a><ul><li><a href="#csrfトークンの追加" class="table-of-contents__link toc-highlight">CSRFトークンの追加</a></li><li><a href="#ダブルサブミットクッキー" class="table-of-contents__link toc-highlight">ダブルサブミットクッキー</a></li><li><a href="#純粋なフロントエンドのダブルサブミットクッキー" class="table-of-contents__link toc-highlight">純粋なフロントエンドのダブルサブミットクッキー</a></li></ul></li><li><a href="#その他の解決策" class="table-of-contents__link toc-highlight">その他の解決策</a><ul><li><a href="#認証にcookieを使用しない" class="table-of-contents__link toc-highlight">認証にCookieを使用しない</a></li><li><a href="#カスタムヘッダーの追加" class="table-of-contents__link toc-highlight">カスタムヘッダーの追加</a></li></ul></li><li><a href="#実際の事例" class="table-of-contents__link toc-highlight">実際の事例</a></li><li><a href="#脆弱性の連鎖csrfとセルフxss" class="table-of-contents__link toc-highlight">脆弱性の連鎖：CSRFとセルフXSS</a></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/ja/assets/js/runtime~main.c9f49c76.js"></script>
<script src="/beyond-xss/ja/assets/js/main.b4cb8381.js"></script>
</body>
</html>