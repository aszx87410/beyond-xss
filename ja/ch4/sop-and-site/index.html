<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ch4/sop-and-site" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">最重要：同一オリジンポリシーとサイト | Beyond XSS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aszx87410.github.io/beyond-xss/ja/img/cover.png"><meta data-rh="true" name="twitter:image" content="https://aszx87410.github.io/beyond-xss/ja/img/cover.png"><meta data-rh="true" property="og:url" content="https://aszx87410.github.io/beyond-xss/ja/ch4/sop-and-site/"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="google-site-verification" content="O7SjDEO9AQXbxqBWhtUW0FVahHxSrnweMXJxLICpSz4"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="最重要：同一オリジンポリシーとサイト | Beyond XSS"><meta data-rh="true" name="description" content="以前の記事で「同一オリジン」について何度か言及しました。これはフロントエンドとサイバーセキュリティの両方の世界で非常に重要な用語です。ブラウザの同一オリジンポリシーは、開発においても攻撃に対処する際にも非常に重要です。"><meta data-rh="true" property="og:description" content="以前の記事で「同一オリジン」について何度か言及しました。これはフロントエンドとサイバーセキュリティの両方の世界で非常に重要な用語です。ブラウザの同一オリジンポリシーは、開発においても攻撃に対処する際にも非常に重要です。"><link data-rh="true" rel="icon" href="/beyond-xss/ja/img/logo.png"><link data-rh="true" rel="canonical" href="https://aszx87410.github.io/beyond-xss/ja/ch4/sop-and-site/"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/en/ch4/sop-and-site/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/sop-and-site/" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ja/ch4/sop-and-site/" hreflang="ja"><link data-rh="true" rel="alternate" href="https://aszx87410.github.io/beyond-xss/ch4/sop-and-site/" hreflang="x-default"><link rel="stylesheet" href="/beyond-xss/ja/assets/css/styles.32fcb3bb.css">
<link rel="preload" href="/beyond-xss/ja/assets/js/runtime~main.531fd90e.js" as="script">
<link rel="preload" href="/beyond-xss/ja/assets/js/main.b4cb8381.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/beyond-xss/ja/"><div class="navbar__logo"><img src="/beyond-xss/ja/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/beyond-xss/ja/img/logo.png" alt="logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Beyond XSS：Webフロントエンドセキュリティの世界を探る</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>日本語</a><ul class="dropdown__menu"><li><a href="/beyond-xss/en/ch4/sop-and-site/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/beyond-xss/ch4/sop-and-site/" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-TW">中文（台灣）</a></li><li><a href="/beyond-xss/ja/ch4/sop-and-site/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="ja">日本語</a></li></ul></div><a href="https://github.com/aszx87410/beyond-xss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/ja/">このシリーズについて</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">第一章：XSSから見たフロントエンド・セキュリティ</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch1/browser-security-model/">ブラウザのセキュリティモデル</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch1/xss-introduction/">XSSから始めるフロントエンドのセキュリティ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch1/know-xss-a-bit-more/">XSSについてもう少し詳しく</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch1/javascript-protocol/">危険な javascript: 疑似スキーム</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">第二章：XSSの防御と回避</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/xss-defense-sanitization/">XSSの第一の防御線：サニタイズ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/xss-defense-csp/">XSSの第二の防御線：CSP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/token-storage/">XSSの第三の防御線：影響範囲の縮小</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/trust-types/">最新のXSS防御：Trusted Typesと組み込みSanitizer API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/csp-bypass/">防御の回避：一般的なCSPバイパス</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/mutation-xss/">防御の回避：Mutation XSS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch2/universal-xss/">最強のXSS：Universal XSS</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">第三章：JavaScriptを使わない攻撃</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/attack-without-js/">攻撃にJavaScriptを直接実行する必要があるなんて誰が言った？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/prototype-pollution/">プロトタイプチェーンを悪用した攻撃：Prototype Pollution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/dom-clobbering/">HTMLもJavaScriptに影響を与える？DOM clobbering入門</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/csti/">フロントエンドのテンプレートインジェクション攻撃：CSTI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/css-injection/">CSSだけで攻撃できる？CSSインジェクション（前編）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/css-injection-2/">CSSだけで攻撃できる？CSSインジェクション（後編）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch3/html-attack/">HTMLだけで攻撃できる？</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">第四章：クロスサイト攻撃</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/beyond-xss/ja/ch4/sop-and-site/">最重要：同一オリジンポリシーとサイト</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/cors-intro/">クロスオリジンリソース共有 CORS 基本紹介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/cors-attack/">クロスオリジンセキュリティの問題</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/csrf/">クロスサイトリクエストフォージェリ（CSRF）を簡単に理解する</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/same-site-cookie/">Same-site Cookie、CSRFの救世主？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/subdomain/">Same-Siteからメインサイトへ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch4/cookie-bomb/">面白くて実用的なCookie Bomb</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">第五章：その他の興味深いフロントエンド・セキュリティのトピック</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/clickjacking/">あなたの画面はあなたの画面ではない：クリックジャッキング</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/mime-sniffing/">MIMEスニッフィングを利用した攻撃</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/supply-chain-attack/">フロントエンドサプライチェーン攻撃：上流から下流への攻撃</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/web3-attacks/">Web3におけるウェブフロントエンド攻撃の応用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/xsleaks-1/">最も興味深いフロントエンドサイドチャネル攻撃：XSLeaks（パート1）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/beyond-xss/ja/ch5/xsleaks-2/">最も興味深いフロントエンドサイドチャネル攻撃：XSLeaks（パート2）</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/ja/summary/">まとめ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/beyond-xss/ja/contact/">著者への連絡</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/beyond-xss/ja/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">第四章：クロスサイト攻撃</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">最重要：同一オリジンポリシーとサイト</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><h1>最重要：同一オリジンポリシーとサイト</h1><p>以前の記事で「同一オリジン」について何度か言及しました。これはフロントエンドとサイバーセキュリティの両方の世界で非常に重要な用語です。ブラウザの同一オリジンポリシーは、開発においても攻撃に対処する際にも非常に重要です。</p><p>さらに、ホストやサイトなど、しばしば混同される用語がいくつかあります。例えば、XSSのXSはクロスサイトを意味し、CSRFのCSもクロスサイトを意味します。では、オリジンとサイトの違いは何でしょうか？ホストとはどのように違うのでしょうか？</p><p>この記事では、これらの概念を完全に理解し、もう混乱しないようにします。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="オリジンとサイトとは正確には何ですかどのように区別しますか">オリジンとサイトとは正確には何ですか？どのように区別しますか？<a href="#オリジンとサイトとは正確には何ですかどのように区別しますか" class="hash-link" aria-label="オリジンとサイトとは正確には何ですか？どのように区別しますか？ への直接リンク" title="オリジンとサイトとは正確には何ですか？どのように区別しますか？ への直接リンク">​</a></h2><p>まず、単純で多少不正確な説明から始め、後で段階的に修正していきます。</p><p>オリジンは、スキーム、ポート、ホストで構成されます。これらを組み合わせると、オリジンが形成されます。</p><p>例えば、<code>https://huli.tw/abc</code> というURLがある場合、構成要素は次のとおりです。</p><ul><li>スキーム：https</li><li>ポート：443（httpsのデフォルトポート）</li><li>ホスト：huli.tw</li></ul><p>したがって、そのオリジンは <code>https://huli.tw</code> です。ご覧のように、パスの部分 <code>/abc</code> はオリジンに影響を与えず、ポートの部分については、httpsはすでにデフォルトポート443を意味しています。</p><p>同一オリジンとは、2つのURLのオリジンが同じである必要があることを意味します。例えば：</p><ol><li><code>https://huli.tw/abc</code> と <code>https://huli.tw/hello/yo</code> は、スキーム、ポート、ホストが同じであり、パスは結果に影響しないため、同一オリジンです。</li><li><code>https://huli.tw</code> と <code>http://huli.tw</code> は、スキームが異なるため、同一オリジンではありません。</li><li><code>http://huli.tw</code> と <code>http://huli.tw:8080</code> は、ポートが異なるため、同一オリジンではありません。</li><li><code>https://huli.tw</code> と <code>https://blog.huli.tw</code> は、ホストが異なるため、同一オリジンではありません。</li></ol><p>上記の例から、同一オリジンの条件は非常に厳格であることがわかります。基本的に、パス以外のすべての部分が同じである必要があります。</p><p>次に、サイトを見てみましょう。サイトはオリジンと比較して考慮する要素が少なく、スキームとホストのみを見て、ポートは無視します。2つのURLが同一サイトであるという定義はより緩やかで、ホストが完全に同じである必要はなく、サブドメインである限り同一サイトと見なされます。</p><p>例えば：</p><ol><li><code>https://huli.tw/abc</code> と <code>https://huli.tw/hello/yo</code> は、スキームとホストが同じであるため、同一サイトです。</li><li><code>https://huli.tw</code> と <code>http://huli.tw</code> は、スキームが異なるため、同一サイトではありません。</li><li><code>http://huli.tw</code> と <code>http://huli.tw:8080</code> は、ポートが結果に影響しないため、同一サイトです。</li><li><code>https://huli.tw</code> と <code>https://blog.huli.tw</code> は、huli.twとblog.huli.twが同じ親ドメインhuli.twの下にあるため、同一サイトです。</li><li><code>https://abc.huli.tw</code> と <code>https://blog.huli.tw</code> も、abc.huli.twとblog.huli.twが同じ親ドメインhuli.twの下にあるため、同一サイトです。</li></ol><p>同一オリジンと比較すると、同一サイトは明らかに緩やかです。ポートが異なっていても同一サイトと見なされ、ホストが同じ親ドメインに属している限り、一般的に同一サイトと見なされます。</p><p>ただし、冒頭で述べたように、上記の定義はほとんどの場合正しいですが、正確ではありません。例外を確認するために、仕様を直接参照しましょう。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="同一オリジンの詳細な検討">同一オリジンの詳細な検討<a href="#同一オリジンの詳細な検討" class="hash-link" aria-label="同一オリジンの詳細な検討 への直接リンク" title="同一オリジンの詳細な検討 への直接リンク">​</a></h2><p>HTML仕様の<a href="https://html.spec.whatwg.org/multipage/origin.html#origin" target="_blank" rel="noopener noreferrer">7.5 Origin</a>セクションで、完全な定義を確認できます。仕様のオリジンに関する説明を見てみましょう。</p><blockquote><p>オリジンは、ウェブのセキュリティモデルの基本的な通貨です。ウェブプラットフォームでオリジンを共有する2つのアクターは、互いに信頼し、同じ権限を持つと見なされます。オリジンが異なるアクターは、互いに対して潜在的に敵対的であると見なされ、さまざまな程度で互いから隔離されます。</p></blockquote><p>ここでの内容は非常に明確です。冒頭で、2つのウェブサイトが同じオリジンを持つ場合、これらの2つのウェブサイトは互いを信頼していることを意味すると説明しています。ただし、オリジンが異なる場合、それらは隔離され、制限されます。</p><p>次に、仕様ではオリジンを2つのタイプに分けています：「不透明なオリジン」と「タプルオリジン」。</p><p>不透明なオリジンは、特殊な場合にのみ現れるオリジンと考えることができます。例えば、ローカルマシンでウェブページを開くと、URLは「file:///...」になります。この場合、ウェブページ内でリクエストを送信すると、オリジンは不透明なオリジン、つまり「null」になります。</p><p>タプルオリジンはより一般的であり、私たちがより関心を持っているオリジンのタイプです。ドキュメントによると、タプルオリジンには以下が含まれます。</p><ol><li>スキーム（ASCII文字列）。</li><li>ホスト（ホスト）。</li><li>ポート（nullまたは16ビット符号なし整数）。</li><li>ドメイン（nullまたはドメイン）。特に明記されていない限りnull。</li></ol><p>ホストとドメインの両方があるのはなぜか疑問に思うかもしれません。これについては後で説明します。</p><p>さらに、仕様では、2つのオリジンAとBが同一オリジンであるかどうかを判断するアルゴリズムも説明しています。</p><ol><li>AとBが同じ不透明なオリジンである場合、trueを返します。</li><li>AとBが両方ともタプルオリジンであり、スキーム、ホスト、ポートが同一である場合、trueを返します。</li><li>falseを返します。</li></ol><p>2つのオリジンが同じ不透明なオリジンであるか、スキーム、ホスト、ポートがすべて同一である場合にのみ、同一オリジンと見なされます。同一オリジンに加えて、仕様では「同一オリジンドメイン」と呼ばれる別の用語も出てきます。これについては後で説明します。</p><p>前述のように、同一オリジンは厳格な制限です。例えば、URL「<a href="https://huli.tw/api%E3%80%8D%E3%81%AE%E5%A0%B4%E5%90%88%E3%80%81%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%B3%E3%81%AF%E3%83%91%E3%82%B9%E3%82%92%E8%80%83%E6%85%AE%E3%81%97%E3%81%AA%E3%81%84%E3%81%9F%E3%82%81%E3%80%81%E3%81%9D%E3%81%AE%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%B3%E3%81%AF%E3%80%8Chttps://huli.tw%E3%80%8D%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82%E3%81%93%E3%82%8C%E3%81%AF%E3%80%81%E5%90%8C%E4%B8%80%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%B3%E3%81%AE%E3%82%A6%E3%82%A7%E3%83%96%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AF%E3%80%81%E5%90%8C%E4%B8%80%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%B3%E3%81%A8%E8%A6%8B%E3%81%AA%E3%81%95%E3%82%8C%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AB%E3%80%81URL%E3%81%8C%E3%80%8Chttps://huli.tw/*%E3%80%8D%E3%81%A7%E5%A7%8B%E3%81%BE%E3%82%8B%E5%BF%85%E8%A6%81%E3%81%8C%E3%81%82%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E6%84%8F%E5%91%B3%E3%81%97%E3%81%BE%E3%81%99%E3%80%82" target="_blank" rel="noopener noreferrer">https://huli.tw/api」の場合、オリジンはパスを考慮しないため、そのオリジンは「https://huli.tw」になります。これは、同一オリジンのウェブサイトは、同一オリジンと見なされるために、URLが「https://huli.tw/*」で始まる必要があることを意味します。</a></p><p>「<a href="https://huli.tw%E3%80%8D%E3%81%A8%E3%80%8Chttps://blog.huli.tw%E3%80%8D%E3%81%AF%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%A8%E3%82%B5%E3%83%96%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%AE%E9%96%A2%E4%BF%82%E3%81%A7%E3%81%99%E3%81%8C%E3%80%81%E3%83%9B%E3%82%B9%E3%83%88%E3%81%8C%E7%95%B0%E3%81%AA%E3%82%8B%E3%81%9F%E3%82%81%E3%80%81%E5%90%8C%E4%B8%80%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%B3%E3%81%A7%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82" target="_blank" rel="noopener noreferrer">https://huli.tw」と「https://blog.huli.tw」はドメインとサブドメインの関係ですが、ホストが異なるため、同一オリジンではありません。</a></p><p>これを覚えておいてください。これは重要です。</p><p>仕様におけるオリジンと同一オリジンの詳細な検討は、冒頭で述べた「不正確な記述」と比較して、不透明なオリジン、同一オリジンドメイン、およびオリジンタプルに含まれる未使用の「ドメイン」が追加されています。</p><p>最後に、もう一つだけ言及させてください。「<a href="https://huli.tw/api%E3%80%8D%E3%81%AE%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%B3%E3%81%AF%E3%80%8Chttps://huli.tw%E3%80%8D%E3%81%A7%E3%81%82%E3%82%8B%E3%81%A8%E8%A8%80%E3%81%86%E3%81%A8%E3%81%8D%E3%80%81%E3%82%88%E3%82%8A%E6%AD%A3%E7%A2%BA%E3%81%AA%E8%A1%A8%E7%8F%BE%E3%81%AF%E3%80%8C%E3%80%8Chttps://huli.tw/api%E3%80%8D%E3%81%AE%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%B3%E3%81%AE%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E3%81%95%E3%82%8C%E3%81%9F%E5%BD%A2%E5%BC%8F%E3%81%AF%E3%80%8Chttps://huli.tw%E3%80%8D%E3%81%A7%E3%81%82%E3%82%8B%E3%80%8D%E3%81%A8%E3%81%84%E3%81%86%E3%81%93%E3%81%A8%E3%81%A7%E3%81%99%E3%80%82" target="_blank" rel="noopener noreferrer">https://huli.tw/api」のオリジンは「https://huli.tw」であると言うとき、より正確な表現は「「https://huli.tw/api」のオリジンのシリアライズされた形式は「https://huli.tw」である」ということです。</a></p><p>これは、オリジンが実際にはタプルであり、<code>(https, huli.tw, null, null)</code> のように表現され、文字列にシリアライズされると <code>https://huli.tw</code> になるためです。タプルとしての表現と比較して、シリアライズされた形式の方が読みやすいと思います。したがって、両者が同様の情報を提供できる場合、後者のアプローチを好みます。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="同一サイトの詳細な検討">同一サイトの詳細な検討<a href="#同一サイトの詳細な検討" class="hash-link" aria-label="同一サイトの詳細な検討 への直接リンク" title="同一サイトの詳細な検討 への直接リンク">​</a></h2><p>サイトの定義も同じ仕様にあり、次のように述べられています。</p><blockquote><p>サイトは、不透明なオリジンまたはスキームとホストです。</p></blockquote><p>したがって、サイトは不透明なオリジンまたはスキームとホストのいずれかになります。</p><p>仕様では、同一サイトに加えて、「スキームなし同一サイト」と呼ばれる別の用語があることがわかります。これら2つの違いも明確です。同一サイトはスキームを考慮しますが、スキームなし同一サイトはスキームを考慮しません。</p><p>したがって、2つのオリジンAとBが同一サイトであるかどうかを判断する場合、アルゴリズムは次のようになります。</p><blockquote><p>2つのオリジンAとBは、以下の両方のステートメントが真である場合、同一サイトであると言われます。</p><ul><li>AとBはスキームなし同一サイトである</li><li>AとBは両方とも不透明なオリジンであるか、または同じスキームを持つタプルオリジンである</li></ul></blockquote><p>AとBが同一サイトである場合、両方とも不透明なオリジンであるか、同じスキームを持ち、スキームなし同一サイトである必要があります。</p><p>したがって、同一サイトはスキームを考慮します。httpとhttpsの2つのURLは決して同一サイトではありませんが、スキームなし同一サイトである可能性があります。</p><p>ここには少し歴史があります。同一サイトが初めて導入されたとき、スキームは考慮されていませんでした。後になってスキームが考慮されるようになりました。</p><p>2016年のRFC: Same-site Cookiesでは、同一サイトの判断にスキームが含まれていないことがわかります。したがって、当時は <code>https://huli.tw</code> と <code>http://huli.tw</code> は同一サイトと見なされていました。</p><p>2019年6月になって初めて、スキームを考慮に入れるかどうかについての議論が始まりました。詳細については、以下を参照してください：<a href="https://github.com/w3c/webappsec-fetch-metadata/issues/34" target="_blank" rel="noopener noreferrer">https://github.com/w3c/webappsec-fetch-metadata/issues/34</a></p><p>当時、同一サイトの仕様は今日見ているHTML仕様ではなく、別のURL仕様で定義されていました。そのため、議論はそちらに移されました：<a href="https://github.com/whatwg/url/issues/448" target="_blank" rel="noopener noreferrer">Consider introducing a &quot;same-site&quot; concept that includes scheme. #448</a>。次に、2019年9月に、このPRがありました：<a href="https://github.com/whatwg/url/pull/449" target="_blank" rel="noopener noreferrer">Tighten &#x27;same site&#x27; checks to include &#x27;scheme&#x27;. #449</a>。これにより、仕様にスキームが正式に含まれました。同一サイトは「スキームを考慮する」と定義され、スキームを考慮しない場合は、スキームなし同一サイトという新しい用語が導入されました。</p><p>その後2ヶ月後、関連する仕様はURLからHTMLに移されました。これらの2つのPRを参照してください：<a href="https://github.com/whatwg/url/pull/457" target="_blank" rel="noopener noreferrer">Let HTML handle the &quot;same site&quot; definition #457</a>、<a href="https://github.com/whatwg/html/pull/5076" target="_blank" rel="noopener noreferrer">Define (schemelessly) same site for origins #5076</a></p><p>仕様は仕様ですが、ブラウザがすぐに変更に追いつくとは限りません。では、ブラウザの現在の実装はどうなっているのでしょうか？</p><p>2020年11月、Chromeは記事を公開しました：<a href="https://web.dev/schemeful-samesite/" target="_blank" rel="noopener noreferrer">Schemeful Same-Site</a>。当時、異なるスキームも同一サイトと見なされていたことが示されていますが、<a href="https://chromestatus.com/feature/5096179480133632" target="_blank" rel="noopener noreferrer">Chrome platform status: Feature: Schemeful same-site</a>から、Chromeはバージョン89以降スキームも考慮するようになったことがわかります。</p><p>Firefoxについては、この問題のステータスから：<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1651119" target="_blank" rel="noopener noreferrer">[meta] Enable cookie sameSite schemeful</a>、この動作はまだデフォルトではないようです。特に設定されていない場合、異なるスキームも同一サイトと見なされます。</p><p>歴史を振り返った後、最も重要なスキームなし同一サイトがどのように判断されるかを見てみましょう。</p><p><img loading="lazy" alt="schemelessly same site" src="/beyond-xss/ja/assets/images/20-01-edadea6cfb957872adccc3a543883d9b.png" width="980" height="349" class="img_ev3q"></p><p>不透明な部分については今は触れません。上記の重要な点は明らかに新しい用語です：「登録可能なドメイン」。2つのホストが同一サイトであるかどうかを判断する際に、これを使用して比較します。</p><p>この登録可能なドメインの定義は、別のURL仕様にあります：<a href="https://url.spec.whatwg.org/#host-registrable-domain" target="_blank" rel="noopener noreferrer">URLの仕様</a>。</p><blockquote><p>ホストの登録可能なドメインは、最も具体的な公開サフィックスと、その直前のドメインラベル（存在する場合）によって形成されるドメインです。</p></blockquote><p>ここで、新しい用語「公開サフィックス」が言及されています。</p><p>理解を深めるために例から始めましょう。<code>blog.huli.tw</code> の登録可能なドメインは <code>huli.tw</code> であり、<code>huli.tw</code> の登録可能なドメインも <code>huli.tw</code> です。</p><p>ただし、<code>bob.github.io</code> の登録可能なドメインは <code>github.io</code> ではなく、<code>bob.github.io</code> です。</p><p>なぜでしょうか？以下に簡単に説明します。</p><p>「登録可能なドメイン」と「公開サフィックス」という概念がなければ、同一サイトの定義は冒頭で述べた通り、<code>huli.tw</code> と <code>blog.huli.tw</code> は同一サイトであり、問題ありません。</p><p>しかし、もしそうであれば、<code>bob.github.io</code> と <code>alice.github.io</code> も同一サイトになります。</p><p>あれ、それは問題ないのでは？</p><p>問題です。<code>github.io</code> はGitHub Pagesのサービスであり、各GitHubユーザーは独自のサブドメインを使用できます。しかし、GitHubは <code>bob.github.io</code> が <code>alice.github.io</code> に干渉することを望んでいません。なぜなら、それらは実際には完全に独立した2つのウェブサイトであり、私が両方を所有している <code>huli.tw</code> と <code>blog.huli.tw</code> とは異なります。</p><p>したがって、公開サフィックスの概念が登場しました。これは手動で管理されているリストであり、「同じウェブサイトと見なされたくないドメインのリスト」が含まれています。いくつか例を挙げます。</p><ol><li>github.io</li><li>com.tw</li><li>s3.amazonaws.com</li><li>azurestaticapps.net</li><li>herokuapp.com</li></ol><p>したがって、ブラウザはこのリストを参照した後、<code>bob.github.io</code> と <code>alice.github.io</code> は実際には関連がなく、同一サイトではないと判断します。これにはeTLD（effective Top-Level-Domain）という専門用語もあります。詳細については、以下を参照してください：<a href="https://blog.kalan.dev/2021-11-09-url-and-samesite/" target="_blank" rel="noopener noreferrer">2つのドメインが同じ所有者であるかどうかを判断する方法</a></p><p>前述のように、<code>github.io</code> は公開サフィックスリストに含まれているため、<code>bob.github.io</code> の登録可能なドメインは <code>bob.github.io</code> であり、<code>alice.github.io</code> の登録可能なドメインは <code>alice.github.io</code> です。</p><p>したがって、最初に述べた同一サイトの定義は正しくありません。2つのホストが同じ親ドメインに属しているように見えても、公開サフィックスの存在により、必ずしも同一サイトであるとは限りません。</p><p><code>bob.github.io</code> と <code>alice.github.io</code> は、登録可能なドメインが異なるため、同一サイトではありません。</p><p><code>blog.huli.tw</code>、<code>huli.tw</code>、<code>test.huli.tw</code> の3つのホストはすべて同一サイトです。登録可能なドメインはすべて <code>huli.tw</code> であるためです。</p><p>仕様には、より明確な表が添付されています。よく見てください。</p><p><img loading="lazy" alt="登録可能なドメインテーブル" src="/beyond-xss/ja/assets/images/20-02-b666bbfbac8fe1684ad927082dc5a452.png" width="872" height="485" class="img_ev3q"></p><p>最後に、同一サイトについてまとめます。</p><ol><li>同一サイトとスキームなし同一サイトがあり、前者の方がよく使われます。</li><li>2つのホストが同一サイトであるかどうかを比較する場合、登録可能なドメインを見る必要があります。</li><li>登録可能なドメインを決定するには、公開サフィックスリストを参照する必要があります。</li><li>2つのホストは、同じ親ドメインに属しているように見えても、公開サフィックスの存在により、必ずしも同一サイトであるとは限りません。</li><li>同一サイトはポートを考慮しないため、<code>http://blog.huli.tw:8888</code> と <code>http://huli.tw</code> は同一サイトです。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="同一オリジンと同一サイト">同一オリジンと同一サイト<a href="#同一オリジンと同一サイト" class="hash-link" aria-label="同一オリジンと同一サイト への直接リンク" title="同一オリジンと同一サイト への直接リンク">​</a></h2><p>同一オリジンは以下によって決定されます。</p><ol><li>スキーム</li><li>ポート</li><li>ホスト</li></ol><p>そして、同一サイトは以下です。</p><ol><li>スキーム</li><li>ホスト（登録可能なドメイン）</li></ol><p>2つのウェブサイトが同一オリジンである場合、同一オリジンの判断基準がより厳格であるため、必ず同一サイトになります。</p><p>両者の主な違いは次のとおりです。</p><ol><li>同一オリジンはポートを考慮しますが、同一サイトは考慮しません。</li><li>同一オリジンはホストを考慮しますが、同一サイトは登録可能なドメインを考慮します。</li></ol><p>以下にいくつかの例を示します。</p><table><thead><tr><th>A</th><th>B</th><th>同一オリジン</th><th>同一サイト</th><th>説明</th></tr></thead><tbody><tr><td><a href="http://huli.tw:8080" target="_blank" rel="noopener noreferrer">http://huli.tw:8080</a></td><td><a href="http://huli.tw" target="_blank" rel="noopener noreferrer">http://huli.tw</a></td><td>X</td><td>O</td><td>同一サイトはポートを考慮しない</td></tr><tr><td><a href="https://blog.huli.tw" target="_blank" rel="noopener noreferrer">https://blog.huli.tw</a></td><td><a href="https://huli.tw" target="_blank" rel="noopener noreferrer">https://huli.tw</a></td><td>X</td><td>O</td><td>登録可能なドメインが同じ</td></tr><tr><td><a href="https://alice.github.io" target="_blank" rel="noopener noreferrer">https://alice.github.io</a></td><td><a href="https://github.io" target="_blank" rel="noopener noreferrer">https://github.io</a></td><td>X</td><td>X</td><td>github.ioは公開サフィックスリストにある</td></tr><tr><td><a href="https://a.alice.github.io" target="_blank" rel="noopener noreferrer">https://a.alice.github.io</a></td><td><a href="https://b.alice.github.io" target="_blank" rel="noopener noreferrer">https://b.alice.github.io</a></td><td>X</td><td>O</td><td>登録可能なドメインが同じ</td></tr><tr><td><a href="https://bob.github.io/page1" target="_blank" rel="noopener noreferrer">https://bob.github.io/page1</a></td><td><a href="https://bob.github.io/about" target="_blank" rel="noopener noreferrer">https://bob.github.io/about</a></td><td>O</td><td>O</td><td>パスは考慮されない</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="不思議なdocumentdomain">不思議なdocument.domain<a href="#不思議なdocumentdomain" class="hash-link" aria-label="不思議なdocument.domain への直接リンク" title="不思議なdocument.domain への直接リンク">​</a></h2><p>オリジンの仕様を見ていると、何に使うのか不明な不思議な「ドメイン」属性の言及がありました。オリジンの仕様には「同一オリジンドメイン」というものまであり、これに直接言及している緑色の注記があります。</p><p><img loading="lazy" alt="同一オリジン注記" src="/beyond-xss/ja/assets/images/20-03-251552df2e976227c38ada9c7ec321f5.png" width="1387" height="407" class="img_ev3q"></p><p>オリジンはドメイン属性以外は不変であり、この属性は <code>document.domain</code> を使用して変更できると記載されています。仕様には、このことについて説明しているセクション<a href="https://html.spec.whatwg.org/multipage/origin.html#relaxing-the-same-origin-restriction" target="_blank" rel="noopener noreferrer">7.5.2 Relaxing the same-origin restriction</a>があります。一部を抜粋します。</p><blockquote><p>(document.domain) は、サブドメインを削除する値に設定でき、オリジンのドメインを変更して、同じドメインの他のサブドメイン上のページ（同じことを行う場合）が互いにアクセスできるようにします。これにより、ドメインの異なるホスト上のページが互いのDOMに同期的にアクセスできるようになります。</p></blockquote><p>理解を深めるために、デモをしてみましょう。</p><p>ローカルマシンの <code>/etc/hosts</code> ファイルを次のように変更しました。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1   alice.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">127.0.0.1   bob.example.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>これで、これらの両方のURLがローカルマシンに接続されます。次に、簡単なHTTPサーバーを起動し、localhost:5555で実行される基本的なHTMLページを作成しました。</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&lt;!</span><span class="token doctype doctype-tag" style="color:#999988;font-style:italic">DOCTYPE</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">html</span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">charset</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">utf-8</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">meta</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">viewport</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">width=device-width, initial-scale=1</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">head</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">h1</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">h1</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">h2</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">h2</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">load</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript string" style="color:#e3116c">&#x27;alice&#x27;</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">load alice iframe</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">load</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript string" style="color:#e3116c">&#x27;bob&#x27;</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">load bob iframe</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">access</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">access iframe content</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">update</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">update domain</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">body</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> name </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">domain</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">replace</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;.example.com&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;h1&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">innerText</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> name</span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;h2&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">innerText</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript known-class-name class-name">Math</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">random</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">load</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript parameter">name</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> iframe </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">createElement</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;iframe&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      iframe</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">src</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;http://&#x27;</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">+</span><span class="token script language-javascript"> name </span><span class="token script language-javascript operator" style="color:#393A34">+</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;.example.com:5555&#x27;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">body</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">appendChild</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript">iframe</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">access</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword" style="color:#00009f">const</span><span class="token script language-javascript"> win </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;iframe&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">contentWindow</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript function" style="color:#d73a49">alert</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;secret:&#x27;</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">+</span><span class="token script language-javascript"> win</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript method function property-access" style="color:#d73a49">querySelector</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript string" style="color:#e3116c">&#x27;h2&#x27;</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">innerText</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword" style="color:#00009f">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:#d73a49">update</span><span class="token script language-javascript punctuation" style="color:#393A34">(</span><span class="token script language-javascript punctuation" style="color:#393A34">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:#393A34">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">      </span><span class="token script language-javascript dom variable" style="color:#36acaa">document</span><span class="token script language-javascript punctuation" style="color:#393A34">.</span><span class="token script language-javascript property-access">domain</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:#393A34">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string" style="color:#e3116c">&#x27;example.com&#x27;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">    </span><span class="token script language-javascript punctuation" style="color:#393A34">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#393A34"><span class="token script language-javascript">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">html</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ページには3つの機能があります。</p><ol><li>iframeの読み込み</li><li>iframeのDOMからデータを読み取る</li><li>document.domainの変更</li></ol><p>まず、<code>http://alice.example.com:5555</code> を開き、次に <code>http://bob.example.com:5555</code> からiframeを読み込みます。次に、Aliceページの「access iframe content」をクリックします。</p><p><img loading="lazy" alt="例外" src="/beyond-xss/ja/assets/images/20-04-290308aa6bce3f68805c523b6df75761.png" width="722" height="461" class="img_ev3q"></p><p>コンソールに次のエラーメッセージが表示されます。</p><blockquote><p>Uncaught DOMException: Blocked a frame with origin &quot;<a href="http://alice.example.com:5555%22" target="_blank" rel="noopener noreferrer">http://alice.example.com:5555&quot;</a> from accessing a cross-origin frame.</p></blockquote><p>これは、AliceとBobは同一サイトですが、同一オリジンではないためです。iframeがDOMのコンテンツにアクセスするには、同一オリジンである必要があります。</p><p>次に、AliceとBobの両方がそれぞれのページの「update domain」をクリックし、その後再び「access iframe content」をクリックします。</p><p><img loading="lazy" alt="成功" src="/beyond-xss/ja/assets/images/20-05-3b2e6e0865aa2cd1c254c8b23649dc9b.png" width="721" height="427" class="img_ev3q"></p><p>今回は、Bobのページからデータを正常に取得し、<code>http://alice.example.com:5555</code> と <code>http://bob.example.com:5555</code> をクロスオリジンから同一オリジンに変更しました。これが忍術、同一サイトを同一オリジンにする術です！</p><p>このテクニックは、任意の2つのウェブページで使用できるわけではありません。基本的に、同一サイトのウェブサイトのみが使用でき、設定中にも多くのチェックが行われます。</p><p><img loading="lazy" alt="チェック" src="/beyond-xss/ja/assets/images/20-06-0c004681ed15c8ee94ee0d2e87e5e3f1.png" width="1302" height="604" class="img_ev3q"></p><p>github.ioを例にとると、<code>alice.github.io</code> が <code>document.domain = &#x27;github.io&#x27;</code> を実行すると、コンソールにエラーが表示されます。</p><blockquote><p>Uncaught DOMException: Failed to set the &#x27;domain&#x27; property on &#x27;Document&#x27;: &#x27;github.io&#x27; is a top-level domain.</p></blockquote><p><code>document.domain</code> を変更すると、なぜ2つのページが同一オリジンになるのでしょうか？厳密に言えば、同一オリジンではなく、同一オリジンドメインです。<a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-bcc-content-document" target="_blank" rel="noopener noreferrer">document</a>関連の仕様には、一部のチェックは同一オリジンではなく、同一オリジンドメインに基づいていると記載されています。</p><p>では、2つのオリジンが同一オリジンドメインであるかどうかをどのように判断するのでしょうか？仕様を見てみましょう。</p><blockquote><ol><li>AとBが同じ不透明なオリジンである場合、trueを返します。</li><li>AとBが両方ともタプルオリジンである場合、以下のサブステップを実行します。</li></ol><ul><li>AとBのスキームが同一であり、ドメインが同一でnullでない場合、trueを返します。</li><li>それ以外の場合、AとBが同一オリジンであり、ドメインが同一でnullである場合、trueを返します。</li></ul><ol start="3"><li>falseを返します。</li></ol></blockquote><p>AとBのスキームが同じで、ドメイン属性も同じでnullでない場合、trueを返します。それ以外の場合、AとBが同一オリジンでドメインが同一でnullであるかどうかをチェックし、成立した場合にのみtrueを返します。それ以外の場合はfalseを返します。</p><p>いくつか興味深い点があります。</p><ol><li>両方のウェブページにドメインが設定されていないか、両方に同じドメインが設定されている場合にのみ、trueが返される可能性があります（これは重要です）。</li><li>ドメインが設定されている場合、同一オリジンドメインのチェックではポートは考慮されません。</li></ol><p><code>document.domain</code> は、オリジンタプルのドメイン属性を変更するために使用されます。</p><p>上記の例では、両方のウェブページ <code>http://alice.example.com:5555</code> と <code>http://bob.example.com:5555</code> がドメインを <code>example.com</code> に変更したため、同一オリジンドメインです。</p><p>次に、3つの興味深いシナリオを見てみましょう。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="シナリオ1一方的な変更">シナリオ1：一方的な変更<a href="#シナリオ1一方的な変更" class="hash-link" aria-label="シナリオ1：一方的な変更 への直接リンク" title="シナリオ1：一方的な変更 への直接リンク">​</a></h3><p><code>https://alice.example.com</code> が <code>document.domain = &#x27;example.com&#x27;</code> を実行し、次に <code>https://example.com</code> をiframeに埋め込んだ場合、Aliceのページにはドメイン属性がありますが、<code>example.com</code> のページにはドメイン属性がないため、それらは依然として同一オリジンドメインではありません。</p><p><code>example.com</code> も <code>document.domain = &#x27;example.com&#x27;</code> を実行する必要があります。そうすれば、それらは同一オリジンドメインになります。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ケース2消えるポート">ケース2：消えるポート<a href="#ケース2消えるポート" class="hash-link" aria-label="ケース2：消えるポート への直接リンク" title="ケース2：消えるポート への直接リンク">​</a></h3><p><code>http://alice.example.com:1234</code> と <code>http://alice.example.com:4567</code> はポートが異なるためクロスオリジンと見なされます。ただし、両方のページが <code>document.domain = &#x27;alice.example.com&#x27;</code> を実行した場合、それらは同一オリジンドメインになり、ポートが考慮されないため、互いのDOMにアクセスできます。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ケース3私は以前の私ではない">ケース3：私は以前の私ではない<a href="#ケース3私は以前の私ではない" class="hash-link" aria-label="ケース3：私は以前の私ではない への直接リンク" title="ケース3：私は以前の私ではない への直接リンク">​</a></h3><p><code>http://alice.example.com</code> が自身をiframeに埋め込んだと仮定すると、iframeと元のページは明らかに同一オリジンであり、互いのDOMにアクセスできます。</p><p>しかし、ページで <code>document.domain = &#x27;alice.example.com&#x27;</code> を実行すると、そのページにはドメイン属性が設定されますが、iframe内のページにはドメイン属性が設定されていません。したがって、それらは異なるオリジンドメインになります。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="documentdomainのフェードアウトと退場">document.domainのフェードアウトと退場<a href="#documentdomainのフェードアウトと退場" class="hash-link" aria-label="document.domainのフェードアウトと退場 への直接リンク" title="document.domainのフェードアウトと退場 への直接リンク">​</a></h2><p>この方法を使用して同一オリジンの制限を緩和することはかなり以前から行われており、早期の動作との互換性のために削除されていません。初期の頃、多くのウェブページがこの方法を使用して同一サイトだがクロスオリジンのページにアクセスしていたと推測されます。</p><p>しかし、これは明らかにリスクを伴います。例えば、サブドメインにXSSの脆弱性がある場合、この方法を利用して影響範囲を拡大し、2016年に<a href="https://twitter.com/fin1te" target="_blank" rel="noopener noreferrer">@fin1te</a>氏が書いた記事<a href="https://whitton.io/articles/xss-on-facebook-via-png-content-types/" target="_blank" rel="noopener noreferrer">An XSS on Facebook via PNGs &amp; Wonky Content Types</a>では、このテクニックを使用してサブドメインから <code>www.facebook.com</code> に正常に迂回してXSSを実行し、脆弱性の影響力を高めました。</p><p>セキュリティ上の懸念から、Chromeは2022年1月11日にブログで記事を公開しました：<a href="https://developer.chrome.com/blog/immutable-document-domain/" target="_blank" rel="noopener noreferrer">Chrome will disable modifying document.domain to relax the same-origin policy</a>。記事では、Chromeバージョン101以降、<code>document.domain</code> の変更のサポートを停止すると説明しています。</p><p>元の動作は <code>postMessage</code> または <code>Channel Messaging API</code> に置き換えることができますが、元のDOMを直接操作するほど便利ではないため、コードをもう少し記述する必要があります。</p><p>ウェブページがこの <code>document.domain</code> の変更機能を引き続き使用したい場合は、応答ヘッダーに <code>Origin-Agent-Cluster: ?0</code> を含める必要があります。</p><p>記事には、この変更に関する関連する議論スレッドも含まれています：<a href="https://github.com/w3ctag/design-reviews/issues/564" target="_blank" rel="noopener noreferrer">Deprecating document.domain setter. #564</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2><p>同一オリジンポリシーとは、セキュリティ上の問題を回避するために、同一オリジンのウェブページのみが互いのデータにアクセスできることを保証するブラウザの保護メカニズムです。したがって、2つのウェブページが同一オリジンであるかどうかを判断するために、オリジンの定義を理解する必要があります。</p><p>オリジンとサイトという2つの重要な基本概念を紹介した後、CSRF（クロスサイトリクエストフォージェリ）とCORS（クロスオリジンリソース共有）という2つの関連用語に徐々に遭遇します。</p><p>参考文献：</p><ol><li><a href="https://html.spec.whatwg.org/multipage/origin.html#origin" target="_blank" rel="noopener noreferrer">HTML仕様</a></li><li><a href="https://url.spec.whatwg.org/#host-registrable-domain" target="_blank" rel="noopener noreferrer">URL仕様</a></li><li><a href="https://blog.kalan.dev/2021-11-09-url-and-samesite/" target="_blank" rel="noopener noreferrer">2つのドメインが同じ所有者であるかどうかを判断する方法</a></li><li><a href="https://developer.chrome.com/blog/immutable-document-domain/" target="_blank" rel="noopener noreferrer">Chrome will disable modifying document.domain to relax the same-origin policy</a></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/beyond-xss/ja/ch3/html-attack/"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">HTMLだけで攻撃できる？</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/beyond-xss/ja/ch4/cors-intro/"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">クロスオリジンリソース共有 CORS 基本紹介</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#オリジンとサイトとは正確には何ですかどのように区別しますか" class="table-of-contents__link toc-highlight">オリジンとサイトとは正確には何ですか？どのように区別しますか？</a></li><li><a href="#同一オリジンの詳細な検討" class="table-of-contents__link toc-highlight">同一オリジンの詳細な検討</a></li><li><a href="#同一サイトの詳細な検討" class="table-of-contents__link toc-highlight">同一サイトの詳細な検討</a></li><li><a href="#同一オリジンと同一サイト" class="table-of-contents__link toc-highlight">同一オリジンと同一サイト</a></li><li><a href="#不思議なdocumentdomain" class="table-of-contents__link toc-highlight">不思議なdocument.domain</a><ul><li><a href="#シナリオ1一方的な変更" class="table-of-contents__link toc-highlight">シナリオ1：一方的な変更</a></li><li><a href="#ケース2消えるポート" class="table-of-contents__link toc-highlight">ケース2：消えるポート</a></li><li><a href="#ケース3私は以前の私ではない" class="table-of-contents__link toc-highlight">ケース3：私は以前の私ではない</a></li></ul></li><li><a href="#documentdomainのフェードアウトと退場" class="table-of-contents__link toc-highlight">document.domainのフェードアウトと退場</a></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Huli. All rights reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/beyond-xss/ja/assets/js/runtime~main.531fd90e.js"></script>
<script src="/beyond-xss/ja/assets/js/main.b4cb8381.js"></script>
</body>
</html>